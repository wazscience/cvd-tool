// Enhanced validation system
        const EnhancedValidation = (function() {
            // Physiological range definitions with realistic ranges and extreme thresholds
            const ranges = {
                // Demographics
                age: { 
                    min: 18, max: 85, 
                    critical: { min: 16, max: 120 },
                    warning: { min: 18, max: 90 },
                    unit: 'years'
                },
                height: { 
                    min: 140, max: 210, 
                    critical: { min: 60, max: 250 }, 
                    warning: { min: 120, max: 220 },
                    unit: 'cm'
                },
                heightIn: { 
                    min: 55, max: 83, 
                    critical: { min: 24, max: 98 }, 
                    warning: { min: 47, max: 87 },
                    unit: 'in'
                },
                weight: { 
                    min: 40, max: 150, 
                    critical: { min: 25, max: 300 }, 
                    warning: { min: 35, max: 200 },
                    unit: 'kg'
                },
                weightLb: { 
                    min: 88, max: 330, 
                    critical: { min: 55, max: 660 }, 
                    warning: { min: 77, max: 440 },
                    unit: 'lb'
                },
                bmi: { 
                    min: 16, max: 40, 
                    critical: { min: 12, max: 70 }, 
                    warning: { min: 15, max: 50 },
                    unit: 'kg/m²'
                },
                
                // Vitals
                sbp: { 
                    min: 90, max: 180, 
                    critical: { min: 60, max: 280 }, 
                    warning: { min: 80, max: 220 },
                    unit: 'mmHg'
                },
                dbp: { 
                    min: 60, max: 110, 
                    critical: { min: 30, max: 180 }, 
                    warning: { min: 50, max: 130 },
                    unit: 'mmHg'
                },
                
                // Lipids (mmol/L)
                totalCholesterolMmol: { 
                    min: 2.5, max: 8.0, 
                    critical: { min: 1.5, max: 20.0 }, 
                    warning: { min: 2.0, max: 12.0 },
                    unit: 'mmol/L'
                },
                ldlMmol: { 
                    min: 1.5, max: 6.0, 
                    critical: { min: 0.5, max: 15.0 }, 
                    warning: { min: 1.0, max: 10.0 },
                    unit: 'mmol/L'
                },
                hdlMmol: { 
                    min: 0.7, max: 3.0, 
                    critical: { min: 0.2, max: 6.0 }, 
                    warning: { min: 0.5, max: 4.0 },
                    unit: 'mmol/L'
                },
                triglycerideMmol: { 
                    min: 0.5, max: 5.0, 
                    critical: { min: 0.1, max: 20.0 }, 
                    warning: { min: 0.3, max: 10.0 },
                    unit: 'mmol/L'
                },
                nonHdlMmol: { 
                    min: 1.5, max: 6.5, 
                    critical: { min: 0.5, max: 18.0 }, 
                    warning: { min: 1.0, max: 12.0 },
                    unit: 'mmol/L'
                },
                
                // Lipids (mg/dL)
                totalCholesterolMgdl: { 
                    min: 100, max: 310, 
                    critical: { min: 60, max: 800 }, 
                    warning: { min: 80, max: 460 },
                    unit: 'mg/dL'
                },
                ldlMgdl: { 
                    min: 60, max: 230, 
                    critical: { min: 20, max: 580 }, 
                    warning: { min: 40, max: 390 },
                    unit: 'mg/dL'
                },
                hdlMgdl: { 
                    min: 25, max: 120, 
                    critical: { min: 8, max: 230 }, 
                    warning: { min: 20, max: 155 },
                    unit: 'mg/dL'
                },
                triglycerideMgdl: { 
                    min: 45, max: 440, 
                    critical: { min: 9, max: 1770 }, 
                    warning: { min: 25, max: 880 },
                    unit: 'mg/dL'
                },
                nonHdlMgdl: { 
                    min: 60, max: 250, 
                    critical: { min: 20, max: 700 }, 
                    warning: { min: 40, max: 460 },
                    unit: 'mg/dL'
                },
                
                // Special tests
                lpaMgdl: { 
                    min: 0, max: 170, 
                    critical: { min: 0, max: 500 }, 
                    warning: { min: 0, max: 250 },
                    unit: 'mg/dL'
                },
                lpaNmol: { 
                    min: 0, max: 430, 
                    critical: { min: 0, max: 1250 }, 
                    warning: { min: 0, max: 630 },
                    unit: 'nmol/L'
                },
                apobGl: { 
                    min: 0.4, max: 1.8, 
                    critical: { min: 0.2, max: 4.0 }, 
                    warning: { min: 0.3, max: 2.5 },
                    unit: 'g/L'
                },
                apobMgdl: { 
                    min: 40, max: 180, 
                    critical: { min: 20, max: 400 }, 
                    warning: { min: 30, max: 250 },
                    unit: 'mg/dL'
                },
                
                // Other clinical
                sbpSd: { 
                    min: 0, max: 20, 
                    critical: { min: 0, max: 40 }, 
                    warning: { min: 0, max: 30 },
                    unit: 'mmHg'
                },
                hba1c: { 
                    min: 4.0, max: 14.0, 
                    critical: { min: 3.0, max: 18.0 }, 
                    warning: { min: 3.5, max: 16.0 },
                    unit: '%'
                }
            };
            
            // Cross-field validation rules with specific error messages
            const crossFieldRules = {
                sbpDbpDifference: {
                    check: (data) => (data.sbp - data.dbp) >= 10,
                    message: "Systolic BP should be at least 10 mmHg higher than diastolic BP",
                    errorLevel: "error"
                },
                hdlLessThanTotalChol: {
                    check: (data) => data.hdl < data.totalChol,
                    message: "HDL cholesterol should be less than total cholesterol",
                    errorLevel: "error"
                },
                ldlLessThanTotalChol: {
                    check: (data) => data.ldl < data.totalChol,
                    message: "LDL cholesterol should be less than total cholesterol",
                    errorLevel: "error"
                },
                calculatedLdl: {
                    check: (data) => {
                        if (data.totalChol && data.hdl && data.triglycerides && data.ldl) {
                            // Friedewald formula: LDL = TC - HDL - (TG/5)
                            const calculatedLdl = data.totalChol - data.hdl - (data.triglycerides / 5);
                            const diff = Math.abs(calculatedLdl - data.ldl);
                            return diff <= 1.0; // Allow for some variance in calculation
                        }
                        return true;
                    },
                    message: "LDL does not match calculated value from total cholesterol, HDL and triglycerides",
                    errorLevel: "warning"
                },
                bmiConsistency: {
                    check: (data) => {
                        if (data.height && data.weight && data.bmi) {
                            // BMI = weight (kg) / height (m)²
                            const heightInM = data.height / 100;
                            const calculatedBmi = data.weight / (heightInM * heightInM);
                            const diff = Math.abs(calculatedBmi - data.bmi);
                            return diff <= 1.0; // Allow for some variance
                        }
                        return true;
                    },
                    message: "BMI does not match calculated value from height and weight",
                    errorLevel: "warning"
                }
            };
            
            // Check if a value is numeric
            function isNumeric(value) {
                if (value === null || value === undefined || value === '') return false;
                return !isNaN(parseFloat(value)) && isFinite(value);
            }
            
            // Validate a single value against its range
            function validateValue(value, paramType, unit = null) {
                // First check if value is numeric
                if (!isNumeric(value)) {
                    return {
                        isValid: false,
                        level: 'error',
                        message: `Value must be a valid number`
                    };
                }
                
                // Convert value to a number
                const numValue = parseFloat(value);
                
                // Determine which range to use based on parameter type and unit
                let range;
                
                if (paramType === 'height' && unit === 'in') {
                    range = ranges.heightIn;
                } else if (paramType === 'weight' && unit === 'lb') {
                    range = ranges.weightLb;
                } else if (paramType === 'totalCholesterol' || paramType === 'totalChol') {
                    range = unit === 'mg/dL' ? ranges.totalCholesterolMgdl : ranges.totalCholesterolMmol;
                } else if (paramType === 'ldl') {
                    range = unit === 'mg/dL' ? ranges.ldlMgdl : ranges.ldlMmol;
                } else if (paramType === 'hdl') {
                    range = unit === 'mg/dL' ? ranges.hdlMgdl : ranges.hdlMmol;
                } else if (paramType === 'triglycerides' || paramType === 'trig') {
                    range = unit === 'mg/dL' ? ranges.triglycerideMgdl : ranges.triglycerideMmol;
                } else if (paramType === 'nonHdl') {
                    range = unit === 'mg/dL' ? ranges.nonHdlMgdl : ranges.nonHdlMmol;
                } else if (paramType === 'lpa') {
                    range = unit === 'nmol/L' ? ranges.lpaNmol : ranges.lpaMgdl;
                } else if (paramType === 'apob') {
                    range = unit === 'mg/dL' ? ranges.apobMgdl : ranges.apobGl;
                } else {
                    range = ranges[paramType];
                }
                
                if (!range) {
                    return {
                        isValid: false,
                        level: 'error',
                        message: `Unknown parameter type: ${paramType}`
                    };
                }
                
                // Critical range check
                if (numValue < range.critical.min || numValue > range.critical.max) {
                    return {
                        isValid: false,
                        level: 'critical',
                        message: `Value is outside physiologically plausible range (${range.critical.min}-${range.critical.max} ${range.unit})`
                    };
                }
                
                // Warning range check
                if (numValue < range.warning.min || numValue > range.warning.max) {
                    return {
                        isValid: true, // Still considered valid but with warning
                        level: 'warning',
                        message: `Value is unusual (normal range is ${range.min}-${range.max} ${range.unit})`
                    };
                }
                
                // Normal range check
                if (numValue < range.min || numValue > range.max) {
                    return {
                        isValid: true, // Still considered valid but with warning
                        level: 'caution',
                        message: `Value is outside typical range (${range.min}-${range.max} ${range.unit})`
                    };
                }
                
                // Value is within normal range
                return {
                    isValid: true,
                    level: 'normal',
                    message: ''
                };
            }
            
            // Validate multiple fields together
            function validateFields(formData) {
                const results = {
                    isValid: true,
                    fieldResults: {},
                    crossFieldErrors: []
                };
                
                // Validate individual fields
                for (const [fieldId, field] of Object.entries(formData)) {
                    // Skip checking if no value provided
                    if (field.value === undefined || field.value === null || field.value === '') continue;
                    
                    // If this is a unit field, skip
                    if (fieldId.endsWith('-unit')) continue;
                    
                    // If this is a non-numeric field type, skip
                    if (field.type === 'checkbox' || field.type === 'radio' || field.type === 'select') continue;
                    
                    // Get parameter type and unit
                    const paramTypeAttr = field.attributes?.['data-param-type'];
                    const paramType = paramTypeAttr ? paramTypeAttr : fieldId.split('-').pop();
                    
                    // Find corresponding unit field
                    const unitFieldId = `${fieldId}-unit`;
                    const unitField = formData[unitFieldId];
                    const unit = unitField ? unitField.value : null;
                    
                    // Validate value
                    const validationResult = validateValue(field.value, paramType, unit);
                    results.fieldResults[fieldId] = validationResult;
                    
                    // Update overall validity
                    if (validationResult.level === 'error' || validationResult.level === 'critical') {
                        results.isValid = false;
                    }
                }
                
                // Apply cross-field validation rules
                // First, extract values needed for cross-field validation
                const crossFieldData = {};
                for (const [fieldId, field] of Object.entries(formData)) {
                    // Skip non-value fields
                    if (field.value === undefined || field.value === null || field.value === '') continue;
                    if (field.type === 'checkbox' || field.type === 'radio') continue;
                    
                    // Extract base field name without prefix
                    const baseFieldId = fieldId.split('-').pop();
                    
                    // Parse numeric value
                    const value = parseFloat(field.value);
                    if (!isNaN(value)) {
                        crossFieldData[baseFieldId] = value;
                    }
                }
                
                // Apply cross-field rules
                for (const [ruleName, rule] of Object.entries(crossFieldRules)) {
                    const requiredFields = rule.check.toString()
                        .match(/data\.(\w+)/g)
                        ?.map(f => f.replace('data.', '')) || [];
                        
                    const hasAllFields = requiredFields.every(field => 
                        crossFieldData[field] !== undefined
                    );
                    
                    if (hasAllFields) {
                        const isValid = rule.check(crossFieldData);
                        if (!isValid) {
                            if (rule.errorLevel === 'error') {
                                results.isValid = false;
                            }
                            
                            results.crossFieldErrors.push({
                                rule: ruleName,
                                message: rule.message,
                                level: rule.errorLevel,
                                fields: requiredFields
                            });
                        }
                    }
                }
                
                return results;
            }
            
            // Setup enhanced input validation
            function setupEnhancedValidation() {
                // Add enhanced validation to all form inputs with data-param-type attribute
                document.querySelectorAll('input[data-param-type], select[data-param-type]').forEach(input => {
                    // Skip checkboxes and radios
                    if (input.type === 'checkbox' || input.type === 'radio') return;
                    
                    // Process input event for real-time validation
                    input.addEventListener('input', function(e) {
                        validateInputField(this);
                    });
                    
                    // Process change event for final validation
                    input.addEventListener('change', function(e) {
                        validateInputField(this, true);
                    });
                    
                    // Validate on blur
                    input.addEventListener('blur', function(e) {
                        validateInputField(this, true);
                    });
                    
                    // Initial validation
                    if (input.value) {
                        validateInputField(input);
                    }
                });
                
                // Add form submit handlers for cross-field validation
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // Extract form data
                        const formData = {};
                        const formElements = this.elements;
                        
                        for (let i = 0; i < formElements.length; i++) {
                            const element = formElements[i];
                            
                            // Skip buttons
                            if (element.type === 'submit' || element.type === 'reset' || element.type === 'button') {
                                continue;
                            }
                            
                            // Extract element data
                            formData[element.id] = {
                                value: element.type === 'checkbox' ? element.checked : element.value,
                                type: element.type,
                                attributes: {
                                    'data-param-type': element.getAttribute('data-param-type')
                                }
                            };
                        }
                        
                        // Validate fields together
                        const validationResults = validateFields(formData);
                        
                        // Check if validation passed
                        if (!validationResults.isValid) {
                            // Show errors
                            showValidationErrors(validationResults, this);
                            return;
                        }
                        
                        // Continue with form submission
                        const formId = this.id;
                        
                        if (formId === 'frs-form') {
                            calculationManager.handleFRSCalculation();
                        } else if (formId === 'qrisk-form') {
                            calculationManager.handleQRISK3Calculation();
                        } else if (formId === 'medication-form') {
                            calculationManager.handleMedicationEvaluation();
                        }
                    });
                });
            }
            
            // Validate a single input field
            function validateInputField(input, showError = false) {
                // Skip if input is not visible
                if (input.offsetParent === null) return;
                
                // Get parameter type
                const paramType = input.getAttribute('data-param-type');
                if (!paramType) return;
                
                // Get unit if applicable
                const unitFieldId = `${input.id}-unit`;
                const unitField = document.getElementById(unitFieldId);
                const unit = unitField ? unitField.value : null;
                
                // Non-numeric validation
                if (input.value !== '' && !isNumeric(input.value)) {
                    input.classList.add('validation-error');
                    
                    if (showError) {
                        showInputError(
                            input, 
                            'Please enter a valid number', 
                            'error'
                        );
                    }
                    
                    return false;
                }
                
                // Skip validation if empty and not required
                if (input.value === '') {
                    if (input.hasAttribute('required')) {
                        input.classList.add('validation-error');
                        
                        if (showError) {
                            showInputError(
                                input, 
                                'This field is required', 
                                'error'
                            );
                        }
                        
                        return false;
                    } else {
                        // Clear any existing validation classes/errors
                        input.classList.remove('validation-error', 'warning-range', 'critical-range');
                        clearInputError(input);
                        return true;
                    }
                }
                
                // Validate value
                const validationResult = validateValue(input.value, paramType, unit);
                
                // Update input styling
                input.classList.remove('validation-error', 'warning-range', 'critical-range');
                
                if (validationResult.level === 'critical') {
                    input.classList.add('critical-range');
                    
                    if (showError) {
                        showInputError(
                            input, 
                            validationResult.message, 
                            'error'
                        );
                    }
                    
                    return false;
                } else if (validationResult.level === 'warning') {
                    input.classList.add('warning-range');
                    
                    if (showError) {
                        showInputError(
                            input, 
                            validationResult.message, 
                            'warning'
                        );
                    }
                } else if (validationResult.level === 'caution') {
                    input.classList.add('warning-range');
                    
                    if (showError) {
                        showInputError(
                            input, 
                            validationResult.message, 
                            'warning'
                        );
                    }
                } else {
                    // Clear any existing errors
                    clearInputError(input);
                }
                
                return validationResult.isValid;
            }
            
            // Show error tooltip for input
            function showInputError(input, message, level = 'error') {
                // Check if error container exists
                const errorId = `${input.id}-validation`;
                let errorContainer = document.getElementById(errorId);
                
                if (errorContainer) {
                    // Update existing error container
                    errorContainer.textContent = message;
                    errorContainer.style.display = 'block';
                    
                    // Set appropriate class
                    errorContainer.className = 'error-message';
                    if (level === 'warning') {
                        errorContainer.classList.add('warning-message');
                    } else if (level === 'critical') {
                        errorContainer.classList.add('critical-message');
                    }
                } else {
                    // Create new tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'error-tooltip';
                    if (level === 'warning') {
                        tooltip.classList.add('warning-tooltip');
                    }
                    tooltip.textContent = message;
                    
                    // Position tooltip
                    const rect = input.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + window.scrollX + rect.width / 2}px`;
                    tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
                    
                    // Add to document
                    document.body.appendChild(tooltip);
                    
                    // Show tooltip
                    setTimeout(() => {
                        tooltip.classList.add('visible');
                    }, 10);
                    
                    // Hide after delay
                    setTimeout(() => {
                        tooltip.classList.remove('visible');
                        setTimeout(() => {
                            if (document.body.contains(tooltip)) {
                                document.body.removeChild(tooltip);
                            }
                        }, 300);
                    }, 5000);
                }
            }
            
            // Clear input error
            function clearInputError(input) {
                // Check if error container exists
                const errorId = `${input.id}-validation`;
                const errorContainer = document.getElementById(errorId);
                
                if (errorContainer) {
                    errorContainer.style.display = 'none';
                }
            }
            
            // Show validation errors for form
            function showValidationErrors(validationResults, form) {
                // Clear existing error message
                clearFormErrors(form);
                
                // Show field errors
                for (const [fieldId, result] of Object.entries(validationResults.fieldResults)) {
                    if (result.level === 'error' || result.level === 'critical') {
                        const input = document.getElementById(fieldId);
                        if (input) {
                            input.classList.add('validation-error');
                            showInputError(input, result.message, result.level);
                        }
                    }
                }
                
                // Show cross-field errors
                if (validationResults.crossFieldErrors.length > 0) {
                    // Create error summary
                    const errorSummary = document.createElement('div');
                    errorSummary.className = 'error-summary';
                    
                    const errorList = document.createElement('ul');
                    
                    validationResults.crossFieldErrors.forEach(error => {
                        const errorItem = document.createElement('li');
                        errorItem.textContent = error.message;
                        errorItem.className = error.level;
                        errorList.appendChild(errorItem);
                    });
                    
                    errorSummary.appendChild(errorList);
                    
                    // Find appropriate place to show error summary
                    const formActions = form.querySelector('.form-actions');
                    if (formActions) {
                        formActions.parentNode.insertBefore(errorSummary, formActions);
                    } else {
                        form.appendChild(errorSummary);
                    }
                }
            }
            
            // Clear all form errors
            function clearFormErrors(form) {
                // Clear error summary
                const errorSummary = form.querySelector('.error-summary');
                if (errorSummary) {
                    errorSummary.parentNode.removeChild(errorSummary);
                }
            }
            
            // Public API
            return {
                setupEnhancedValidation,
                validateValue,
                validateFields,
                validateInputField,
                showInputError,
                clearInputError
            };
        })();        /* Enhanced error display */
        .validation-error {
            border-color: var(--danger-color) !important;
            background-color: rgba(220, 53, 69, 0.05) !important;
        }
        
        .warning-range {
            border-color: var(--warning-color) !important;
            background-color: rgba(255, 193, 7, 0.05) !important;
        }
        
        .critical-range {
            border-color: var(--danger-color) !important;
            background-color: rgba(220, 53, 69, 0.05) !important;
        }
        
        .error-tooltip {
            position: absolute;
            background-color: var(--danger-color);
            color: white;
            padding: var(--spacing-2);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            z-index: 100;
            max-width: 250px;
            box-shadow: var(--shadow);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-speed) ease-in-out;
        }
        
        .error-tooltip.visible {
            opacity: 1;
        }
        
        .warning-tooltip {
            background-color: var(--warning-color);
            color: #333;
        }
        
        /* Enhanced visualization components */
        .risk-visualization {
            width: 100%;
            height: 60px;
            background: linear-gradient(to right, var(--low-risk-color) 0%, var(--low-risk-color) 10%, 
                                               var(--moderate-risk-color) 10%, var(--moderate-risk-color) 20%, 
                                               var(--high-risk-color) 20%, var(--high-risk-color) 40%, 
                                               var(--extreme-risk-color) 40%, var(--extreme-risk-color) 100%);
            border-radius: var(--border-radius);
            position: relative;
            margin: var(--spacing-4) 0;
        }
        
        .risk-marker {
            position: absolute;
            width: 12px;
            height: 70px;
            top: -5px;
            background-color: #333;
            border: 2px solid white;
            border-radius: 2px;
            transform: translateX(-50%);
            transition: left 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .risk-marker::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #333;
        }
        
        .risk-marker-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .risk-labels {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-2);
            font-size: 0.8rem;
        }
        
        .risk-label {
            position: relative;
            text-align: center;
        }
        
        .risk-label::before {
            content: "";
            position: absolute;
            top: -8px;
            left: 50%;
            height: 6px;
            border-left: 1px solid var(--text-muted);
            transform: translateX(-50%);
        }
        
        .risk-label-low {
            color: var(--low-risk-color);
            margin-left: 5%;
            width: 10%;
        }
        
        .risk-label-moderate {
            color: var(--moderate-risk-color);
            margin-left: 5%;
            width: 10%;
        }
        
        .risk-label-high {
            color: var(--high-risk-color);
            margin-left: 10%;
            width: 10%;
        }
        
        .risk-label-extreme {
            color: var(--extreme-risk-color);
            margin-right: 5%;
            width: 10%;
        }
        
        /* Factor contribution visualization */
        .factor-contribution {
            margin: var(--spacing-4) 0;
        }
        
        .factor-bar {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-2);
        }
        
        .factor-name {
            width: 30%;
            font-size: 0.9rem;
        }
        
        .factor-value-bar {
            flex-grow: 1;
            height: 20px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
        }
        
        .factor-value-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0;
            transition: width 1s ease-out;
        }
        
        .factor-percentage {
            position: absolute;
            right: var(--spacing-2);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        .factor-negative .factor-value-fill {
            background-color: var(--accent-color);
        }
        
        .factor-positive .factor-value-fill {
            background-color: var(--success-color);
        }
        
        /* Interactive help tooltips */
        .help-tooltip-trigger {
            position: relative;
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: pointer;
            margin-left: var(--spacing-2);
        }
        
        .help-tooltip {
            position: absolute;
            width: 250px;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: var(--spacing-3);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            z-index: 100;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: var(--spacing-2);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease-in-out, visibility var(--transition-speed) ease-in-out;
        }
        
        .help-tooltip-trigger:hover .help-tooltip,
        .help-tooltip-trigger:focus .help-tooltip {
            opacity: 1;
            visibility: visible;
        }        // Setup export handlers
        function setupExportHandlers() {
            // PDF export buttons
            document.querySelectorAll('#frs-export-pdf, #qrisk-export-pdf, #med-export-pdf, #comparison-export-pdf').forEach(button => {
                button.addEventListener('click', function() {
                    // Show PDF export modal
                    const modal = document.getElementById('pdf-export-modal');
                    if (modal) {
                        modal.setAttribute('aria-hidden', 'false');
                    }
                });
            });
            
            // Generate PDF button
            const generatePdfButton = document.getElementById('generate-pdf-button');
            if (generatePdfButton) {
                generatePdfButton.addEventListener('click', async function() {
                    try {
                        // Show loading state
                        this.textContent = 'Generating...';
                        this.disabled = true;
                        
                        // Generate PDF
                        const pdfBlob = await generatePDF();
                        
                        // Create download URL
                        const url = URL.createObjectURL(pdfBlob);
                        
                        // Create download link
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'CVD_Risk_Assessment.pdf';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Clean up
                        URL.revokeObjectURL(url);
                        
                        // Close modal
                        const modal = document.getElementById('pdf-export-modal');
                        if (modal) {
                            modal.setAttribute('aria-hidden', 'true');
                        }
                        
                        // Reset button
                        this.textContent = 'Generate PDF';
                        this.disabled = false;
                    } catch (error) {
                        console.error('Failed to generate PDF:', error);
                        alert('Failed to generate PDF. Please try again.');
                        
                        // Reset button
                        this.textContent = 'Generate PDF';
                        this.disabled = false;
                    }
                });
            }
            
            // CSV export buttons
            document.querySelectorAll('#frs-export-csv, #qrisk-export-csv, #med-export-csv, #comparison-export-csv').forEach(button => {
                button.addEventListener('click', function() {
                    // Determine type based on button ID
                    const type = this.id.split('-')[0];
                    
                    // Generate CSV
                    generateCSV(type);
                });
            });
            
            // Print buttons
            document.querySelectorAll('#frs-print-results, #qrisk-print-results, #med-print-results, #comparison-print-results').forEach(button => {
                button.addEventListener('click', function() {
                    window.print();
                });
            });
            
            // Toggle patient info fields in PDF export modal
            const includePatientInfoCheckbox = document.getElementById('pdf-include-patient-info');
            const patientInfoFields = document.getElementById('patient-info-fields');
            
            if (includePatientInfoCheckbox && patientInfoFields) {
                includePatientInfoCheckbox.addEventListener('change', function() {
                    patientInfoFields.style.display = this.checked ? 'flex' : 'none';
                });
            }
        }
        
        // DOMPurify script loading (for input sanitization)
        function loadDOMPurify() {
            return new Promise((resolve, reject) => {
                if (window.DOMPurify) {
                    resolve(window.DOMPurify);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js';
                script.integrity = 'sha512-/hVANe2rNto5LTiWo4iEXF4fDVuXXA64gu+M9S9zV/BuwXM9I4Xful+Fwu0mdFimQTfUallubtJCiNTWJwPCrQ==';
                script.crossOrigin = 'anonymous';
                
                script.onload = () => resolve(window.DOMPurify);
                script.onerror = () => {
                    console.warn('Failed to load DOMPurify. Falling back to basic sanitization.');
                    resolve(null);
                };
                
                document.head.appendChild(script);
            });
        }
        
        // CryptoJS script loading (for encryption)
        function loadCryptoJS() {
            return new Promise((resolve, reject) => {
                if (window.CryptoJS) {
                    resolve(window.CryptoJS);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
                script.integrity = 'sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==';
                script.crossOrigin = 'anonymous';
                
                script.onload = () => resolve(window.CryptoJS);
                script.onerror = () => {
                    console.warn('Failed to load CryptoJS. Falling back to basic encoding.');
                    resolve(null);
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Load security libraries asynchronously
        async function loadSecurityLibraries() {
            try {
                await Promise.all([
                    loadDOMPurify(),
                    loadCryptoJS()
                ]);
                
                console.log('Security libraries loaded successfully.');
            } catch (e) {
                console.warn('Failed to load some security libraries:', e);
            }
        }
        
        // Call security library loading
        loadSecurityLibraries();        // Enhanced PDF export functionality
        function generatePDF() {
            return new Promise((resolve, reject) => {
                try {
                    // Check if jsPDF is loaded
                    if (!window.jspdf || !window.jspdf.jsPDF) {
                        throw new Error('jsPDF library not loaded');
                    }
                    
                    // Create new PDF document
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Add header
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.text('CVD Risk Assessment Report', 105, 20, { align: 'center' });
                    
                    // Add date
                    const today = new Date();
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(`Generated on: ${today.toLocaleDateString()}`, 105, 27, { align: 'center' });
                    
                    // Add patient info if available
                    const patientName = document.getElementById('pdf-patient-name')?.value;
                    const patientId = document.getElementById('pdf-patient-id')?.value;
                    
                    if (patientName || patientId) {
                        doc.setFontSize(12);
                        doc.text('Patient Information:', 20, 40);
                        
                        doc.setFontSize(10);
                        let yPos = 45;
                        
                        if (patientName) {
                            doc.text(`Name: ${patientName}`, 20, yPos);
                            yPos += 5;
                        }
                        
                        if (patientId) {
                            doc.text(`ID: ${patientId}`, 20, yPos);
                            yPos += 5;
                        }
                    }
                    
                    // Get active tab
                    const activeTab = document.querySelector('.tab.active');
                    if (!activeTab) throw new Error('No active tab found');
                    
                    // Determine result type
                    let resultTitle = 'Cardiovascular Risk Assessment';
                    let resultContent = null;
                    
                    if (activeTab.id === 'tab-frs') {
                        resultTitle = 'Framingham Risk Score Assessment';
                        resultContent = extractResultData('frs');
                    } else if (activeTab.id === 'tab-qrisk') {
                        resultTitle = 'QRISK3 Assessment';
                        resultContent = extractResultData('qrisk');
                    } else if (activeTab.id === 'tab-medication') {
                        resultTitle = 'Lipid-Lowering Therapy Assessment';
                        resultContent = extractMedicationData();
                    } else if (activeTab.id === 'tab-comparison') {
                        resultTitle = 'Risk Calculator Comparison';
                        resultContent = extractComparisonData();
                    }
                    
                    if (!resultContent) {
                        throw new Error('No result content available');
                    }
                    
                    // Add result title
                    let yPosition = patientName || patientId ? 55 : 40;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text(resultTitle, 20, yPosition);
                    yPosition += 10;
                    
                    // Add result summary
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.text('Result Summary:', 20, yPosition);
                    yPosition += 7;
                    
                    // Add summary data
                    doc.setFontSize(10);
                    
                    if (resultContent.baseRisk !== undefined) {
                        doc.text(`Base Risk: ${resultContent.baseRisk}%`, 25, yPosition);
                        yPosition += 5;
                    }
                    
                    if (resultContent.lpaModifier !== undefined) {
                        doc.text(`Lp(a) Modifier: ${resultContent.lpaModifier}x`, 25, yPosition);
                        yPosition += 5;
                    }
                    
                    if (resultContent.modifiedRisk !== undefined) {
                        doc.text(`Modified Risk: ${resultContent.modifiedRisk}%`, 25, yPosition);
                        yPosition += 5;
                    }
                    
                    if (resultContent.riskCategory) {
                        // Set color based on risk category
                        let categoryColor;
                        switch (resultContent.riskCategory.toLowerCase()) {
                            case 'low':
                                categoryColor = [40, 167, 69]; // Green
                                break;
                            case 'moderate':
                                categoryColor = [255, 193, 7]; // Yellow
                                break;
                            case 'high':
                                categoryColor = [220, 53, 69]; // Red
                                break;
                            default:
                                categoryColor = [0, 0, 0]; // Black
                        }
                        
                        doc.setTextColor(categoryColor[0], categoryColor[1], categoryColor[2]);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`Risk Category: ${resultContent.riskCategory.toUpperCase()}`, 25, yPosition);
                        doc.setTextColor(0, 0, 0); // Reset to black
                        doc.setFont('helvetica', 'normal');
                        yPosition += 10;
                    } else {
                        yPosition += 5;
                    }
                    
                    // Add interpretation
                    if (resultContent.interpretation) {
                        doc.setFontSize(12);
                        doc.text('Interpretation:', 20, yPosition);
                        yPosition += 7;
                        
                        doc.setFontSize(10);
                        const interpretationLines = doc.splitTextToSize(resultContent.interpretation, 170);
                        doc.text(interpretationLines, 25, yPosition);
                        yPosition += (interpretationLines.length * 5) + 5;
                    }
                    
                    // Add recommendations
                    if (resultContent.recommendations) {
                        doc.setFontSize(12);
                        doc.text('Recommendations:', 20, yPosition);
                        yPosition += 7;
                        
                        doc.setFontSize(10);
                        
                        // Split recommendations into lines
                        const recLines = doc.splitTextToSize(resultContent.recommendations, 170);
                        doc.text(recLines, 25, yPosition);
                        yPosition += (recLines.length * 5) + 5;
                    }
                    
                    // Add input parameters
                    if (resultContent.parameters) {
                        doc.setFontSize(12);
                        doc.text('Input Parameters:', 20, yPosition);
                        yPosition += 7;
                        
                        doc.setFontSize(9);
                        
                        // Create parameter table
                        const paramKeys = Object.keys(resultContent.parameters);
                        const columnWidth = 85;
                        
                        // Create two-column layout for parameters
                        for (let i = 0; i < paramKeys.length; i += 2) {
                            const leftKey = paramKeys[i];
                            const leftValue = resultContent.parameters[leftKey];
                            
                            let paramLine = `${leftKey}: ${leftValue}`;
                            
                            // Add right column if available
                            if (i + 1 < paramKeys.length) {
                                const rightKey = paramKeys[i + 1];
                                const rightValue = resultContent.parameters[rightKey];
                                paramLine = paramLine.padEnd(columnWidth) + `${rightKey}: ${rightValue}`;
                            }
                            
                            doc.text(paramLine, 25, yPosition);
                            yPosition += 4;
                            
                            // Add page break if needed
                            if (yPosition > 280) {
                                doc.addPage();
                                yPosition = 20;
                            }
                        }
                        
                        yPosition += 5;
                    }
                    
                    // Add disclaimer
                    doc.addPage();
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Medical Disclaimer:', 20, 20);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    
                    const disclaimer = [
                        "This report is intended for use by healthcare professionals only as a supplementary aid in cardiovascular risk assessment and management.",
                        "",
                        "The results provided are based on epidemiological data and should not replace clinical judgment. Individual patient factors may not be fully captured by these risk algorithms.",
                        "",
                        "Treatment recommendations are based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult. These guidelines may change over time, and users should refer to the most current recommendations.",
                        "",
                        "The Lp(a) risk modification is based on observational evidence and expert consensus. The precise quantitative relationship between Lp(a) levels and CVD risk may vary between individuals.",
                        "",
                        "The risk calculators have inherent limitations and may not be applicable to all populations.",
                        "",
                        "Reference: Pearson GJ, Thanassoulis G, Anderson TJ, et al. 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult. Can J Cardiol. 2021;37(8):1129-1150."
                    ];
                    
                    let disclaimerY = 25;
                    disclaimer.forEach(line => {
                        doc.text(line, 20, disclaimerY);
                        disclaimerY += line ? 5 : 3;
                    });
                    
                    // Add footer with page numbers
                    const pageCount = doc.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                    }
                    
                    // Generate PDF blob
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    console.error('PDF generation error:', error);
                    reject(error);
                }
            });
        }
        
        // Extract result data for PDF
        function extractResultData(type) {
            const resultContainer = document.getElementById(`${type}-results`);
            if (!resultContainer || !resultContainer.firstElementChild) return null;
            
            // Get latest result card
            const resultCard = resultContainer.firstElementChild;
            
            // Extract data
            const baseRisk = parseFloat(resultCard.querySelector('.base-risk')?.textContent);
            const lpaModifier = parseFloat(resultCard.querySelector('.lpa-modifier')?.textContent);
            const modifiedRisk = parseFloat(resultCard.querySelector('.modified-risk')?.textContent);
            const riskCategory = resultCard.querySelector('.risk-category')?.textContent;
            const interpretation = resultCard.querySelector('.interpretation-text')?.textContent;
            
            // Extract recommendations
            let recommendations = '';
            const recommendationsContent = resultCard.querySelector('.recommendations-content');
            if (recommendationsContent) {
                recommendations = recommendationsContent.textContent.trim();
            }
            
            // Get form parameters
            const form = document.getElementById(`${type}-form`);
            const parameters = {};
            
            if (form) {
                // Add demographics
                parameters['Age'] = document.getElementById(`${type}-age`)?.value || 'N/A';
                parameters['Sex'] = document.getElementById(`${type}-sex`)?.value || 'N/A';
                parameters['BMI'] = document.getElementById(`${type}-bmi`)?.value || 'N/A';
                
                // Add blood pressure
                parameters['Systolic BP'] = document.getElementById(`${type}-sbp`)?.value || 'N/A';
                
                // Add cholesterol
                const totalChol = document.getElementById(`${type}-total-chol`)?.value;
                const totalCholUnit = document.getElementById(`${type}-total-chol-unit`)?.value;
                if (totalChol) {
                    parameters['Total Cholesterol'] = `${totalChol} ${totalCholUnit}`;
                }
                
                const hdl = document.getElementById(`${type}-hdl`)?.value;
                const hdlUnit = document.getElementById(`${type}-hdl-unit`)?.value;
                if (hdl) {
                    parameters['HDL Cholesterol'] = `${hdl} ${hdlUnit}`;
                }
                
                // Add Lp(a)
                const lpa = document.getElementById(`${type}-lpa`)?.value;
                const lpaUnit = document.getElementById(`${type}-lpa-unit`)?.value;
                if (lpa) {
                    parameters['Lp(a)'] = `${lpa} ${lpaUnit}`;
                }
                
                // Add diabetes status
                parameters['Diabetes'] = document.getElementById(`${type}-diabetes`)?.value || 'N/A';
                
                // Add smoking status
                parameters['Smoker'] = document.getElementById(`${type}-smoker`)?.value || 'N/A';
                
                // Add BP treatment
                parameters['BP Treatment'] = document.getElementById(`${type}-bp-treatment`)?.value || 'N/A';
            }
            
            return {
                baseRisk,
                lpaModifier,
                modifiedRisk,
                riskCategory,
                interpretation,
                recommendations,
                parameters
            };
        }
        
        // Extract medication data for PDF
        function extractMedicationData() {
            const resultContainer = document.getElementById('med-results');
            if (!resultContainer || !resultContainer.firstElementChild) return null;
            
            // Get latest result card
            const resultCard = resultContainer.firstElementChild;
            
            // Extract targets data
            const targetsTable = resultCard.querySelector('#targets-table-body');
            const targets = {};
            
            if (targetsTable) {
                const rows = targetsTable.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 4) {
                        const paramName = cells[0].textContent.trim();
                        const currentValue = cells[1].textContent.trim();
                        const targetValue = cells[2].textContent.trim();
                        const status = cells[3].textContent.trim();
                        
                        targets[paramName] = {
                            current: currentValue,
                            target: targetValue,
                            status: status
                        };
                    }
                });
            }
            
            // Extract therapy assessment
            let therapyAssessment = '';
            const therapyAssessmentContent = resultCard.querySelector('#therapy-assessment-content');
            if (therapyAssessmentContent) {
                therapyAssessment = therapyAssessmentContent.textContent.trim();
            }
            
            // Extract recommendations
            let recommendations = '';
            const therapyRecommendationsContent = resultCard.querySelector('#therapy-recommendations-content');
            if (therapyRecommendationsContent) {
                recommendations = therapyRecommendationsContent.textContent.trim();
            }
            
            // Get form parameters
            const form = document.getElementById('medication-form');
            const parameters = {};
            
            if (form) {
                // Prevention category
                parameters['Prevention'] = document.getElementById('med-prevention')?.value || 'N/A';
                
                // Current statin
                const statin = document.getElementById('med-statin')?.value;
                const statinDose = document.getElementById('med-statin-dose')?.value;
                if (statin && statin !== 'none') {
                    parameters['Statin'] = statinDose ? `${statin} ${statinDose} mg` : statin;
                } else {
                    parameters['Statin'] = 'None';
                }
                
                // Other medications
                parameters['Ezetimibe'] = document.getElementById('med-ezetimibe')?.checked ? 'Yes' : 'No';
                parameters['PCSK9 Inhibitor'] = document.getElementById('med-pcsk9')?.checked ? 'Yes' : 'No';
                parameters['Bempedoic Acid'] = document.getElementById('med-bempedoic')?.checked ? 'Yes' : 'No';
                parameters['Fibrate'] = document.getElementById('med-fibrate')?.checked ? 'Yes' : 'No';
                
                // Lipid values
                const ldl = document.getElementById('med-ldl')?.value;
                const ldlUnit = document.getElementById('med-ldl-unit')?.value;
                if (ldl) {
                    parameters['LDL Cholesterol'] = `${ldl} ${ldlUnit}`;
                }
                
                const nonHdl = document.getElementById('med-non-hdl')?.value;
                const nonHdlUnit = document.getElementById('med-non-hdl-unit')?.value;
                if (nonHdl) {
                    parameters['Non-HDL Cholesterol'] = `${nonHdl} ${nonHdlUnit}`;
                }
                
                const lpa = document.getElementById('med-lpa')?.value;
                const lpaUnit = document.getElementById('med-lpa-unit')?.value;
                if (lpa) {
                    parameters['Lp(a)'] = `${lpa} ${lpaUnit}`;
                }
                
                const apob = document.getElementById('med-apob')?.value;
                const apobUnit = document.getElementById('med-apob-unit')?.value;
                if (apob) {
                    parameters['ApoB'] = `${apob} ${apobUnit}`;
                }
            }
            
            // Create interpretation text
            const interpretationParts = [];
            
            // Add targets summary
            const ldlTarget = targets['LDL Cholesterol']?.status || '';
            const nonHdlTarget = targets['Non-HDL Cholesterol']?.status || '';
            
            if (ldlTarget.includes('At Target')) {
                interpretationParts.push('LDL-C is at target.');
            } else if (targets['LDL Cholesterol']) {
                interpretationParts.push(`LDL-C is not at target. Current: ${targets['LDL Cholesterol'].current}, Target: ${targets['LDL Cholesterol'].target}.`);
            }
            
            if (nonHdlTarget.includes('At Target')) {
                interpretationParts.push('Non-HDL-C is at target.');
            } else if (targets['Non-HDL Cholesterol']) {
                interpretationParts.push(`Non-HDL-C is not at target. Current: ${targets['Non-HDL Cholesterol'].current}, Target: ${targets['Non-HDL Cholesterol'].target}.`);
            }
            
            // Add therapy assessment summary
            if (therapyAssessment) {
                interpretationParts.push(therapyAssessment.replace(/\s+/g, ' ').replace(/(\r\n|\n|\r)/gm, ' '));
            }
            
            const interpretation = interpretationParts.join(' ');
            
            return {
                interpretation,
                recommendations,
                parameters,
                targets
            };
        }
        
        // Extract comparison data for PDF
        function extractComparisonData() {
            const resultContainer = document.getElementById('comparison-results');
            if (!resultContainer || !resultContainer.firstElementChild) return null;
            
            // Get result card
            const resultCard = resultContainer.firstElementChild;
            
            // Extract risk values
            const frsBase = parseFloat(resultCard.querySelector('#compare-frs-base')?.textContent);
            const qriskBase = parseFloat(resultCard.querySelector('#compare-qrisk-base')?.textContent);
            const frsMod = parseFloat(resultCard.querySelector('#compare-frs-adjusted')?.textContent);
            const qriskMod = parseFloat(resultCard.querySelector('#compare-qrisk-adjusted')?.textContent);
            const frsLpa = parseFloat(resultCard.querySelector('#compare-frs-lpa')?.textContent);
            const qriskLpa = parseFloat(resultCard.querySelector('#compare-qrisk-lpa')?.textContent);
            
            // Extract interpretation
            const interpretation = resultCard.querySelector('#comparison-interpretation')?.textContent;
            
            // Extract recommendations
            let recommendations = '';
            const recommendationsContent = resultCard.querySelector('#recommendations-content');
            if (recommendationsContent) {
                recommendations = recommendationsContent.textContent.trim();
            }
            
            // Create parameters object
            const parameters = {
                'FRS Base Risk': `${frsBase}%`,
                'QRISK3 Base Risk': `${qriskBase}%`,
                'FRS Lp(a) Modifier': `${frsLpa}x`,
                'QRISK3 Lp(a) Modifier': `${qriskLpa}x`,
                'FRS Modified Risk': `${frsMod}%`,
                'QRISK3 Modified Risk': `${qriskMod}%`
            };
            
            // Determine risk category based on highest risk
            let riskCategory = 'Low';
            const highestRisk = Math.max(frsMod, qriskMod);
            
            if (highestRisk >= 20) {
                riskCategory = 'High';
            } else if (highestRisk >= 10) {
                riskCategory = 'Moderate';
            }
            
            return {
                baseRisk: Math.max(frsBase, qriskBase),
                modifiedRisk: highestRisk,
                riskCategory,
                interpretation,
                recommendations,
                parameters
            };
        }
        
        // Enhanced CSV export functionality
        function generateCSV(type) {
            try {
                // Get data based on type
                let data = null;
                let filename = 'cvd_risk_assessment.csv';
                
                if (type === 'frs') {
                    data = extractResultData('frs');
                    filename = 'framingham_risk_assessment.csv';
                } else if (type === 'qrisk') {
                    data = extractResultData('qrisk');
                    filename = 'qrisk3_assessment.csv';
                } else if (type === 'medication') {
                    data = extractMedicationData();
                    filename = 'medication_assessment.csv';
                } else if (type === 'comparison') {
                    data = extractComparisonData();
                    filename = 'risk_comparison.csv';
                }
                
                if (!data) {
                    throw new Error('No data available for CSV export');
                }
                
                // Create CSV content
                let csvContent = 'Parameter,Value\n';
                
                // Add risk data
                if (data.baseRisk !== undefined) {
                    csvContent += `Base Risk,${data.baseRisk}%\n`;
                }
                
                if (data.lpaModifier !== undefined) {
                    csvContent += `Lp(a) Modifier,${data.lpaModifier}x\n`;
                }
                
                if (data.modifiedRisk !== undefined) {
                    csvContent += `Modified Risk,${data.modifiedRisk}%\n`;
                }
                
                if (data.riskCategory) {
                    csvContent += `Risk Category,${data.riskCategory}\n`;
                }
                
                // Add empty row as separator
                csvContent += '\n';
                
                // Add parameters
                if (data.parameters) {
                    csvContent += 'Input Parameters:\n';
                    
                    for (const [key, value] of Object.entries(data.parameters)) {
                        csvContent += `${key},${value}\n`;
                    }
                    
                    // Add empty row as separator
                    csvContent += '\n';
                }
                
                // Add targets for medication assessment
                if (data.targets) {
                    csvContent += 'Lipid Targets:\n';
                    csvContent += 'Parameter,Current Value,Target Value,Status\n';
                    
                    for (const [key, value] of Object.entries(data.targets)) {
                        csvContent += `${key},${value.current},${value.target},${value.status}\n`;
                    }
                    
                    // Add empty row as separator
                    csvContent += '\n';
                }
                
                // Add interpretation if available
                if (data.interpretation) {
                    csvContent += 'Interpretation:\n';
                    csvContent += `"${data.interpretation.replace(/"/g, '""')}"\n\n`;
                }
                
                // Add recommendations if available
                if (data.recommendations) {
                    csvContent += 'Recommendations:\n';
                    csvContent += `"${data.recommendations.replace(/"/g, '""')}"\n\n`;
                }
                
                // Add disclaimer
                csvContent += 'Disclaimer:\n';
                csvContent += '"This report is intended for use by healthcare professionals only as a supplementary aid in cardiovascular risk assessment and management. The results provided are based on epidemiological data and should not replace clinical judgment."\n';
                csvContent += '"Reference: Pearson GJ, Thanassoulis G, Anderson TJ, et al. 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult. Can J Cardiol. 2021;37(8):1129-1150."\n';
                
                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                return true;
            } catch (error) {
                console.error('CSV generation error:', error);
                alert('Failed to generate CSV file. Please try again.');
                return false;
            }
        }        // Security and sanitization module 
        const SecurityModule = (function() {
            // DOMPurify configuration
            const purifyConfig = {
                ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'p', 'br', 'ul', 'ol', 'li'],
                ALLOWED_ATTR: ['class'],
                ALLOW_DATA_ATTR: false,
                USE_PROFILES: { html: true }
            };
            
            // Input sanitization for all form inputs
            function setupInputSanitization() {
                // Apply to all form inputs
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    // Skip inputs that don't need sanitization (checkbox, radio, button)
                    if (['checkbox', 'radio', 'button', 'submit', 'reset'].includes(input.type)) {
                        return;
                    }
                    
                    // Add input event listeners for real-time sanitization
                    input.addEventListener('input', function(e) {
                        const sanitizedValue = sanitizeInput(this.value, this.type);
                        
                        // Only update if value changed to avoid cursor position issues
                        if (sanitizedValue !== this.value) {
                            // Get cursor position
                            const cursorPos = this.selectionStart;
                            
                            // Update value
                            this.value = sanitizedValue;
                            
                            // Try to restore cursor position
                            this.setSelectionRange(cursorPos, cursorPos);
                        }
                    });
                    
                    // Also sanitize on blur for complete check
                    input.addEventListener('blur', function() {
                        this.value = sanitizeInput(this.value, this.type);
                    });
                });
                
                // Add submit event listeners to all forms
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', function(e) {
                        // Prevent default submit
                        e.preventDefault();
                        
                        // Get all form inputs
                        const formInputs = this.querySelectorAll('input, textarea, select');
                        let isValid = true;
                        
                        // Sanitize all inputs and validate
                        formInputs.forEach(input => {
                            // Skip inputs that don't need sanitization
                            if (['checkbox', 'radio', 'button', 'submit', 'reset'].includes(input.type)) {
                                return;
                            }
                            
                            // Sanitize
                            const sanitizedValue = sanitizeInput(input.value, input.type);
                            input.value = sanitizedValue;
                            
                            // Validate
                            if (input.required && !validateSanitized(sanitizedValue, input.type)) {
                                isValid = false;
                                
                                // Show validation error
                                const errorId = `${input.id}-validation`;
                                const errorEl = document.getElementById(errorId);
                                
                                if (errorEl) {
                                    errorEl.textContent = 'Invalid input. Please check this field.';
                                    errorEl.style.display = 'block';
                                }
                            }
                        });
                        
                        // If all inputs are valid, proceed with original submit handler
                        if (isValid) {
                            // Get the form ID to determine which handler to call
                            const formId = this.id;
                            
                            if (formId === 'frs-form') {
                                calculationManager.handleFRSCalculation();
                            } else if (formId === 'qrisk-form') {
                                calculationManager.handleQRISK3Calculation();
                            } else if (formId === 'medication-form') {
                                calculationManager.handleMedicationEvaluation();
                            }
                        }
                    });
                });
            }
            
            // Sanitize input based on type
            function sanitizeInput(value, type) {
                if (!value) return value;
                
                // Convert to string
                const strValue = String(value);
                
                // Type-specific sanitization
                switch (type) {
                    case 'number':
                    case 'range':
                        // Allow only digits, decimal point, and minus sign
                        return strValue.replace(/[^0-9.-]/g, '');
                        
                    case 'email':
                        // Basic email sanitization
                        return strValue.replace(/[^a-zA-Z0-9.@_-]/g, '');
                        
                    case 'tel':
                        // Allow only digits, +, (), and -
                        return strValue.replace(/[^0-9+()-]/g, '');
                        
                    case 'url':
                        // Basic URL sanitization
                        return strValue.replace(/[^a-zA-Z0-9._~:/?#[\]@!'()*+,;=-]/g, '');
                        
                    case 'text':
                    case 'textarea':
                    default:
                        // Use DOMPurify for HTML content if available
                        if (window.DOMPurify) {
                            return window.DOMPurify.sanitize(strValue, purifyConfig);
                        } else {
                            // Basic fallback sanitization
                            return strValue
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#039;');
                        }
                }
            }
            
            // Validate sanitized value
            function validateSanitized(value, type) {
                if (!value) return false;
                
                switch (type) {
                    case 'number':
                    case 'range':
                        return !isNaN(parseFloat(value)) && isFinite(value);
                        
                    case 'email':
                        return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(value);
                        
                    case 'tel':
                        return /^[0-9+()-\s]{5,20}$/.test(value);
                        
                    case 'url':
                        try {
                            new URL(value);
                            return true;
                        } catch (e) {
                            return false;
                        }
                        
                    case 'text':
                    case 'textarea':
                    default:
                        return value.length > 0;
                }
            }
            
            // Prevent XSS in dynamic content
            function preventXSS(content) {
                // Use DOMPurify for HTML content if available
                if (window.DOMPurify) {
                    return window.DOMPurify.sanitize(content, purifyConfig);
                } else {
                    // Basic fallback sanitization
                    return String(content)
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }
            }
            
            // Encrypt sensitive data
            function encryptData(data, key) {
                // Use CryptoJS if available
                if (window.CryptoJS) {
                    return window.CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
                } else {
                    // Simple base64 encoding as fallback (not real encryption!)
                    return btoa(JSON.stringify(data));
                }
            }
            
            // Decrypt sensitive data
            function decryptData(encryptedData, key) {
                try {
                    // Use CryptoJS if available
                    if (window.CryptoJS) {
                        const bytes = window.CryptoJS.AES.decrypt(encryptedData, key);
                        return JSON.parse(bytes.toString(window.CryptoJS.enc.Utf8));
                    } else {
                        // Simple base64 decoding as fallback (not real decryption!)
                        return JSON.parse(atob(encryptedData));
                    }
                } catch (e) {
                    console.error('Decryption failed:', e);
                    return null;
                }
            }
            
            // Generate encryption key
            function generateEncryptionKey() {
                // Use modern crypto API if available
                if (window.crypto && window.crypto.getRandomValues) {
                    const array = new Uint8Array(16);
                    window.crypto.getRandomValues(array);
                    return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
                } else {
                    // Fallback to less secure Math.random
                    return Math.random().toString(36).substring(2, 15) + 
                           Math.random().toString(36).substring(2, 15);
                }
            }
            
            // Public API
            return {
                setupInputSanitization,
                sanitizeInput,
                validateSanitized,
                preventXSS,
                encryptData,
                decryptData,
                generateEncryptionKey
            };
        })();
        
        // Juno EMR Integration Module
        const JunoIntegration = (function() {
            // API configuration
            let apiKey = null;
            let clinicId = null;
            let isConnected = false;
            
            // Patient data
            let selectedPatient = null;
            
            // Base API URL
            const apiBaseUrl = 'https://api.junoemr.com/api/v1';
            
            // Setup the Juno integration
            function initializeJunoIntegration() {
                // Check for saved connection info
                try {
                    const savedConnection = localStorage.getItem('juno_connection');
                    if (savedConnection) {
                        const decryptedConnection = SecurityModule.decryptData(
                            savedConnection, 
                            'juno_connection_key'
                        );
                        
                        if (decryptedConnection && decryptedConnection.apiKey && decryptedConnection.clinicId) {
                            apiKey = decryptedConnection.apiKey;
                            clinicId = decryptedConnection.clinicId;
                            isConnected = true;
                            
                            // Show connected UI
                            updateJunoConnectionUI(true);
                        }
                    }
                } catch (e) {
                    console.error('Failed to load Juno connection:', e);
                    // Reset connection on error
                    apiKey = null;
                    clinicId = null;
                    isConnected = false;
                }
                
                // Setup modal UI events
                setupJunoModalEvents();
            }
            
            // Setup Juno modal events
            function setupJunoModalEvents() {
                // Connect button
                const connectBtn = document.getElementById('juno-connect-btn');
                if (connectBtn) {
                    connectBtn.addEventListener('click', async function() {
                        const apiKeyInput = document.getElementById('juno-api-key');
                        const clinicIdInput = document.getElementById('juno-clinic-id');
                        
                        if (apiKeyInput && clinicIdInput) {
                            // Sanitize inputs
                            const sanitizedApiKey = SecurityModule.sanitizeInput(apiKeyInput.value, 'text');
                            const sanitizedClinicId = SecurityModule.sanitizeInput(clinicIdInput.value, 'text');
                            
                            // Try to connect
                            await connectToJuno(sanitizedApiKey, sanitizedClinicId);
                        }
                    });
                }
                
                // Search patient button
                const patientSearchInput = document.getElementById('juno-patient-search');
                if (patientSearchInput) {
                    patientSearchInput.addEventListener('input', debounce(function() {
                        const searchTerm = SecurityModule.sanitizeInput(this.value, 'text');
                        if (searchTerm && searchTerm.length >= 3) {
                            searchPatient(searchTerm);
                        }
                    }, 500));
                }
                
                // Import data button
                const importBtn = document.getElementById('juno-import-btn');
                if (importBtn) {
                    importBtn.addEventListener('click', function() {
                        if (selectedPatient) {
                            importPatientData(selectedPatient);
                        }
                    });
                }
                
                // Export button
                const exportBtn = document.getElementById('juno-export-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', function() {
                        if (selectedPatient) {
                            exportToJuno(selectedPatient);
                        }
                    });
                }
            }
            
            // Connect to Juno EMR
            async function connectToJuno(newApiKey, newClinicId) {
                try {
                    // Show loading indicator
                    const connectBtn = document.getElementById('juno-connect-btn');
                    if (connectBtn) {
                        connectBtn.innerHTML = 'Connecting...';
                        connectBtn.disabled = true;
                    }
                    
                    // Attempt to validate credentials with the Juno API
                    const response = await fetch(`${apiBaseUrl}/clinics/${newClinicId}/validate`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${newApiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to connect to Juno EMR');
                    }
                    
                    // Connection successful
                    apiKey = newApiKey;
                    clinicId = newClinicId;
                    isConnected = true;
                    
                    // Save connection info (encrypted)
                    try {
                        const connectionData = { apiKey, clinicId };
                        const encryptedData = SecurityModule.encryptData(
                            connectionData,
                            'juno_connection_key'
                        );
                        localStorage.setItem('juno_connection', encryptedData);
                    } catch (e) {
                        console.error('Failed to save Juno connection:', e);
                    }
                    
                    // Update UI
                    updateJunoConnectionUI(true);
                    
                    return true;
                } catch (error) {
                    console.error('Juno connection error:', error);
                    
                    // Show error
                    alert('Failed to connect to Juno EMR. Please check your credentials and try again.');
                    
                    // Reset button
                    if (connectBtn) {
                        connectBtn.innerHTML = 'Connect';
                        connectBtn.disabled = false;
                    }
                    
                    return false;
                }
            }
            
            // Update Juno connection UI
            function updateJunoConnectionUI(isConnected) {
                const authSection = document.getElementById('juno-auth-section');
                const patientSection = document.getElementById('juno-patient-section');
                
                if (authSection && patientSection) {
                    if (isConnected) {
                        authSection.style.display = 'none';
                        patientSection.style.display = 'block';
                    } else {
                        authSection.style.display = 'block';
                        patientSection.style.display = 'none';
                        
                        // Reset other sections
                        const dataSection = document.getElementById('juno-data-section');
                        const exportSection = document.getElementById('juno-export-section');
                        
                        if (dataSection) dataSection.style.display = 'none';
                        if (exportSection) exportSection.style.display = 'none';
                    }
                }
                
                // Update header section with connection status
                const headerJunoStatus = document.getElementById('juno-connection-status');
                if (headerJunoStatus) {
                    headerJunoStatus.className = isConnected ? 'connected' : 'disconnected';
                    headerJunoStatus.textContent = isConnected ? 'Connected to Juno EMR' : 'Not Connected';
                }
            }
            
            // Search for patients
            async function searchPatient(searchTerm) {
                if (!isConnected) return;
                
                try {
                    // Show loading
                    const resultsContainer = document.getElementById('juno-patient-results');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '<p>Searching...</p>';
                    }
                    
                    // Call Juno API
                    const response = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/search?term=${encodeURIComponent(searchTerm)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Patient search failed');
                    }
                    
                    const patients = await response.json();
                    
                    // Display results
                    displayPatientResults(patients);
                    
                    return patients;
                } catch (error) {
                    console.error('Patient search error:', error);
                    
                    // Show error
                    const resultsContainer = document.getElementById('juno-patient-results');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '<p class="error">Failed to search patients. Please try again.</p>';
                    }
                    
                    return [];
                }
            }
            
            // Display patient search results
            function displayPatientResults(patients) {
                const resultsContainer = document.getElementById('juno-patient-results');
                if (!resultsContainer) return;
                
                if (!patients || patients.length === 0) {
                    resultsContainer.innerHTML = '<p>No patients found. Try a different search term.</p>';
                    return;
                }
                
                // Create results list
                let html = '<ul class="patient-list">';
                
                patients.forEach(patient => {
                    html += `
                        <li class="patient-item" data-patient-id="${SecurityModule.preventXSS(patient.id)}">
                            <div class="patient-name">${SecurityModule.preventXSS(patient.lastName)}, ${SecurityModule.preventXSS(patient.firstName)}</div>
                            <div class="patient-info">
                                <span class="patient-dob">DOB: ${SecurityModule.preventXSS(patient.dateOfBirth)}</span>
                                <span class="patient-chart">Chart: ${SecurityModule.preventXSS(patient.chartNumber)}</span>
                            </div>
                        </li>
                    `;
                });
                
                html += '</ul>';
                
                // Set HTML
                resultsContainer.innerHTML = html;
                
                // Add click handlers
                const patientItems = resultsContainer.querySelectorAll('.patient-item');
                patientItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const patientId = this.dataset.patientId;
                        selectPatient(patientId, patients);
                    });
                });
            }
            
            // Select a patient
            function selectPatient(patientId, patientsList) {
                // Find patient in list
                const patient = patientsList.find(p => p.id === patientId);
                if (!patient) return;
                
                // Set selected patient
                selectedPatient = patient;
                
                // Update UI
                const dataSection = document.getElementById('juno-data-section');
                if (dataSection) {
                    dataSection.style.display = 'block';
                }
                
                // Display patient info
                const patientInfo = document.getElementById('juno-patient-info');
                if (patientInfo) {
                    patientInfo.innerHTML = `
                        <div class="patient-card">
                            <h4>${SecurityModule.preventXSS(patient.firstName)} ${SecurityModule.preventXSS(patient.lastName)}</h4>
                            <div class="patient-card-details">
                                <p><strong>Chart:</strong> ${SecurityModule.preventXSS(patient.chartNumber)}</p>
                                <p><strong>DOB:</strong> ${SecurityModule.preventXSS(patient.dateOfBirth)} (${calculateAge(patient.dateOfBirth)} years)</p>
                                <p><strong>Sex:</strong> ${SecurityModule.preventXSS(patient.sex)}</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Import patient data
            async function importPatientData(patient) {
                if (!isConnected || !patient) return;
                
                try {
                    // Show loading
                    const importBtn = document.getElementById('juno-import-btn');
                    if (importBtn) {
                        importBtn.innerHTML = 'Importing...';
                        importBtn.disabled = true;
                    }
                    
                    // Determine what to import
                    const importDemographics = document.getElementById('juno-import-demographics')?.checked || false;
                    const importVitals = document.getElementById('juno-import-vitals')?.checked || false;
                    const importLabs = document.getElementById('juno-import-labs')?.checked || false;
                    const importConditions = document.getElementById('juno-import-conditions')?.checked || false;
                    const importMedications = document.getElementById('juno-import-medications')?.checked || false;
                    
                    // Fetch patient details
                    const patientResponse = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/${patient.id}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!patientResponse.ok) {
                        throw new Error('Failed to fetch patient details');
                    }
                    
                    const patientDetails = await patientResponse.json();
                    
                    // Populate form fields
                    
                    // Determine active tab/calculator
                    const activeTab = document.querySelector('.tab.active');
                    let formPrefix = 'frs';
                    
                    if (activeTab) {
                        if (activeTab.id === 'tab-qrisk') {
                            formPrefix = 'qrisk';
                        } else if (activeTab.id === 'tab-medication') {
                            formPrefix = 'med';
                        }
                    }
                    
                    // Demographics
                    if (importDemographics) {
                        // Age
                        if (patientDetails.dateOfBirth) {
                            const age = calculateAge(patientDetails.dateOfBirth);
                            document.getElementById(`${formPrefix}-age`)?.setValue(age);
                        }
                        
                        // Sex
                        if (patientDetails.sex) {
                            const sexValue = patientDetails.sex.toLowerCase() === 'male' ? 'male' : 'female';
                            document.getElementById(`${formPrefix}-sex`)?.setValue(sexValue);
                        }
                    }
                    
                    // Vitals
                    if (importVitals) {
                        // Fetch vitals
                        const vitalsResponse = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/${patient.id}/vitals`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (vitalsResponse.ok) {
                            const vitals = await vitalsResponse.json();
                            
                            // Use most recent vitals
                            if (vitals.length > 0) {
                                const latestVitals = vitals[0]; // Assuming sorted by date
                                
                                // Height
                                if (latestVitals.height) {
                                    document.getElementById(`${formPrefix}-height`)?.setValue(latestVitals.height);
                                    document.getElementById(`${formPrefix}-height-unit`)?.setValue('cm');
                                }
                                
                                // Weight
                                if (latestVitals.weight) {
                                    document.getElementById(`${formPrefix}-weight`)?.setValue(latestVitals.weight);
                                    document.getElementById(`${formPrefix}-weight-unit`)?.setValue('kg');
                                }
                                
                                // Blood pressure
                                if (latestVitals.systolicBP) {
                                    document.getElementById(`${formPrefix}-sbp`)?.setValue(latestVitals.systolicBP);
                                }
                            }
                        }
                    }
                    
                    // Labs
                    if (importLabs) {
                        // Fetch labs
                        const labsResponse = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/${patient.id}/labs`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (labsResponse.ok) {
                            const labs = await labsResponse.json();
                            
                            // Find relevant labs
                            const lipidPanel = findLatestLabByType(labs, 'LIPID_PANEL');
                            const hba1c = findLatestLabByType(labs, 'HBA1C');
                            const lpa = findLatestLabByType(labs, 'LIPOPROTEIN_A');
                            
                            // Populate lipid panel
                            if (lipidPanel) {
                                // Total cholesterol
                                if (lipidPanel.components.totalCholesterol) {
                                    document.getElementById(`${formPrefix}-total-chol`)?.setValue(lipidPanel.components.totalCholesterol);
                                    document.getElementById(`${formPrefix}-total-chol-unit`)?.setValue('mmol/L');
                                }
                                
                                // HDL
                                if (lipidPanel.components.hdl) {
                                    document.getElementById(`${formPrefix}-hdl`)?.setValue(lipidPanel.components.hdl);
                                    document.getElementById(`${formPrefix}-hdl-unit`)?.setValue('mmol/L');
                                }
                                
                                // LDL
                                if (lipidPanel.components.ldl) {
                                    document.getElementById(`${formPrefix}-ldl`)?.setValue(lipidPanel.components.ldl);
                                    document.getElementById(`${formPrefix}-ldl-unit`)?.setValue('mmol/L');
                                }
                                
                                // Triglycerides
                                if (lipidPanel.components.triglycerides) {
                                    document.getElementById(`${formPrefix}-trig`)?.setValue(lipidPanel.components.triglycerides);
                                    document.getElementById(`${formPrefix}-trig-unit`)?.setValue('mmol/L');
                                }
                                
                                // Non-HDL
                                if (lipidPanel.components.totalCholesterol && lipidPanel.components.hdl) {
                                    const nonHdl = lipidPanel.components.totalCholesterol - lipidPanel.components.hdl;
                                    document.getElementById(`${formPrefix}-nonhdl`)?.setValue(nonHdl.toFixed(2));
                                    document.getElementById(`${formPrefix}-nonhdl-unit`)?.setValue('mmol/L');
                                }
                                
                                // ApoB
                                if (lipidPanel.components.apob) {
                                    document.getElementById(`${formPrefix}-apob`)?.setValue(lipidPanel.components.apob);
                                    document.getElementById(`${formPrefix}-apob-unit`)?.setValue('g/L');
                                }
                            }
                            
                            // HbA1c
                            if (hba1c && hba1c.value) {
                                document.getElementById(`${formPrefix}-ha1c`)?.setValue(hba1c.value);
                            }
                            
                            // Lp(a)
                            if (lpa && lpa.value) {
                                document.getElementById(`${formPrefix}-lpa`)?.setValue(lpa.value);
                                document.getElementById(`${formPrefix}-lpa-unit`)?.setValue('mg/dL');
                            }
                        }
                    }
                    
                    // Medical conditions
                    if (importConditions) {
                        // Fetch conditions
                        const conditionsResponse = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/${patient.id}/conditions`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (conditionsResponse.ok) {
                            const conditions = await conditionsResponse.json();
                            
                            // Check for diabetes
                            const hasDiabetes = conditions.some(c => 
                                c.name.toLowerCase().includes('diabetes') || 
                                c.icd10.startsWith('E10') || 
                                c.icd10.startsWith('E11')
                            );
                            
                            if (hasDiabetes) {
                                // Determine type
                                const isType1 = conditions.some(c => 
                                    c.name.toLowerCase().includes('type 1') || 
                                    c.icd10.startsWith('E10')
                                );
                                
                                if (formPrefix === 'qrisk') {
                                    document.getElementById(`${formPrefix}-diabetes`)?.setValue(isType1 ? 'type1' : 'type2');
                                } else {
                                    document.getElementById(`${formPrefix}-diabetes`)?.setValue('yes');
                                }
                            }
                            
                            // Check for hypertension
                            const hasHypertension = conditions.some(c => 
                                c.name.toLowerCase().includes('hypertension') || 
                                c.icd10.startsWith('I10') || 
                                c.icd10.startsWith('I11')
                            );
                            
                            if (hasHypertension) {
                                document.getElementById(`${formPrefix}-bp-treatment`)?.setValue('yes');
                            }
                            
                            // Check for other conditions (QRISK3 specific)
                            if (formPrefix === 'qrisk') {
                                // Atrial fibrillation
                                const hasAFib = conditions.some(c => 
                                    c.name.toLowerCase().includes('atrial fibrillation') || 
                                    c.icd10.startsWith('I48')
                                );
                                
                                if (hasAFib) {
                                    document.getElementById('qrisk-atrial-fibrillation').checked = true;
                                }
                                
                                // Rheumatoid arthritis
                                const hasRA = conditions.some(c => 
                                    c.name.toLowerCase().includes('rheumatoid arthritis') || 
                                    c.icd10.startsWith('M05') || 
                                    c.icd10.startsWith('M06')
                                );
                                
                                if (hasRA) {
                                    document.getElementById('qrisk-rheumatoid-arthritis').checked = true;
                                }
                                
                                // Kidney disease
                                const hasCKD = conditions.some(c => 
                                    c.name.toLowerCase().includes('chronic kidney disease') || 
                                    c.icd10.startsWith('N18')
                                );
                                
                                if (hasCKD) {
                                    document.getElementById('qrisk-renal-disease').checked = true;
                                }
                                
                                // Migraine
                                const hasMigraine = conditions.some(c => 
                                    c.name.toLowerCase().includes('migraine') || 
                                    c.icd10.startsWith('G43')
                                );
                                
                                if (hasMigraine) {
                                    document.getElementById('qrisk-migraine').checked = true;
                                }
                                
                                // SLE
                                const hasSLE = conditions.some(c => 
                                    c.name.toLowerCase().includes('lupus') || 
                                    c.icd10.startsWith('M32')
                                );
                                
                                if (hasSLE) {
                                    document.getElementById('qrisk-systemic-lupus').checked = true;
                                }
                            }
                            
                            // Populate medical conditions (for medication tab)
                            if (formPrefix === 'med' && conditions.length > 0) {
                                // Limit to 6 conditions
                                const limitedConditions = conditions.slice(0, 6);
                                
                                limitedConditions.forEach((condition, index) => {
                                    const conditionInput = document.getElementById(`med-condition-${index + 1}`);
                                    const durationInput = document.getElementById(`med-condition-duration-${index + 1}`);
                                    
                                    if (conditionInput) {
                                        conditionInput.value = condition.name;
                                    }
                                    
                                    if (durationInput && condition.onsetDate) {
                                        const onsetDate = new Date(condition.onsetDate);
                                        const monthsDuration = monthsBetween(onsetDate, new Date());
                                        
                                        if (monthsDuration < 1) {
                                            durationInput.value = '<1';
                                        } else if (monthsDuration < 6) {
                                            durationInput.value = '1-6';
                                        } else if (monthsDuration < 12) {
                                            durationInput.value = '6-12';
                                        } else if (monthsDuration < 60) {
                                            durationInput.value = '1-5';
                                        } else {
                                            durationInput.value = '>5';
                                        }
                                    }
                                });
                            }
                        }
                    }
                    
                    // Medications
                    if (importMedications && formPrefix === 'med') {
                        // Fetch medications
                        const medsResponse = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/${patient.id}/medications`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (medsResponse.ok) {
                            const medications = await medsResponse.json();
                            
                            // Check for statins
                            const statins = {
                                'atorvastatin': ['atorvastatin', 'lipitor'],
                                'rosuvastatin': ['rosuvastatin', 'crestor'],
                                'simvastatin': ['simvastatin', 'zocor'],
                                'pravastatin': ['pravastatin', 'pravachol'],
                                'lovastatin': ['lovastatin', 'mevacor'],
                                'fluvastatin': ['fluvastatin', 'lescol'],
                                'pitavastatin': ['pitavastatin', 'livalo']
                            };
                            
                            let foundStatin = null;
                            let statinDose = null;
                            
                            // Check each statin
                            for (const [statinKey, statinNames] of Object.entries(statins)) {
                                const matchingMed = medications.find(med => 
                                    statinNames.some(name => med.name.toLowerCase().includes(name))
                                );
                                
                                if (matchingMed) {
                                    foundStatin = statinKey;
                                    
                                    // Try to extract dose
                                    const doseMatch = matchingMed.name.match(/\b(\d+)[\s]?mg\b/i);
                                    if (doseMatch) {
                                        statinDose = doseMatch[1];
                                    }
                                    
                                    break;
                                }
                            }
                            
                            // Set statin
                            if (foundStatin) {
                                document.getElementById('med-statin').value = foundStatin;
                                document.getElementById('med-statin').dispatchEvent(new Event('change'));
                                
                                // Set dose if found
                                if (statinDose) {
                                    setTimeout(() => {
                                        document.getElementById('med-statin-dose').value = statinDose;
                                    }, 100);
                                }
                            }
                            
                            // Check for other lipid medications
                            const ezetimibe = medications.some(med => 
                                med.name.toLowerCase().includes('ezetimibe') || 
                                med.name.toLowerCase().includes('zetia') || 
                                med.name.toLowerCase().includes('ezetrol')
                            );
                            
                            if (ezetimibe) {
                                document.getElementById('med-ezetimibe').checked = true;
                                document.getElementById('med-ezetimibe').dispatchEvent(new Event('change'));
                            }
                            
                            const pcsk9 = medications.some(med => 
                                med.name.toLowerCase().includes('evolocumab') || 
                                med.name.toLowerCase().includes('repatha') || 
                                med.name.toLowerCase().includes('alirocumab') || 
                                med.name.toLowerCase().includes('praluent')
                            );
                            
                            if (pcsk9) {
                                document.getElementById('med-pcsk9').checked = true;
                                document.getElementById('med-pcsk9').dispatchEvent(new Event('change'));
                            }
                            
                            const bempedoic = medications.some(med => 
                                med.name.toLowerCase().includes('bempedoic') || 
                                med.name.toLowerCase().includes('nexletol') || 
                                med.name.toLowerCase().includes('nilemdo')
                            );
                            
                            if (bempedoic) {
                                document.getElementById('med-bempedoic').checked = true;
                                document.getElementById('med-bempedoic').dispatchEvent(new Event('change'));
                            }
                            
                            const fibrate = medications.some(med => 
                                med.name.toLowerCase().includes('fenofibrate') || 
                                med.name.toLowerCase().includes('gemfibrozil')
                            );
                            
                            if (fibrate) {
                                document.getElementById('med-fibrate').checked = true;
                                document.getElementById('med-fibrate').dispatchEvent(new Event('change'));
                            }
                            
                            const niacin = medications.some(med => 
                                med.name.toLowerCase().includes('niacin') || 
                                med.name.toLowerCase().includes('nicotinic acid')
                            );
                            
                            if (niacin) {
                                document.getElementById('med-niacin').checked = true;
                                document.getElementById('med-niacin').dispatchEvent(new Event('change'));
                            }
                            
                            const omega3 = medications.some(med => 
                                med.name.toLowerCase().includes('omega-3') || 
                                med.name.toLowerCase().includes('icosapent') || 
                                med.name.toLowerCase().includes('vascepa') || 
                                med.name.toLowerCase().includes('lovaza')
                            );
                            
                            if (omega3) {
                                document.getElementById('med-omega3').checked = true;
                                document.getElementById('med-omega3').dispatchEvent(new Event('change'));
                            }
                        }
                    }
                    
                    // Show export section
                    const exportSection = document.getElementById('juno-export-section');
                    if (exportSection) {
                        exportSection.style.display = 'block';
                    }
                    
                    // Reset button
                    if (importBtn) {
                        importBtn.innerHTML = 'Import Selected Data';
                        importBtn.disabled = false;
                    }
                    
                    // Close modal
                    const modal = document.getElementById('juno-integration-modal');
                    if (modal) {
                        modal.setAttribute('aria-hidden', 'true');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Data import error:', error);
                    
                    // Show error
                    alert('Failed to import patient data. Please try again.');
                    
                    // Reset button
                    const importBtn = document.getElementById('juno-import-btn');
                    if (importBtn) {
                        importBtn.innerHTML = 'Import Selected Data';
                        importBtn.disabled = false;
                    }
                    
                    return false;
                }
            }
            
            // Export results to Juno
            async function exportToJuno(patient) {
                if (!isConnected || !patient) return;
                
                try {
                    // Show loading
                    const exportBtn = document.getElementById('juno-export-btn');
                    if (exportBtn) {
                        exportBtn.innerHTML = 'Exporting...';
                        exportBtn.disabled = true;
                    }
                    
                    // Get active tab
                    const activeTab = document.querySelector('.tab.active');
                    if (!activeTab) throw new Error('No active tab found');
                    
                    // Get result content
                    let resultContent = '';
                    
                    if (activeTab.id === 'tab-frs') {
                        const resultElement = document.getElementById('frs-results');
                        if (resultElement) {
                            resultContent = resultElement.innerHTML;
                        }
                    } else if (activeTab.id === 'tab-qrisk') {
                        const resultElement = document.getElementById('qrisk-results');
                        if (resultElement) {
                            resultContent = resultElement.innerHTML;
                        }
                    } else if (activeTab.id === 'tab-medication') {
                        const resultElement = document.getElementById('med-results');
                        if (resultElement) {
                            resultContent = resultElement.innerHTML;
                        }
                    } else if (activeTab.id === 'tab-comparison') {
                        const resultElement = document.getElementById('comparison-results');
                        if (resultElement) {
                            resultContent = resultElement.innerHTML;
                        }
                    }
                    
                    if (!resultContent) {
                        throw new Error('No result content found to export');
                    }
                    
                    // Get export options
                    const includePdf = document.getElementById('juno-export-pdf')?.checked || false;
                    const includeSummary = document.getElementById('juno-export-summary')?.checked || false;
                    const additionalNote = document.getElementById('juno-export-note')?.value || '';
                    
                    // Create PDF if needed
                    let pdfBlob = null;
                    
                    if (includePdf) {
                        // Generate PDF
                        pdfBlob = await generatePDF();
                    }
                    
                    // Create export data
                    const exportData = {
                        patientId: patient.id,
                        clinicId,
                        content: {
                            type: activeTab.id.replace('tab-', ''),
                            summary: includeSummary,
                            note: additionalNote,
                            html: resultContent
                        }
                    };
                    
                    // Export to Juno
                    const exportResponse = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/${patient.id}/notes`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(exportData)
                    });
                    
                    if (!exportResponse.ok) {
                        throw new Error('Failed to export note to Juno EMR');
                    }
                    
                    // Upload PDF if available
                    if (pdfBlob) {
                        const noteId = await exportResponse.json().id;
                        
                        const formData = new FormData();
                        formData.append('file', pdfBlob, 'CVD_Risk_Assessment.pdf');
                        
                        const pdfResponse = await fetch(`${apiBaseUrl}/clinics/${clinicId}/patients/${patient.id}/notes/${noteId}/attachments`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: formData
                        });
                        
                        if (!pdfResponse.ok) {
                            console.warn('Failed to attach PDF to note');
                        }
                    }
                    
                    // Success
                    alert('Results successfully exported to Juno EMR.');
                    
                    // Reset button
                    if (exportBtn) {
                        exportBtn.innerHTML = 'Export to Juno EMR';
                        exportBtn.disabled = false;
                    }
                    
                    // Close modal
                    const modal = document.getElementById('juno-integration-modal');
                    if (modal) {
                        modal.setAttribute('aria-hidden', 'true');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Export error:', error);
                    
                    // Show error
                    alert('Failed to export results to Juno EMR. Please try again.');
                    
                    // Reset button
                    const exportBtn = document.getElementById('juno-export-btn');
                    if (exportBtn) {
                        exportBtn.innerHTML = 'Export to Juno EMR';
                        exportBtn.disabled = false;
                    }
                    
                    return false;
                }
            }
            
            // Helper function to calculate age from DOB
            function calculateAge(dateOfBirth) {
                const dob = new Date(dateOfBirth);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                
                return age;
            }
            
            // Helper function to calculate months between dates
            function monthsBetween(date1, date2) {
                const d1 = new Date(date1);
                const d2 = new Date(date2);
                
                const yearDiff = d2.getFullYear() - d1.getFullYear();
                const monthDiff = d2.getMonth() - d1.getMonth();
                
                return yearDiff * 12 + monthDiff;
            }
            
            // Helper function to find latest lab by type
            function findLatestLabByType(labs, type) {
                if (!labs || !labs.length) return null;
                
                // Filter by type
                const filteredLabs = labs.filter(lab => lab.type === type);
                
                if (!filteredLabs.length) return null;
                
                // Sort by date (descending)
                filteredLabs.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA;
                });
                
                return filteredLabs[0];
            }
            
            // Helper for input value setting
            Element.prototype.setValue = function(value) {
                if (this.type === 'checkbox') {
                    this.checked = Boolean(value);
                } else {
                    this.value = value;
                }
                
                // Trigger change event
                this.dispatchEvent(new Event('change'));
            };
            
            // Utility function for debouncing
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }
            
            // Public API
            return {
                initializeJunoIntegration,
                connectToJuno,
                searchPatient,
                importPatientData,
                exportToJuno
            };
        })();    <div class="modal" id="juno-integration-modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-container" role="dialog" aria-labelledby="juno-integration-modal-title" aria-modal="true">
            <div class="modal-header">
                <h2 id="juno-integration-modal-title">Juno EMR Integration</h2>
                <button class="modal-close" aria-label="Close Juno integration modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="juno-auth-section" id="juno-auth-section">
                    <h3>Connect to Juno EMR</h3>
                    <p>Connect to your Juno EMR account to import patient data and export results.</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="juno-api-key">Juno API Key</label>
                            <input type="password" id="juno-api-key" class="form-input form-input-large" placeholder="Enter your Juno API key">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="juno-clinic-id">Clinic ID</label>
                            <input type="text" id="juno-clinic-id" class="form-input form-input-large" placeholder="Enter your clinic ID">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="juno-connect-btn" class="button button-primary">Connect</button>
                    </div>
                </div>
                
                <div class="juno-patient-section" id="juno-patient-section" style="display: none;">
                    <h3>Select Patient</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="juno-patient-search">Search Patient</label>
                            <input type="text" id="juno-patient-search" class="form-input form-input-large" placeholder="Search by name or chart number">
                        </div>
                    </div>
                    
                    <div class="juno-patient-results" id="juno-patient-results">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                
                <div class="juno-data-section" id="juno-data-section" style="display: none;">
                    <h3>Patient Data</h3>
                    <div id="juno-patient-info" class="juno-patient-info"></div>
                    
                    <h4>Available Data</h4>
                    <div class="juno-data-options">
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="juno-import-demographics" class="form-checkbox-large" checked>
                            <label for="juno-import-demographics">Demographics</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="juno-import-vitals" class="form-checkbox-large" checked>
                            <label for="juno-import-vitals">Vitals</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="juno-import-labs" class="form-checkbox-large" checked>
                            <label for="juno-import-labs">Lab Results</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="juno-import-conditions" class="form-checkbox-large" checked>
                            <label for="juno-import-conditions">Medical Conditions</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="juno-import-medications" class="form-checkbox-large" checked>
                            <label for="juno-import-medications">Medications</label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="juno-import-btn" class="button button-primary">Import Selected Data</button>
                    </div>
                </div>
                
                <div class="juno-export-section" id="juno-export-section" style="display: none;">
                    <h3>Export Results to Juno EMR</h3>
                    
                    <div class="form-group form-group-checkbox">
                        <input type="checkbox" id="juno-export-pdf" class="form-checkbox-large" checked>
                        <label for="juno-export-pdf">Attach PDF Report</label>
                    </div>
                    
                    <div class="form-group form-group-checkbox">
                        <input type="checkbox" id="juno-export-summary" class="form-checkbox-large" checked>
                        <label for="juno-export-summary">Add Summary to Progress Notes</label>
                    </div>
                    
                    <div class="form-group">
                        <label for="juno-export-note">Additional Note</label>
                        <textarea id="juno-export-note" class="form-textarea form-input-large" placeholder="Optional note to include with the results"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="juno-export-btn" class="button button-primary">Export to Juno EMR</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button button-secondary modal-close">Cancel</button>
            </div>
        </div>
    </div>        // Unit conversion configuration
        function setupUnitConversionHandlers() {
            // Define unit pairs for conversion
            const unitConversions = {
                // Cholesterol conversions (mmol/L <-> mg/dL)
                'total-chol': { factor: 38.67, types: ['frs', 'qrisk', 'med'] },
                'ldl': { factor: 38.67, types: ['frs', 'qrisk', 'med'] },
                'hdl': { factor: 38.67, types: ['frs', 'qrisk', 'med'] },
                'nonhdl': { factor: 38.67, types: ['frs', 'med'] },
                'trig': { factor: 88.57, types: ['frs', 'med'] },
                
                // Lp(a) conversions (mg/dL <-> nmol/L)
                'lpa': { factor: 2.5, reverse: 0.4, types: ['frs', 'qrisk', 'med'] },
                
                // ApoB conversions (g/L <-> mg/dL)
                'apob': { factor: 100, types: ['frs', 'med'] },
                
                // Height and weight conversions
                'height': { factor: 2.54, types: ['frs', 'qrisk'] },  // in to cm
                'weight': { factor: 0.453592, types: ['frs', 'qrisk'] }  // lb to kg
            };
            
            // Set up change handlers for all unit dropdowns
            Object.keys(unitConversions).forEach(baseId => {
                const conversion = unitConversions[baseId];
                
                conversion.types.forEach(type => {
                    const unitSelectId = `${type}-${baseId}-unit`;
                    const valueInputId = `${type}-${baseId}`;
                    
                    const unitSelect = document.getElementById(unitSelectId);
                    const valueInput = document.getElementById(valueInputId);
                    
                    if (unitSelect && valueInput) {
                        unitSelect.addEventListener('change', function() {
                            // Get current value
                            const currentValue = parseFloat(valueInput.value);
                            if (isNaN(currentValue)) return;
                            
                            // Get current and new units
                            const previousUnit = this.dataset.previousUnit || this.options[0].value;
                            const newUnit = this.value;
                            
                            // Skip if units are the same
                            if (previousUnit === newUnit) return;
                            
                            // Calculate new value based on conversion
                            let newValue;
                            
                            if (baseId === 'lpa') {
                                // Special case for Lp(a) with different factors in each direction
                                if (previousUnit === 'mg/dL' && newUnit === 'nmol/L') {
                                    newValue = currentValue * conversion.factor;
                                } else if (previousUnit === 'nmol/L' && newUnit === 'mg/dL') {
                                    newValue = currentValue * conversion.reverse;
                                }
                            } else if (baseId === 'height') {
                                // Height conversion
                                if (previousUnit === 'in' && newUnit === 'cm') {
                                    newValue = currentValue * conversion.factor;
                                } else if (previousUnit === 'cm' && newUnit === 'in') {
                                    newValue = currentValue / conversion.factor;
                                }
                            } else if (baseId === 'weight') {
                                // Weight conversion
                                if (previousUnit === 'lb' && newUnit === 'kg') {
                                    newValue = currentValue * conversion.factor;
                                } else if (previousUnit === 'kg' && newUnit === 'lb') {
                                    newValue = currentValue / conversion.factor;
                                }
                            } else {
                                // General conversions (cholesterol, etc.)
                                if (previousUnit === 'mmol/L' && newUnit === 'mg/dL') {
                                    newValue = currentValue * conversion.factor;
                                } else if (previousUnit === 'g/L' && newUnit === 'mg/dL') {
                                    newValue = currentValue * conversion.factor;
                                } else if (previousUnit === 'mg/dL' && newUnit === 'mmol/L') {
                                    newValue = currentValue / conversion.factor;
                                } else if (previousUnit === 'mg/dL' && newUnit === 'g/L') {
                                    newValue = currentValue / conversion.factor;
                                }
                            }
                            
                            // Update input value with appropriate precision
                            if (!isNaN(newValue)) {
                                if (baseId === 'apob') {
                                    valueInput.value = newValue.toFixed(2);
                                } else if (baseId === 'height' || baseId === 'weight') {
                                    valueInput.value = newValue.toFixed(1);
                                } else {
                                    valueInput.value = newValue.toFixed(1);
                                }
                            }
                            
                            // Store current unit for next conversion
                            this.dataset.previousUnit = newUnit;
                            
                            // Trigger change event to update dependent fields (like BMI)
                            valueInput.dispatchEvent(new Event('change'));
                        });
                        
                        // Initialize previous unit
                        unitSelect.dataset.previousUnit = unitSelect.value;
                    }
                });
            });
        }
        
        // Touch event handling for mobile devices
        function setupTouchEvents() {
            // Check if we're on a touch device
            if (!('ontouchstart' in window)) return;
            
            // Apply touch-specific enhancements
            document.body.classList.add('touch-device');
            
            // Make tabs more responsive on touch devices
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                // Add larger touch target area
                tab.classList.add('touch-target');
                
                // Add active state for touch feedback
                tab.addEventListener('touchstart', function() {
                    this.classList.add('touch-active');
                });
                
                tab.addEventListener('touchend', function() {
                    this.classList.remove('touch-active');
                });
                
                tab.addEventListener('touchcancel', function() {
                    this.classList.remove('touch-active');
                });
            });
            
            // Improve scrolling on touch devices
            const scrollableAreas = document.querySelectorAll('.form-textarea, .results-container, .modal-body');
            scrollableAreas.forEach(area => {
                area.style.webkitOverflowScrolling = 'touch';
            });
            
            // Add swipe gesture for tab navigation on mobile
            const tabContainer = document.querySelector('.tabs');
            if (tabContainer) {
                let startX, startY;
                let distX, distY;
                const threshold = 100; // Minimum distance for swipe
                
                tabContainer.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });
                
                tabContainer.addEventListener('touchmove', function(e) {
                    if (!startX || !startY) return;
                    
                    distX = e.touches[0].clientX - startX;
                    distY = e.touches[0].clientY - startY;
                    
                    // If vertical scrolling is dominant, don't handle as swipe
                    if (Math.abs(distY) > Math.abs(distX)) return;
                    
                    // Prevent page scrolling if horizontal swipe seems intentional
                    if (Math.abs(distX) > 10 && Math.abs(distY) < 10) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                tabContainer.addEventListener('touchend', function(e) {
                    if (!startX || !startY) return;
                    
                    // Check if it's a horizontal swipe
                    if (Math.abs(distX) >= threshold && Math.abs(distY) < 100) {
                        const activeTab = document.querySelector('.tab.active');
                        if (activeTab) {
                            const tabs = Array.from(document.querySelectorAll('.tab'));
                            const currentIndex = tabs.indexOf(activeTab);
                            
                            // Right to left swipe (next tab)
                            if (distX < 0 && currentIndex < tabs.length - 1) {
                                tabs[currentIndex + 1].click();
                            }
                            // Left to right swipe (previous tab)
                            else if (distX > 0 && currentIndex > 0) {
                                tabs[currentIndex - 1].click();
                            }
                        }
                    }
                    
                    // Reset values
                    startX = null;
                    startY = null;
                    distX = null;
                    distY = null;
                }, { passive: true });
            }
        }        // The following function is included to implement CCS guideline recommendations
        function getCCSRecommendation(risk, ldl, hasDiabetes, age) {
            // Implementation based on 2021 Canadian Cardiovascular Society Guidelines
            let recommendation = '<div class="ccs-recommendation">';
            
            // Primary prevention
            if (hasDiabetes) {
                // Diabetes-specific recommendations
                recommendation += '<div class="recommendation-strength">Strong Recommendation</div>';
                recommendation += '<div class="evidence-level">High-Quality Evidence</div>';
                
                if (age >= 40) {
                    recommendation += '<p>For individuals with diabetes mellitus who are ≥40 years of age, statin therapy should be used to reduce CVD events.</p>';
                    
                    if (ldl >= 2.0) { // LDL ≥ 2.0 mmol/L (77 mg/dL)
                        recommendation += '<p>Consider moderate to high-intensity statin therapy to achieve ≥50% reduction in LDL-C.</p>';
                    } else {
                        recommendation += '<p>Consider moderate-intensity statin therapy.</p>';
                    }
                } else {
                    recommendation += '<p>For individuals with diabetes mellitus who are <40 years of age, statin therapy should be considered in the presence of microvascular complications or duration of diabetes >15 years.</p>';
                }
            } else if (risk >= 20) {
                // High risk (≥20%)
                recommendation += '<div class="recommendation-strength">Strong Recommendation</div>';
                recommendation += '<div class="evidence-level">High-Quality Evidence</div>';
                recommendation += '<p>For individuals at high risk (FRS ≥20%), statins are recommended to reduce CVD events.</p>';
                
                if (ldl !== null && ldl !== undefined) {
                    if (ldl >= 1.8) { // LDL ≥ 1.8 mmol/L (70 mg/dL)
                        recommendation += '<p>Consider high-intensity statin therapy to achieve ≥50% reduction in LDL-C with a target of LDL-C <1.8 mmol/L.</p>';
                    } else {
                        recommendation += '<p>Consider continuing current therapy as the target LDL-C of <1.8 mmol/L has been achieved.</p>';
                    }
                } else {
                    recommendation += '<p>Consider high-intensity statin therapy to achieve ≥50% reduction in LDL-C with a target of LDL-C <1.8 mmol/L.</p>';
                }
            } else if (risk >= 10) {
                // Intermediate risk (10-19%)
                recommendation += '<div class="recommendation-strength">Strong Recommendation</div>';
                recommendation += '<div class="evidence-level">High-Quality Evidence</div>';
                recommendation += '<p>For individuals at intermediate risk (FRS 10-19%), statins are recommended to reduce CVD events.</p>';
                
                if (ldl !== null && ldl !== undefined) {
                    if (ldl >= 2.0) { // LDL ≥ 2.0 mmol/L (77 mg/dL)
                        recommendation += '<p>Consider moderate to high-intensity statin therapy to achieve ≥30% reduction in LDL-C with a target of LDL-C <2.0 mmol/L.</p>';
                    } else {
                        recommendation += '<p>Consider continuing current therapy as the target LDL-C of <2.0 mmol/L has been achieved.</p>';
                    }
                } else {
                    recommendation += '<p>Consider moderate to high-intensity statin therapy to achieve ≥30% reduction in LDL-C with a target of LDL-C <2.0 mmol/L.</p>';
                }
            } else {
                // Low risk (<10%)
                recommendation += '<div class="recommendation-strength">Conditional Recommendation</div>';
                recommendation += '<div class="evidence-level">Moderate-Quality Evidence</div>';
                
                if (ldl !== null && ldl !== undefined && ldl >= 5.0) { // LDL ≥ 5.0 mmol/L (193 mg/dL)
                    recommendation += '<p>For individuals with LDL-C ≥5.0 mmol/L, statin therapy should be considered to reduce CVD events.</p>';
                    recommendation += '<p>Consider moderate-intensity statin therapy to achieve ≥30% reduction in LDL-C.</p>';
                } else {
                    recommendation += '<p>For individuals with low risk (FRS <10%) and without severely elevated LDL-C, pharmacologic lipid-lowering therapy is not routinely recommended.</p>';
                    recommendation += '<p>Focus on healthy lifestyle behaviors that increase physical activity and dietary patterns low in saturated fats.</p>';
                }
            }
            
            // Lp(a) considerations
            recommendation += '<p><strong>Lp(a) Considerations:</strong> Elevated Lp(a) (≥50 mg/dL or ≥125 nmol/L) should be considered a risk-enhancing factor that may favor initiation or intensification of statin therapy, particularly for those with borderline risk decision points.</p>';
            
            recommendation += '</div>';
            
            return recommendation;
        }    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.7.1/chart.min.js" 
            integrity="sha512-QSkVNOCYLtj73J4hbmVoOV6KVZuMluZlioC+trLpewV8qMjsWqlIQvkn1KGX2StWvPMdWGBqim1xlC8krl1EKQ==" 
            crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" 
            crossorigin="anonymous" defer></script>
</body>
</html>                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-ezetimibe" name="med-ezetimibe" class="form-checkbox-large">
                                            <label for="med-ezetimibe">Ezetimibe (Zetia/Ezetrol)</label>
                                        </div>
                                        <div class="form-group med-duration-field" id="med-ezetimibe-duration-container" style="display: none;">
                                            <label for="med-ezetimibe-duration">Duration on Ezetimibe</label>
                                            <select id="med-ezetimibe-duration" name="med-ezetimibe-duration" class="form-select form-input-large">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value="6-12">6-12 months</option>
                                                <option value=">12">More than 12 months</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-pcsk9" name="med-pcsk9" class="form-checkbox-large">
                                            <label for="med-pcsk9">PCSK9 Inhibitor (Repatha/Praluent)</label>
                                        </div>
                                        <div class="form-group med-duration-field" id="med-pcsk9-duration-container" style="display: none;">
                                            <label for="med-pcsk9-duration">Duration on PCSK9 Inhibitor</label>
                                            <select id="med-pcsk9-duration" name="med-pcsk9-duration" class="form-select form-input-large">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value="6-12">6-12 months</option>
                                                <option value=">12">More than 12 months</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-bempedoic" name="med-bempedoic" class="form-checkbox-large">
                                            <label for="med-bempedoic">Bempedoic Acid (Nexletol/Nilemdo)</label>
                                        </div>
                                        <div class="form-group med-duration-field" id="med-bempedoic-duration-container" style="display: none;">
                                            <label for="med-bempedoic-duration">Duration on Bempedoic Acid</label>
                                            <select id="med-bempedoic-duration" name="med-bempedoic-duration" class="form-select form-input-large">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value="6-12">6-12 months</option>
                                                <option value=">12">More than 12 months</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-fibrate" name="med-fibrate" class="form-checkbox-large">
                                            <label for="med-fibrate">Fibrate (Fenofibrate/Gemfibrozil)</label>
                                        </div>
                                        <div class="form-group med-duration-field" id="med-fibrate-duration-container" style="display: none;">
                                            <label for="med-fibrate-duration">Duration on Fibrate</label>
                                            <select id="med-fibrate-duration" name="med-fibrate-duration" class="form-select form-input-large">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value="6-12">6-12 months</option>
                                                <option value=">12">More than 12 months</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-niacin" name="med-niacin" class="form-checkbox-large">
                                            <label for="med-niacin">Niacin</label>
                                        </div>
                                        <div class="form-group med-duration-field" id="med-niacin-duration-container" style="display: none;">
                                            <label for="med-niacin-duration">Duration on Niacin</label>
                                            <select id="med-niacin-duration" name="med-niacin-duration" class="form-select form-input-large">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value="6-12">6-12 months</option>
                                                <option value=">12">More than 12 months</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-omega3" name="med-omega3" class="form-checkbox-large">
                                            <label for="med-omega3">Omega-3 Fatty Acids</label>
                                        </div>
                                        <div class="form-group med-duration-field" id="med-omega3-duration-container" style="display: none;">
                                            <label for="med-omega3-duration">Duration on Omega-3</label>
                                            <select id="med-omega3-duration" name="med-omega3-duration" class="form-select form-input-large">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value="6-12">6-12 months</option>
                                                <option value=">12">More than 12 months</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-therapy-duration">Duration on Current Therapy</label>
                                            <select id="med-therapy-duration" name="med-therapy-duration" class="form-select form-input-large">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value=">6">More than 6 months</option>
                                            </select>
                                            <div class="error-message" id="med-therapy-duration-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-max-therapy-duration">Duration on Maximum Therapy</label>
                                            <select id="med-max-therapy-duration" name="med-max-therapy-duration" class="form-select form-input-large">
                                                <option value="NA" selected>Not applicable</option>
                                                <option value="<1">Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value=">6">More than 6 months</option>
                                            </select>
                                            <div class="error-message" id="med-max-therapy-duration-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-additional-conditions">Medical Conditions</label>
                                            <div id="med-conditions-container" class="medical-conditions-container">
                                                <div class="condition-row">
                                                    <input type="text" class="form-input form-input-large condition-name" 
                                                           placeholder="Enter condition name" id="med-condition-1" name="med-condition-1">
                                                    <select class="form-select form-input-large condition-duration" 
                                                            id="med-condition-duration-1" name="med-condition-duration-1">
                                                        <option value="" selected disabled>Duration</option>
                                                        <option value="<1">Less than 1 month</option>
                                                        <option value="1-6">1-6 months</option>
                                                        <option value="6-12">6-12 months</option>
                                                        <option value="1-5">1-5 years</option>
                                                        <option value=">5">More than 5 years</option>
                                                    </select>
                                                </div>
                                                <div class="condition-row">
                                                    <input type="text" class="form-input form-input-large condition-name" 
                                                           placeholder="Enter condition name" id="med-condition-2" name="med-condition-2">
                                                    <select class="form-select form-input-large condition-duration" 
                                                            id="med-condition-duration-2" name="med-condition-duration-2">
                                                        <option value="" selected disabled>Duration</option>
                                                        <option value="<1">Less than 1 month</option>
                                                        <option value="1-6">1-6 months</option>
                                                        <option value="6-12">6-12 months</option>
                                                        <option value="1-5">1-5 years</option>
                                                        <option value=">5">More than 5 years</option>
                                                    </select>
                                                </div>
                                                <div class="condition-row">
                                                    <input type="text" class="form-input form-input-large condition-name" 
                                                           placeholder="Enter condition name" id="med-condition-3" name="med-condition-3">
                                                    <select class="form-select form-input-large condition-duration" 
                                                            id="med-condition-duration-3" name="med-condition-duration-3">
                                                        <option value="" selected disabled>Duration</option>
                                                        <option value="<1">Less than 1 month</option>
                                                        <option value="1-6">1-6 months</option>
                                                        <option value="6-12">6-12 months</option>
                                                        <option value="1-5">1-5 years</option>
                                                        <option value=">5">More than 5 years</option>
                                                    </select>
                                                </div>
                                                <div class="condition-row">
                                                    <input type="text" class="form-input form-input-large condition-name" 
                                                           placeholder="Enter condition name" id="med-condition-4" name="med-condition-4">
                                                    <select class="form-select form-input-large condition-duration" 
                                                            id="med-condition-duration-4" name="med-condition-duration-4">
                                                        <option value="" selected disabled>Duration</option>
                                                        <option value="<1">Less than 1 month</option>
                                                        <option value="1-6">1-6 months</option>
                                                        <option value="6-12">6-12 months</option>
                                                        <option value="1-5">1-5 years</option>
                                                        <option value=">5">More than 5 years</option>
                                                    </select>
                                                </div>
                                                <div class="condition-row">
                                                    <input type="text" class="form-input form-input-large condition-name" 
                                                           placeholder="Enter condition name" id="med-condition-5" name="med-condition-5">
                                                    <select class="form-select form-input-large condition-duration" 
                                                            id="med-condition-duration-5" name="med-condition-duration-5">
                                                        <option value="" selected disabled>Duration</option>
                                                        <option value="<1">Less than 1 month</option>
                                                        <option value="1-6">1-6 months</option>
                                                        <option value="6-12">6-12 months</option>
                                                        <option value="1-5">1-5 years</option>
                                                        <option value=">5">More than 5 years</option>
                                                    </select>
                                                </div>
                                                <div class="condition-row">
                                                    <input type="text" class="form-input form-input-large condition-name" 
                                                           placeholder="Enter condition name" id="med-condition-6" name="med-condition-6">
                                                    <select class="form-select form-input-large condition-duration" 
                                                            id="med-condition-duration-6" name="med-condition-duration-6">
                                                        <option value="" selected disabled>Duration</option>
                                                        <option value="<1">Less than 1 month</option>
                                                        <option value="1-6">1-6 months</option>
                                                        <option value="6-12">6-12 months</option>
                                                        <option value="1-5">1-5 years</option>
                                                        <option value=">5">More than 5 years</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-additional-medications">Additional Medications</label>
                                            <textarea id="med-additional-medications" name="med-additional-medications" 
                                                    class="form-textarea form-input-large" rows="4" placeholder="Enter other medications"></textarea>
                                        </div>
                                    </div>                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-bmi">BMI (kg/m²)</label>
                                            <input type="number" id="qrisk-bmi" name="qrisk-bmi" min="15" max="50" 
                                                   placeholder="Calculated" step="0.1" class="form-input form-input-large" readonly
                                                   data-validation="physiological" data-param-type="bmi">
                                            <div class="error-message" id="qrisk-bmi-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-ethnicity">Ethnicity</label>
                                            <select id="qrisk-ethnicity" name="qrisk-ethnicity" required class="form-select form-input-large">
                                                <option value="" selected disabled>Select ethnicity</option>
                                                <option value="white">White</option>
                                                <option value="indian">Indian</option>
                                                <option value="pakistani">Pakistani</option>
                                                <option value="bangladeshi">Bangladeshi</option>
                                                <option value="other_asian">Other Asian</option>
                                                <option value="black_caribbean">Black Caribbean</option>
                                                <option value="black_african">Black African</option>
                                                <option value="chinese">Chinese</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <div class="error-message" id="qrisk-ethnicity-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-smoker">Smoking Status</label>
                                            <select id="qrisk-smoker" name="qrisk-smoker" required class="form-select form-input-large">
                                                <option value="" selected disabled>Select status</option>
                                                <option value="non">Non-smoker</option>
                                                <option value="ex">Ex-smoker</option>
                                                <option value="light">Light smoker (less than 10)</option>
                                                <option value="moderate">Moderate smoker (10-19)</option>
                                                <option value="heavy">Heavy smoker (20+)</option>
                                            </select>
                                            <div class="error-message" id="qrisk-smoker-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-townsend">Townsend Deprivation Score</label>
                                            <input type="number" id="qrisk-townsend" name="qrisk-townsend" min="-7" max="12" 
                                                   placeholder="Enter score (optional)" step="0.1" class="form-input form-input-large">
                                            <div class="form-help">Enter if known. UK measure of socioeconomic deprivation.</div>
                                            <div class="error-message" id="qrisk-townsend-validation"></div>
                                        </div>
                                    </div><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Cardiovascular Disease Risk Assessment Tool with Lp(a) Post-Test Modifier">
    <meta name="author" content="CVD Risk Assessment Team">
    <meta name="version" content="2.0.0">
    
    <!-- Enhanced Security headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' https://api.junoemr.com; worker-src 'self' blob:; manifest-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), interest-cohort=()">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <title>Enhanced CVD Risk Toolkit</title>
    
    <!-- PWA support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a5f">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
    
    <!-- Resource hints for performance -->
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="combined.js" as="script">
    
    <!-- Critical CSS inline for faster rendering -->
    <style>
        /* Critical CSS for initial loading */
        :root {
            --primary-color: #1e3a5f;
            --secondary-color: #4a7aad;
            --accent-color: #e74c3c;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-muted: #6c757d;
            --border-color: #e5e7eb;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            
            --low-risk-color: #28a745;
            --moderate-risk-color: #ffc107;
            --high-risk-color: #dc3545;
            --extreme-risk-color: #990000;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
                Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-mono: 'JetBrains Mono', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 0.75rem;
            --spacing-4: 1rem;
            --spacing-6: 1.5rem;
            --spacing-8: 2rem;
            
            --border-radius: 0.375rem;
            --transition-speed: 0.2s;
        }
        
        body {
            margin: 0;
            font-family: var(--font-sans);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-4);
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
    
    <!-- Full CSS with non-blocking loading -->
    <link rel="stylesheet" href="styles.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="styles.css"></noscript>
    
    <!-- Font Loading -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"></noscript>
</head>

<body>
    <!-- Accessibility: Skip to content link -->
    <a href="#main-content" class="skip-link">Skip to content</a>
    
    <!-- Initial loading overlay -->
    <div class="loading-overlay" id="initial-loading">
        <div class="loading-spinner" aria-hidden="true"></div>
        <p class="loading-text">Loading CVD Risk Toolkit...</p>
    </div>
    
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="icons/logo.svg" alt="CVD Risk Toolkit Logo" class="logo" width="48" height="48">
                    <h1 class="site-title">Enhanced CVD Risk Toolkit</h1>
                </div>
                <div class="header-actions">
                    <button id="help-button" class="icon-button" aria-label="Help">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </button>
                    <button id="theme-toggle" class="icon-button" aria-label="Toggle Dark Mode">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <main id="main-content" class="main">
        <div class="container">
            <!-- Disclaimer Alert -->
            <div class="alert alert-warning" id="disclaimer-alert">
                <p><strong>Medical Disclaimer:</strong> This tool is intended for healthcare professionals only. Always use clinical judgment when interpreting results.</p>
                <button class="alert-close" aria-label="Close disclaimer">×</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-container">
                <div class="tabs" role="tablist">
                    <button id="tab-frs" class="tab active" role="tab" aria-selected="true" aria-controls="panel-frs">
                        <span>Framingham Risk Score</span>
                    </button>
                    <button id="tab-qrisk" class="tab" role="tab" aria-selected="false" aria-controls="panel-qrisk">
                        <span>QRISK3</span>
                    </button>
                    <button id="tab-medication" class="tab" role="tab" aria-selected="false" aria-controls="panel-medication">
                        <span>Medication Evaluation</span>
                    </button>
                    <button id="tab-comparison" class="tab" role="tab" aria-selected="false" aria-controls="panel-comparison">
                        <span>Compare Calculators</span>
                    </button>
                </div>
                
                <!-- Tab Panels -->
                <div class="tab-content">
                    <!-- Framingham Risk Score Panel -->
                    <div id="panel-frs" class="tab-panel active" role="tabpanel" aria-labelledby="tab-frs">
                        <form id="frs-form" class="risk-form" novalidate>
                            <div class="card">
                                <div class="card-header">
                                    <h2>Demographics</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-age">Age (years)</label>
                                            <input type="number" id="frs-age" name="frs-age" min="30" max="79" 
                                                   placeholder="Enter age" required class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="age">
                                            <div class="error-message" id="frs-age-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-sex">Sex</label>
                                            <select id="frs-sex" name="frs-sex" required class="form-select form-input-large">
                                                <option value="" selected disabled>Select sex</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                            <div class="error-message" id="frs-sex-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-height">Height</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-height" name="frs-height" min="120" max="220" 
                                                       placeholder="Enter height" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="height">
                                                <select id="frs-height-unit" name="frs-height-unit" class="input-group-addon form-input-large">
                                                    <option value="cm">cm</option>
                                                    <option value="in">in</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-height-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-weight">Weight</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-weight" name="frs-weight" min="30" max="200" 
                                                       placeholder="Enter weight" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="weight">
                                                <select id="frs-weight-unit" name="frs-weight-unit" class="input-group-addon form-input-large">
                                                    <option value="kg">kg</option>
                                                    <option value="lb">lb</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-weight-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-bmi">BMI (kg/m²)</label>
                                            <input type="number" id="frs-bmi" name="frs-bmi" min="15" max="50" 
                                                   placeholder="Calculated" step="0.1" class="form-input form-input-large" readonly
                                                   data-validation="physiological" data-param-type="bmi">
                                            <div class="error-message" id="frs-bmi-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-smoker">Smoking Status</label>
                                            <select id="frs-smoker" name="frs-smoker" required class="form-select form-input-large">
                                                <option value="" selected disabled>Select status</option>
                                                <option value="no">Non-smoker</option>
                                                <option value="yes">Current smoker</option>
                                            </select>
                                            <div class="error-message" id="frs-smoker-validation"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Medical Conditions</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-diabetes">Diabetes</label>
                                            <select id="frs-diabetes" name="frs-diabetes" required class="form-select form-input-large">
                                                <option value="no" selected>No</option>
                                                <option value="yes">Yes</option>
                                            </select>
                                            <div class="error-message" id="frs-diabetes-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-bp-treatment">Treated Hypertension</label>
                                            <select id="frs-bp-treatment" name="frs-bp-treatment" required class="form-select form-input-large">
                                                <option value="no" selected>No</option>
                                                <option value="yes">Yes</option>
                                            </select>
                                            <div class="error-message" id="frs-bp-treatment-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-ha1c">Hemoglobin A1c (%)</label>
                                            <input type="number" id="frs-ha1c" name="frs-ha1c" min="4" max="15" 
                                                   placeholder="Enter HbA1c" step="0.1" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="hba1c">
                                            <div class="error-message" id="frs-ha1c-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-medical-conditions">Past Medical Conditions</label>
                                            <select id="frs-medical-conditions" name="frs-medical-conditions" multiple class="form-select form-input-large" size="3">
                                                <option value="hypertension">Hypertension</option>
                                                <option value="prev_mi">Previous MI</option>
                                                <option value="stroke">Stroke</option>
                                                <option value="heart_failure">Heart Failure</option>
                                                <option value="pvd">Peripheral Vascular Disease</option>
                                                <option value="ckd">Chronic Kidney Disease</option>
                                                <option value="afib">Atrial Fibrillation</option>
                                                <option value="ra">Rheumatoid Arthritis</option>
                                            </select>
                                            <div class="form-help">Hold Ctrl/Cmd to select multiple conditions</div>
                                            <div class="error-message" id="frs-medical-conditions-validation"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Measurements</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-sbp">Systolic Blood Pressure (mmHg)</label>
                                            <input type="number" id="frs-sbp" name="frs-sbp" min="90" max="200" 
                                                   placeholder="Enter SBP" required class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="frs-sbp-validation"></div>
                                        </div>
                                        <div class="form-group form-group-toggle">
                                            <label for="frs-multiple-sbp">Multiple SBP Readings?</label>
                                            <label class="toggle">
                                                <input type="checkbox" id="frs-multiple-sbp" name="frs-multiple-sbp">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="frs-sbp-readings" class="form-row" style="display: none;">
                                        <div class="form-group">
                                            <label for="frs-sbp-1">SBP Reading 1 (mmHg)</label>
                                            <input type="number" id="frs-sbp-1" name="frs-sbp-1" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="frs-sbp-1-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-sbp-2">SBP Reading 2 (mmHg)</label>
                                            <input type="number" id="frs-sbp-2" name="frs-sbp-2" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="frs-sbp-2-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="frs-sbp-readings-extra" class="form-row" style="display: none;">
                                        <div class="form-group">
                                            <label for="frs-sbp-3">SBP Reading 3 (mmHg)</label>
                                            <input type="number" id="frs-sbp-3" name="frs-sbp-3" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="frs-sbp-3-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-sbp-4">SBP Reading 4 (mmHg)</label>
                                            <input type="number" id="frs-sbp-4" name="frs-sbp-4" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="frs-sbp-4-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="frs-sbp-readings-extra2" class="form-row" style="display: none;">
                                        <div class="form-group">
                                            <label for="frs-sbp-5">SBP Reading 5 (mmHg)</label>
                                            <input type="number" id="frs-sbp-5" name="frs-sbp-5" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="frs-sbp-5-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-sbp-6">SBP Reading 6 (mmHg)</label>
                                            <input type="number" id="frs-sbp-6" name="frs-sbp-6" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="frs-sbp-6-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="frs-sbp-sd-container" class="form-row" style="display: none;">
                                        <div class="form-group">
                                            <label for="frs-sbp-sd">Standard Deviation of SBP (mmHg)</label>
                                            <input type="number" id="frs-sbp-sd" name="frs-sbp-sd" min="0" max="30" 
                                                   placeholder="Calculated automatically" class="form-input form-input-large" readonly
                                                   data-validation="physiological" data-param-type="sbpSd">
                                            <div class="form-help">Calculated automatically from multiple readings</div>
                                            <div class="error-message" id="frs-sbp-sd-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-total-chol">Total Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-total-chol" name="frs-total-chol" min="1" max="15" 
                                                       placeholder="Enter value" required step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="totalCholesterol">
                                                <select id="frs-total-chol-unit" name="frs-total-chol-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-total-chol-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-hdl">HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-hdl" name="frs-hdl" min="0.4" max="4" 
                                                       placeholder="Enter value" required step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="hdl">
                                                <select id="frs-hdl-unit" name="frs-hdl-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-hdl-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-ldl">LDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-ldl" name="frs-ldl" min="0.5" max="10" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="ldl">
                                                <select id="frs-ldl-unit" name="frs-ldl-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-ldl-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-trig">Triglycerides</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-trig" name="frs-trig" min="0.2" max="10" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="triglycerides">
                                                <select id="frs-trig-unit" name="frs-trig-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-trig-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-nonhdl">Non-HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-nonhdl" name="frs-nonhdl" min="0.5" max="12" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="nonHdl">
                                                <select id="frs-nonhdl-unit" name="frs-nonhdl-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-nonhdl-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="frs-apob">Apolipoprotein B</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-apob" name="frs-apob" min="0.2" max="2.5" 
                                                       placeholder="Enter value" step="0.01" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="apob">
                                                <select id="frs-apob-unit" name="frs-apob-unit" class="input-group-addon form-input-large">
                                                    <option value="g/L">g/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-apob-validation"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Lp(a) Measurement (Optional)</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-lpa">Lipoprotein(a)</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-lpa" name="frs-lpa" min="0" max="500" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="lpa">
                                                <select id="frs-lpa-unit" name="frs-lpa-unit" class="input-group-addon form-input-large">
                                                    <option value="mg/dL">mg/dL</option>
                                                    <option value="nmol/L">nmol/L</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="frs-lpa-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <div class="info-box">
                                                <p>Elevated Lp(a) is an independent risk factor for CVD. Values ≥50 mg/dL (≥125 nmol/L) are considered elevated and may warrant more aggressive risk factor modification.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="reset" class="button button-secondary">Reset Form</button>
                                <button type="submit" class="button button-primary">Calculate Risk</button>
                            </div>
                        </form>
                        
                        <div id="frs-results-container" class="results-container" style="display: none;">
                            <div class="results-date">Calculated on <span>Date</span></div>
                            <div id="frs-results" class="results"></div>
                            <div class="results-actions">
                                <button id="frs-copy-to-qrisk" class="button button-secondary">Copy to QRISK3</button>
                                <button id="frs-copy-to-medication" class="button button-secondary">Copy to Medication</button>
                                <button id="frs-print-results" class="button button-primary">Print Results</button>
                                <button id="frs-export-pdf" class="button button-primary">Export PDF</button>
                                <button id="frs-export-csv" class="button button-secondary">Export CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QRISK3 Panel -->
                    <div id="panel-qrisk" class="tab-panel" role="tabpanel" aria-labelledby="tab-qrisk">
                        <form id="qrisk-form" class="risk-form" novalidate>
                            <div class="card">
                                <div class="card-header">
                                    <h2>Demographics</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-age">Age (years)</label>
                                            <input type="number" id="qrisk-age" name="qrisk-age" min="25" max="84" 
                                                   placeholder="Enter age" required class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="age">
                                            <div class="error-message" id="qrisk-age-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-sex">Sex</label>
                                            <select id="qrisk-sex" name="qrisk-sex" required class="form-select form-input-large">
                                                <option value="" selected disabled>Select sex</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                            <div class="error-message" id="qrisk-sex-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-height">Height</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-height" name="qrisk-height" min="120" max="220" 
                                                       placeholder="Enter height" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="height">
                                                <select id="qrisk-height-unit" name="qrisk-height-unit" class="input-group-addon form-input-large">
                                                    <option value="cm">cm</option>
                                                    <option value="in">in</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="qrisk-height-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-weight">Weight</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-weight" name="qrisk-weight" min="30" max="200" 
                                                       placeholder="Enter weight" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="weight">
                                                <select id="qrisk-weight-unit" name="qrisk-weight-unit" class="input-group-addon form-input-large">
                                                    <option value="kg">kg</option>
                                                    <option value="lb">lb</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="qrisk-weight-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-bmi">BMI (kg/m²)</label>
                                            <input type="number" id="qrisk-bmi" name="qrisk-bmi" min="15" max="50" 
                                                   placeholder="Calculated" step="0.1" class="form-input" readonly
                                                   data-validation="physiological" data-param-type="bmi">
                                            <div class="error-message" id="qrisk-bmi-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-ethnicity">Ethnicity</label>
                                            <select id="qrisk-ethnicity" name="qrisk-ethnicity" required class="form-select">
                                                <option value="" selected disabled>Select ethnicity</option>
                                                <option value="white">White</option>
                                                <option value="indian">Indian</option>
                                                <option value="pakistani">Pakistani</option>
                                                <option value="bangladeshi">Bangladeshi</option>
                                                <option value="other_asian">Other Asian</option>
                                                <option value="black_caribbean">Black Caribbean</option>
                                                <option value="black_african">Black African</option>
                                                <option value="chinese">Chinese</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <div class="error-message" id="qrisk-ethnicity-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-smoker">Smoking Status</label>
                                            <select id="qrisk-smoker" name="qrisk-smoker" required class="form-select">
                                                <option value="" selected disabled>Select status</option>
                                                <option value="non">Non-smoker</option>
                                                <option value="ex">Ex-smoker</option>
                                                <option value="light">Light smoker (less than 10)</option>
                                                <option value="moderate">Moderate smoker (10-19)</option>
                                                <option value="heavy">Heavy smoker (20+)</option>
                                            </select>
                                            <div class="error-message" id="qrisk-smoker-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-townsend">Townsend Deprivation Score</label>
                                            <input type="number" id="qrisk-townsend" name="qrisk-townsend" min="-7" max="12" 
                                                   placeholder="Enter score (optional)" step="0.1" class="form-input">
                                            <div class="form-help">Enter if known. UK measure of socioeconomic deprivation.</div>
                                            <div class="error-message" id="qrisk-townsend-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-family-history" name="qrisk-family-history" class="form-checkbox-large">
                                            <label for="qrisk-family-history">Family history of coronary heart disease in first degree relative under 60 years</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Medical Conditions</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-diabetes">Diabetes</label>
                                            <select id="qrisk-diabetes" name="qrisk-diabetes" required class="form-select form-input-large">
                                                <option value="none" selected>None</option>
                                                <option value="type1">Type 1</option>
                                                <option value="type2">Type 2</option>
                                            </select>
                                            <div class="error-message" id="qrisk-diabetes-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-bp-treatment">Treated for Hypertension</label>
                                            <select id="qrisk-bp-treatment" name="qrisk-bp-treatment" required class="form-select form-input-large">
                                                <option value="no" selected>No</option>
                                                <option value="yes">Yes</option>
                                            </select>
                                            <div class="error-message" id="qrisk-bp-treatment-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-atrial-fibrillation" name="qrisk-atrial-fibrillation" class="form-checkbox-large">
                                            <label for="qrisk-atrial-fibrillation">Atrial fibrillation</label>
                                        </div>
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-rheumatoid-arthritis" name="qrisk-rheumatoid-arthritis" class="form-checkbox-large">
                                            <label for="qrisk-rheumatoid-arthritis">Rheumatoid arthritis</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-renal-disease" name="qrisk-renal-disease" class="form-checkbox-large">
                                            <label for="qrisk-renal-disease">Chronic kidney disease (stage 3, 4, or 5)</label>
                                        </div>
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-migraine" name="qrisk-migraine" class="form-checkbox-large">
                                            <label for="qrisk-migraine">Migraine</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-steroid" name="qrisk-steroid" class="form-checkbox-large">
                                            <label for="qrisk-steroid">Regular steroid tablets/injections</label>
                                        </div>
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-mental-illness" name="qrisk-mental-illness" class="form-checkbox-large">
                                            <label for="qrisk-mental-illness">Severe mental illness</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-systemic-lupus" name="qrisk-systemic-lupus" class="form-checkbox-large">
                                            <label for="qrisk-systemic-lupus">Systemic lupus erythematosus (SLE)</label>
                                        </div>
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-atypical-antipsychotic" name="qrisk-atypical-antipsychotic" class="form-checkbox-large">
                                            <label for="qrisk-atypical-antipsychotic">Atypical antipsychotic medication</label>
                                        </div>
                                    </div>
                                    
                                    <div id="qrisk-male-only" class="form-row" style="display: none;">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="qrisk-erectile-dysfunction" name="qrisk-erectile-dysfunction" class="form-checkbox-large">
                                            <label for="qrisk-erectile-dysfunction">Erectile dysfunction or treatment</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-ha1c">Hemoglobin A1c (%)</label>
                                            <input type="number" id="qrisk-ha1c" name="qrisk-ha1c" min="4" max="15" 
                                                   placeholder="Enter HbA1c" step="0.1" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="hba1c">
                                            <div class="error-message" id="qrisk-ha1c-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-additional-conditions">Additional Medical Conditions</label>
                                            <textarea id="qrisk-additional-conditions" name="qrisk-additional-conditions" 
                                                      class="form-textarea form-input-large" rows="3" placeholder="Enter up to 6 additional conditions"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Measurements</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-sbp">Systolic Blood Pressure (mmHg)</label>
                                            <input type="number" id="qrisk-sbp" name="qrisk-sbp" min="90" max="200" 
                                                   placeholder="Enter SBP" required class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="qrisk-sbp-validation"></div>
                                        </div>
                                        <div class="form-group form-group-toggle">
                                            <label for="qrisk-multiple-sbp">Multiple SBP Readings?</label>
                                            <label class="toggle">
                                                <input type="checkbox" id="qrisk-multiple-sbp" name="qrisk-multiple-sbp">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="qrisk-sbp-readings" class="form-row" style="display: none;">
                                        <div class="form-group">
                                            <label for="qrisk-sbp-1">SBP Reading 1 (mmHg)</label>
                                            <input type="number" id="qrisk-sbp-1" name="qrisk-sbp-1" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="qrisk-sbp-1-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-sbp-2">SBP Reading 2 (mmHg)</label>
                                            <input type="number" id="qrisk-sbp-2" name="qrisk-sbp-2" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="qrisk-sbp-2-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="qrisk-sbp-readings-extra" class="form-row" style="display: none;">
                                        <div class="form-group">
                                            <label for="qrisk-sbp-3">SBP Reading 3 (mmHg)</label>
                                            <input type="number" id="qrisk-sbp-3" name="qrisk-sbp-3" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="qrisk-sbp-3-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-sbp-4">SBP Reading 4 (mmHg)</label>
                                            <input type="number" id="qrisk-sbp-4" name="qrisk-sbp-4" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="qrisk-sbp-4-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="qrisk-sbp-readings-extra2" class="form-row" style="display: none;">
                                        <div class="form-group">
                                            <label for="qrisk-sbp-5">SBP Reading 5 (mmHg)</label>
                                            <input type="number" id="qrisk-sbp-5" name="qrisk-sbp-5" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="qrisk-sbp-5-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-sbp-6">SBP Reading 6 (mmHg)</label>
                                            <input type="number" id="qrisk-sbp-6" name="qrisk-sbp-6" min="90" max="200" 
                                                   placeholder="Enter SBP" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="sbp">
                                            <div class="error-message" id="qrisk-sbp-6-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="qrisk-sbp-sd-container" class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-sbp-sd">Standard Deviation of SBP (mmHg)</label>
                                            <input type="number" id="qrisk-sbp-sd" name="qrisk-sbp-sd" min="0" max="30" 
                                                   placeholder="Calculated automatically" class="form-input form-input-large" 
                                                   data-validation="physiological" data-param-type="sbpSd">
                                            <div class="form-help">Calculated automatically if multiple readings provided</div>
                                            <div class="error-message" id="qrisk-sbp-sd-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-total-chol">Total Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-total-chol" name="qrisk-total-chol" min="1" max="15" 
                                                       placeholder="Enter value" required step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="totalCholesterol">
                                                <select id="qrisk-total-chol-unit" name="qrisk-total-chol-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="qrisk-total-chol-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="qrisk-hdl">HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-hdl" name="qrisk-hdl" min="0.4" max="4" 
                                                       placeholder="Enter value" required step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="hdl">
                                                <select id="qrisk-hdl-unit" name="qrisk-hdl-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="qrisk-hdl-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-chol-ratio">Total Chol:HDL Ratio</label>
                                            <input type="number" id="qrisk-chol-ratio" name="qrisk-chol-ratio" min="1" max="12" 
                                                   placeholder="Calculated" step="0.1" class="form-input form-input-large" readonly>
                                            <div class="error-message" id="qrisk-chol-ratio-validation"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Lp(a) Measurement (Optional)</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-lpa">Lipoprotein(a)</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-lpa" name="qrisk-lpa" min="0" max="500" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="lpa">
                                                <select id="qrisk-lpa-unit" name="qrisk-lpa-unit" class="input-group-addon form-input-large">
                                                    <option value="mg/dL">mg/dL</option>
                                                    <option value="nmol/L">nmol/L</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="qrisk-lpa-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <div class="info-box">
                                                <p>Elevated Lp(a) is an independent risk factor for CVD. Values ≥50 mg/dL (≥125 nmol/L) are considered elevated and may warrant more aggressive risk factor modification.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="reset" class="button button-secondary">Reset Form</button>
                                <button type="submit" class="button button-primary">Calculate Risk</button>
                            </div>
                        </form>
                        
                        <div id="qrisk-results-container" class="results-container" style="display: none;">
                            <div class="results-date">Calculated on <span>Date</span></div>
                            <div id="qrisk-results" class="results"></div>
                            <div class="results-actions">
                                <button id="qrisk-copy-to-frs" class="button button-secondary">Copy to Framingham</button>
                                <button id="qrisk-copy-to-medication" class="button button-secondary">Copy to Medication</button>
                                <button id="qrisk-print-results" class="button button-primary">Print Results</button>
                                <button id="qrisk-export-pdf" class="button button-primary">Export PDF</button>
                                <button id="qrisk-export-csv" class="button button-secondary">Export CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Panel -->
                    <div id="panel-comparison" class="tab-panel" role="tabpanel" aria-labelledby="tab-comparison">
                        <div class="comparison-instructions">
                            <div class="card">
                                <div class="card-header">
                                    <h2>Calculator Comparison</h2>
                                </div>
                                <div class="card-body">
                                    <p>This tool allows you to compare results from different CVD risk calculators. Please calculate risk using at least two calculators first.</p>
                                    
                                    <div id="comparison-status" class="comparison-status">
                                        <div class="comparison-calculator">
                                            <span class="status-label">Framingham Risk Score:</span>
                                            <span id="frs-status" class="status-indicator incomplete">Not calculated</span>
                                        </div>
                                        <div class="comparison-calculator">
                                            <span class="status-label">QRISK3:</span>
                                            <span id="qrisk-status" class="status-indicator incomplete">Not calculated</span>
                                        </div>
                                    </div>
                                    
                                    <div class="info-box">
                                        <p><strong>Note:</strong> Different calculators may give different results because they consider different risk factors and were developed in different populations.</p>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button id="run-comparison" class="button button-primary" disabled>Compare Calculators</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="comparison-results-container" class="results-container" style="display: none;">
                            <div class="results-date">Compared on <span>Date</span></div>
                            <div id="comparison-results" class="results"></div>
                            <div class="results-actions">
                                <button id="comparison-print-results" class="button button-primary">Print Results</button>
                                <button id="comparison-export-pdf" class="button button-primary">Export PDF</button>
                                <button id="comparison-export-csv" class="button button-secondary">Export CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Medication Evaluation Panel -->
                    <div id="panel-medication" class="tab-panel" role="tabpanel" aria-labelledby="tab-medication">
                        <form id="medication-form" class="risk-form" novalidate>
                            <div class="card">
                                <div class="card-header">
                                    <h2>Clinical Context</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-prevention">Prevention Category</label>
                                            <select id="med-prevention" name="med-prevention" required class="form-select form-input-large">
                                                <option value="" selected disabled>Select category</option>
                                                <option value="primary">Primary Prevention</option>
                                                <option value="secondary">Secondary Prevention</option>
                                            </select>
                                            <div class="error-message" id="med-prevention-validation"></div>
                                        </div>
                                        <div class="form-group" id="med-secondary-details-container" style="display: none;">
                                            <label for="med-secondary-details">Secondary Prevention Details</label>
                                            <select id="med-secondary-details" name="med-secondary-details" class="form-select form-input-large">
                                                <option value="" selected disabled>Select category</option>
                                                <option value="stable">Stable CVD</option>
                                                <option value="mi">Recent ACS/MI (within 2 years)</option>
                                                <option value="multi">Multiple vascular territories</option>
                                            </select>
                                            <div class="error-message" id="med-secondary-details-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-familial-hypercholesterolemia" name="med-familial-hypercholesterolemia" class="form-checkbox-large">
                                            <label for="med-familial-hypercholesterolemia">Familial Hypercholesterolemia</label>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-calculated-risk">Calculated CVD Risk (%)</label>
                                            <input type="number" id="med-calculated-risk" name="med-calculated-risk" min="0" max="100" 
                                                   placeholder="Enter risk %" step="0.1" class="form-input form-input-large">
                                            <div class="form-help">From Framingham, QRISK3, or other calculator</div>
                                            <div class="error-message" id="med-calculated-risk-validation"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Current Lipid Values</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-total-chol">Total Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-total-chol" name="med-total-chol" min="1" max="15" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="totalCholesterol">
                                                <select id="med-total-chol-unit" name="med-total-chol-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="med-total-chol-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-ldl">LDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-ldl" name="med-ldl" min="0.5" max="10" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="ldl">
                                                <select id="med-ldl-unit" name="med-ldl-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="med-ldl-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-hdl">HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-hdl" name="med-hdl" min="0.4" max="4" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="hdl">
                                                <select id="med-hdl-unit" name="med-hdl-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="med-hdl-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-non-hdl">Non-HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-non-hdl" name="med-non-hdl" min="0.5" max="12" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="nonHdl">
                                                <select id="med-non-hdl-unit" name="med-non-hdl-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="med-non-hdl-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-trig">Triglycerides</label>
                                            <div class="input-group">
                                                <input type="number" id="med-trig" name="med-trig" min="0.2" max="10" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="triglycerides">
                                                <select id="med-trig-unit" name="med-trig-unit" class="input-group-addon form-input-large">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="med-trig-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-apob">Apolipoprotein B</label>
                                            <div class="input-group">
                                                <input type="number" id="med-apob" name="med-apob" min="0.2" max="2.5" 
                                                       placeholder="Enter value" step="0.01" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="apob">
                                                <select id="med-apob-unit" name="med-apob-unit" class="input-group-addon form-input-large">
                                                    <option value="g/L">g/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="med-apob-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-lpa">Lipoprotein(a)</label>
                                            <div class="input-group">
                                                <input type="number" id="med-lpa" name="med-lpa" min="0" max="500" 
                                                       placeholder="Enter value" step="0.1" class="form-input form-input-large"
                                                       data-validation="physiological" data-param-type="lpa">
                                                <select id="med-lpa-unit" name="med-lpa-unit" class="input-group-addon form-input-large">
                                                    <option value="mg/dL">mg/dL</option>
                                                    <option value="nmol/L">nmol/L</option>
                                                </select>
                                            </div>
                                            <div class="error-message" id="med-lpa-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-ha1c">Hemoglobin A1c (%)</label>
                                            <input type="number" id="med-ha1c" name="med-ha1c" min="4" max="15" 
                                                   placeholder="Enter HbA1c" step="0.1" class="form-input form-input-large"
                                                   data-validation="physiological" data-param-type="hba1c">
                                            <div class="error-message" id="med-ha1c-validation"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Current Lipid-Lowering Therapy</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-statin">Statin</label>
                                            <select id="med-statin" name="med-statin" class="form-select form-input-large">
                                                <option value="none" selected>None</option>
                                                <option value="atorvastatin">Atorvastatin (Lipitor)</option>
                                                <option value="rosuvastatin">Rosuvastatin (Crestor)</option>
                                                <option value="simvastatin">Simvastatin (Zocor)</option>
                                                <option value="pravastatin">Pravastatin (Pravachol)</option>
                                                <option value="lovastatin">Lovastatin (Mevacor)</option>
                                                <option value="fluvastatin">Fluvastatin (Lescol)</option>
                                                <option value="pitavastatin">Pitavastatin (Livalo)</option>
                                            </select>
                                            <div class="error-message" id="med-statin-validation"></div>
                                        </div>
                                        <div class="form-group" id="med-statin-dose-container" style="display: none;">
                                            <label for="med-statin-dose">Statin Dose</label>
                                            <select id="med-statin-dose" name="med-statin-dose" class="form-select form-input-large">
                                                <option value="" selected disabled>Select dose</option>
                                                <!-- Doses will be populated dynamically based on selected statin -->
                                            </select>
                                            <div class="error-message" id="med-statin-dose-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-statin-intensity">Statin Intensity</label>
                                            <select id="med-statin-intensity" name="med-statin-intensity" class="form-select form-input-large">
                                                <option value="none" selected>None</option>
                                                <option value="low">Low Intensity</option>
                                                <option value="moderate">Moderate Intensity</option>
                                                <option value="high">High Intensity</option>
                                            </select>
                                            <div class="error-message" id="med-statin-intensity-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-statin-intolerance">Statin Intolerance</label>
                                            <select id="med-statin-intolerance" name="med-statin-intolerance" class="form-select form-input-large">
                                                <option value="no" selected>No</option>
                                                <option value="partial">Partial (tolerates low dose)</option>
                                                <option value="complete">Complete (cannot tolerate any dose)</option>
                                            </select>
                                            <div class="error-message" id="med-statin-intolerance-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-ezetimibe" name="med-ezetimibe">
                                            <label for="med-ezetimibe">Ezetimibe (Zetia/Ezetrol)</label>
                                        </div>
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-pcsk9" name="med-pcsk9">
                                            <label for="med-pcsk9">PCSK9 Inhibitor (Repatha/Praluent)</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-bempedoic" name="med-bempedoic">
                                            <label for="med-bempedoic">Bempedoic Acid (Nexletol/Nilemdo)</label>
                                        </div>
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-fibrate" name="med-fibrate">
                                            <label for="med-fibrate">Fibrate (Fenofibrate/Gemfibrozil)</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-niacin" name="med-niacin">
                                            <label for="med-niacin">Niacin</label>
                                        </div>
                                        <div class="form-group form-group-checkbox">
                                            <input type="checkbox" id="med-omega3" name="med-omega3">
                                            <label for="med-omega3">Omega-3 Fatty Acids</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-therapy-duration">Duration on Current Therapy</label>
                                            <select id="med-therapy-duration" name="med-therapy-duration" class="form-select">
                                                <option value="<1" selected>Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value=">6">More than 6 months</option>
                                            </select>
                                            <div class="error-message" id="med-therapy-duration-validation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="med-max-therapy-duration">Duration on Maximum Therapy</label>
                                            <select id="med-max-therapy-duration" name="med-max-therapy-duration" class="form-select">
                                                <option value="NA" selected>Not applicable</option>
                                                <option value="<1">Less than 1 month</option>
                                                <option value="1-3">1-3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value=">6">More than 6 months</option>
                                            </select>
                                            <div class="error-message" id="med-max-therapy-duration-validation"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-additional-medications">Additional Medications</label>
                                            <textarea id="med-additional-medications" name="med-additional-medications" 
                                                    class="form-textarea" rows="3" placeholder="Enter other medications"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>