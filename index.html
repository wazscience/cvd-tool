<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Enhanced Cardiovascular Disease Risk Assessment Toolkit for healthcare professionals, featuring FRS, QRISK3, Lp(a) analysis, medication evaluation, and advanced visualizations. Version 5.0.">
    <meta name="author" content="CVD Risk Assessment Team">
    <title>Enhanced CVD Risk Toolkit - Integrated Edition v5.0</title>

    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https://placehold.co; connect-src 'self' https://api.ipgeolocation.io https://*.junoemr.com; object-src 'none'; frame-ancestors 'self' https://*.junoemr.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN"> <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c7afc">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png"> <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css"> <link rel="modulepreload" href="js/utils/error-detection-system.js">
    <link rel="modulepreload" href="js/utils/runtime-protection.js">
    <link rel="modulepreload" href="js/utils/event-bus.js">
    <link rel="modulepreload" href="js/utils/validation-helpers.js">
    <link rel="modulepreload" href="js/utils/secure-storage.js">
    <link rel="modulepreload" href="js/utils/input-sanitizer.js">
    <link rel="modulepreload" href="js/utils/tab-manager.js"> <link rel="modulepreload" href="js/utils/module-loader.js">
    <link rel="modulepreload" href="js/utils/form-handler.js"> <link rel="modulepreload" href="js/utils/loading-manager.js">
    <link rel="modulepreload" href="js/utils/memory-manager.js">
    <link rel="modulepreload" href="js/utils/enhanced-disclaimer.js"> <link rel="modulepreload" href="js/utils/cross-tab-sync.js">
    <link rel="modulepreload" href="js/utils/device-capability-detector.js">
    <link rel="modulepreload" href="js/main.js"> <link rel="modulepreload" href="js/ui.js"> <link rel="modulepreload" href="js/calculations/framingham-algorithm.js"> <link rel="modulepreload" href="js/calculations/qrisk3-algorithm.js"> <link rel="modulepreload" href="js/calculations/treatment-recommendations.js">
    <link rel="modulepreload" href="js/calculations/risk-calculator.js">
    <link rel="modulepreload" href="js/data/clinical-thresholds.js">
    <link rel="modulepreload" href="js/data/medication-database.js">
    <link rel="modulepreload" href="js/data-management/data-manager.js"> <link rel="modulepreload" href="js/data-management/emr-connector.js">
    <link rel="modulepreload" href="js/data-management/field-mapper.js">
    <link rel="modulepreload" href="js/integrations/juno-integration.js">
    <link rel="modulepreload" href="js/ui/results-display.js">
    <link rel="modulepreload" href="js/visualizations/chart-renderer.js"> <link rel="modulepreload" href="js/visualizations/chart-exporter.js">
    <link rel="modulepreload" href="js/services/pdf-service.js">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" integrity="sha512-SY3zbDTeK3D5G7Fp9cA7Qz70D0CL1ZgA3gYhVjXFjR3M2W3vPjYQejjI6f7FhRjHy3hR8pWzYfF+kP/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4HCUpSP7J0qPZVIM3p3+CPTFSJHyGEZEROjKDBbA_jS21fs4L6cDRi4G_w==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" integrity="sha512-V8g582jwGUxPAtd99JDAx2sO2x4Mh4xHhWlG97Gqg2U1iP/q22s5U7k/6c/qP0RjM7fP0RzYgGZ1zRjYg==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgM6HZreqGFIomiQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-SGWyrQRMLRoCqV1L/jKqjwKsbhL4Uf2G2hMhW3Mh7QxV6wH2Wf/Lz7S9Yq2954Vv/6o/aV4N3yYhM5vL/w==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylQ9K_6_86K2sVpSg/M1TqO9pYnS_1C_WJvVzDq_hGgWJjf/TfK/GzX/tBv/JbNf/g==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>

    <script>
        window.__earlyErrors = window.__earlyErrors || [];
        window.__originalConsoleError = console.error;
        console.error = function() {
            window.__originalConsoleError.apply(console, arguments);
            window.__earlyErrors.push({ timestamp: new Date(), message: Array.from(arguments).join(' '), type: 'console.error' });
        };
        window.onerror = function(message, source, lineno, colno, error) {
            window.__earlyErrors.push({ timestamp: new Date(), message, source, lineno, colno, error: error ? error.stack : null, type: 'global.error' });
            // Consider if you want to prevent default browser error handling here.
            // The uploaded index had 'return true;' which does prevent it.
            // For now, let's keep that behavior.
            return true;
        };
        window.onunhandledrejection = function(event) {
            window.__earlyErrors.push({ timestamp: new Date(), message: event.reason ? (event.reason.message || event.reason) : 'Unhandled Promise Rejection', stack: event.reason && event.reason.stack ? event.reason.stack : null, type: 'promise.rejection' });
        };

        let globalLoadingCount = 0;
        window.__coreLoaded = false;
        window.ENABLE_SERVICE_WORKER = true; // Control SW registration
        window.CVD_APP_VERSION = "5.0.0"; // New integrated version
        window.CVD_APP_CONFIG = {
            appName: "Enhanced CVD Risk Toolkit - Integrated",
            version: window.CVD_APP_VERSION,
        };

        function showLoading(message = 'Processing...') {
            globalLoadingCount++;
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                updateLoadingState(message);
            } else {
                window.addEventListener('DOMContentLoaded', () => updateLoadingState(message));
            }
        }

        function updateLoadingState(message) {
            const loadingOverlay = document.getElementById('loading-overlay'); // Will use loading-overlay from v4.3 / Uploaded Index
            if (!loadingOverlay) return;
            const loadingMessageElement = loadingOverlay.querySelector('#loading-message') || loadingOverlay.querySelector('.loading-message'); // Accommodate both
            if (loadingMessageElement) loadingMessageElement.textContent = message;
            loadingOverlay.classList.add('show'); // Assuming 'show' class makes it visible
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            globalLoadingCount = Math.max(0, globalLoadingCount - 1);
            if (globalLoadingCount === 0 && (document.readyState === 'complete' || document.readyState === 'interactive')) {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('show');
                    loadingOverlay.style.display = 'none';
                }
            }
        }
    </script>

    <style>
        /* Critical CSS from Uploaded Index - Selected relevant parts, assuming styles.css covers more */
        :root {
            --primary-color: #2c7afc; /* from v4.3 */
            --primary-dark: #1f5fc7; /* from v4.3 */
            --secondary-color: #6c757d;  /* from v4.3 */
            --success-color: #28a745; /* from v4.3 */
            --warning-color: #ffc107; /* from v4.3 */
            --danger-color: #dc3545; /* from v4.3 */
            --light-color: #f8f9fa; /* from v4.3 */
            --dark-color: #343a40; /* from v4.3 */
            --background-color: #ffffff; /* from v4.3 */
            --text-color: #212529; /* from v4.3 */
            --border-radius: 0.25rem; /* from v4.3 */
            --border-color: #dee2e6; /* from Uploaded Index CSS snippet */
            --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* from v4.3 */
            --transition-speed: 0.3s; /* from v4.3 */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* from v4.3 */
            --radius-md: 0.375rem; /* from Uploaded Index */
        }
        /* ... (other critical base styles from uploaded index if necessary,
               otherwise defer to styles.css and the more specific styles below) ... */

        .skip-to-content {
            position: absolute; top: -40px; left: 0; background: var(--primary-color);
            color: white; padding: 8px; z-index: 10000; /* Higher z-index */
            transition: top 0.3s;
        }
        .skip-to-content:focus { top: 0; }

        /* Loading Overlay Style (based on v4.3 / Uploaded Index concept) */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; text-align: center;
        }
        #loading-overlay .loading-spinner { /* Spinner like v4.3 */
            border: 5px solid var(--light-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        #loading-overlay .loading-message, #loading-overlay #loading-message { /* Accommodate both id/class */
            margin-top: 1rem; font-size: 1.1em; color: var(--text-color);
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Basic Tab Styling (from v4.3, will be enhanced by styles.css) */
        .tabs-navigation { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tab-button {
            padding: 0.75rem 1.25rem; cursor: pointer; background-color: transparent;
            border: 1px solid transparent; border-bottom: none; margin-right: 0.25rem;
            border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius);
            font-size: 1rem; color: var(--secondary-color);
        }
        .tab-button:hover { background-color: var(--light-color); color: var(--primary-color); }
        .tab-button.active { background-color: var(--background-color); border-color: var(--border-color); border-bottom: 1px solid var(--background-color); color: var(--primary-color); font-weight: 600; margin-bottom: -1px; }
        .tab-button .tab-icon { margin-right: 0.5em; }
        .tab-content-panel { display: none; padding: 1rem; border: 1px solid var(--border-color); border-top: none; }
        .tab-content-panel.active { display: block; }

        /* Styles from Uploaded Index CSS snippet for Advanced Visualization - good to keep */
        .chart-container {
            border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 1.5rem;
            margin-bottom: 1.5rem; background-color: #fff; box-shadow: var(--box-shadow);
            transition: box-shadow 0.3s ease;
        }
        .chart-container:hover { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); }
        /* ... (other relevant critical styles from uploaded index's inline CSS) */
    </style>
</head>

<body class="light-theme"> <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <div id="loading-overlay" aria-hidden="true" style="display: none;">
        <div class="loading-spinner" role="progressbar" aria-valuetext="Loading..."></div>
        <p id="loading-message" class="loading-message">Processing...</p>
    </div>

    <header class="app-header">
        <div class="header-content container"> <img src="images/logo-placeholder.png" alt="CVD Toolkit Logo" class="logo" id="app-logo-header"
                 onerror="this.onerror=null; this.src='https://placehold.co/150x50/2c7afc/ffffff?text=CVD+Toolkit';">
            <h1>Enhanced CVD Risk Toolkit <span class="version-badge">v5.0</span></h1>
            <p style="font-size: 0.9em; color: #e9ecef;">Advanced cardiovascular risk assessment and management tool.</p> </div>
        <div class="header-actions integration-controls"> <button id="fhir-integration-button" class="button button-secondary icon-button" aria-label="Configure FHIR Integration" title="FHIR Integration">FHIR</button>
            <button id="emr-integration-button" class="button button-secondary icon-button" aria-label="Configure EMR Integration" title="EMR Integration">EMR</button>
            <button id="theme-toggle-button" class="icon-button" aria-label="Toggle theme" title="Toggle Theme">
                <span class="theme-icon-light">☀️</span><span class="theme-icon-dark">🌙</span>
            </button>
            <button id="font-size-decrease-button" class="button button-icon font-size-btn icon-button" aria-label="Decrease font size" title="Decrease Font">A-</button>
            <button id="font-size-increase-button" class="button button-icon font-size-btn icon-button" aria-label="Increase font size" title="Increase Font">A+</button>
            <button id="settings-button-header" class="icon-button" aria-label="Settings" data-modal-target="settings-modal-main" title="Settings">⚙️</button> </div>
    </header>

    <div class="tool-description container disclaimer-alert-container">
        <div class="disclaimer-alert" id="disclaimer-alert-main" role="alert">
            <p><strong>Medical Disclaimer:</strong> This tool is intended for use by healthcare professionals only...</p>
            <p>By using this application, you acknowledge that you have read and agreed to the <a href="#" id="show-clinical-disclaimer-link" class="disclaimer-link" data-modal-target="main-disclaimer-modal" data-disclaimer-key="mainAppDisclaimer">Clinical Use Disclaimer</a> and <a href="#" id="show-terms-link" class="disclaimer-link" data-modal-target="terms-modal" data-disclaimer-key="termsOfService">Terms of Use</a>.</p>
            <button class="alert-close" aria-label="Close disclaimer" onclick="this.parentElement.style.display='none';">×</button>
        </div>
    </div>

    <main class="app-main container" id="main-content">
        <nav class="tabs-navigation" role="tablist" aria-label="Main toolkit sections">
            <button id="tab-medication-button" class="tab-button active" data-tab-target="#panel-medication" role="tab" aria-selected="true" aria-controls="panel-medication">
                <span class="tab-icon" aria-hidden="true">💊</span>Medication & Labs
            </button>
            <button id="tab-frs-button" class="tab-button" data-tab-target="#panel-frs" role="tab" aria-selected="false" aria-controls="panel-frs">
                <span class="tab-icon" aria-hidden="true">📊</span>FRS Calculator
            </button>
            <button id="tab-qrisk-button" class="tab-button" data-tab-target="#panel-qrisk3" role="tab" aria-selected="false" aria-controls="panel-qrisk3">
                <span class="tab-icon" aria-hidden="true">📉</span>QRISK®3 Calculator
            </button>
            <button id="tab-combined-button" class="tab-button" data-tab-target="#panel-combined" role="tab" aria-selected="false" aria-controls="panel-combined">
                <span class="tab-icon" aria-hidden="true">🔄</span>Combined View
            </button>
            <button id="tab-recommendations-button" class="tab-button" data-tab-target="#panel-recommendations" role="tab" aria-selected="false" aria-controls="panel-recommendations">
                <span class="tab-icon" aria-hidden="true">💡</span>Recommendations
            </button>
            <button id="tab-advanced-viz-button" class="tab-button" data-tab-target="#panel-advanced-viz" role="tab" aria-selected="false" aria-controls="panel-advanced-viz">
                <span class="tab-icon" aria-hidden="true">📈</span>Advanced Visualization
            </button>
            <button id="tab-history-button" class="tab-button" data-tab-target="#panel-history" role="tab" aria-selected="false" aria-controls="panel-history">
                <span class="tab-icon" aria-hidden="true">📜</span>History
            </button>
            <button id="tab-data-button" class="tab-button" data-tab-target="#panel-data-io" role="tab" aria-selected="false" aria-controls="panel-data-io">
                <span class="tab-icon" aria-hidden="true">📁</span>Data Import/Export
            </button>
            <button id="tab-future-button" class="tab-button" data-tab-target="#panel-future" role="tab" aria-selected="false" aria-controls="panel-future">
                <span class="tab-icon" aria-hidden="true">🔬</span>Future Projects
            </button>
            <button id="tab-settings-button" class="tab-button" data-tab-target="#panel-settings" role="tab" aria-selected="false" aria-controls="panel-settings">
                <span class="tab-icon" aria-hidden="true">⚙️</span>Settings
            </button>
        </nav>

        <div class="tab-content">
            <div role="tabpanel" aria-labelledby="tab-medication-button" id="panel-medication" class="tab-content-panel active">
                <form id="medication-labs-form" class="input-form clinical-form" data-validate novalidate>
                    <div class="form-section">
                        <h2>Patient Data, Medications, and Labs</h2>
                        <p>Enter patient details, current lab values, and relevant medical history. This information will be used to inform risk calculations and medication evaluations. Fields marked with <span class="required-asterisk">*</span> are required.</p>
                        <div id="medication-form-error" class="error-message form-level-error" style="display:none;" role="alert"></div>

                        <h3>Patient Demographics & Vitals</h3>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-age" class="form-label required">Age (years)</label>
                                    <input type="number" id="ml-age" name="age" class="form-control" required min="18" max="120" placeholder="e.g., 55" data-validation-type="age" data-param-type="age">
                                    <span class="validation-error error-message" id="medication-labs-form-age-validation"></span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-sex" class="form-label required">Sex (assigned at birth)</label>
                                    <select id="ml-sex" name="sex" class="form-control" required data-validation-type="sex">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                    <span class="validation-error error-message" id="medication-labs-form-sex-validation"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-weight" class="form-label">Weight</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-weight" name="weight" class="form-control" placeholder="e.g., 70" min="0" step="any" data-validation-type="weight" data-param-type="weight_kg" data-physiological="true">
                                        <select id="ml-weight-unit" name="weight_unit" class="form-control input-group-append">
                                            <option value="kg">kg</option>
                                            <option value="lbs">lbs</option>
                                        </select>
                                    </div>
                                    <div id="ml-weight-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-height" class="form-label">Height</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-height" name="height" class="form-control" placeholder="e.g., 175" min="0" step="any" data-validation-type="height" data-param-type="height_cm" data-physiological="true">
                                        <select id="ml-height-unit" name="height_unit" class="form-control input-group-append">
                                            <option value="cm">cm</option>
                                            <option value="in">inches</option>
                                        </select>
                                    </div>
                                     <div id="ml-height-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                             <div class="col">
                                <div class="form-group">
                                    <label for="ml-bmi" class="form-label">BMI (kg/m²)</label>
                                    <input type="number" id="ml-bmi" name="bmi" class="form-control" readonly data-param-type="bmi">
                                    <div id="ml-bmi-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-sbp" class="form-label required">Systolic Blood Pressure (SBP)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-sbp" name="sbp" class="form-control" required placeholder="e.g., 120" min="0" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <span class="unit-display form-control-plaintext">mmHg</span>
                                    </div>
                                    <span class="validation-error error-message" id="medication-labs-form-sbp-validation"></span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-dbp" class="form-label">Diastolic Blood Pressure (DBP)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-dbp" name="dbp" class="form-control" placeholder="e.g., 80" min="0" data-validation-type="diastolicBP" data-param-type="dbp" data-physiological="true">
                                        <span class="unit-display form-control-plaintext">mmHg</span>
                                    </div>
                                    <div id="ml-dbp-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-ethnicity-qrisk" class="form-label required">Ethnicity (for QRISK®3)</label>
                                    <select id="ml-ethnicity-qrisk" name="ethnicity_qrisk" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Select ethnicity...</option>
                                        <option value="WHITE_OR_NOT_STATED">White or not stated</option>
                                        <option value="INDIAN">Indian</option>
                                        <option value="PAKISTANI">Pakistani</option>
                                        <option value="BANGLADESHI">Bangladeshi</option>
                                        <option value="OTHER_ASIAN">Other Asian</option>
                                        <option value="BLACK_CARIBBEAN">Black Caribbean</option>
                                        <option value="BLACK_AFRICAN">Black African</option>
                                        <option value="CHINESE">Chinese</option>
                                        <option value="OTHER_ETHNIC_GROUP">Other ethnic group</option>
                                        </select>
                                    <span class="validation-error error-message" id="medication-labs-form-ethnicity-qrisk-validation"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Cardiovascular Risk Factors & Lab Values</h3>
                         <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-total-cholesterol" class="form-label required">Total Cholesterol</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-total-cholesterol" name="total_cholesterol" class="form-control" required placeholder="e.g., 5.2" min="0" step="any" data-validation-type="cholesterol" data-param-type="totalCholesterol" data-physiological="true">
                                        <select id="ml-total-cholesterol-unit" name="total_cholesterol_unit" class="form-control input-group-append">
                                            <option value="mmol/L">mmol/L</option>
                                            <option value="mg_dl">mg/dL</option>
                                        </select>
                                    </div>
                                    <span class="validation-error error-message" id="medication-labs-form-total-cholesterol-validation"></span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-hdl-cholesterol" class="form-label required">HDL Cholesterol</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-hdl-cholesterol" name="hdl_cholesterol" class="form-control" required placeholder="e.g., 1.3" min="0" step="any" data-validation-type="hdl" data-param-type="hdl" data-physiological="true">
                                        <select id="ml-hdl-cholesterol-unit" name="hdl_cholesterol_unit" class="form-control input-group-append">
                                            <option value="mmol/L">mmol/L</option>
                                            <option value="mg_dl">mg/dL</option>
                                        </select>
                                    </div>
                                    <span class="validation-error error-message" id="medication-labs-form-hdl-cholesterol-validation"></span>
                                </div>
                            </div>
                             <div class="col">
                                <div class="form-group">
                                    <label for="ml-ldl-cholesterol" class="form-label">LDL Cholesterol</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-ldl-cholesterol" name="ldl_cholesterol" class="form-control" placeholder="e.g., 3.0" min="0" step="any" data-validation-type="ldl" data-param-type="ldl" data-physiological="true">
                                        <select id="ml-ldl-cholesterol-unit" name="ldl_cholesterol_unit" class="form-control input-group-append">
                                            <option value="mmol/L">mmol/L</option>
                                            <option value="mg_dl">mg/dL</option>
                                        </select>
                                    </div>
                                    <div id="ml-ldl-cholesterol-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col">
                                <div class="form-group">
                                    <label for="ml-triglycerides" class="form-label">Triglycerides</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-triglycerides" name="triglycerides" class="form-control" placeholder="e.g., 1.7" min="0" step="any" data-validation-type="triglycerides" data-param-type="triglycerides" data-physiological="true">
                                        <select id="ml-triglycerides-unit" name="triglycerides_unit" class="form-control input-group-append">
                                            <option value="mmol/L">mmol/L</option>
                                            <option value="mg_dl">mg/dL</option>
                                        </select>
                                    </div>
                                    <div id="ml-triglycerides-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-non-hdl" class="form-label">Non-HDL Cholesterol</label>
                                     <div class="input-group input-with-unit">
                                        <input type="number" id="ml-non-hdl" name="non_hdl_cholesterol" class="form-control" readonly data-param-type="nonHdl" placeholder="Calculated">
                                        <span id="ml-non-hdl-unit-display" class="unit-display form-control-plaintext">mmol/L</span>
                                     </div>
                                    <div id="ml-non-hdl-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                             <div class="col">
                                <div class="form-group">
                                    <label for="ml-lipoprotein-a" class="form-label">Lipoprotein(a)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-lipoprotein-a" name="lpa" class="form-control" min="0" step="any" placeholder="e.g., 30" data-validation-type="lpa" data-param-type="lpa" data-physiological="true">
                                        <select id="ml-lpa-unit" name="lpa_unit" class="form-control input-group-append">
                                            <option value="mg_dl">mg/dL</option>
                                            <option value="nmol_L">nmol/L</option>
                                        </select>
                                    </div>
                                    <div id="ml-lipoprotein-a-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-apolipoprotein-b" class="form-label">Apolipoprotein B100</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-apolipoprotein-b" name="apoB" class="form-control" min="0" step="any" placeholder="e.g., 1.0" data-validation-type="apob" data-param-type="apoB" data-physiological="true">
                                        <select id="ml-apob-unit" name="apoB_unit" class="form-control input-group-append">
                                            <option value="g_L">g/L</option>
                                            <option value="mg_dl">mg/dL</option>
                                        </select>
                                    </div>
                                    <div id="ml-apolipoprotein-b-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-on-bp-medication" class="form-label required">On Blood Pressure Medication?</label>
                                    <select id="ml-on-bp-medication" name="on_bp_medication" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                    <span class="validation-error error-message" id="medication-labs-form-on-bp-medication-validation"></span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-smoking-status" class="form-label required">Smoking Status</label>
                                    <select id="ml-smoking-status" name="smoking_status" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="non_smoker">Non-smoker</option>
                                        <option value="ex_smoker">Ex-smoker</option>
                                        <option value="light_smoker">Light smoker (1-9/day)</option>
                                        <option value="moderate_smoker">Moderate smoker (10-19/day)</option>
                                        <option value="heavy_smoker">Heavy smoker (20+/day)</option>
                                    </select>
                                    <span class="validation-error error-message" id="medication-labs-form-smoking-status-validation"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Diabetes & Glucose Monitoring</h3>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-diabetes-status" class="form-label required">Diabetes Status</label>
                                    <select id="ml-diabetes-status" name="diabetes_status" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="no_diabetes">No Diabetes</option>
                                        <option value="type1_diabetes">Type 1 Diabetes</option>
                                        <option value="type2_diabetes">Type 2 Diabetes</option>
                                    </select>
                                    <span class="validation-error error-message" id="medication-labs-form-diabetes-status-validation"></span>
                                </div>
                            </div>
                           <div class="col">
                                <div class="form-group">
                                    <label for="ml-hba1c-value" class="form-label">HbA1c</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="ml-hba1c-value" name="hba1c" class="form-control" min="3" max="20" step="0.1" placeholder="e.g., 5.7" data-validation-type="hba1c" data-param-type="hba1c" data-physiological="true">
                                        <select id="ml-hba1c-unit" name="hba1c_unit" class="form-control input-group-append">
                                            <option value="%">%</option>
                                            <option value="mmol_mol">mmol/mol</option>
                                        </select>
                                    </div>
                                    <div id="ml-hba1c-value-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ml-random-glucose" class="form-label">Random Glucose Level</label>
                            <div class="input-group input-with-unit">
                                <input type="number" id="ml-random-glucose" name="random_glucose" class="form-control" placeholder="e.g., 5.5" min="0" step="any">
                                <select id="ml-random-glucose-unit" name="random_glucose_unit" class="form-control input-group-append">
                                    <option value="mmol_l">mmol/L</option>
                                    <option value="mg_dl">mg/dL</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Current Medications</h3>
                        <p>Enter current relevant medications, their dosages, and duration of use.</p>
                        <h4>Anti-Lipid Medications</h4>
                        <div class="row medication-row" id="lipid-med-row-1">
                            <div class="col"><div class="form-group"><label for="lipid-med-1-name" class="form-label">Medication 1 Name</label><input type="text" id="lipid-med-1-name" name="lipidMed1Name" class="form-control"></div></div>
                            <div class="col"><div class="form-group"><label for="lipid-med-1-dose" class="form-label">Dosage</label><input type="text" id="lipid-med-1-dose" name="lipidMed1Dose" class="form-control"></div></div>
                            <div class="col"><div class="form-group"><label for="lipid-med-1-duration" class="form-label">Duration (months)</label><input type="number" id="lipid-med-1-duration" name="lipidMed1Duration" class="form-control" min="0"></div></div>
                        </div>
                        </div>


                    <div class="form-section">
                        <h3>Additional Clinical Information (for QRISK®3)</h3>
                        <div class="row">
                            <div class="col">
                                <div class="form-group form-check"> <input type="checkbox" id="ml-family-history-cvd" name="family_history_cvd" class="form-check-input">
                                    <label for="ml-family-history-cvd" class="form-check-label">Angina or heart attack in a 1st degree relative &lt; 60?</label>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-ckd-stage" class="form-label">Chronic Kidney Disease (CKD)</label>
                                    <select id="ml-ckd-stage" name="ckd_stage" class="form-control">
                                         <option value="" selected disabled>Select...</option>
                                        <option value="no_ckd">No CKD / Stage 1-2</option>
                                        <option value="ckd_stage3">Stage 3</option>
                                        <option value="ckd_stage4_5">Stage 4 or 5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col"><div class="form-group form-check"><input type="checkbox" id="ml-atrial-fibrillation" name="atrial_fibrillation" class="form-check-input"><label for="ml-atrial-fibrillation" class="form-check-label">Atrial Fibrillation?</label></div></div>
                            <div class="col"><div class="form-group form-check"><input type="checkbox" id="ml-migraines" name="migraines" class="form-check-input"><label for="ml-migraines" class="form-check-label">History of Migraines?</label></div></div>
                        </div>
                        <div class="row">
                            <div class="col"><div class="form-group form-check"><input type="checkbox" id="ml-rheumatoid-arthritis" name="rheumatoid_arthritis" class="form-check-input"><label for="ml-rheumatoid-arthritis" class="form-check-label">Rheumatoid Arthritis?</label></div></div>
                            <div class="col"><div class="form-group form-check"><input type="checkbox" id="ml-sle" name="sle" class="form-check-input"><label for="ml-sle" class="form-check-label">Systemic Lupus Erythematosus (SLE)?</label></div></div>
                        </div>
                        <div class="row">
                             <div class="col">
                                <div class="form-group form-check">
                                    <input type="checkbox" id="ml-severe-mental-illness" name="severe_mental_illness" class="form-check-input">
                                    <label for="ml-severe-mental-illness" class="form-check-label">Severe Mental Illness (schizophrenia, bipolar, mod/severe depression)?</label>
                                </div>
                            </div>
                           <div class="col">
                                <div class="form-group form-check">
                                    <input type="checkbox" id="ml-atypical-antipsychotics" name="atypical_antipsychotics" class="form-check-input">
                                    <label for="ml-atypical-antipsychotics" class="form-check-label">On Atypical Antipsychotic Medication?</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col">
                                <div class="form-group form-check">
                                    <input type="checkbox" id="ml-regular-steroids" name="regular_steroids" class="form-check-input">
                                    <label for="ml-regular-steroids" class="form-check-label">On Regular Steroid Tablets?</label>
                                </div>
                            </div>
                            <div class="col dependency-target" id="ml-erectile-dysfunction-group" style="display:none;"> <div class="form-group form-check">
                                     <input type="checkbox" id="ml-erectile-dysfunction" name="erectile_dysfunction" class="form-check-input">
                                    <label for="ml-erectile-dysfunction" class="form-check-label">Erectile Dysfunction (men only)?</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ml-townsend-score" class="form-label">Townsend Deprivation Score (optional)</label>
                            <input type="number" step="any" id="ml-townsend-score" name="townsend_score" class="form-control" placeholder="e.g., -1.5 to 10">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Systolic BP Variability (for QRISK®3)</h3>
                        <p>Enter up to 6 recent SBP readings (mmHg). Leave unused fields blank. Alternatively, enter the calculated SBP SD directly.</p>
                        <div class="row sbp-variability-inputs">
                            <div class="col col-sm-4 col-md-2"><div class="form-group"><label class="form-label sr-only" for="ml-sbp-reading1">Reading 1</label><input type="number" id="ml-sbp-reading1" name="sbp_reading1" class="form-control" placeholder="R1" min="0"></div></div>
                            <div class="col col-sm-4 col-md-2"><div class="form-group"><label class="form-label sr-only" for="ml-sbp-reading2">Reading 2</label><input type="number" id="ml-sbp-reading2" name="sbp_reading2" class="form-control" placeholder="R2" min="0"></div></div>
                            <div class="col col-sm-4 col-md-2"><div class="form-group"><label class="form-label sr-only" for="ml-sbp-reading3">Reading 3</label><input type="number" id="ml-sbp-reading3" name="sbp_reading3" class="form-control" placeholder="R3" min="0"></div></div>
                            <div class="col col-sm-4 col-md-2"><div class="form-group"><label class="form-label sr-only" for="ml-sbp-reading4">Reading 4</label><input type="number" id="ml-sbp-reading4" name="sbp_reading4" class="form-control" placeholder="R4" min="0"></div></div>
                            <div class="col col-sm-4 col-md-2"><div class="form-group"><label class="form-label sr-only" for="ml-sbp-reading5">Reading 5</label><input type="number" id="ml-sbp-reading5" name="sbp_reading5" class="form-control" placeholder="R5" min="0"></div></div>
                            <div class="col col-sm-4 col-md-2"><div class="form-group"><label class="form-label sr-only" for="ml-sbp-reading6">Reading 6</label><input type="number" id="ml-sbp-reading6" name="sbp_reading6" class="form-control" placeholder="R6" min="0"></div></div>
                        </div>
                        <div class="row">
                             <div class="col">
                                <div class="form-group">
                                    <label for="ml-sbp-sd-calculated" class="form-label">Calculated SBP Standard Deviation (mmHg)</label>
                                    <input type="number" step="any" id="ml-sbp-sd-calculated" name="calculated_sbp_sd" class="form-control" readonly placeholder="Calculated from readings">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="ml-sbp-sd-manual" class="form-label">Or, Enter SBP Standard Deviation Manually</label>
                                    <input type="number" step="any" id="ml-sbp-sd-manual" name="manual_sbp_sd" class="form-control" placeholder="e.g., 5.2" min="0">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                     <button type="button" id="calculate-sbp-sd-button" class="button utility-button button-secondary" style="margin-top: 2rem;">Calculate SD</button>
                                </div>
                            </div>
                        </div>
                        <span class="validation-error error-message" id="medication-labs-form-sbp-sd-validation"></span>
                    </div>

                    <div class="form-actions">
                        <button type="submit" id="save-medication-labs" class="button primary-button">Save Data & Update Calculators</button>
                        <button type="reset" id="reset-medication-labs" class="button secondary-button">Reset Form</button>
                    </div>
                </form>
            </div>

            <div role="tabpanel" aria-labelledby="tab-frs-button" id="panel-frs" class="tab-content-panel">
                <form id="frs-form" class="input-form clinical-form" data-validate novalidate>
                    <div class="form-section">
                        <h2>Framingham Risk Score Calculator (2008 General CVD)</h2>
                        <p class="auto-populate-info">Estimates the 10-year cardiovascular disease risk. Fields marked with (*) are auto-populated from the 'Medication & Labs' tab. You can override them here if values are not available there or need adjustment for this specific calculation.</p>
                        <div id="frs-form-error" class="error-message form-level-error" style="display:none;" role="alert">Please correct the errors highlighted below.</div>
                        <h3>Patient Information</h3>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-age" class="form-label required">Age (30-79 years) (*)</label>
                                    <input type="number" id="frs-age" name="age" class="form-control" required placeholder="Auto-populated" min="30" max="79" data-validation-type="age" data-param-type="age">
                                    <div id="frs-age-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-sex" class="form-label required">Sex (*)</label>
                                    <select id="frs-sex" name="sex" class="form-control" required data-validation-type="sex">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                     <div id="frs-sex-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>Clinical Factors</h3>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-total-cholesterol" class="form-label required">Total Cholesterol (*) </label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="frs-total-cholesterol" name="total_cholesterol" class="form-control" required placeholder="Auto-populated" min="0" step="any" data-validation-type="cholesterol" data-param-type="totalCholesterol">
                                        <span id="frs-total-cholesterol-unit-display" class="unit-display form-control-plaintext">mmol/L</span>
                                    </div>
                                    <div id="frs-total-cholesterol-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-hdl-cholesterol" class="form-label required">HDL Cholesterol (*)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="frs-hdl-cholesterol" name="hdl_cholesterol" class="form-control" required placeholder="Auto-populated" min="0" step="any" data-validation-type="hdl" data-param-type="hdl">
                                         <span id="frs-hdl-cholesterol-unit-display" class="unit-display form-control-plaintext">mmol/L</span>
                                    </div>
                                    <div id="frs-hdl-cholesterol-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-sbp" class="form-label required">Systolic Blood Pressure (SBP) (*) (mmHg)</label>
                                     <div class="input-group input-with-unit">
                                        <input type="number" id="frs-sbp" name="sbp" class="form-control" required placeholder="Auto-populated" min="0" data-validation-type="systolicBP" data-param-type="sbp">
                                        <span class="unit-display form-control-plaintext">mmHg</span>
                                    </div>
                                    <div id="frs-sbp-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-on-bp-medication" class="form-label required">On BP Medication? (*)</label>
                                    <select id="frs-on-bp-medication" name="on_bp_medication" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                    <div id="frs-bp-treatment-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                         <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-smoking-status" class="form-label required">Current Smoker? (*)</label>
                                    <select id="frs-smoking-status" name="smoking_status_frs" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                    <div id="frs-smoker-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-diabetes-status" class="form-label required">Diabetes? (*)</label>
                                    <select id="frs-diabetes-status" name="diabetes_status_frs" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                    <div id="frs-diabetes-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                         <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="frs-lipoprotein-a" class="form-label">Lipoprotein(a) (Optional, for context)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="frs-lipoprotein-a" name="lpa_frs" class="form-control" min="0" step="any" placeholder="e.g., 30" data-validation-type="lpa" data-param-type="lpa">
                                        <span id="frs-lpa-unit-display" class="unit-display form-control-plaintext">mg/dL</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="calculate-frs-button" class="button primary-button">Calculate FRS</button>
                        <button type="reset" id="reset-frs-form" class="button secondary-button">Reset FRS Form</button>
                    </div>
                    <div class="loading" id="frs-calculation-loading" style="display:none;">
                        <div class="loading-spinner"></div><p>Calculating FRS Risk...</p>
                    </div>
                    <div id="frs-results-container" class="results-section" style="display:none;" aria-live="polite">
                        </div>
                </form>
            </div>

            <div role="tabpanel" aria-labelledby="tab-qrisk-button" id="panel-qrisk3" class="tab-content-panel">
                <form id="qrisk-form" class="input-form clinical-form" data-validate novalidate>
                    <div class="form-section">
                        <h2>QRISK®3-2018 Calculator (10-year CVD Risk)</h2>
                        <p class="auto-populate-info">Fields marked with (*) are auto-populated from 'Medication & Labs'. Review and complete all fields. Some fields may require manual selection if not directly mapped.</p>
                        <div id="qrisk-form-error" class="error-message form-level-error" style="display:none;" role="alert">Please correct the errors highlighted below.</div>

                        <h3>Patient Information</h3>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-age" class="form-label required">Age (25-84 years) (*)</label>
                                    <input type="number" id="qrisk-age" name="age" class="form-control" required min="25" max="84" placeholder="Auto-populated" data-validation-type="age" data-param-type="age">
                                    <div id="qrisk-age-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-sex" class="form-label required">Sex (*)</label>
                                    <select id="qrisk-sex" name="sex" class="form-control" required data-validation-type="sex">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                    <div id="qrisk-sex-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-ethnicity" class="form-label required">Ethnicity (*)</label>
                                    <select id="qrisk-ethnicity" name="ethnicity" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="WHITE_OR_NOT_STATED">White or not stated</option>
                                        <option value="INDIAN">Indian</option>
                                        <option value="PAKISTANI">Pakistani</option>
                                        <option value="BANGLADESHI">Bangladeshi</option>
                                        <option value="OTHER_ASIAN">Other Asian</option>
                                        <option value="BLACK_CARIBBEAN">Black Caribbean</option>
                                        <option value="BLACK_AFRICAN">Black African</option>
                                        <option value="CHINESE">Chinese</option>
                                        <option value="OTHER_ETHNIC_GROUP">Other ethnic group</option>
                                        <option value="WHITE_IRISH">White Irish</option>
                                        <option value="WHITE_GYPSY">White Gypsy or Irish Traveller</option>
                                        <option value="OTHER_WHITE">Other White background</option>
                                        <option value="WHITE_BLACK_CARIBBEAN">Mixed: White and Black Caribbean</option>
                                        <option value="WHITE_BLACK_AFRICAN">Mixed: White and Black African</option>
                                        <option value="WHITE_ASIAN">Mixed: White and Asian</option>
                                        <option value="OTHER_MIXED">Other Mixed background</option>
                                    </select>
                                    <div id="qrisk-ethnicity-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-height" class="form-label required">Height (*)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="qrisk-height" name="height" class="form-control" required placeholder="Auto-populated (cm)" data-param-type="height_cm">
                                        <span id="qrisk-height-unit-display" class="unit-display form-control-plaintext">cm</span>
                                    </div>
                                    <div id="qrisk-height-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-weight" class="form-label required">Weight (*)</label>
                                     <div class="input-group input-with-unit">
                                        <input type="number" id="qrisk-weight" name="weight" class="form-control" required placeholder="Auto-populated (kg)" data-param-type="weight_kg">
                                        <span id="qrisk-weight-unit-display" class="unit-display form-control-plaintext">kg</span>
                                    </div>
                                    <div id="qrisk-weight-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-bmi" class="form-label">BMI (kg/m²) (*)</label>
                                    <input type="number" step="any" id="qrisk-bmi" name="bmi" class="form-control" placeholder="Auto-calculated" readonly data-param-type="bmi">
                                    <div id="qrisk-bmi-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-townsend-score" class="form-label">Townsend Deprivation Score (*)</label>
                                    <input type="number" step="any" id="qrisk-townsend-score" name="townsend_score" class="form-control" placeholder="Auto-populated (optional)" data-validation-type="numeric">
                                    <div id="qrisk-townsend-score-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Clinical Parameters</h3>
                         <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="qrisk-sbp" class="form-label required">Systolic Blood Pressure (SBP) (*) (mmHg)</label>
                                    <div class="input-group">
                                        <input type="number" id="qrisk-sbp" name="sbp" class="form-control" required placeholder="Auto-populated" data-validation-type="systolicBP" data-param-type="sbp">
                                        <div class="form-check form-check-inline" style="margin-left: 10px; padding-top: 0.5rem;">
                                            <input type="checkbox" id="qrisk-use-multiple-sbp-check" name="useMultipleSbp" class="form-check-input" data-conditional-input data-conditional-target="#qrisk-sbp-readings-details-group">
                                            <label for="qrisk-use-multiple-sbp-check" class="form-check-label">Use multiple SBP readings for SD</label>
                                        </div>
                                    </div>
                                    <div id="qrisk-sbp-validation" class="error-message" role="alert"></div>
                                </div>
                                <div id="qrisk-sbp-readings-details-group" class="dependency-target form-group" style="display: none; border: 1px solid var(--border-color); padding:1rem; margin-top:0.5rem; border-radius: var(--radius-md);">
                                    <p style="margin-bottom: 0.5rem;">Enter up to 6 recent SBP readings (mmHg) from 'Medication & Labs' tab to calculate SD, or enter SD directly below.</p>
                                    <div class="row">
                                        ${Array.from({ length: 6 }, (_, i) => `
                                        <div class="col col-sm-4 col-md-2"> <div class="form-group">
                                                <label class="form-label sr-only" for="qrisk-sbp-display-reading-${i+1}">Reading ${i+1}</label>
                                                <input type="number" id="qrisk-sbp-display-reading-${i+1}" name="qrisk_sbp_display_reading${i+1}" class="form-control qrisk-sbp-reading-display" placeholder="R${i+1}" readonly>
                                            </div>
                                        </div>
                                        `).join('')}
                                    </div>
                                </div>
                                 <div class="form-group">
                                    <label for="qrisk-sbp-sd" class="form-label required">SBP Standard Deviation (mmHg) (*)</label>
                                    <input type="number" step="any" id="qrisk-sbp-sd" name="sbp_sd" class="form-control" required placeholder="Auto-calculated/populated" data-validation-type="numeric" data-param-type="sbpStd">
                                    <small class="form-text text-muted">From SBP readings in Meds/Labs, or manually entered there.</small>
                                    <div id="qrisk-sbp-sd-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                             <div class="col-md-4">
                                <div class="form-group">
                                    <label for="qrisk-on-bp-medication" class="form-label required">On BP Medication? (*)</label>
                                    <select id="qrisk-on-bp-medication" name="on_bp_medication" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                    <div id="qrisk-bp-treatment-validation" class="error-message" role="alert"></div>
                                </div>
                                <div class="form-group">
                                    <label for="qrisk-smoking-status" class="form-label required">Smoking Status (*)</label>
                                    <select id="qrisk-smoking-status" name="smoking_status" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="non_smoker">Non-smoker</option>
                                        <option value="ex_smoker">Ex-smoker</option>
                                        <option value="light_smoker">Light smoker (1-9/day)</option>
                                        <option value="moderate_smoker">Moderate smoker (10-19/day)</option>
                                        <option value="heavy_smoker">Heavy smoker (20+/day)</option>
                                    </select>
                                    <div id="qrisk-smoking-status-validation" class="error-message" role="alert"></div>
                                </div>
                                <div class="form-group">
                                    <label for="qrisk-diabetes-status" class="form-label required">Diabetes Status (*)</label>
                                    <select id="qrisk-diabetes-status" name="diabetes_status" class="form-control" required data-validation-type="text">
                                        <option value="" selected disabled>Auto-populated</option>
                                        <option value="no_diabetes">No Diabetes</option>
                                        <option value="type1_diabetes">Type 1 Diabetes</option>
                                        <option value="type2_diabetes">Type 2 Diabetes</option>
                                    </select>
                                    <div id="qrisk-diabetes-status-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Lipid Parameters</h3>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-total-cholesterol" class="form-label required">Total Cholesterol (*) </label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="qrisk-total-cholesterol" name="total_cholesterol" class="form-control" required placeholder="Auto-populated" min="0" step="any" data-validation-type="cholesterol" data-param-type="totalCholesterol">
                                        <span id="qrisk-total-cholesterol-unit-display" class="unit-display form-control-plaintext">mmol/L</span>
                                    </div>
                                     <div id="qrisk-total-cholesterol-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-hdl-cholesterol" class="form-label required">HDL Cholesterol (*)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="qrisk-hdl-cholesterol" name="hdl_cholesterol" class="form-control" required placeholder="Auto-populated" min="0" step="any" data-validation-type="hdl" data-param-type="hdl">
                                        <span id="qrisk-hdl-cholesterol-unit-display" class="unit-display form-control-plaintext">mmol/L</span>
                                    </div>
                                    <div id="qrisk-hdl-cholesterol-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-cholesterol-hdl-ratio" class="form-label required">Total Cholesterol/HDL Ratio (*)</label>
                                    <input type="number" step="any" id="qrisk-cholesterol-hdl-ratio" name="cholesterol_hdl_ratio" class="form-control" required readonly placeholder="Auto-calculated/populated" min="0" data-validation-type="numeric" data-param-type="cholHDLRatio">
                                    <div id="qrisk-cholesterol-ratio-validation" class="error-message" role="alert"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Additional Clinical Information (Select all that apply) (*)</h3>
                         <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-family-history-cvd" class="form-check-label">Angina/heart attack in 1st degree relative &lt; 60? (*)</label>
                                    <select id="qrisk-family-history-cvd" name="family_history_cvd" class="form-control" required disabled>
                                         <option value="" selected>Auto-populated</option><option value="yes">Yes</option><option value="no">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-ckd-stage" class="form-check-label">Chronic Kidney Disease (*)</label>
                                    <select id="qrisk-ckd-stage" name="ckd_stage" class="form-control" required disabled>
                                        <option value="" selected>Auto-populated</option>
                                        <option value="no_ckd">No CKD / Stage 1-2</option>
                                        <option value="ckd_stage3">Stage 3</option>
                                        <option value="ckd_stage4_5">Stage 4 or 5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col"><div class="form-group"><label for="qrisk-atrial-fibrillation">Atrial Fibrillation? (*)</label><select id="qrisk-atrial-fibrillation" name="atrial_fibrillation" class="form-control" required disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                            <div class="col"><div class="form-group"><label for="qrisk-migraines">Migraines? (*)</label><select id="qrisk-migraines" name="migraines" class="form-control" required disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                        </div>
                        <div class="row">
                            <div class="col"><div class="form-group"><label for="qrisk-rheumatoid-arthritis">Rheumatoid Arthritis? (*)</label><select id="qrisk-rheumatoid-arthritis" name="rheumatoid_arthritis" class="form-control" required disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                            <div class="col"><div class="form-group"><label for="qrisk-sle">SLE? (*)</label><select id="qrisk-sle" name="sle" class="form-control" required disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                        </div>
                        <div class="row">
                            <div class="col"><div class="form-group"><label for="qrisk-severe-mental-illness">Severe Mental Illness? (*)</label><select id="qrisk-severe-mental-illness" name="severe_mental_illness" class="form-control" required disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                            <div class="col"><div class="form-group"><label for="qrisk-atypical-antipsychotics">On Atypical Antipsychotics? (*)</label><select id="qrisk-atypical-antipsychotics" name="atypical_antipsychotics" class="form-control" required disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                        </div>
                        <div class="row">
                            <div class="col"><div class="form-group"><label for="qrisk-regular-steroids">On Regular Steroid Tablets? (*)</label><select id="qrisk-regular-steroids" name="regular_steroids" class="form-control" required disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                            <div class="col dependency-target" id="qrisk-erectile-dysfunction-group-display" style="display:none;"><div class="form-group"><label for="qrisk-erectile-dysfunction">Erectile Dysfunction? (*)</label><select id="qrisk-erectile-dysfunction" name="erectile_dysfunction" class="form-control" disabled><option value="" selected>Auto</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                        </div>
                         <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="qrisk-lipoprotein-a" class="form-label">Lipoprotein(a) (Optional, for context)</label>
                                    <div class="input-group input-with-unit">
                                        <input type="number" id="qrisk-lipoprotein-a" name="lpa_qrisk" class="form-control" min="0" step="any" placeholder="Auto-populated (mg/dL)" data-validation-type="lpa" data-param-type="lpa">
                                        <span id="qrisk-lpa-unit-display" class="unit-display form-control-plaintext">mg/dL</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="calculate-qrisk3-button" class="button primary-button">Calculate QRISK®3</button>
                        <button type="reset" id="reset-qrisk3-form" class="button secondary-button">Reset QRISK®3 Form</button>
                    </div>
                    <div class="loading" id="qrisk-calculation-loading" style="display:none;">
                        <div class="loading-spinner"></div><p>Calculating QRISK3 Risk...</p>
                    </div>
                    <div id="qrisk3-results-container" class="results-section" style="display:none;" aria-live="polite">
                        </div>
                </form>
            </div>

            <div role="tabpanel" aria-labelledby="tab-combined-button" id="panel-combined" class="tab-content-panel">
                <div class="form-section">
                    <h2>Combined Risk Assessment & Comparison</h2>
                    <p>Compare Framingham Risk Score and QRISK®3 results side-by-side. Ensure both calculators have been run first for accurate comparison.</p>
                    <div id="combined-view-error" class="error-message form-level-error" style="display:none;" role="alert">Please calculate both FRS and QRISK3 scores first to enable this view.</div>
                    <div class="combined-status row">
                        <div class="col"><h3>Framingham Risk Score Status:</h3><div id="combined-frs-status-indicator" class="status-indicator incomplete">Not calculated</div></div>
                        <div class="col"><h3>QRISK3 Status:</h3><div id="combined-qrisk-status-indicator" class="status-indicator incomplete">Not calculated</div></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="update-combined-view-action-btn" class="button primary-button">Update Combined View</button>
                        <button type="button" id="export-combined-report-action-btn" class="button secondary-button" disabled>Export Combined Report (PDF)</button>
                    </div>
                    <div class="loading" id="combined-view-loading" style="display:none;"><div class="loading-spinner"></div><p>Updating Combined View...</p></div>
                    <div class="combined-results-container results-section" id="combined-results-display-area" style="display:none;" aria-live="polite">
                         </div>
                </div>
            </div>

            <div role="tabpanel" aria-labelledby="tab-recommendations-button" id="panel-recommendations" class="tab-content-panel">
                <div class="form-section">
                    <h2>Personalized Recommendations</h2>
                    <p>Based on the calculated risk scores and patient data, this section will provide guideline-based recommendations for lipid management, blood pressure control, and lifestyle modifications.</p>
                    <div id="recommendations-content-area" class="results-section" aria-live="polite">
                        <p><em>Calculate FRS or QRISK3 to generate recommendations.</em></p>
                    </div>
                </div>
            </div>

            <div role="tabpanel" aria-labelledby="tab-advanced-viz-button" id="panel-advanced-viz" class="tab-content-panel">
                <div class="form-section">
                    <h2>Advanced Risk Visualization</h2>
                    <p>Explore risk dynamics with interactive charts. Ensure a primary risk score (FRS or QRISK3) has been calculated first.</p>
                    <div id="advanced-viz-form-error" class="error-message form-level-error" style="display:none;" role="alert">Please calculate a base risk score first.</div>
                    <form id="advanced-viz-form" class="control-panel clinical-form">
                         <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="viz-calculator-select" class="form-label">Base Calculator for Visualization:</label>
                                    <select id="viz-calculator-select" name="vizCalculator" class="form-control">
                                        <option value="frs">Framingham Risk Score</option>
                                        <option value="qrisk">QRISK3</option>
                                        <option value="highest">Use Higher of FRS/QRISK3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="viz-type-select" class="form-label">Visualization Type:</label>
                                    <select id="viz-type-select" name="vizType" class="form-control">
                                        <option value="time-series">Risk Progression Over Time</option>
                                        <option value="risk-factors">Risk Factor Impact</option>
                                        <option value="treatment-effect">Treatment Effect Projection</option>
                                        <option value="sensitivity">Sensitivity Analysis</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="dynamic-viz-options-container">
                            </div>
                        <div class="form-actions">
                            <button type="button" id="generate-advanced-viz-action-btn" class="button primary-button">Generate Visualization</button>
                        </div>
                    </form>
                    <div class="loading" id="advanced-viz-generation-loading" style="display:none;"><div class="loading-spinner"></div><p>Generating Visualization...</p></div>
                    <div id="advanced-visualization-output-area" class="visualization-container chart-container" style="min-height: 400px; margin-top:1rem;" aria-live="polite">
                        <p class="text-center">Select options and click "Generate Visualization". Chart will appear here.</p>
                    </div>
                    <div id="advanced-visualization-details-area" class="results-section" style="margin-top:1rem;" aria-live="polite"></div>
                </div>
            </div>

             <div role="tabpanel" aria-labelledby="tab-history-button" id="panel-history" class="tab-content-panel">
                <div class="form-section">
                    <h2>Assessment History</h2>
                    <p>This section will display a list of previously saved assessments for this session or patient (if data persistence is implemented).</p>
                    <div id="assessment-history-list-area" class="results-section" aria-live="polite">
                        <p><em>No history available for the current session. Save an assessment to see it here.</em></p>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="clear-history-button" class="button danger-button">Clear Session History</button>
                    </div>
                </div>
            </div>

            <div role="tabpanel" aria-labelledby="tab-data-button" id="panel-data-io" class="tab-content-panel">
                <div class="form-section">
                    <h2>Patient Data Management</h2>
                    <p>Import, export, and manage patient data and assessment results securely.</p>
                    <div id="data-management-error" class="error-message form-level-error" style="display:none;" role="alert"></div>

                    <h3 id="import-data-heading">Import Patient Data</h3>
                    <form id="data-import-form" aria-labelledby="import-data-heading" class="clinical-form">
                        <div class="import-container row">
                            <div class="col"><div class="form-group"><label for="patient-data-import-file-input" class="form-label">Select File:</label><input type="file" id="patient-data-import-file-input" name="importFile" class="form-control" accept=".csv,.json,.xlsx" aria-required="true"></div></div>
                            <div class="col"><div class="form-group"><label for="import-file-format-select" class="form-label">Format:</label><select id="import-file-format-select" name="importFormat" class="form-control"><option value="auto">Auto-detect</option><option value="csv">CSV</option><option value="json">JSON</option><option value="xlsx">Excel (XLSX)</option></select></div></div>
                        </div>
                        <div class="data-validation-options form-group">
                            <h4>Data Validation & Security Options</h4>
                            <div class="form-check"><input type="checkbox" id="import-validate-data-types-check" name="validateDataTypes" class="form-check-input" checked><label for="import-validate-data-types-check" class="form-check-label">Validate Data Types</label></div>
                            <div class="form-check"><input type="checkbox" id="import-decrypt-data-check" name="decryptImportedData" class="form-check-input" data-conditional-input data-conditional-target="#import-decryption-options-group"><label for="import-decrypt-data-check" class="form-check-label">File is Encrypted</label></div>
                            <div id="import-decryption-options-group" class="form-group dependency-target" style="display: none; margin-top:0.5rem;"><label for="import-decryption-password-input" class="form-label">Decryption Password:</label><input type="password" id="import-decryption-password-input" name="importDecryptionPassword" class="form-control" data-validation-type="password" aria-label="Decryption password for import"></div>
                        </div>
                        <div class="form-actions"><button type="button" id="import-data-action-btn" class="button primary-button">Import Data</button></div>
                    </form>
                    <div class="loading" id="data-import-processing-loading" style="display:none;"><div class="loading-spinner"></div><p>Importing Data...</p></div>
                    <div id="import-status-message-area" class="status-message" role="status"></div>
                    <div id="data-preview-display-section" class="data-preview results-section" style="margin-top:1rem; display:none;"><h4>Data Preview (First 10 Records)</h4><div id="data-preview-content-table-area" class="table-responsive"></div></div>

                    <h3 style="margin-top: 2rem;" id="export-data-heading">Export Assessment Data</h3>
                    <form id="data-export-form" aria-labelledby="export-data-heading" class="clinical-form">
                        <div class="export-options row">
                            <div class="col"><div class="form-group"><label for="export-data-selection-options" class="form-label">Data to Export:</label><select id="export-data-selection-options" name="exportDataSelection" class="form-control"><option value="current_assessment_summary">Current Assessment Summary</option><option value="all_input_data">All Input Data (Medication & Labs)</option><option value="full_session_export">Full Session Export (All Data & Results)</option></select></div></div>
                            <div class="col"><div class="form-group"><label for="export-file-format-options" class="form-label">Export Format:</label><select id="export-file-format-options" name="exportFormat" class="form-control"><option value="json">JSON</option><option value="pdf">PDF Report</option><option value="csv">CSV</option></select></div></div>
                        </div>
                        <div class="form-group">
                            <div class="form-check"><input type="checkbox" id="export-encrypt-data-check" name="encryptExportedData" class="form-check-input" data-conditional-input data-conditional-target="#export-encryption-options-group"><label for="export-encrypt-data-check" class="form-check-label">Encrypt Exported Data (JSON only)</label></div>
                            <div id="export-encryption-options-group" class="dependency-target form-group" style="display: none; margin-top:0.5rem;"><label for="export-encryption-password-input" class="form-label">Encryption Password:</label><input type="password" id="export-encryption-password-input" name="exportEncryptionPassword" class="form-control" data-validation-type="password" aria-label="Encryption password for export"><small class="form-text text-muted">Required to decrypt. Ensure you remember this.</small></div>
                        </div>
                        <div class="form-actions"><button type="button" id="export-data-action-btn" class="button primary-button">Export Data</button></div>
                    </form>
                    <div class="loading" id="data-export-processing-loading" style="display:none;"><div class="loading-spinner"></div><p>Exporting Data...</p></div>
                    <div id="export-status-message-area" class="status-message" role="status"></div>
                </div>
                <div class="form-section">
                    <h3>EMR Integration</h3>
                    <p>Connect to Electronic Medical Record systems. (Requires setup via modal)</p>
                    <div class="integration-controls">
                        <button id="emr-pull-data-action-btn" class="button secondary-button" disabled>Pull Data from EMR</button>
                        <button id="emr-push-data-action-btn" class="button secondary-button" disabled>Push Results to EMR</button>
                        <button id="emr-configure-action-btn" class="button primary-button" data-modal-target="integration-setup-modal-main">Configure EMR/FHIR</button>
                    </div>
                    <div id="emr-status-message-area" class="status-message" role="status">Current Status: Not Configured.</div>
                </div>
            </div>

            <div role="tabpanel" aria-labelledby="tab-future-button" id="panel-future" class="tab-content-panel">
                 <div class="form-section">
                    <h2>Future Projects & Lipoprotein(a) Research Focus</h2>
                    <p>This section outlines planned enhancements and ongoing research, with a particular focus on understanding and quantifying the impact of Lipoprotein(a) [Lp(a)] on cardiovascular risk.</p>
                    <div class="feature-card">
                        <h3>Machine Learning for Lipoprotein(a) Risk Assessment</h3>
                        <span class="feature-status in-progress">Research Phase</span>
                        <p>Machine learning offers a powerful approach to unravel the complex role of Lipoprotein(a) in cardiovascular disease...</p>
                        <h4>Research Goals:</h4><ul><li>Utilize supervised learning...</li></ul>
                        <h4>Current Toolkit Integration & Lp(a) Input:</h4>
                        <p>This toolkit currently allows for the manual input of Lp(a) values...</p>
                         <div class="visualization-container chart-container" id="lpa-research-viz-placeholder" style="min-height: 200px; border-style: dashed; display:flex; align-items:center; justify-content:center;">
                            <p class="text-center"><i>Placeholder: Future interactive visualization on ML-derived Lp(a) risk.</i></p>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3 id="research-contact-heading">Research Collaboration & Feedback</h3>
                        <form id="research-contact-form" class="feedback-form clinical-form" aria-labelledby="research-contact-heading">
                            <div class="form-actions"><button type="button" class="button primary-button" id="contact-submit-action-btn">Submit Message</button></div>
                            <div id="contact-form-status-message" class="status-message" role="alert"></div>
                        </form>
                    </div>
                </div>
            </div>

            <div role="tabpanel" aria-labelledby="tab-settings-button" id="panel-settings" class="tab-content-panel">
                <div class="form-section">
                    <h2>Application Settings</h2>
                    <form id="app-settings-form" class="clinical-form">
                        <div class="row">
                            <div class="col"><div class="form-group"><label for="setting-region-select" class="form-label">Guideline Region:</label><select id="setting-region-select" name="region" class="form-control"><option value="CA">Canada (CCS)</option><option value="US">United States (ACC/AHA)</option></select></div></div>
                            <div class="col"><div class="form-group"><label for="setting-language-select" class="form-label">Display Language:</label><select id="setting-language-select" name="language" class="form-control"><option value="en">English</option></select></div></div>
                        </div>
                        <div class="row">
                            <div class="col"><div class="form-group form-check"><input type="checkbox" id="setting-dark-theme-check" name="useDarkTheme" class="form-check-input"><label for="setting-dark-theme-check" class="form-check-label">Enable Dark Theme</label></div></div>
                            <div class="col"><div class="form-group form-check"><input type="checkbox" id="setting-encrypt-storage-check" name="encryptLocalStorage" class="form-check-input"><label for="setting-encrypt-storage-check" class="form-check-label">Encrypt Locally Stored Data</label></div></div>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="save-settings-action-btn" class="button primary-button">Save Settings</button>
                            <button type="button" id="clear-all-data-action-btn" class="button danger-button">Clear All Stored Data & Reset</button>
                        </div>
                    </form>
                     <div id="settings-status-message-area" class="status-message" role="status" style="margin-top:1rem;"></div>
                </div>
            </div>

        </div> </main>

    <div id="error-notification-container" class="error-notification-container" role="alert" aria-live="assertive"></div>

    <template id="main-disclaimer-modal-template">
        <div class="modal disclaimer-dialog" role="dialog" aria-modal="true" aria-labelledby="main-disclaimer-title">
            <div class="modal-content modal-container"> <div class="modal-header">
                    <h2 class="modal-title-text" id="main-disclaimer-title">Important Medical Disclaimer</h2>
                    <button class="modal-close-button" aria-label="Close disclaimer modal">&times;</button>
                </div>
                <div class="modal-body modal-body-content"></div>
                <div class="modal-footer modal-footer-buttons">
                    <button class="button button-primary modal-accept-button" disabled>Accept & Continue</button>
                </div>
            </div>
        </div>
    </template>

    <template id="terms-modal-template">
         <div class="modal terms-dialog" role="dialog" aria-modal="true" aria-labelledby="terms-modal-title">
            <div class="modal-content modal-container">
                <div class="modal-header"><h2 class="modal-title-text" id="terms-modal-title">Terms of Use</h2><button class="modal-close-button" aria-label="Close Terms of Use">&times;</button></div>
                <div class="modal-body modal-body-content"><p>By using this CVD Risk Toolkit, you agree to...</p></div>
                <div class="modal-footer modal-footer-buttons"><button class="button button-secondary modal-close-button">Close</button></div>
            </div>
        </div>
    </template>

    <template id="results-template-cvd">
        <div class="results-output-container">
            <div class="results-header">
                <h3 class="results-title-text">Risk Assessment Results</h3>
                <div class="results-date-text"></div>
                <div class="results-actions-buttons">
                    <button class="button button-secondary results-print-btn" aria-label="Print results"><span class="icon-print" aria-hidden="true"></span>Print</button>
                    <button class="button button-secondary results-export-pdf-btn" aria-label="Export results as PDF"><span class="icon-export" aria-hidden="true"></span>Export PDF</button>
                </div>
            </div>
            <div class="results-body-content row">
                <div class="results-column col">
                    <div class="result-item"><div class="result-label">10-Year CVD Risk:</div><div class="result-value base-risk-value">N/A</div></div>
                    <div class="result-item risk-points-display" style="display: none;"><div class="result-label">FRS Risk Points:</div><div class="result-value risk-points-value">N/A</div></div>
                    <div class="result-item relative-risk-display" style="display: none;"><div class="result-label">Relative Risk:</div><div class="result-value relative-risk-value">N/A</div></div>
                    <div class="result-item heart-age-display" style="display: none;"><div class="result-label">Heart Age:</div><div class="result-value heart-age-value">N/A</div></div>
                    <div class="result-item"><div class="result-label">Risk Category:</div><div class="result-value risk-category-text">N/A</div></div>
                </div>
                <div class="results-column col">
                    <div class="chart-container"><canvas class="risk-chart-canvas"></canvas></div>
                </div>
            </div>
            <div class="results-footer-content"><div class="recommended-treatment-section"><h4>Recommended Treatment:</h4><div class="treatment-primary-text"><p>Recommendations will appear here.</p></div></div></div>
        </div>
    </template>
    
    <template id="medication-evaluation-results-template"> </template>
    <template id="comparison-view-results-template"> </template>
    <template id="integration-setup-modal-template"> </template> <template id="error-correction-modal-template"> </template>


    <footer class="app-footer">
        <div class="container">
            <p>&copy; <span id="current-year">2025</span> Enhanced CVD Risk Assessment Team. For clinical use by healthcare professionals.</p>
            <div class="footer-links">
                <a href="#" id="footer-show-terms-link" class="disclaimer-link" data-modal-target="terms-modal" data-disclaimer-key="termsOfService">Terms of Use</a>
                <a href="#" id="footer-show-clinical-disclaimer-link" class="disclaimer-link" data-modal-target="main-disclaimer-modal" data-disclaimer-key="mainAppDisclaimer">Clinical Disclaimer</a>
                </div>
            <p class="footer-note">Version: <span class="version-badge">v5.0</span>. Based on CCS 2021, FRS 2008, QRISK3-2017/2018.</p>
        </div>
    </footer>

    <script src="js/main.js" type="module" defer></script>
    <script>
        // Service Worker Registration (from Uploaded Index)
        if ('serviceWorker' in navigator && window.ENABLE_SERVICE_WORKER === true) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js', { scope: './' }) // Assuming service-worker.js is at root
                    .then(registration => console.log('ServiceWorker: Registration successful with scope: ', registration.scope))
                    .catch(error => console.error('ServiceWorker: Registration failed: ', error));
            });
        } else {
            console.info('Service Worker not registered (ENABLE_SERVICE_WORKER is false or navigator.serviceWorker not supported).');
        }
    </script>
</body>
</html>