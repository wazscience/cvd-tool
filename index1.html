9800; }
                    .high { background-color: #F44336; }
                    .risk-value { font-size: 24px; font-weight: bold; }
                    .results-meta { display: flex; gap: 15px; margin-bottom: 10px; }
                    .meta-item { display: flex; align-items: center; gap: 5px; }
                    .risk-visualization { margin: 15px 0; }
                    .risk-gauge { position: relative; height: 120px; margin: 20px 0; }
                    .gauge-value { position: absolute; left: 0; right: 0; top: 0; text-align: center; }
                    .gauge-scale { position: absolute; bottom: 0; left: 0; right: 0; height: 10px; background: linear-gradient(to right, #4CAF50, #FFC107, #F44336); border-radius: 5px; }
                    .scale-marker { position: absolute; top: -25px; transform: translateX(-50%); }
                    .risk-details { margin: 15px 0; }
                    .results-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
                    .results-label { font-weight: bold; }
                    .recommendations-content { margin-top: 15px; }
                    .recommendation-item { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; }
                    .recommendation-title { margin-top: 0; }
                    .lipid-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                    .table-header, .table-row { display: flex; }
                    .table-cell { flex: 1; padding: 8px; border: 1px solid #ddd; }
                    .table-header .table-cell { font-weight: bold; background: #f5f5f5; }
                    .target-met { color: #4CAF50; }
                    .target-not-met { color: #F44336; }
                    @media print {
                        body { background-color: white; }
                        .results-card { break-inside: avoid; }
                    }
                </style>
            </head>
            <body>
                ${content.innerHTML}
            </body>
            </html>
        `);
        iframeDocument.close();
        
        // Use external PDF generation library (html2pdf.js)
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        script.onload = function() {
            const element = iframe.contentWindow.document.body;
            const opt = {
                margin: 10,
                filename: 'cvd_risk_assessment_' + new Date().toISOString().slice(0, 10) + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // Generate PDF
            iframe.contentWindow.html2pdf().from(element).set(opt).save().then(() => {
                // Restore button text
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
                
                // Clean up
                document.body.removeChild(iframe);
                
                // Close modal
                closeModal(document.getElementById('pdf-preview-modal'));
            });
        };
        
        // Handle script load error
        script.onerror = function() {
            downloadBtn.innerHTML = originalText;
            downloadBtn.disabled = false;
            document.body.removeChild(iframe);
            showModal('Error loading PDF generation library. Please try again later or use the Print function instead.');
        };
        
        // Append script to iframe
        iframe.contentWindow.document.head.appendChild(script);
    }
    
    /***********************************
     * JUNO EMR INTEGRATION FUNCTIONS
     ***********************************/
    
    /**
     * Check if Juno EMR integration is available
     */
    function checkJunoIntegration() {
        try {
            // Check if window.JUNO is available
            if (typeof window.JUNO !== 'undefined') {
                console.log("Juno EMR integration available");
                setupJunoIntegration();
            } else {
                // Check if we're running in a Juno iframe
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'JUNO_READY') {
                        console.log("Juno EMR integration available via postMessage");
                        setupJunoIntegration();
                    }
                });
            }
        } catch (error) {
            console.log("Juno EMR integration not available", error);
        }
    }
    
    /**
     * Set up Juno EMR integration features
     */
    function setupJunoIntegration() {
        // Add Juno integration indicator
        const headerActions = document.querySelector('.header-actions');
        if (headerActions) {
            const junoIndicator = document.createElement('div');
            junoIndicator.className = 'juno-indicator';
            junoIndicator.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span>Juno EMR</span>
            `;
            headerActions.insertBefore(junoIndicator, headerActions.firstChild);
        }
        
        // Add patient information retrieval
        const resultsHeader = document.querySelector('.results-meta');
        if (resultsHeader) {
            const patientInfo = document.createElement('div');
            patientInfo.className = 'meta-item';
            patientInfo.id = 'juno-patient-info';
            patientInfo.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span>Loading patient info...</span>
            `;
            resultsHeader.appendChild(patientInfo);
            
            // Fetch patient information
            fetchJunoPatientInfo();
        }
        
        // Add export to Juno button
        const exportSection = document.querySelector('.export-buttons');
        if (exportSection) {
            const exportToJunoBtn = document.createElement('button');
            exportToJunoBtn.type = 'button';
            exportToJunoBtn.id = 'export-to-juno';
            exportToJunoBtn.className = 'export-btn';
            exportToJunoBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                Save to Juno EMR
            `;
            exportToJunoBtn.addEventListener('click', saveToJunoEMR);
            exportSection.appendChild(exportToJunoBtn);
        }
        
        // Add laboratory data retrieval
        setupJunoLabDataRetrieval();
    }
    
    /**
     * Fetch patient information from Juno EMR
     */
    function fetchJunoPatientInfo() {
        try {
            if (typeof window.JUNO !== 'undefined' && window.JUNO.getPatient) {
                window.JUNO.getPatient().then(patient => {
                    displayJunoPatientInfo(patient);
                }).catch(error => {
                    console.error('Error fetching Juno patient information:', error);
                    document.getElementById('juno-patient-info').querySelector('span').textContent = 'Patient: Unknown';
                });
            } else {
                // Try postMessage API
                window.parent.postMessage({ type: 'JUNO_GET_PATIENT' }, '*');
                
                // Set up listener for response
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'JUNO_PATIENT_INFO') {
                        displayJunoPatientInfo(event.data.patient);
                    }
                });
            }
        } catch (error) {
            console.error('Error fetching Juno patient information:', error);
            document.getElementById('juno-patient-info').querySelector('span').textContent = 'Patient: Unknown';
        }
    }
    
    /**
     * Display patient information from Juno
     * @param {Object} patient - Patient information object
     */
    function displayJunoPatientInfo(patient) {
        const patientInfoElement = document.getElementById('juno-patient-info');
        if (patientInfoElement && patient) {
            // Format name and ID
            const patientName = `${patient.lastName}, ${patient.firstName}`;
            const patientId = patient.id || patient.emrId || '';
            
            patientInfoElement.querySelector('span').textContent = `${patientName} (${patientId})`;
            
            // Store patient info for other functions
            appState.junoPatient = patient;
            
            // Pre-fill form fields if available
            if (patient.age) {
                const ageInputs = document.querySelectorAll('[id$="-age"]');
                ageInputs.forEach(input => {
                    if (!input.value) input.value = patient.age;
                });
            }
            
            if (patient.sex) {
                const sexSelects = document.querySelectorAll('[id$="-sex"]');
                sexSelects.forEach(select => {
                    if (!select.value) select.value = patient.sex.toLowerCase();
                });
            }
            
            // If height and weight are available
            if (patient.height) {
                const heightInputs = document.querySelectorAll('[id$="-height"]');
                heightInputs.forEach(input => {
                    if (!input.value) input.value = patient.height;
                });
            }
            
            if (patient.weight) {
                const weightInputs = document.querySelectorAll('[id$="-weight"]');
                weightInputs.forEach(input => {
                    if (!input.value) input.value = patient.weight;
                });
            }
            
            // If BMI is available for QRISK form
            if (patient.bmi || (patient.height && patient.weight)) {
                const bmi = patient.bmi || calculateBMI(patient.height, patient.weight);
                if (bmi) {
                    document.getElementById('qrisk-bmi-display').value = formatBMI(bmi);
                    document.getElementById('qrisk-bmi').value = bmi.toFixed(1);
                }
            }
        }
    }
    
    /**
     * Set up Juno laboratory data retrieval
     */
    function setupJunoLabDataRetrieval() {
        try {
            // Add lab data buttons to forms
            addJunoLabDataButton('frs-form', 'Fetch Lab Data');
            addJunoLabDataButton('qrisk-form', 'Fetch Lab Data');
            addJunoLabDataButton('medication-form', 'Fetch Lab Data');
        } catch (error) {
            console.error('Error setting up Juno lab data retrieval:', error);
        }
    }
    
    /**
     * Add a Juno lab data button to a form
     * @param {string} formId - ID of the form
     * @param {string} buttonText - Text for the button
     */
    function addJunoLabDataButton(formId, buttonText) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        // Find the lipid profile card
        const lipidCards = form.querySelectorAll('.card');
        let lipidCard = null;
        
        lipidCards.forEach(card => {
            const header = card.querySelector('.card-header');
            if (header && header.textContent.includes('Lipid Profile')) {
                lipidCard = card;
            }
        });
        
        if (!lipidCard) return;
        
        // Check if button already exists
        if (lipidCard.querySelector('.juno-lab-data-btn')) return;
        
        // Create and add the button
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'juno-lab-data-btn';
        button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
            ${buttonText}
        `;
        
        // Add event listener
        button.addEventListener('click', function() {
            fetchJunoLabData(formId);
        });
        
        // Add to card header
        const cardHeader = lipidCard.querySelector('.card-header');
        cardHeader.appendChild(button);
    }
    
    /**
     * Fetch laboratory data from Juno EMR
     * @param {string} formId - ID of the form to populate
     */
    function fetchJunoLabData(formId) {
        try {
            // Show loading indicator
            showLoading();
            
            // Define lab codes to retrieve
            const labCodes = {
                'CHOL': 'total-chol',
                'HDL': 'hdl',
                'LDL': 'ldl',
                'TRIG': 'trig',
                'APOB': 'apob',
                'LP(A)': 'lpa',
                'LPA': 'lpa',
                'NON-HDL': 'non-hdl',
                'SBP': 'sbp'
            };
            
            if (typeof window.JUNO !== 'undefined' && window.JUNO.getRecentLabs) {
                window.JUNO.getRecentLabs(Object.keys(labCodes)).then(labs => {
                    populateLabData(formId, labs, labCodes);
                    hideLoading();
                }).catch(error => {
                    console.error('Error fetching Juno lab data:', error);
                    hideLoading();
                    showModal('Error fetching laboratory data from Juno EMR.');
                });
            } else {
                // Try postMessage API
                window.parent.postMessage({
                    type: 'JUNO_GET_RECENT_LABS',
                    labCodes: Object.keys(labCodes)
                }, '*');
                
                // Set up listener for response
                const messageHandler = function(event) {
                    if (event.data && event.data.type === 'JUNO_LAB_RESULTS') {
                        // Remove this specific listener to avoid duplicates
                        window.removeEventListener('message', messageHandler);
                        
                        populateLabData(formId, event.data.labs, labCodes);
                        hideLoading();
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                // Set timeout for loading
                setTimeout(() => {
                    hideLoading();
                }, 5000);
            }
        } catch (error) {
            console.error('Error fetching Juno lab data:', error);
            hideLoading();
            showModal('Error fetching laboratory data from Juno EMR.');
        }
    }
    
    /**
     * Populate form with laboratory data
     * @param {string} formId - ID of the form to populate
     * @param {Array} labs - Array of laboratory results
     * @param {Object} labCodes - Mapping of lab codes to form field names
     */
    function populateLabData(formId, labs, labCodes) {
        if (!labs || labs.length === 0) {
            showModal('No recent laboratory data found in Juno EMR.');
            return;
        }
        
        const prefix = formId.split('-')[0];
        let dataLoaded = false;
        
        // Process each lab result
        labs.forEach(lab => {
            const fieldName = labCodes[lab.code];
            if (!fieldName) return;
            
            const valueInput = document.getElementById(`${prefix}-${fieldName}`);
            const unitSelect = document.getElementById(`${prefix}-${fieldName}-unit`);
            
            if (valueInput) {
                valueInput.value = lab.value;
                dataLoaded = true;
                
                // If unit is provided and unitSelect exists, set the unit
                if (lab.unit && unitSelect) {
                    if (lab.unit === 'mg/dL' || lab.unit === 'mmol/L') {
                        unitSelect.value = lab.unit;
                    }
                }
                
                // Trigger input event to update any calculated fields
                valueInput.dispatchEvent(new Event('input'));
            }
        });
        
        if (dataLoaded) {
            showNotification('Laboratory data successfully loaded from Juno EMR.', 'success');
        } else {
            showModal('No applicable laboratory data found in Juno EMR.');
        }
    }
    
    /**
     * Save results to Juno EMR
     */
    function saveToJunoEMR() {
        try {
            // Get results container
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer || resultsContainer.style.display === 'none') {
                showModal('No results to save. Please calculate risk scores first.');
                return;
            }
            
            // Prepare data to save
            const resultCards = document.querySelectorAll('.result-card-wrapper');
            if (resultCards.length === 0) {
                showModal('No results to save.');
                return;
            }
            
            // Create structured data for saving
            const saveData = {
                type: 'CVD_RISK_ASSESSMENT',
                date: new Date().toISOString(),
                results: []
            };
            
            // Process each result card
            resultCards.forEach(card => {
                const titleElement = card.querySelector('.risk-title');
                if (!titleElement) return;
                
                const resultType = titleElement.textContent;
                
                if (resultType.includes('Framingham')) {
                    saveData.results.push({
                        assessmentType: 'FRS',
                        baseRisk: parseFloat(card.querySelector('.base-risk').textContent),
                        modifiedRisk: parseFloat(card.querySelector('.adjusted-risk').textContent),
                        riskCategory: card.querySelector('.risk-category').textContent,
                        lpaModifier: card.querySelector('.lpa-modifier') ? 
                            parseFloat(card.querySelector('.lpa-modifier').textContent) : 1.0
                    });
                } else if (resultType.includes('QRISK')) {
                    saveData.results.push({
                        assessmentType: 'QRISK3',
                        baseRisk: parseFloat(card.querySelector('.base-risk').textContent),
                        modifiedRisk: parseFloat(card.querySelector('.adjusted-risk').textContent),
                        riskCategory: card.querySelector('.risk-category').textContent,
                        lpaModifier: card.querySelector('.lpa-modifier') ? 
                            parseFloat(card.querySelector('.lpa-modifier').textContent) : 1.0
                    });
                } else if (resultType.includes('Comparison')) {
                    saveData.results.push({
                        assessmentType: 'COMPARISON',
                        frsRisk: parseFloat(card.querySelector('#compare-frs-adjusted').textContent),
                        qriskRisk: parseFloat(card.querySelector('#compare-qrisk-adjusted').textContent),
                        interpretation: card.querySelector('#comparison-interpretation').textContent
                    });
                } else if (resultType.includes('Therapy')) {
                    const lipidRows = card.querySelectorAll('.lipid-table .table-row');
                    const lipidValues = {};
                    
                    lipidRows.forEach(row => {
                        const cells = row.querySelectorAll('.table-cell');
                        if (cells.length >= 2) {
                            const paramName = cells[0].textContent.trim().replace(/\s+/g, '_').toLowerCase();
                            lipidValues[paramName] = cells[1].textContent;
                        }
                    });
                    
                    const recommendations = [];
                    const recItems = card.querySelectorAll('.recommendations-summary li');
                    recItems.forEach(item => {
                        recommendations.push(item.textContent);
                    });
                    
                    saveData.results.push({
                        assessmentType: 'MEDICATION',
                        lipidValues: lipidValues,
                        recommendations: recommendations
                    });
                }
            });
            
            // Save to Juno EMR
            if (typeof window.JUNO !== 'undefined' && window.JUNO.saveAssessment) {
                window.JUNO.saveAssessment(saveData).then(() => {
                    showNotification('Results successfully saved to Juno EMR.', 'success');
                }).catch(error => {
                    console.error('Error saving to Juno EMR:', error);
                    showModal('Error saving results to Juno EMR.');
                });
            } else {
                // Try postMessage API
                window.parent.postMessage({
                    type: 'JUNO_SAVE_ASSESSMENT',
                    assessment: saveData
                }, '*');
                
                // Set up listener for response
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'JUNO_SAVE_RESULT') {
                        if (event.data.success) {
                            showNotification('Results successfully saved to Juno EMR.', 'success');
                        } else {
                            showModal('Error saving results to Juno EMR: ' + event.data.error);
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error saving to Juno EMR:', error);
            showModal('Error saving results to Juno EMR.');
        }
    }
    
    /***********************************
     * UNIT CONVERSION SETUP
     ***********************************/
    
    /**
     * Set up unit conversion handlers
     */
    function setupUnitConversions() {
        // Setup cholesterol unit conversion
        setupCholesterolUnitConversion();
        
        // Setup height unit toggle
        setupHeightToggle();
        
        // Setup weight unit conversion
        setupWeightUnitConversion();
        
        // Setup Lp(a) unit conversion
        setupLpaUnitConversion();
        
        // Setup BMI calculation
        setupBMICalculation();
    }
    
    /**
     * Set up cholesterol unit conversions
     */
    function setupCholesterolUnitConversion() {
        // Get all cholesterol unit selectors
        const cholUnitSelectors = document.querySelectorAll('[id$="-chol-unit"], [id$="-ldl-unit"], [id$="-hdl-unit"]');
        
        cholUnitSelectors.forEach(selector => {
            selector.addEventListener('change', function() {
                // Get the associated input field
                const inputId = this.id.replace('-unit', '');
                const input = document.getElementById(inputId);
                
                if (!input || !input.value) return;
                
                // Get the current and new units
                const currentUnit = this.value;
                const oldUnit = currentUnit === 'mmol/L' ? 'mg/dL' : 'mmol/L';
                
                // Convert the value
                const currentValue = parseFloat(input.value);
                const convertedValue = convertCholesterol(currentValue, oldUnit, currentUnit);
                
                // Update the input value
                input.value = convertedValue.toFixed(2);
                
                // Trigger input event to update any calculated fields
                input.dispatchEvent(new Event('input'));
            });
        });
    }
    
    /**
     * Set up weight unit conversion
     */
    function setupWeightUnitConversion() {
        // Get all weight unit selectors
        const weightUnitSelectors = document.querySelectorAll('[id$="-weight-unit"]');
        
        weightUnitSelectors.forEach(selector => {
            selector.addEventListener('change', function() {
                // Get the associated input field
                const inputId = this.id.replace('-unit', '');
                const input = document.getElementById(inputId);
                
                if (!input || !input.value) return;
                
                // Get the current and new units
                const currentUnit = this.value;
                const oldUnit = currentUnit === 'kg' ? 'lb' : 'kg';
                
                // Convert the value
                const currentValue = parseFloat(input.value);
                let convertedValue;
                
                if (currentUnit === 'kg') {
                    // Convert from lb to kg
                    convertedValue = convertWeightToKg(currentValue);
                } else {
                    // Convert from kg to lb
                    convertedValue = currentValue / 0.45359237;
                }
                
                // Update the input value
                input.value = convertedValue.toFixed(1);
                
                // Trigger input event to update any calculated fields
                input.dispatchEvent(new Event('input'));
            });
        });
    }
    
    /**
     * Set up Lp(a) unit conversion
     */
    function setupLpaUnitConversion() {
        // Get all Lp(a) unit selectors
        const lpaUnitSelectors = document.querySelectorAll('[id$="-lpa-unit"]');
        
        lpaUnitSelectors.forEach(selector => {
            selector.addEventListener('change', function() {
                // Get the associated input field
                const inputId = this.id.replace('-unit', '');
                const input = document.getElementById(inputId);
                
                if (!input || !input.value) return;
                
                // Get the current and new units
                const currentUnit = this.value;
                const oldUnit = currentUnit === 'mg/dL' ? 'nmol/L' : 'mg/dL';
                
                // Convert the value
                const currentValue = parseFloat(input.value);
                const convertedValue = convertLpa(currentValue, oldUnit, currentUnit);
                
                // Update the input value
                input.value = convertedValue.toFixed(0);
            });
        });
    }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            try {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(error) {
                        // Check if it's a security error (sandboxed environment)
                        if (error.name === 'SecurityError') {
                            console.log('Service Worker registration not available in this environment');
                        } else {
                            console.error('Service Worker registration failed:', error);
                        }
                    });
            } catch (e) {
                // Handle any exceptions that might occur when checking for service worker support
                console.log('Service Worker registration attempted but not supported in this environment');
            }
        });
    }
    </script>
    
    <!-- Inline Service Worker Code (for cases where the separate file can't be accessed) -->
    <script>
    // This is the code from service-worker.js, included inline as a fallback
    // It will be used to create a blob URL if the external file fails to load
    const serviceWorkerCode = `
        /* eslint-env serviceworker */
        const CACHE_NAME = 'cvd-toolkit-v1';
        const urlsToCache = [
            '/',
            '/index.html',
            '/styles.css',
            '/combined.js',
            '/js/validation.js',
            '/js/calculations.js',
            '/js/medication.js',
            '/js/ui.js'
        ];

        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(CACHE_NAME)
                    .then(cache => cache.addAll(urlsToCache))
            );
        });

        self.addEventListener('fetch', event => {
            event.respondWith(
                caches.match(event.request)
                    .then(response => response || fetch(event.request))
            );
        });
    `;

    // Function to register a service worker from a blob URL if the external file fails
    function registerServiceWorkerFromBlob() {
        try {
            const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const blobURL = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(blobURL)
                .then(registration => {
                    console.log('Service Worker registered from blob with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration from blob failed:', error);
                })
                .finally(() => {
                    // Clean up the blob URL
                    URL.revokeObjectURL(blobURL);
                });
        } catch (e) {
            console.log('Blob Service Worker registration not supported in this environment');
        }
    }

    // Add an event listener to try the blob approach if the external file fails
    window.addEventListener('error', function(event) {
        if (event.target.tagName === 'SCRIPT' && 
            event.target.src && 
            event.target.src.includes('service-worker.js')) {
            console.log('Attempting to register service worker from blob');
            registerServiceWorkerFromBlob();
        }
    }, true);
    </script>
</body>
</html>
String();
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    /**
     * Display comparison results in the results section
     * @param {Object} frsData - FRS input data
     * @param {Object} frsResults - FRS calculation results
     * @param {Object} qriskData - QRISK input data
     * @param {Object} qriskResults - QRISK calculation results
     * @param {string} recommendations - HTML-formatted treatment recommendations
     */
    function displayComparisonResults(frsData, frsResults, qriskData, qriskResults, recommendations) {
        const resultsContainer = document.getElementById('results-container');
        const resultsDiv = document.getElementById('risk-results');
        
        if (!resultsContainer || !resultsDiv) {
            console.error('Results container not found');
            return;
        }
        
        // Get comparison template
        const template = document.getElementById('comparison-risk-template');
        if (!template) {
            console.error('Comparison template not found');
            return;
        }
        
        // Create a new results card (don't clear previous results)
        const resultCard = template.content.cloneNode(true);
        
        // Fill in comparison table
        resultCard.querySelector('#compare-frs-base').textContent = `${frsResults.baseRisk.toFixed(1)}%`;
        resultCard.querySelector('#compare-qrisk-base').textContent = `${qriskResults.baseRisk.toFixed(1)}%`;
        
        resultCard.querySelector('#compare-frs-lpa').textContent = `${frsResults.lpaModifier.toFixed(1)}x`;
        resultCard.querySelector('#compare-qrisk-lpa').textContent = `${qriskResults.lpaModifier.toFixed(1)}x`;
        
        resultCard.querySelector('#compare-frs-adjusted').textContent = `${frsResults.modifiedRisk.toFixed(1)}%`;
        resultCard.querySelector('#compare-qrisk-adjusted').textContent = `${qriskResults.modifiedRisk.toFixed(1)}%`;
        
        resultCard.querySelector('#compare-frs-category').textContent = frsResults.riskCategory.charAt(0).toUpperCase() + frsResults.riskCategory.slice(1);
        resultCard.querySelector('#compare-qrisk-category').textContent = qriskResults.riskCategory.charAt(0).toUpperCase() + qriskResults.riskCategory.slice(1);
        
        // Set clinical interpretation
        const difference = Math.abs(frsResults.modifiedRisk - qriskResults.modifiedRisk);
        const percentDifference = (difference / ((frsResults.modifiedRisk + qriskResults.modifiedRisk) / 2)) * 100;
        
        let interpretationText = '';
        if (percentDifference < 10) {
            interpretationText = `The Framingham Risk Score and QRISK3 provide similar risk estimates (${frsResults.modifiedRisk.toFixed(1)}% vs ${qriskResults.modifiedRisk.toFixed(1)}%), suggesting a consistent risk assessment.`;
        } else if (percentDifference < 30) {
            interpretationText = `There is a moderate difference between the Framingham Risk Score (${frsResults.modifiedRisk.toFixed(1)}%) and QRISK3 (${qriskResults.modifiedRisk.toFixed(1)}%). This may be due to the additional factors considered in QRISK3 or differences in the underlying populations used to develop these scores.`;
        } else {
            interpretationText = `There is a substantial difference between the Framingham Risk Score (${frsResults.modifiedRisk.toFixed(1)}%) and QRISK3 (${qriskResults.modifiedRisk.toFixed(1)}%). This significant variation suggests that the additional factors considered in QRISK3 (such as ethnicity, family history, or medical conditions) may have a major impact on this individual's risk assessment.`;
        }
        
        // Add which score is higher
        if (frsResults.modifiedRisk > qriskResults.modifiedRisk) {
            interpretationText += ` The Framingham Risk Score gives a higher risk estimate, which may be more conservative for treatment decisions.`;
        } else if (qriskResults.modifiedRisk > frsResults.modifiedRisk) {
            interpretationText += ` QRISK3 gives a higher risk estimate, which may account for additional risk factors not captured in the Framingham score.`;
        }
        
        // Add treatment considerations
        interpretationText += ` Based on the higher risk score of ${Math.max(frsResults.modifiedRisk, qriskResults.modifiedRisk).toFixed(1)}%, this patient falls into the ${Math.max(frsResults.modifiedRisk, qriskResults.modifiedRisk) >= 20 ? 'high' : (Math.max(frsResults.modifiedRisk, qriskResults.modifiedRisk) >= 10 ? 'intermediate' : 'low')} risk category for treatment considerations.`;
        
        // Set interpretation
        resultCard.querySelector('#comparison-interpretation').textContent = interpretationText;
        
        // Create comparison chart
        const chartContainer = resultCard.querySelector('#comparison-chart-container');
        
        // Create simple HTML/CSS chart
        chartContainer.innerHTML = `
            <div class="comparison-bars">
                <div class="chart-bar-container">
                    <div class="chart-label">Framingham</div>
                    <div class="chart-bar-wrapper">
                        <div class="chart-bar frs-bar" style="height: ${Math.min(frsResults.modifiedRisk * 2, 100)}%;">
                            <span class="chart-value">${frsResults.modifiedRisk.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
                <div class="chart-bar-container">
                    <div class="chart-label">QRISK3</div>
                    <div class="chart-bar-wrapper">
                        <div class="chart-bar qrisk-bar" style="height: ${Math.min(qriskResults.modifiedRisk * 2, 100)}%;">
                            <span class="chart-value">${qriskResults.modifiedRisk.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-axis">
                <div class="axis-label">0%</div>
                <div class="axis-line"></div>
                <div class="axis-marker" style="bottom: 20%;">10%</div>
                <div class="axis-marker" style="bottom: 40%;">20%</div>
                <div class="axis-marker" style="bottom: 60%;">30%</div>
                <div class="axis-marker" style="bottom: 80%;">40%</div>
                <div class="axis-marker" style="bottom: 100%;">50%+</div>
            </div>
        `;
        
        // Add to results - prepend to show newest result at top
        const timestamp = new Date();
        const resultCardElement = document.createElement('div');
        resultCardElement.className = 'result-card-wrapper';
        resultCardElement.innerHTML = `<div class="result-timestamp">Calculated on ${timestamp.toLocaleString()}</div>`;
        resultCardElement.appendChild(resultCard);
        resultsDiv.insertBefore(resultCardElement, resultsDiv.firstChild);
        
        // Show treatment recommendations
        document.getElementById('recommendations-content').innerHTML = recommendations;
        
        // Set date and show results container
        document.querySelector('#results-date span').textContent = new Date().toLocaleDateString();
        resultsContainer.style.display = 'block';
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    /**
     * Evaluate medications and generate recommendations
     * @param {Object} data - Validated data from the medication form
     */
    function evaluateMedications(data) {
        // Standardize units
        const standardizedData = standardizeUnits(data);
        
        // Determine target levels based on risk category
        const targetLevels = determineTargetLevels(standardizedData);
        
        // Assess current therapy and determine gaps
        const assessment = assessCurrentTherapy(standardizedData, targetLevels);
        
        // Generate recommendations
        const recommendations = generateMedicationRecommendations(standardizedData, assessment, targetLevels);
        
        // Check PCSK9 inhibitor eligibility for PharmaCare
        const pcsk9Coverage = assessPCSK9Coverage(standardizedData, assessment);
        
        // Display results
        displayMedicationResults(standardizedData, assessment, targetLevels, recommendations, pcsk9Coverage);
    }
    
    /**
     * Standardize units for all measurements to mmol/L
     * @param {Object} data - Raw form data
     * @returns {Object} - Data with standardized units
     */
    function standardizeUnits(data) {
        const standardized = { ...data };
        
        // Convert cholesterol values to mmol/L if needed
        const cholesterolFields = ['total-chol', 'ldl', 'hdl', 'non-hdl'];
        cholesterolFields.forEach(field => {
            if (data[field] !== null && data[field] !== undefined) {
                if (data[field + '-unit'] === 'mg/dL') {
                    standardized[field] = convertCholesterol(data[field], 'mg/dL', 'mmol/L');
                    standardized[field + '-unit'] = 'mmol/L';
                }
            }
        });
        
        // Convert triglycerides to mmol/L if needed
        if (data['trig'] !== null && data['trig'] !== undefined) {
            if (data['trig-unit'] === 'mg/dL') {
                standardized['trig'] = data['trig'] / 88.5; // Conversion factor for triglycerides
                standardized['trig-unit'] = 'mmol/L';
            }
        }
        
        // Convert ApoB to g/L if needed
        if (data['apob'] !== null && data['apob'] !== undefined) {
            if (data['apob-unit'] === 'mg/dL') {
                standardized['apob'] = data['apob'] / 100; // Conversion factor for ApoB
                standardized['apob-unit'] = 'g/L';
            }
        }
        
        // Convert Lp(a) to mg/dL if needed
        if (data['lpa'] !== null && data['lpa'] !== undefined) {
            if (data['lpa-unit'] === 'nmol/L') {
                standardized['lpa'] = convertLpa(data['lpa'], 'nmol/L', 'mg/dL');
                standardized['lpa-unit'] = 'mg/dL';
            }
        }
        
        return standardized;
    }
    
    /**
     * Determine target LDL and non-HDL levels based on risk category
     * @param {Object} data - Standardized patient data
     * @returns {Object} - Target levels
     */
    function determineTargetLevels(data) {
        const targets = {};
        
        // Determine targets based on clinical guidelines
        if (data.preventionCategory === 'secondary') {
            // Secondary prevention targets
            targets.ldl = { value: 1.8, unit: 'mmol/L' };
            targets.nonHDL = { value: 2.6, unit: 'mmol/L' };
            targets.apoB = { value: 0.8, unit: 'g/L' };
            targets.percentReduction = 50;
            targets.riskCategory = 'Very High Risk';
            
            // Even lower targets for recent ACS or multiple events
            if (data.secondaryDetails === 'mi' || data.secondaryDetails === 'multi') {
                targets.ldl = { value: 1.4, unit: 'mmol/L' };
                targets.nonHDL = { value: 2.2, unit: 'mmol/L' };
                targets.apoB = { value: 0.65, unit: 'g/L' };
                targets.percentReduction = 50;
                targets.riskCategory = 'Extreme Risk';
            }
        } else {
            // Primary prevention - check if risk scores are available
            let highestRisk = 0;
            
            // Try to get risk from session storage (cross-tab sharing)
            const storedRisk = sessionStorage.getItem('last-risk-score');
            if (storedRisk !== null) {
                highestRisk = parseFloat(storedRisk);
            } else {
                // Try to extract risk score from results if available
                const riskContainer = document.getElementById('risk-results');
                if (riskContainer) {
                    const riskValueElements = riskContainer.querySelectorAll('.risk-value');
                    riskValueElements.forEach(element => {
                        const riskText = element.textContent;
                        const riskMatch = riskText.match(/(\d+\.\d+)%/);
                        if (riskMatch) {
                            const riskValue = parseFloat(riskMatch[1]);
                            highestRisk = Math.max(highestRisk, riskValue);
                        }
                    });
                }
            }
            
            // Set targets based on risk score
            if (highestRisk >= 20) {
                // High risk primary prevention
                targets.ldl = { value: 2.0, unit: 'mmol/L' };
                targets.nonHDL = { value: 2.6, unit: 'mmol/L' };
                targets.apoB = { value: 0.8, unit: 'g/L' };
                targets.percentReduction = 50;
                targets.riskCategory = 'High Risk';
            } else if (highestRisk >= 10) {
                // Intermediate risk primary prevention
                targets.ldl = { value: 2.0, unit: 'mmol/L' };
                targets.nonHDL = { value: 2.6, unit: 'mmol/L' };
                targets.apoB = { value: 0.8, unit: 'g/L' };
                targets.percentReduction = 30;
                targets.riskCategory = 'Intermediate Risk';
            } else {
                // Low risk primary prevention
                targets.ldl = { value: 3.5, unit: 'mmol/L' }; // Medication threshold for low risk
                targets.nonHDL = { value: 4.2, unit: 'mmol/L' };
                targets.apoB = { value: 1.0, unit: 'g/L' };
                targets.percentReduction = 30;
                targets.riskCategory = 'Low Risk';
            }
        }
        
        // Elevated Lp(a) may warrant more aggressive targets
        if (data.lpa !== undefined && data.lpa !== null && data.lpa >= 50) {
            targets.lpaAdjustedLDL = { value: Math.max(targets.ldl.value - 0.3, 1.4), unit: 'mmol/L' };
            targets.hasElevatedLpa = true;
        } else {
            targets.hasElevatedLpa = false;
        }
        
        return targets;
    }
    
    /**
     * Assess current therapy and determine gaps
     * @param {Object} data - Standardized patient data
     * @param {Object} targets - Target levels
     * @returns {Object} - Assessment results
     */
    function assessCurrentTherapy(data, targets) {
        const assessment = {
            currentTherapyIntensity: 'None',
            atLDLTarget: false,
            atNonHDLTarget: false,
            atApoBTarget: false,
            gapToLDLTarget: 0,
            gapToNonHDLTarget: 0,
            estimatedAdditionalLDLReduction: 0,
            canIntensifyStatin: false,
            maxStatinReached: false,
            statinIntolerance: false,
            onEzetimibe: data.ezetimibe,
            onPCSK9: data.pcsk9,
            onMaximumTherapy: false,
            hypertriglyceridemia: false,
            mixedDyslipidemia: false
        };
        
        // Assess current therapy intensity
        if (data.statin !== 'none') {
            assessment.currentTherapyIntensity = data['statin-intensity'] || 'Unknown';
            
            // Check if maximum statin dose reached
            if (data['statin-intensity'] === 'high') {
                const maxDoses = {
                    atorvastatin: '80',
                    rosuvastatin: '40',
                    simvastatin: '40',
                    pravastatin: '80',
                    lovastatin: '40',
                    fluvastatin: '80',
                    pitavastatin: '4'
                };
                
                assessment.maxStatinReached = data['statin-dose'] === maxDoses[data.statin];
            }
            
            // Determine if statin can be intensified
            if (data['statin-intensity'] === 'low' || data['statin-intensity'] === 'moderate') {
                assessment.canIntensifyStatin = true;
            }
        }
        
        // Check statin intolerance
        assessment.statinIntolerance = data['statin-intolerance'] !== 'no';
        
        // Check if on maximum therapy
        assessment.onMaximumTherapy = (
            (assessment.maxStatinReached || (assessment.statinIntolerance && data['statin-intolerance'] === 'complete')) &&
            assessment.onEzetimibe
        );
        
        // Evaluate lipid targets
        if (data.ldl !== undefined && data.ldl !== null) {
            assessment.atLDLTarget = data.ldl <= targets.ldl.value;
            assessment.gapToLDLTarget = data.ldl - targets.ldl.value;
        }
        
        if (data['non-hdl'] !== undefined && data['non-hdl'] !== null) {
            assessment.atNonHDLTarget = data['non-hdl'] <= targets.nonHDL.value;
            assessment.gapToNonHDLTarget = data['non-hdl'] - targets.nonHDL.value;
        }
        
        if (data.apob !== undefined && data.apob !== null) {
            assessment.atApoBTarget = data.apob <= targets.apoB.value;
        }
        
        // Check for hypertriglyceridemia
        if (data.trig !== undefined && data.trig !== null) {
            assessment.hypertriglyceridemia = data.trig > 2.0;
            assessment.severeTriglycerides = data.trig > 5.0;
        }
        
        // Check for mixed dyslipidemia
        if (data.ldl !== undefined && data.trig !== undefined && data.hdl !== undefined) {
            assessment.mixedDyslipidemia = data.ldl > targets.ldl.value && data.trig > 2.0 && data.hdl < 1.0;
        }
        
        // Estimate additional LDL reduction needed if not at target
        if (!assessment.atLDLTarget && assessment.gapToLDLTarget > 0) {
            assessment.estimatedAdditionalLDLReduction = (assessment.gapToLDLTarget / data.ldl) * 100;
        }
        
        return assessment;
    }
    
    /**
     * Generate medication recommendations based on assessment
     * @param {Object} data - Standardized patient data
     * @param {Object} assessment - Current therapy assessment
     * @param {Object} targets - Target levels
     * @returns {Object} - Recommendation details
     */
    function generateMedicationRecommendations(data, assessment, targets) {
        const recommendations = {
            summary: [],
            statinChange: null,
            statinRationale: null,
            ezetimibeChange: null,
            ezetimibeRationale: null,
            pcsk9Change: null,
            pcsk9Rationale: null,
            otherTherapies: [],
            nonPharmacological: [
                'Therapeutic lifestyle changes (Mediterranean or DASH diet)',
                'Regular physical activity (150+ minutes/week of moderate activity)',
                'Smoking cessation for all smokers',
                'Weight management targeting BMI <25 kg/m'
            ]
        };
        
        // Assign risk category
        const riskCategory = targets.riskCategory;
        
        // Determine statin recommendations
        if (data.statin === 'none' && !assessment.statinIntolerance) {
            // No current statin and no intolerance
            if (riskCategory === 'High Risk' || riskCategory === 'Very High Risk' || riskCategory === 'Extreme Risk') {
                recommendations.statinChange = 'Initiate high-intensity statin therapy';
                recommendations.statinRationale = 'High-intensity statin therapy is recommended for high-risk patients to achieve 50% LDL-C reduction';
                recommendations.summary.push('Start high-intensity statin (atorvastatin 40-80 mg or rosuvastatin 20-40 mg)');
            } else if (riskCategory === 'Intermediate Risk') {
                recommendations.statinChange = 'Initiate moderate-intensity statin therapy';
                recommendations.statinRationale = 'Moderate-intensity statin therapy is recommended for intermediate-risk patients to achieve 30-50% LDL-C reduction';
                recommendations.summary.push('Start moderate-intensity statin (atorvastatin 10-20 mg, rosuvastatin 5-10 mg, or equivalent)');
            } else if (data.ldl >= 5.0) {
                recommendations.statinChange = 'Consider statin therapy despite low risk due to very high LDL-C';
                recommendations.statinRationale = 'LDL-C 5.0 mmol/L may indicate familial hypercholesterolemia and warrants consideration of statin therapy regardless of risk category';
                recommendations.summary.push('Consider statin therapy due to very high LDL-C');
            } else {
                recommendations.statinChange = 'Statin therapy not routinely recommended for low-risk patients';
                recommendations.statinRationale = 'For low-risk patients, lifestyle modification is the primary intervention';
                recommendations.summary.push('Focus on lifestyle modifications');
            }
        } else if (data.statin !== 'none' && assessment.canIntensifyStatin && !assessment.atLDLTarget && !assessment.statinIntolerance) {
            // On non-maximum statin, not at target, and no intolerance
            recommendations.statinChange = 'Intensify current statin therapy';
            recommendations.statinRationale = 'Intensifying statin therapy can provide additional LDL-C reduction to help reach target';
            recommendations.summary.push(`Increase ${data.statin} dose to achieve greater LDL-C reduction`);
        } else if (assessment.statinIntolerance && data['statin-intolerance'] === 'complete') {
            // Complete statin intolerance
            recommendations.statinChange = 'Statin therapy not feasible due to documented intolerance';
            recommendations.statinRationale = 'Alternative lipid-lowering strategies are required for patients with complete statin intolerance';
            recommendations.summary.push('Statin-independent therapy required due to documented statin intolerance');
        } else if (assessment.statinIntolerance && data['statin-intolerance'] === 'partial') {
            // Partial statin intolerance
            recommendations.statinChange = 'Continue maximum tolerated statin dose';
            recommendations.statinRationale = 'Maintain the highest tolerated statin dose to achieve as much LDL-C reduction as possible';
            recommendations.summary.push('Maintain current tolerated statin dose');
        } else if (assessment.atLDLTarget) {
            // At LDL target
            recommendations.statinChange = 'Continue current statin therapy';
            recommendations.statinRationale = 'Current therapy is effectively reaching the target LDL-C level';
            recommendations.summary.push('Continue current statin therapy');
        } else {
            // On maximum statin, not at target
            recommendations.statinChange = 'Continue maximum statin therapy';
            recommendations.statinRationale = 'Maximum statin therapy should be maintained while considering add-on therapies';
            recommendations.summary.push('Continue maximum statin therapy');
        }
        
        // Determine ezetimibe recommendations
        if (!assessment.onEzetimibe && !assessment.atLDLTarget && 
            (data.statin !== 'none' || assessment.statinIntolerance)) {
            // Not on ezetimibe, not at target, and either on statin or statin intolerant
            recommendations.ezetimibeChange = 'Add ezetimibe therapy';
            recommendations.ezetimibeRationale = 'Ezetimibe can provide an additional 15-25% LDL-C reduction';
            recommendations.summary.push('Add ezetimibe 10 mg daily');
        } else if (assessment.onEzetimibe && assessment.atLDLTarget) {
            // On ezetimibe and at target
            recommendations.ezetimibeChange = 'Continue ezetimibe therapy';
            recommendations.ezetimibeRationale = 'Current combination therapy is effectively reaching the target LDL-C level';
        } else if (assessment.onEzetimibe && !assessment.atLDLTarget) {
            // On ezetimibe, not at target
            recommendations.ezetimibeChange = 'Continue ezetimibe therapy';
            recommendations.ezetimibeRationale = 'Ezetimibe should be continued while considering additional lipid-lowering options';
        }
    
        // Determine PCSK9 inhibitor recommendations
        const highRiskCategories = ['High Risk', 'Very High Risk', 'Extreme Risk'];
        if (!assessment.onPCSK9 && !assessment.atLDLTarget && 
            assessment.onEzetimibe && (data.statin !== 'none' || assessment.statinIntolerance) &&
            highRiskCategories.includes(riskCategory)) {
            // Not on PCSK9, not at target, on ezetimibe, and either on statin or statin intolerant
            if (data.preventionCategory === 'secondary' && data.ldl >= 2.5) {
                recommendations.pcsk9Change = 'Consider PCSK9 inhibitor therapy';
                recommendations.pcsk9Rationale = 'PCSK9 inhibitors can provide an additional 50-60% LDL-C reduction in patients with established ASCVD not at target despite maximum tolerated statin plus ezetimibe';
                recommendations.summary.push('Consider PCSK9 inhibitor for secondary prevention');
            } else if (data.preventionCategory === 'primary' && data.ldl >= 3.5) {
                recommendations.pcsk9Change = 'Consider PCSK9 inhibitor therapy if familial hypercholesterolemia is confirmed';
                recommendations.pcsk9Rationale = 'PCSK9 inhibitors may be considered for primary prevention in patients with confirmed FH and LDL-C 3.5 mmol/L despite maximum tolerated statin plus ezetimibe';
                recommendations.summary.push('Consider PCSK9 inhibitor if FH is confirmed');
            }
        } else if (assessment.onPCSK9) {
            // Already on PCSK9 inhibitor
            recommendations.pcsk9Change = 'Continue PCSK9 inhibitor therapy';
            recommendations.pcsk9Rationale = 'Continue current therapy and reassess lipid levels at next follow-up';
        }
        
        // Recommendations for hypertriglyceridemia
        if (assessment.severeTriglycerides) {
            recommendations.otherTherapies.push({
                therapy: 'Consider fibrate therapy',
                rationale: 'Severe hypertriglyceridemia (>5.0 mmol/L) increases risk of pancreatitis and may benefit from fibrate therapy',
                intensityClass: 'warning'
            });
            recommendations.summary.push('Fibrate therapy for severe hypertriglyceridemia');
        } else if (assessment.hypertriglyceridemia && assessment.mixedDyslipidemia) {
            recommendations.otherTherapies.push({
                therapy: 'Consider fenofibrate as add-on therapy',
                rationale: 'Mixed dyslipidemia with elevated triglycerides and low HDL-C may benefit from add-on fenofibrate therapy after statin optimization',
                intensityClass: 'info'
            });
        }
        
        // Additional recommendations for elevated Lp(a)
        if (targets.hasElevatedLpa) {
            recommendations.otherTherapies.push({
                therapy: 'More aggressive LDL-C targets recommended',
                rationale: 'Elevated Lp(a) is an independent risk factor that warrants more aggressive LDL-C reduction',
                intensityClass: 'warning'
            });
            recommendations.summary.push('More aggressive LDL-C targets due to elevated Lp(a)');
            
            recommendations.otherTherapies.push({
                therapy: 'Consider family screening for Lp(a)',
                rationale: 'Elevated Lp(a) is largely genetically determined and first-degree relatives should be screened',
                intensityClass: 'info'
            });
        }
        
        return recommendations;
    }
    
    /**
     * Assess PCSK9 inhibitor coverage eligibility
     * @param {Object} data - Standardized patient data
     * @param {Object} assessment - Current therapy assessment
     * @returns {Object} - Coverage assessment
     */
    function assessPCSK9Coverage(data, assessment) {
        const coverage = {
            eligible: false,
            criteria: [],
            notMet: [],
            notes: []
        };
        
        // Check if already on PCSK9
        if (data.pcsk9) {
            coverage.notes.push('Patient is currently on PCSK9 inhibitor therapy');
        }
        
        // Check for secondary prevention
        if (data.preventionCategory === 'secondary') {
            coverage.criteria.push('Secondary prevention');
            
            // Check LDL criterion
            if (data.ldl >= 2.0) {
                coverage.criteria.push('LDL-C 2.0 mmol/L');
            } else {
                coverage.notMet.push('LDL-C must be 2.0 mmol/L for secondary prevention coverage');
            }
            
            // Check for recent event
            if (data.secondaryDetails === 'mi') {
                coverage.criteria.push('Recent MI/ACS (higher priority for coverage)');
            }
            
            // Check for multi-vessel disease
            if (data.secondaryDetails === 'multi') {
                coverage.criteria.push('Multi-vessel disease (higher priority for coverage)');
            }
        } 
        // Check for primary prevention with very high LDL
        else if (data.preventionCategory === 'primary' && data.ldl >= 3.5) {
            coverage.criteria.push('Primary prevention with very high LDL-C');
            coverage.notes.push('Documentation of familial hypercholesterolemia with DLCN score 6 would be required');
        } else {
            coverage.notMet.push('Does not meet primary coverage criteria (secondary prevention or primary prevention with LDL-C 3.5 mmol/L and documented FH)');
        }
        
        // Check for maximum tolerated therapy
        if (assessment.onMaximumTherapy) {
            coverage.criteria.push('On maximum tolerated lipid-lowering therapy');
        } else {
            if (!assessment.statinIntolerance) {
                coverage.notMet.push('Must be on maximum tolerated statin therapy');
            }
            
            if (!data.ezetimibe) {
                coverage.notMet.push('Must be on ezetimibe in addition to maximum tolerated statin');
            }
        }
        
        // Check duration on maximum therapy
        if (data['max-therapy-duration'] === '>6' || data['max-therapy-duration'] === '3-6') {
            coverage.criteria.push('3 months on maximum tolerated therapy');
        } else {
            coverage.notMet.push('Must be on maximum tolerated therapy for at least 3 months');
        }
        
        // Check for documented statin intolerance if applicable
        if (assessment.statinIntolerance) {
            if (data['intolerance-type'] && data['intolerance-type'] !== '') {
                coverage.criteria.push('Documented statin intolerance');
            } else {
                coverage.notMet.push('Statin intolerance must be properly documented');
            }
        }
        
        // Determine overall eligibility
        coverage.eligible = coverage.notMet.length === 0 && (
            (data.preventionCategory === 'secondary' && data.ldl >= 2.0 && assessment.onMaximumTherapy) ||
            (data.preventionCategory === 'primary' && data.ldl >= 3.5 && assessment.onMaximumTherapy)
        );
        
        return coverage;
    }
    
    /**
     * Display medication evaluation results
     * @param {Object} data - Standardized patient data
     * @param {Object} assessment - Current therapy assessment
     * @param {Object} targets - Target levels
     * @param {Object} recommendations - Recommendations object
     * @param {Object} pcsk9Coverage - PCSK9 coverage assessment
     */
    function displayMedicationResults(data, assessment, targets, recommendations, pcsk9Coverage) {
        const resultsContainer = document.getElementById('results-container');
        const resultsDiv = document.getElementById('risk-results');
        
        if (!resultsContainer || !resultsDiv) {
            console.error('Results container not found');
            return;
        }
        
        // Create medication results card
        const resultCardElement = document.createElement('div');
        resultCardElement.className = 'result-card-wrapper';
        
        // Add timestamp
        const timestamp = new Date();
        resultCardElement.innerHTML = `<div class="result-timestamp">Calculated on ${timestamp.toLocaleString()}</div>`;
        
        // Create results card
        const resultCard = document.createElement('div');
        resultCard.className = 'results-card';
        
        // Add header
        resultCard.innerHTML = `
            <div class="risk-header">
                <h3 class="risk-title">Lipid-Lowering Therapy Assessment</h3>
                <div class="risk-badge ${assessment.atLDLTarget ? 'low' : 'high'}">
                    ${assessment.atLDLTarget ? 'At Target' : 'Not At Target'}
                </div>
            </div>
        `;
        
        // Current lipid profile and targets section
        const lipidProfile = document.createElement('div');
        lipidProfile.className = 'lipid-profile-section';
        lipidProfile.innerHTML = `
            <h4>Current Lipid Profile vs. Targets</h4>
            <div class="lipid-table">
                <div class="table-header">
                    <div class="table-cell">Parameter</div>
                    <div class="table-cell">Current Value</div>
                    <div class="table-cell">Target</div>
                    <div class="table-cell">Status</div>
                </div>
                <div class="table-row">
                    <div class="table-cell">LDL Cholesterol</div>
                    <div class="table-cell">${data.ldl.toFixed(2)} mmol/L</div>
                    <div class="table-cell">${targets.ldl.value} mmol/L</div>
                    <div class="table-cell ${assessment.atLDLTarget ? 'target-met' : 'target-not-met'}">
                        ${assessment.atLDLTarget ? 'At Target' : 'Not At Target'}
                    </div>
                </div>
                <div class="table-row">
                    <div class="table-cell">Non-HDL Cholesterol</div>
                    <div class="table-cell">${data['non-hdl'].toFixed(2)} mmol/L</div>
                    <div class="table-cell">${targets.nonHDL.value} mmol/L</div>
                    <div class="table-cell ${assessment.atNonHDLTarget ? 'target-met' : 'target-not-met'}">
                        ${assessment.atNonHDLTarget ? 'At Target' : 'Not At Target'}
                    </div>
                </div>
                ${data.apob ? `
                <div class="table-row">
                    <div class="table-cell">ApoB</div>
                    <div class="table-cell">${data.apob.toFixed(2)} g/L</div>
                    <div class="table-cell">${targets.apoB.value} g/L</div>
                    <div class="table-cell ${assessment.atApoBTarget ? 'target-met' : 'target-not-met'}">
                        ${assessment.atApoBTarget ? 'At Target' : 'Not At Target'}
                    </div>
                </div>
                ` : ''}
                <div class="table-row">
                    <div class="table-cell">Triglycerides</div>
                    <div class="table-cell">${data.trig.toFixed(2)} mmol/L</div>
                    <div class="table-cell">&lt;1.7 mmol/L</div>
                    <div class="table-cell ${data.trig < 1.7 ? 'target-met' : 'target-not-met'}">
                        ${data.trig < 1.7 ? 'Normal' : (data.trig > 5.0 ? 'Severely Elevated' : 'Elevated')}
                    </div>
                </div>
                ${data.lpa ? `
                <div class="table-row">
                    <div class="table-cell">Lp(a)</div>
                    <div class="table-cell">${data.lpa} mg/dL</div>
                    <div class="table-cell">&lt;50 mg/dL</div>
                    <div class="table-cell ${data.lpa < 50 ? 'target-met' : 'target-not-met'}">
                        ${data.lpa < 50 ? 'Normal' : 'Elevated'}
                    </div>
                </div>
                ` : ''}
            </div>
            <div class="risk-category-info">
                <p><strong>Risk Category:</strong> ${targets.riskCategory}</p>
                <p><strong>Current Therapy Intensity:</strong> ${assessment.currentTherapyIntensity}</p>
                ${assessment.gapToLDLTarget > 0 ? 
                `<p><strong>Additional LDL-C Reduction Needed:</strong> ${assessment.estimatedAdditionalLDLReduction.toFixed(0)}%</p>` : ''}
            </div>
        `;
        
        resultCard.appendChild(lipidProfile);
        
        // Treatment recommendations section
        const recommendationsSection = document.createElement('div');
        recommendationsSection.className = 'recommendations-section';
        recommendationsSection.innerHTML = `
            <h4>Treatment Recommendations</h4>
            <div class="recommendations-summary">
                <ul>
                    ${recommendations.summary.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
            
            <div class="detailed-recommendations">
                ${recommendations.statinChange ? `
                <div class="recommendation-item">
                    <h5 class="recommendation-title">Statin Therapy</h5>
                    <p>${recommendations.statinChange}</p>
                    <div class="rationale">
                        <p><strong>Rationale:</strong> ${recommendations.statinRationale}</p>
                    </div>
                </div>
                ` : ''}
                
                ${recommendations.ezetimibeChange ? `
                <div class="recommendation-item">
                    <h5 class="recommendation-title">Ezetimibe</h5>
                    <p>${recommendations.ezetimibeChange}</p>
                    <div class="rationale">
                        <p><strong>Rationale:</strong> ${recommendations.ezetimibeRationale}</p>
                    </div>
                </div>
                ` : ''}
                
                ${recommendations.pcsk9Change ? `
                <div class="recommendation-item">
                    <h5 class="recommendation-title">PCSK9 Inhibitor</h5>
                    <p>${recommendations.pcsk9Change}</p>
                    <div class="rationale">
                        <p><strong>Rationale:</strong> ${recommendations.pcsk9Rationale}</p>
                    </div>
                </div>
                ` : ''}
                
                ${recommendations.otherTherapies.length > 0 ? `
                <div class="recommendation-item">
                    <h5 class="recommendation-title">Additional Considerations</h5>
                    ${recommendations.otherTherapies.map(therapy => `
                        <div class="other-therapy ${therapy.intensityClass}">
                            <p>${therapy.therapy}</p>
                            <div class="rationale">
                                <p><strong>Rationale:</strong> ${therapy.rationale}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                <div class="recommendation-item">
                    <h5 class="recommendation-title">Non-Pharmacological Therapy</h5>
                    <ul>
                        ${recommendations.nonPharmacological.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
        
        resultCard.appendChild(recommendationsSection);
        
        // PCSK9 coverage section if applicable
        if (recommendations.pcsk9Change || data.pcsk9) {
            const pcsk9Section = document.createElement('div');
            pcsk9Section.className = 'pcsk9-coverage-assessment';
            pcsk9Section.innerHTML = `
                <h4>PCSK9 Inhibitor Coverage Assessment</h4>
                <div class="coverage-status ${pcsk9Coverage.eligible ? 'eligible' : 'not-eligible'}">
                    <p><strong>Coverage Status:</strong> ${pcsk9Coverage.eligible ? 'Likely Eligible' : 'Currently Not Eligible'}</p>
                </div>
                
                ${pcsk9Coverage.criteria.length > 0 ? `
                <div class="criteria-met">
                    <p><strong>Criteria Met:</strong></p>
                    <ul>
                        ${pcsk9Coverage.criteria.map(criterion => `<li>${criterion}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${pcsk9Coverage.notMet.length > 0 ? `
                <div class="criteria-not-met">
                    <p><strong>Criteria Not Met:</strong></p>
                    <ul>
                        ${pcsk9Coverage.notMet.map(criterion => `<li>${criterion}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${pcsk9Coverage.notes.length > 0 ? `
                <div class="coverage-notes">
                    <p><strong>Notes:</strong></p>
                    <ul>
                        ${pcsk9Coverage.notes.map(note => `<li>${note}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                <div class="coverage-info">
                    <p><strong>Documentation Required for Special Authority:</strong></p>
                    <ul>
                        <li>Current and baseline lipid values</li>
                        <li>Details of current and previous lipid-lowering therapies</li>
                        <li>Documentation of statin intolerance if applicable</li>
                        <li>For primary prevention: documentation of familial hypercholesterolemia diagnosis</li>
                    </ul>
                </div>
            `;
            
            resultCard.appendChild(pcsk9Section);
        }
        
        // Add card to results and show container - prepend to show newest result at top
        resultCardElement.appendChild(resultCard);
        resultsDiv.insertBefore(resultCardElement, resultsDiv.firstChild);
        
        // Set date and show results container
        document.querySelector('#results-date span').textContent = new Date().toLocaleDateString();
        resultsContainer.style.display = 'block';
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    /***********************************
     * UNIT CONVERSION FUNCTIONS
     ***********************************/
    
    /**
     * Convert height from feet/inches to cm
     * @param {number} feet - Height in feet
     * @param {number} inches - Height in inches
     * @returns {number} - Height in cm
     */
    function convertHeightToCm(feet, inches) {
        if (feet === null && inches === null) return null;
        feet = feet || 0;
        inches = inches || 0;
        return ((feet * 12) + parseFloat(inches)) * 2.54;
    }
    
    /**
     * Convert weight from pounds to kg
     * @param {number} pounds - Weight in pounds
     * @returns {number} - Weight in kg
     */
    function convertWeightToKg(pounds) {
        if (pounds === null) return null;
        return pounds * 0.45359237;
    }
    
    /**
     * Convert cholesterol between mg/dL and mmol/L
     * @param {number} value - Cholesterol value
     * @param {string} fromUnit - Original unit ('mg/dL' or 'mmol/L')
     * @param {string} toUnit - Target unit ('mg/dL' or 'mmol/L')
     * @returns {number} - Converted cholesterol value
     */
    function convertCholesterol(value, fromUnit, toUnit) {
        if (value === null) return null;
        
        if (fromUnit === toUnit) {
            return parseFloat(value);
        }
        
        if (fromUnit === 'mg/dL' && toUnit === 'mmol/L') {
            return parseFloat(value) / 38.67;
        }
        
        if (fromUnit === 'mmol/L' && toUnit === 'mg/dL') {
            return parseFloat(value) * 38.67;
        }
        
        return parseFloat(value);
    }
    
    /**
     * Convert Lp(a) between mg/dL and nmol/L
     * @param {number} value - Lp(a) value
     * @param {string} fromUnit - Original unit ('mg/dL' or 'nmol/L')
     * @param {string} toUnit - Target unit ('mg/dL' or 'nmol/L')
     * @returns {number} - Converted Lp(a) value
     */
    function convertLpa(value, fromUnit, toUnit) {
        if (value === null) return null;
        
        if (fromUnit === toUnit) {
            return parseFloat(value);
        }
        
        if (fromUnit === 'mg/dL' && toUnit === 'nmol/L') {
            return parseFloat(value) * 2.5;
        }
        
        if (fromUnit === 'nmol/L' && toUnit === 'mg/dL') {
            return parseFloat(value) * 0.4;
        }
        
        return parseFloat(value);
    }
    
    /***********************************
     * DATA MANAGEMENT FUNCTIONS
     ***********************************/
    
    /**
     * Save form state to localStorage
     * @param {string} formId - ID of the form to save
     */
    function saveFormState(formId) {
        try {
            const form = document.getElementById(formId);
            if (!form) return;
            
            const formData = {};
            
            // Get all inputs and selects
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.name) {
                    if (input.type === 'checkbox') {
                        formData[input.name] = input.checked;
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value;
                        }
                    } else {
                        formData[input.name] = input.value;
                    }
                } else {
                    // Use ID if name not available
                    if (input.id) {
                        if (input.type === 'checkbox') {
                            formData[input.id] = input.checked;
                        } else if (input.type === 'radio') {
                            if (input.checked) {
                                formData[input.id] = input.value;
                            }
                        } else {
                            formData[input.id] = input.value;
                        }
                    }
                }
            });
            
            // Save to localStorage
            localStorage.setItem(`cvd-toolkit-${formId}`, JSON.stringify(formData));
        } catch (error) {
            console.error('Error saving form state:', error);
        }
    }
    
    /**
     * Load form state from localStorage
     */
    function loadSavedFormState() {
        try {
            // Load form states for each form
            const formIds = ['frs-form', 'qrisk-form', 'medication-form'];
            
            formIds.forEach(formId => {
                const savedState = localStorage.getItem(`cvd-toolkit-${formId}`);
                if (!savedState) return;
                
                try {
                    const formData = JSON.parse(savedState);
                    const form = document.getElementById(formId);
                    if (!form) return;
                    
                    // Populate form fields
                    for (const [key, value] of Object.entries(formData)) {
                        // Try to find by name first, then by ID
                        const inputByName = form.querySelector(`[name="${key}"]`);
                        const inputById = form.querySelector(`#${key}`);
                        const input = inputByName || inputById;
                        
                        if (!input) continue;
                        
                        if (input.type === 'checkbox') {
                            input.checked = value;
                        } else if (input.type === 'radio') {
                            const radio = form.querySelector(`[name="${key}"][value="${value}"]`) || 
                                         form.querySelector(`#${key}[value="${value}"]`);
                            if (radio) radio.checked = true;
                        } else {
                            input.value = value;
                        }
                    }
                    
                    // Special handling for form-specific UI updates
                    if (formId === 'qrisk-form') {
                        // Update height display
                        if (formData['qrisk-height-unit'] === 'ft/in') {
                            toggleHeightInputs('qrisk');
                        }
                        
                        // Update BMI if height and weight are present
                        if (formData['qrisk-height'] && formData['qrisk-weight']) {
                            document.getElementById('qrisk-height').dispatchEvent(new Event('input'));
                        }
                        
                        // Update cholesterol ratio if total and HDL are present
                        if (formData['qrisk-total-chol'] && formData['qrisk-hdl']) {
                            document.getElementById('qrisk-total-chol').dispatchEvent(new Event('input'));
                        }
                        
                        // Update ED field visibility based on sex
                        if (formData['qrisk-sex'] === 'male') {
                            document.getElementById('qrisk-ed-container').style.display = 'block';
                        }
                    } else if (formId === 'medication-form') {
                        // Update statin dose options
                        if (formData['med-statin'] !== 'none') {
                            updateStatinDoseOptions(formData['med-statin']);
                            document.getElementById('med-statin-dose').disabled = false;
                        }
                        
                        // Update intolerance type display
                        if (formData['med-statin-intolerance'] !== 'no') {
                            document.getElementById('med-intolerance-type').disabled = false;
                        }
                        
                        // Update secondary details display
                        if (formData['prevention-category'] === 'secondary') {
                            document.getElementById('secondary-details').disabled = false;
                        }
                        
                        // Update PCSK9 details display
                        if (formData['med-pcsk9'] === true) {
                            document.getElementById('pcsk9-details').style.display = 'block';
                            
                            // Update PCSK9 dose options
                            if (formData['med-pcsk9-type']) {
                                updatePCSK9DoseOptions(formData['med-pcsk9-type']);
                                document.getElementById('med-pcsk9-dose').disabled = false;
                            }
                        }
                        
                        // Calculate non-HDL
                        if (formData['med-total-chol'] && formData['med-hdl']) {
                            calculateNonHDL();
                        }
                    }
                } catch (innerError) {
                    console.error(`Error loading state for ${formId}:`, innerError);
                }
            });
        } catch (error) {
            console.error('Error loading form state:', error);
        }
    }
    
    /**
     * Export results to CSV
     */
    function exportToCSV() {
        // Get data from results
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer || resultsContainer.style.display === 'none') {
            showModal('No results to export. Please calculate risk scores first.');
            return;
        }
        
        // Create CSV content
        let csvContent = 'data:text/csv;charset=utf-8,';
        csvContent += 'CVD Risk Assessment Results,\r\n';
        csvContent += 'Date,' + document.querySelector('#results-date span').textContent + '\r\n\r\n';
        
        // Get all result cards
        const resultCards = document.querySelectorAll('.result-card-wrapper');
        for (let i = 0; i < resultCards.length; i++) {
            // Get timestamp
            const timestamp = resultCards[i].querySelector('.result-timestamp')?.textContent || '';
            csvContent += timestamp + '\r\n';
            
            // Check if it's a single risk card or comparison card
            const riskTitle = resultCards[i].querySelector('.risk-title')?.textContent || '';
            csvContent += 'Assessment Type,' + riskTitle + '\r\n';
            
            if (riskTitle.includes('Comparison')) {
                // Comparison card
                csvContent += 'Comparison Results,\r\n';
                csvContent += 'Parameter,Framingham,QRISK3\r\n';
                
                csvContent += 'Base Risk,' + 
                    (resultCards[i].querySelector('#compare-frs-base')?.textContent || '') + ',' +
                    (resultCards[i].querySelector('#compare-qrisk-base')?.textContent || '') + '\r\n';
                
                csvContent += 'Lp(a) Modifier,' + 
                    (resultCards[i].querySelector('#compare-frs-lpa')?.textContent || '') + ',' +
                    (resultCards[i].querySelector('#compare-qrisk-lpa')?.textContent || '') + '\r\n';
                
                csvContent += 'Adjusted Risk,' + 
                    (resultCards[i].querySelector('#compare-frs-adjusted')?.textContent || '') + ',' +
                    (resultCards[i].querySelector('#compare-qrisk-adjusted')?.textContent || '') + '\r\n';
                
                csvContent += 'Risk Category,' + 
                    (resultCards[i].querySelector('#compare-frs-category')?.textContent || '') + ',' +
                    (resultCards[i].querySelector('#compare-qrisk-category')?.textContent || '') + '\r\n';
                
                csvContent += 'Interpretation,' + (resultCards[i].querySelector('#comparison-interpretation')?.textContent || '') + '\r\n';
            } else if (riskTitle.includes('Therapy')) {
                // Medication card
                csvContent += 'Lipid Profile vs Targets,\r\n';
                
                const lipidRows = resultCards[i].querySelectorAll('.lipid-table .table-row');
                lipidRows.forEach(row => {
                    const cells = row.querySelectorAll('.table-cell');
                    if (cells.length >= 4) {
                        csvContent += cells[0].textContent + ',' + 
                                       cells[1].textContent + ',' + 
                                       cells[2].textContent + ',' + 
                                       cells[3].textContent + '\r\n';
                    }
                });
                
                csvContent += '\r\nRecommendations,\r\n';
                const summaryItems = resultCards[i].querySelectorAll('.recommendations-summary li');
                summaryItems.forEach(item => {
                    csvContent += item.textContent + '\r\n';
                });
            } else {
                // Single risk card
                const baseRisk = resultCards[i].querySelector('.base-risk')?.textContent || '';
                const lpaModifier = resultCards[i].querySelector('.lpa-modifier')?.textContent || '';
                const adjustedRisk = resultCards[i].querySelector('.adjusted-risk')?.textContent || '';
                const riskCategory = resultCards[i].querySelector('.risk-category')?.textContent || '';
                
                csvContent += 'Base Risk,' + baseRisk + '\r\n';
                csvContent += 'Lp(a) Modifier,' + lpaModifier + '\r\n';
                csvContent += 'Adjusted Risk,' + adjustedRisk + '\r\n';
                csvContent += 'Risk Category,' + riskCategory + '\r\n';
                
                // Get interpretation
                const interpretation = resultCards[i].querySelector('.risk-interpretation')?.textContent || '';
                csvContent += 'Interpretation,' + interpretation.replace(/\n/g, ' ').replace(/,/g, ';') + '\r\n';
            }
            
            csvContent += '\r\n';
        }
        
        // Add recommendations
        const recommendations = document.getElementById('recommendations-content');
        if (recommendations) {
            csvContent += 'Treatment Recommendations,\r\n';
            
            const recItems = recommendations.querySelectorAll('.recommendation-item');
            recItems.forEach(item => {
                const title = item.querySelector('.recommendation-title')?.textContent || '';
                const content = item.textContent.replace(title, '').trim().replace(/\n/g, ' ');
                csvContent += title + ',' + content.replace(/,/g, ';') + '\r\n';
            });
        }
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', 'cvd_risk_assessment_' + new Date().toISOString().slice(0, 10) + '.csv');
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        document.body.removeChild(link);
    }
    
    /**
     * Show PDF preview before export
     */
    function showPdfPreview() {
        const previewModal = document.getElementById('pdf-preview-modal');
        const previewContent = document.getElementById('pdf-preview-content');
        
        if (!previewModal || !previewContent) {
            showModal('PDF preview functionality is not available. Please try again later.');
            return;
        }
        
        // Clone the results section for preview
        const resultsContainer = document.getElementById('results-container');
        previewContent.innerHTML = '';
        previewContent.appendChild(resultsContainer.cloneNode(true));
        
        // Add preview styling
        previewContent.querySelector('.export-section').style.display = 'none';
        
        // Show the preview modal
        openModal('pdf-preview-modal');
    }
    
    /**
     * Generate PDF from results
     */
    function generatePDF() {
        const downloadBtn = document.getElementById('download-pdf-btn');
        const originalText = downloadBtn.innerHTML;
        
        // Check for PDF generation options
        const includeLogo = document.getElementById('pdf-include-logo').checked;
        const includeDisclaimer = document.getElementById('pdf-include-disclaimer').checked;
        
        // Show loading state
        downloadBtn.innerHTML = `
            <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
            Generating PDF...
        `;
        downloadBtn.disabled = true;
        
        // Create a hidden iframe to generate PDF content
        const iframe = document.createElement('iframe');
        iframe.style.width = '0px';
        iframe.style.height = '0px';
        iframe.style.position = 'absolute';
        iframe.style.top = '-9999px';
        iframe.style.left = '-9999px';
        document.body.appendChild(iframe);
        
        // Get the results content
        const content = document.getElementById('pdf-preview-content').cloneNode(true);
        
        // Apply PDF-specific styling
        if (!includeLogo) {
            const header = content.querySelector('.results-header');
            if (header) header.style.display = 'none';
        }
        
        if (!includeDisclaimer) {
            const disclaimer = content.querySelector('.legal-disclaimer');
            if (disclaimer) disclaimer.style.display = 'none';
        }
        
        // Write PDF content to iframe
        const iframeDocument = iframe.contentWindow.document;
        iframeDocument.open();
        iframeDocument.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>CVD Risk Assessment</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .results-card { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; }
                    .risk-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
                    .risk-badge { padding: 5px 10px; border-radius: 4px; color: white; font-weight: bold; }
                    .low { background-color: #4CAF50; }
                    .moderate { background-color: #FF null;
        }
        
        // Add the LDL-C value if provided for treatment recommendations
        const ldlInput = document.getElementById('frs-ldl');
        if (ldlInput.value && !validateInput(ldlInput, true)) {
            errors.push('Please enter a valid LDL cholesterol value between 0.5 and 10');
        } else if (ldlInput.value) {
            data.ldl = parseFloat(ldlInput.value);
            data.ldlUnit = document.getElementById('frs-ldl-unit').value;
        } else {
            data.ldl = null;
        }
        
        return {
            isValid: errors.length === 0,
            data: data,
            errors: errors
        };
    }
    
    /**
     * Calculates QRISK3 score and displays results
     */
    function calculateQRISK() {
        // Show loading indicator
        showLoading();
        
        try {
            // Validate form
            const validationResult = validateQRISKForm();
            if (!validationResult.isValid) {
                hideLoading();
                displayErrors(validationResult.errors);
                return;
            }
            
            const data = validationResult.data;
            
            // Calculate risk score
            const results = calculateQRISK3Score(data);
            
            // Store results for later use
            appState.qriskResults = results;
            appState.qriskCalculated = true;
            
            // Get LDL value for treatment recommendations if available
            let ldlValue = null;
            if (data.ldl !== null) {
                ldlValue = data.ldl;
                if (data.ldlUnit === 'mg/dL') {
                    ldlValue = convertCholesterol(ldlValue, 'mg/dL', 'mmol/L');
                }
            }
            
            // Get treatment recommendations
            const recommendations = getCCSRecommendation(
                results.modifiedRisk, 
                ldlValue, 
                data.diabetes !== 'none', 
                data.age
            );
            
            // Display results
            displayQRISKResults(data, results, recommendations);
            
            // Save form state
            saveFormState('qrisk-form');
            
            // Update comparison tab status
            updateComparisonTabStatus('qrisk', true);
            
            // Save risk score for medication tab
            sessionStorage.setItem('last-risk-score', results.modifiedRisk.toFixed(1));
            sessionStorage.setItem('risk-calculator-used', 'QRISK3');
            
            // Hide loading indicator
            hideLoading();
            
            // Show success notification
            showNotification('QRISK3 calculation completed successfully.', 'success');
        } catch (error) {
            // Hide loading indicator
            hideLoading();
            
            // Show error
            console.error('Error calculating QRISK3:', error);
            showModal('An error occurred while calculating the QRISK3 score: ' + error.message);
        }
    }
    
    /**
     * Validate QRISK form inputs
     * @returns {Object} - { isValid: boolean, data: Object, errors: Array }
     */
    function validateQRISKForm() {
        const errors = [];
        const data = {};
        
        // Validate age
        const ageInput = document.getElementById('qrisk-age');
        if (!validateInput(ageInput, true)) {
            errors.push('Please enter a valid age between 25 and 84');
        } else {
            data.age = parseFloat(ageInput.value);
        }
        
        // Validate sex
        const sexSelect = document.getElementById('qrisk-sex');
        if (!validateInput(sexSelect, true)) {
            errors.push('Please select sex');
        } else {
            data.sex = sexSelect.value;
        }
        
        // Validate ethnicity
        const ethnicitySelect = document.getElementById('qrisk-ethnicity');
        if (!validateInput(ethnicitySelect, true)) {
            errors.push('Please select ethnicity');
        } else {
            data.ethnicity = ethnicitySelect.value;
        }
        
        // Validate height
        let heightValid = false;
        const heightUnit = document.getElementById('qrisk-height-unit').value;
        
        if (heightUnit === 'cm') {
            const heightInput = document.getElementById('qrisk-height');
            if (!validateInput(heightInput, true)) {
                errors.push('Please enter a valid height');
            } else {
                data.height = parseFloat(heightInput.value);
                heightValid = true;
            }
        } else {
            // Validate feet and inches
            const feetInput = document.getElementById('qrisk-height-feet');
            const inchesInput = document.getElementById('qrisk-height-inches');
            
            if (!validateInput(feetInput, true)) {
                errors.push('Please enter a valid height (feet)');
            } else {
                const feet = parseFloat(feetInput.value);
                const inches = parseFloat(inchesInput.value || 0);
                data.height = convertHeightToCm(feet, inches);
                heightValid = true;
            }
        }
        
        // Validate weight
        const weightInput = document.getElementById('qrisk-weight');
        if (!validateInput(weightInput, true)) {
            errors.push('Please enter a valid weight');
        } else {
            data.weight = parseFloat(weightInput.value);
            
            // Convert weight if needed
            if (document.getElementById('qrisk-weight-unit').value === 'lb') {
                data.weight = convertWeightToKg(data.weight);
            }
        }
        
        // Calculate BMI if we have height and weight
        if (heightValid && data.weight) {
            data.bmi = calculateBMI(data.height, data.weight);
            document.getElementById('qrisk-bmi').value = data.bmi;
            document.getElementById('qrisk-bmi-display').value = formatBMI(data.bmi);
        }
        
        // Validate systolic blood pressure
        const sbpInput = document.getElementById('qrisk-sbp');
        if (!validateInput(sbpInput, true)) {
            errors.push('Please enter a valid systolic blood pressure value');
        } else {
            data.sbp = parseFloat(sbpInput.value);
        }
        
        // Validate SD of SBP (not required)
        const sbpSdInput = document.getElementById('qrisk-sbp-sd');
        if (sbpSdInput.value && !validateInput(sbpSdInput, true)) {
            errors.push('Please enter a valid standard deviation of SBP between 0 and 30');
        } else if (sbpSdInput.value) {
            data.sbpSd = parseFloat(sbpSdInput.value);
        } else {
            data.sbpSd = null;
        }
        
        // Validate total cholesterol
        const totalCholInput = document.getElementById('qrisk-total-chol');
        if (!validateInput(totalCholInput, true)) {
            errors.push('Please enter a valid total cholesterol value');
        } else {
            data.totalChol = parseFloat(totalCholInput.value);
            data.totalCholUnit = document.getElementById('qrisk-total-chol-unit').value;
        }
        
        // Validate HDL cholesterol
        const hdlInput = document.getElementById('qrisk-hdl');
        if (!validateInput(hdlInput, true)) {
            errors.push('Please enter a valid HDL cholesterol value');
        } else {
            data.hdl = parseFloat(hdlInput.value);
            data.hdlUnit = document.getElementById('qrisk-hdl-unit').value;
        }
        
        // Calculate cholesterol ratio
        if (data.totalChol && data.hdl) {
            // Convert units if needed to ensure same units for ratio
            let totalChol = data.totalChol;
            let hdl = data.hdl;
            
            if (data.totalCholUnit !== data.hdlUnit) {
                if (data.totalCholUnit === 'mg/dL') {
                    totalChol = convertCholesterol(totalChol, 'mg/dL', 'mmol/L');
                } else {
                    hdl = convertCholesterol(hdl, 'mg/dL', 'mmol/L');
                }
            }
            
            // Calculate ratio
            data.cholRatio = totalChol / hdl;
            document.getElementById('qrisk-chol-ratio').value = data.cholRatio;
            document.getElementById('qrisk-ratio-display').value = data.cholRatio.toFixed(2);
        }
        
        // Validate smoker status
        const smokerSelect = document.getElementById('qrisk-smoker');
        if (!validateInput(smokerSelect, true)) {
            errors.push('Please select smoker status');
        } else {
            data.smoker = smokerSelect.value;
        }
        
        // Validate diabetes
        const diabetesSelect = document.getElementById('qrisk-diabetes');
        if (!validateInput(diabetesSelect, true)) {
            errors.push('Please select diabetes status');
        } else {
            data.diabetes = diabetesSelect.value;
        }
        
        // Validate family history of CVD
        const familyHistorySelect = document.getElementById('qrisk-family-history');
        if (!validateInput(familyHistorySelect, true)) {
            errors.push('Please select family history of CVD');
        } else {
            data.familyHistory = familyHistorySelect.value === 'yes';
        }
        
        // Validate BP treatment (not required)
        data.bpTreatment = document.getElementById('qrisk-bp-treatment').value === 'yes';
        
        // Get medical conditions
        data.atrialFibrillation = document.getElementById('qrisk-af').checked;
        data.rheumatoidArthritis = document.getElementById('qrisk-ra').checked;
        data.chronicKidneyDisease = document.getElementById('qrisk-ckd').checked;
        data.migraine = document.getElementById('qrisk-migraine').checked;
        data.systemicLupusErythematosus = document.getElementById('qrisk-sle').checked;
        data.severeMentalIllness = document.getElementById('qrisk-semi').checked;
        data.erectileDysfunction = document.getElementById('qrisk-ed').checked && data.sex === 'male';
        
        // Get medications
        data.atypicalAntipsychotics = document.getElementById('qrisk-atypical-antipsychotics').checked;
        data.regularSteroids = document.getElementById('qrisk-corticosteroids').checked;
        
        // Validate Lp(a) (not required)
        const lpaInput = document.getElementById('qrisk-lpa');
        if (lpaInput.value && !validateInput(lpaInput, true)) {
            errors.push('Please enter a valid Lp(a) value between 0 and 500');
        } else if (lpaInput.value) {
            data.lpa = parseFloat(lpaInput.value);
            data.lpaUnit = document.getElementById('qrisk-lpa-unit').value;
        } else {
            data.lpa = null;
        }
        
        // Add the LDL-C value if provided for treatment recommendations
        const ldlInput = document.getElementById('qrisk-ldl');
        if (ldlInput.value && !validateInput(ldlInput, true)) {
            errors.push('Please enter a valid LDL cholesterol value between 0.5 and 10');
        } else if (ldlInput.value) {
            data.ldl = parseFloat(ldlInput.value);
            data.ldlUnit = document.getElementById('qrisk-ldl-unit').value;
        } else {
            data.ldl = null;
        }
        
        // Add Townsend deprivation score
        const townsendInput = document.getElementById('qrisk-townsend');
        if (townsendInput.value && !validateInput(townsendInput, false)) {
            errors.push('Please enter a valid Townsend deprivation score between -6 and 10');
        } else if (townsendInput.value) {
            data.townsend = parseFloat(townsendInput.value);
        } else {
            data.townsend = 0; // Default value
        }
        
        return {
            isValid: errors.length === 0,
            data: data,
            errors: errors
        };
    }
    
    /**
     * Calculates both FRS and QRISK3 scores and displays comparison
     */
    function calculateBoth() {
        // First check if both calculators have been filled in
        const frsStatus = document.getElementById('frs-status').textContent;
        const qriskStatus = document.getElementById('qrisk-status').textContent;
        
        if (frsStatus === 'Not completed' || qriskStatus === 'Not completed') {
            showModal('Please complete both the FRS and QRISK3 calculators before comparing results.');
            return;
        }
        
        // Show loading indicator
        showLoading();
        
        try {
            // Validate both forms
            const frsResult = validateFRSForm();
            const qriskResult = validateQRISKForm();
            
            const errors = [...frsResult.errors, ...qriskResult.errors];
            
            if (errors.length > 0) {
                hideLoading();
                displayErrors(errors);
                return;
            }
            
            const frsData = frsResult.data;
            const qriskData = qriskResult.data;
            
            // Calculate FRS
            const frsResults = calculateFraminghamRiskScore(frsData);
            
            // Calculate QRISK3
            const qriskResults = calculateQRISK3Score(qriskData);
            
            // Store results
            appState.frsResults = frsResults;
            appState.qriskResults = qriskResults;
            appState.frsCalculated = true;
            appState.qriskCalculated = true;
            
            // Use the higher of the two risks for recommendations
            const highestRisk = Math.max(frsResults.modifiedRisk, qriskResults.modifiedRisk);
            
            // Get LDL value for treatment recommendations
            let ldlValue = null;
            if (frsData.ldl !== null) {
                ldlValue = frsData.ldl;
                if (frsData.ldlUnit === 'mg/dL') {
                    ldlValue = convertCholesterol(ldlValue, 'mg/dL', 'mmol/L');
                }
            } else if (qriskData.ldl !== null) {
                ldlValue = qriskData.ldl;
                if (qriskData.ldlUnit === 'mg/dL') {
                    ldlValue = convertCholesterol(ldlValue, 'mg/dL', 'mmol/L');
                }
            }
            
            // Get treatment recommendations based on highest risk
            const hasDiabetes = frsData.diabetes || qriskData.diabetes !== 'none';
            const recommendations = getCCSRecommendation(
                highestRisk, 
                ldlValue, 
                hasDiabetes, 
                frsData.age
            );
            
            // Display comparison results
            displayComparisonResults(frsData, frsResults, qriskData, qriskResults, recommendations);
            
            // Save form states
            saveFormState('frs-form');
            saveFormState('qrisk-form');
            
            // Save highest risk score for medication tab
            sessionStorage.setItem('last-risk-score', highestRisk.toFixed(1));
            sessionStorage.setItem('risk-calculator-used', 'Combined');
            
            // Hide loading indicator
            hideLoading();
            
            // Show success notification
            showNotification('Risk comparison calculation completed successfully.', 'success');
        } catch (error) {
            // Hide loading indicator
            hideLoading();
            
            // Show error
            console.error('Error calculating comparison:', error);
            showModal('An error occurred while calculating the risk comparison: ' + error.message);
        }
    }
    
    /**
     * Evaluate medications and generate recommendations
     */
    function evaluateMedicationsHandler() {
        // Show loading indicator
        showLoading();
        
        try {
            // Validate form
            const validationResult = validateMedicationForm();
            if (!validationResult.isValid) {
                hideLoading();
                displayErrors(validationResult.errors);
                return;
            }
            
            const data = validationResult.data;
            
            // Process medication evaluation
            evaluateMedications(data);
            
            // Save form state
            saveFormState('medication-form');
            
            // Hide loading indicator
            hideLoading();
            
            // Show success notification
            showNotification('Medication recommendations generated successfully.', 'success');
        } catch (error) {
            // Hide loading indicator
            hideLoading();
            
            // Show error
            console.error('Error evaluating medications:', error);
            showModal('An error occurred while evaluating medications: ' + error.message);
        }
    }
    
    /**
     * Validate medication form inputs
     * @returns {Object} - { isValid: boolean, data: Object, errors: Array }
     */
    function validateMedicationForm() {
        const errors = [];
        const data = {};
        
        // Validate prevention category
        const preventionCategorySelect = document.getElementById('prevention-category');
        if (!validateInput(preventionCategorySelect, true)) {
            errors.push('Please select a prevention category');
        } else {
            data.preventionCategory = preventionCategorySelect.value;
            
            // Validate secondary details if applicable
            if (data.preventionCategory === 'secondary') {
                const secondaryDetailsSelect = document.getElementById('secondary-details');
                if (!validateInput(secondaryDetailsSelect, true)) {
                    errors.push('Please select secondary prevention details');
                } else {
                    data.secondaryDetails = secondaryDetailsSelect.value;
                }
            }
        }
        
        // Validate lipid values
        const lipidFields = [
            { id: 'med-total-chol', name: 'Total Cholesterol', min: 1, max: 15 },
            { id: 'med-ldl', name: 'LDL Cholesterol', min: 0.5, max: 10 },
            { id: 'med-hdl', name: 'HDL Cholesterol', min: 0.5, max: 3 },
            { id: 'med-trig', name: 'Triglycerides', min: 0.5, max: 15 }
        ];
        
        lipidFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (!validateInput(input, true)) {
                errors.push(`Please enter a valid ${field.name} value between ${field.min} and ${field.max}`);
            } else {
                data[field.id.replace('med-', '')] = parseFloat(input.value);
                data[field.id.replace('med-', '') + '-unit'] = document.getElementById(field.id + '-unit').value;
            }
        });
        
        // Get non-HDL
        const nonHDLInput = document.getElementById('med-non-hdl');
        if (nonHDLInput) {
            if (nonHDLInput.disabled) {
                // Auto-calculated value
                calculateNonHDL();
                data['non-hdl'] = parseFloat(nonHDLInput.value);
                data['non-hdl-unit'] = 'mmol/L';
            } else {
                // Manually entered value
                if (!validateInput(nonHDLInput, true)) {
                    errors.push('Please enter a valid Non-HDL Cholesterol value');
                } else {
                    data['non-hdl'] = parseFloat(nonHDLInput.value);
                    data['non-hdl-unit'] = document.getElementById('med-non-hdl-unit').textContent;
                }
            }
        }
        
        // Get optional values
        // ApoB
        const apoBInput = document.getElementById('med-apob');
        if (apoBInput && apoBInput.value) {
            if (!validateInput(apoBInput, true)) {
                errors.push('Please enter a valid ApoB value between 0.2 and 2.5');
            } else {
                data['apob'] = parseFloat(apoBInput.value);
                data['apob-unit'] = document.getElementById('med-apob-unit').value;
            }
        }
        
        // Lp(a)
        const lpaInput = document.getElementById('med-lpa');
        if (lpaInput && lpaInput.value) {
            if (!validateInput(lpaInput, true)) {
                errors.push('Please enter a valid Lp(a) value between 0 and 500');
            } else {
                data['lpa'] = parseFloat(lpaInput.value);
                data['lpa-unit'] = document.getElementById('med-lpa-unit').value;
            }
        }
        
        // Get medication data
        // Statin
        data['statin'] = document.getElementById('med-statin').value;
        if (data['statin'] !== 'none') {
            const statinDoseSelect = document.getElementById('med-statin-dose');
            if (!validateInput(statinDoseSelect, true)) {
                errors.push('Please select a statin dose');
            } else {
                data['statin-dose'] = statinDoseSelect.value;
                
                // Get statin intensity
                const selectedOption = statinDoseSelect.options[statinDoseSelect.selectedIndex];
                data['statin-intensity'] = selectedOption ? selectedOption.dataset.intensity : null;
            }
        }
        
        // Statin intolerance
        data['statin-intolerance'] = document.getElementById('med-statin-intolerance').value;
        if (data['statin-intolerance'] !== 'no') {
            const intoleranceTypeSelect = document.getElementById('med-intolerance-type');
            if (!validateInput(intoleranceTypeSelect, true)) {
                errors.push('Please select intolerance details');
            } else {
                data['intolerance-type'] = intoleranceTypeSelect.value;
            }
        }
        
        // Other medications
        data['ezetimibe'] = document.getElementById('med-ezetimibe').checked;
        data['pcsk9'] = document.getElementById('med-pcsk9').checked;
        data['fibrate'] = document.getElementById('med-fibrate').checked;
        data['niacin'] = document.getElementById('med-niacin').checked;
        data['bile-acid'] = document.getElementById('med-bile-acid').checked;
        
        // PCSK9 inhibitor details
        if (data['pcsk9']) {
            const pcsk9TypeSelect = document.getElementById('med-pcsk9-type');
            if (!validateInput(pcsk9TypeSelect, true)) {
                errors.push('Please select a PCSK9 inhibitor type');
            } else {
                data['pcsk9-type'] = pcsk9TypeSelect.value;
                
                const pcsk9DoseSelect = document.getElementById('med-pcsk9-dose');
                if (!validateInput(pcsk9DoseSelect, true)) {
                    errors.push('Please select a PCSK9 inhibitor dose');
                } else {
                    data['pcsk9-dose'] = pcsk9DoseSelect.value;
                }
                
                const maxTherapyDurationSelect = document.getElementById('med-max-therapy-duration');
                if (!validateInput(maxTherapyDurationSelect, true)) {
                    errors.push('Please select duration on maximum therapy');
                } else {
                    data['max-therapy-duration'] = maxTherapyDurationSelect.value;
                }
                
                const ldlReductionInput = document.getElementById('med-ldl-reduction');
                if (ldlReductionInput.value && !validateInput(ldlReductionInput, false)) {
                    errors.push('Please enter a valid LDL reduction value between 0 and 100');
                } else if (ldlReductionInput.value) {
                    data['ldl-reduction'] = parseFloat(ldlReductionInput.value);
                }
            }
        }
        
        return {
            isValid: errors.length === 0,
            data: data,
            errors: errors
        };
    }
    
    /**
     * Display validation errors to the user
     * @param {Array} errors - Array of error messages
     */
    function displayErrors(errors) {
        if (errors.length === 0) return;
        
        const errorMessage = errors.join('\n ');
        showModal('Please correct the following errors:\n\n ' + errorMessage);
    }
    
    /**
     * Show a modal with a message
     * @param {string} message - Message to display in modal
     */
    function showModal(message) {
        document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>');
        openModal('warning-modal');
    }
    
    /**
     * Show loading spinner
     */
    function showLoading() {
        const loading = document.getElementById('loading-container');
        if (loading) {
            loading.style.display = 'flex';
        }
    }
    
    /**
     * Hide loading spinner
     */
    function hideLoading() {
        const loading = document.getElementById('loading-container');
        if (loading) {
            loading.style.display = 'none';
        }
    }
    
    /***********************************
     * CALCULATION FUNCTIONS
     ***********************************/
    
    /**
     * Calculate Lp(a) risk modifier based on concentration
     * @param {number} lpaValue - Lp(a) concentration in mg/dL
     * @returns {number} - Risk multiplier
     */
    function calculateLpaModifier(lpaValue) {
        // No additional risk below 30 mg/dL
        if (lpaValue < 30) {
            return 1.0;
        }
        // Linear increase 1.0-1.3x for 30-50 mg/dL
        else if (lpaValue >= 30 && lpaValue < 50) {
            return 1.0 + (lpaValue - 30) * (0.3 / 20);
        }
        // Linear increase 1.3-1.6x for 50-100 mg/dL
        else if (lpaValue >= 50 && lpaValue < 100) {
            return 1.3 + (lpaValue - 50) * (0.3 / 50);
        }
        // Linear increase 1.6-2.0x for 100-200 mg/dL
        else if (lpaValue >= 100 && lpaValue < 200) {
            return 1.6 + (lpaValue - 100) * (0.4 / 100);
        }
        // Linear increase 2.0-3.0x for 200-300 mg/dL
        else if (lpaValue >= 200 && lpaValue < 300) {
            return 2.0 + (lpaValue - 200) * (1.0 / 100);
        }
        // Maximum 3.0x increase for values 300 mg/dL
        else {
            return 3.0;
        }
    }
    
    /**
     * Determine risk category based on percentage
     * @param {number} riskPercentage - Risk percentage value
     * @returns {string} - Risk category (low, moderate, high)
     */
    function getRiskCategory(riskPercentage) {
        if (riskPercentage < 10) {
            return 'low';
        } else if (riskPercentage < 20) {
            return 'moderate';
        } else {
            return 'high';
        }
    }
    
    /**
     * Calculates Framingham Risk Score
     * @param {Object} data - Validated data from the FRS form
     * @returns {Object} - Risk calculation results
     */
    function calculateFraminghamRiskScore(data) {
        // Convert units if needed
        let totalChol = data.totalChol;
        let hdl = data.hdl;
        
        if (data.totalCholUnit === 'mg/dL') {
            totalChol = convertCholesterol(totalChol, 'mg/dL', 'mmol/L');
        }
        
        if (data.hdlUnit === 'mg/dL') {
            hdl = convertCholesterol(hdl, 'mg/dL', 'mmol/L');
        }
        
        let lnAge = Math.log(data.age);
        let lnTotalChol = Math.log(totalChol);
        let lnHdl = Math.log(hdl);
        let lnSbp = Math.log(data.sbp);
        
        let risk;
        
        if (data.sex === 'male') {
            // Coefficients for men
            risk = (lnAge * 3.11296) + 
                   (lnTotalChol * 1.12370) - 
                   (lnHdl * 0.93263) + 
                   (lnSbp * (data.bpTreatment ? 1.99881 : 1.93303)) + 
                   (data.smoker ? 0.65451 : 0) + 
                   (data.diabetes ? 0.57367 : 0) - 
                   23.9802;
        } else {
            // Coefficients for women
            risk = (lnAge * 2.72107) + 
                   (lnTotalChol * 1.20904) - 
                   (lnHdl * 0.70833) + 
                   (lnSbp * (data.bpTreatment ? 2.82263 : 2.76157)) + 
                   (data.smoker ? 0.52873 : 0) + 
                   (data.diabetes ? 0.69154 : 0) - 
                   26.1931;
        }
        
        // Calculate 10-year risk
        let baselineSurvival = data.sex === 'male' ? 0.88431 : 0.94833;
        let tenYearRisk = 1 - Math.pow(baselineSurvival, Math.exp(risk));
        let riskPercentage = tenYearRisk * 100;
        
        // Apply Lp(a) modifier if available
        let modifiedRiskPercentage = riskPercentage;
        let lpaModifier = 1.0;
        
        if (data.lpa !== null) {
            // Convert Lp(a) to mg/dL if needed
            let lpaValue = data.lpa;
            if (data.lpaUnit === 'nmol/L') {
                lpaValue = convertLpa(lpaValue, 'nmol/L', 'mg/dL');
            }
            
            // Calculate modifier based on Lp(a) level
            lpaModifier = calculateLpaModifier(lpaValue);
            modifiedRiskPercentage = riskPercentage * lpaModifier;
        }
        
        return {
            baseRisk: riskPercentage,
            lpaModifier: lpaModifier,
            modifiedRisk: modifiedRiskPercentage,
            riskCategory: getRiskCategory(modifiedRiskPercentage)
        };
    }
    
    /**
     * Calculates QRISK3 score
     * @param {Object} data - Validated data from the QRISK form
     * @returns {Object} - Risk calculation results
     */
    function calculateQRISK3Score(data) {
        // Convert units if needed
        const standardizedData = standardizeUnitsForQRISK3(data);
        
        // Calculate base QRISK3 score using the official algorithm
        const baseRiskScore = calculateRawQRISK3(standardizedData);
        
        // Apply Lp(a) modifier if available
        let lpaModifier = 1.0;
        let modifiedRiskPercentage = baseRiskScore;
        
        if (standardizedData.lpa !== null && standardizedData.lpa !== undefined) {
            // Convert Lp(a) to mg/dL if needed
            let lpaValue = standardizedData.lpa;
            if (standardizedData.lpaUnit === 'nmol/L') {
                lpaValue = convertLpa(lpaValue, 'nmol/L', 'mg/dL');
            }
            
            // Calculate modifier based on Lp(a) level
            lpaModifier = calculateLpaModifier(lpaValue);
            modifiedRiskPercentage = baseRiskScore * lpaModifier;
        }
        
        return {
            baseRisk: baseRiskScore,
            lpaModifier: lpaModifier,
            modifiedRisk: modifiedRiskPercentage,
            riskCategory: getRiskCategory(modifiedRiskPercentage),
            contributing: getContributingFactors(standardizedData)
        };
    }
    
    /**
     * Standardize units for QRISK3 calculation
     * @param {Object} data - Raw form data
     * @returns {Object} - Data with standardized units
     */
    function standardizeUnitsForQRISK3(data) {
        const standardized = { ...data };
        
        // Convert height and weight to calculate BMI if not provided
        if (!standardized.bmi && standardized.height && standardized.weight) {
            // Convert height to meters
            const heightInM = standardized.height / 100;
            
            // Convert weight to kg if in pounds
            let weightInKg = standardized.weight;
            if (standardized.weightUnit === 'lb') {
                weightInKg = convertWeightToKg(weightInKg);
            }
            
            // Calculate BMI
            standardized.bmi = weightInKg / (heightInM * heightInM);
        }
        
        // Calculate cholesterol ratio if not provided
        if (standardized.totalChol && standardized.hdl && !standardized.cholRatio) {
            let totalChol = standardized.totalChol;
            let hdl = standardized.hdl;
            
            // Convert to mmol/L if needed
            if (standardized.totalCholUnit === 'mg/dL') {
                totalChol = convertCholesterol(totalChol, 'mg/dL', 'mmol/L');
            }
            if (standardized.hdlUnit === 'mg/dL') {
                hdl = convertCholesterol(hdl, 'mg/dL', 'mmol/L');
            }
            
            standardized.cholRatio = totalChol / hdl;
        }
        
        // Check for systolic BP readings and calculate SD if not provided
        if (!standardized.sbpSd) {
            // Look for multiple SBP readings
            const sbpReadings = [];
            for (let i = 1; i <= 6; i++) {
                const readingId = `qrisk-sbp-reading-${i}`;
                const readingElement = document.getElementById(readingId);
                if (readingElement && readingElement.value) {
                    const reading = parseFloat(readingElement.value);
                    if (!isNaN(reading)) {
                        sbpReadings.push(reading);
                    }
                }
            }
            
            // Calculate SD if we have enough readings
            if (sbpReadings.length >= 3) {
                standardized.sbpSd = calculateStandardDeviation(sbpReadings);
            } else {
                // Default SD value if not calculated
                standardized.sbpSd = 0;
            }
        }
        
        return standardized;
    }
    
    /**
     * Calculate standard deviation for a set of values
     * @param {Array} values - Array of numeric values
     * @returns {number} - Standard deviation
     */
    function calculateStandardDeviation(values) {
        const n = values.length;
        if (n < 2) return 0;
        
        // Calculate mean
        const mean = values.reduce((sum, val) => sum + val, 0) / n;
        
        // Calculate sum of squared differences
        const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
        const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / (n - 1);
        
        return Math.sqrt(variance);
    }
    
    /**
     * Calculate raw QRISK3 score using the official algorithm
     * @param {Object} data - Standardized patient data
     * @returns {number} - 10-year risk percentage
     */
    function calculateRawQRISK3(data) {
        // Determine which algorithm to use based on sex
        const isFemale = data.sex === 'female';
        
        // Convert categorical variables to numeric values
        const ethrisk = convertEthnicity(data.ethnicity);
        const smoke_cat = convertSmoking(data.smoker);
        
        // Set boolean values for conditions
        const b_AF = data.atrialFibrillation ? 1 : 0;
        const b_atypicalantipsy = data.atypicalAntipsychotics ? 1 : 0;
        const b_corticosteroids = data.regularSteroids ? 1 : 0;
        const b_impotence2 = (!isFemale && data.erectileDysfunction) ? 1 : 0;
        const b_migraine = data.migraine ? 1 : 0;
        const b_ra = data.rheumatoidArthritis ? 1 : 0;
        const b_renal = data.chronicKidneyDisease ? 1 : 0;
        const b_semi = data.severeMentalIllness ? 1 : 0;
        const b_sle = data.systemicLupusErythematosus ? 1 : 0;
        const b_treatedhyp = data.bpTreatment ? 1 : 0;
        const b_type1 = (data.diabetes === 'type1') ? 1 : 0;
        const b_type2 = (data.diabetes === 'type2') ? 1 : 0;
        
        // Get continuous variables
        const age = data.age;
        const bmi = data.bmi;
        const sbp = data.sbp;
        const sbps5 = data.sbpSd || 0; // Standard deviation of SBP
        const rati = data.cholRatio; // Total cholesterol / HDL ratio
        const town = data.townsend || 0; // Default to 0 if not provided
        const fh_cvd = data.familyHistory ? 1 : 0;
        
        // Calculate the risk score using the appropriate function
        let score;
        if (isFemale) {
            score = cvd_female_raw(
                age, b_AF, b_atypicalantipsy, b_corticosteroids, b_migraine,
                b_ra, b_renal, b_semi, b_sle, b_treatedhyp, b_type1, b_type2,
                bmi, ethrisk, fh_cvd, rati, sbp, sbps5, smoke_cat, 10, town
            );
        } else {
            score = cvd_male_raw(
                age, b_AF, b_atypicalantipsy, b_corticosteroids, b_impotence2,
                b_migraine, b_ra, b_renal, b_semi, b_sle, b_treatedhyp, b_type1,
                b_type2, bmi, ethrisk, fh_cvd, rati, sbp, sbps5, smoke_cat, 10, town
            );
        }
        
        return score;
    }
    
    /**
     * Convert ethnicity values to QRISK3 numeric codes
     * @param {string} ethnicity - Ethnicity from form
     * @returns {number} - QRISK3 ethnicity code
     */
    function convertEthnicity(ethnicity) {
        const ethnicityMap = {
            'white': 1,
            'indian': 2,
            'pakistani': 3,
            'bangladeshi': 4,
            'other_asian': 5,
            'black_caribbean': 6,
            'black_african': 7,
            'chinese': 8,
            'other': 9
        };
        
        return ethnicityMap[ethnicity] || 1; // Default to White if not specified
    }
    
    /**
     * Convert smoking status to QRISK3 numeric codes
     * @param {string} smoker - Smoking status from form
     * @returns {number} - QRISK3 smoking code
     */
    function convertSmoking(smoker) {
        const smokingMap = {
            'non': 0,
            'ex': 1,
            'light': 2,
            'moderate': 3,
            'heavy': 4
        };
        
        return smokingMap[smoker] || 0; // Default to non-smoker if not specified
    }
    
    /**
     * Official QRISK3 algorithm for females
     * Directly ported from the published code
     */
    function cvd_female_raw(
        age, b_AF, b_atypicalantipsy, b_corticosteroids, b_migraine,
        b_ra, b_renal, b_semi, b_sle, b_treatedhyp, b_type1, b_type2,
        bmi, ethrisk, fh_cvd, rati, sbp, sbps5, smoke_cat, surv, town
    ) {
        const survivor = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0.988876402378082, // 10-year survival probability
            0, 0, 0, 0, 0
        ];
        
        // Conditional arrays for ethnicity and smoking
        const Iethrisk = [
            0,
            0,
            0.28040314332995425,
            0.56298994142075398,
            0.29590000851116516,
            0.0727853798779825450000000,
            -0.17072135508857317,
            -0.39371043314874971,
            -0.32632495283530272,
            -0.17127056883241784
        ];
        
        const Ismoke = [
            0,
            0.13386833786546262,
            0.56200858012438537,
            0.66749593377502547,
            0.84948177644830847
        ];
        
        // Applying fractional polynomial transforms
        const dage = age / 10;
        let age_1 = Math.pow(dage, -2);
        let age_2 = dage;
        
        const dbmi = bmi / 10;
        let bmi_1 = Math.pow(dbmi, -2);
        let bmi_2 = Math.pow(dbmi, -2) * Math.log(dbmi);
        
        // Centering continuous variables
        age_1 = age_1 - 0.053274843841791;
        age_2 = age_2 - 4.332503318786621;
        bmi_1 = bmi_1 - 0.154946178197861;
        bmi_2 = bmi_2 - 0.144462317228317;
        const rati_c = rati - 3.476326465606690;
        const sbp_c = sbp - 123.130012512207030;
        const sbps5_c = sbps5 - 9.002537727355957;
        const town_c = town - 0.392308831214905;
        
        // Start of sum
        let a = 0;
        
        // Conditional sums
        a += Iethrisk[ethrisk];
        a += Ismoke[smoke_cat];
        
        // Sum from continuous values
        a += age_1 * -8.1388109247726188;
        a += age_2 * 0.79733376689699098;
        a += bmi_1 * 0.29236092275460052;
        a += bmi_2 * -4.1513300213837665;
        a += rati_c * 0.15338035820802554;
        a += sbp_c * 0.0131314884071034240000000;
        a += sbps5_c * 0.0078894541014586095000000;
        a += town_c * 0.0772237905885901080000000;
        
        // Sum from boolean values
        a += b_AF * 1.5923354969269663;
        a += b_atypicalantipsy * 0.25237642070115557;
        a += b_corticosteroids * 0.59520725304601851;
        a += b_migraine * 0.301267260870345;
        a += b_ra * 0.21364803435181942;
        a += b_renal * 0.65194569493845833;
        a += b_semi * 0.12555308058820178;
        a += b_sle * 0.75880938654267693;
        a += b_treatedhyp * 0.50931593683423004;
        a += b_type1 * 1.7267977510537347;
        a += b_type2 * 1.0688773244615468;
        a += fh_cvd * 0.45445319020896213;
        
        // Sum from interaction terms
        a += age_1 * (smoke_cat === 1 ? 1 : 0) * -4.7057161785851891;
        a += age_1 * (smoke_cat === 2 ? 1 : 0) * -2.7430383403573337;
        a += age_1 * (smoke_cat === 3 ? 1 : 0) * -0.86608088829392182;
        a += age_1 * (smoke_cat === 4 ? 1 : 0) * 0.90241562369710648;
        a += age_1 * b_AF * 19.938034889546561;
        a += age_1 * b_corticosteroids * -0.98408045235936281;
        a += age_1 * b_migraine * 1.7634979587872999;
        a += age_1 * b_renal * -3.5874047731694114;
        a += age_1 * b_sle * 19.690303738638292;
        a += age_1 * b_treatedhyp * 11.872809733921812;
        a += age_1 * b_type1 * -1.2444332714320747;
        a += age_1 * b_type2 * 6.8652342000009599;
        a += age_1 * bmi_1 * 23.802623412141742;
        a += age_1 * bmi_2 * -71.184947692087007;
        a += age_1 * fh_cvd * 0.99467807940435127;
        a += age_1 * sbp_c * 0.0341318423386154850000000;
        a += age_1 * town_c * -1.0301180802035639;
        a += age_2 * (smoke_cat === 1 ? 1 : 0) * -0.0755892446431930260000000;
        a += age_2 * (smoke_cat === 2 ? 1 : 0) * -0.11951192874867074;
        a += age_2 * (smoke_cat === 3 ? 1 : 0) * -0.10366306397571923;
        a += age_2 * (smoke_cat === 4 ? 1 : 0) * -0.13991853591718389;
        a += age_2 * b_AF * -0.0761826510111625050000000;
        a += age_2 * b_corticosteroids * -0.12005364946742472;
        a += age_2 * b_migraine * -0.0655869178986998590000000;
        a += age_2 * b_renal * -0.22688873086442507;
        a += age_2 * b_sle * 0.0773479496790162730000000;
        a += age_2 * b_treatedhyp * 0.0009685782358817443600000;
        a += age_2 * b_type1 * -0.28724064624488949;
        a += age_2 * b_type2 * -0.0971122525906954890000000;
        a += age_2 * bmi_1 * 0.52369958933664429;
        a += age_2 * bmi_2 * 0.0457441901223237590000000;
        a += age_2 * fh_cvd * -0.0768850516984230380000000;
        a += age_2 * sbp_c * -0.0015082501423272358000000;
        a += age_2 * town_c * -0.0315934146749623290000000;
        
        // Calculate the score
        const score = 100.0 * (1 - Math.pow(survivor[surv], Math.exp(a)));
        return score;
    }
    
    /**
     * Official QRISK3 algorithm for males
     * Directly ported from the published code
     */
    function cvd_male_raw(
        age, b_AF, b_atypicalantipsy, b_corticosteroids, b_impotence2,
        b_migraine, b_ra, b_renal, b_semi, b_sle, b_treatedhyp, b_type1,
        b_type2, bmi, ethrisk, fh_cvd, rati, sbp, sbps5, smoke_cat, surv, town
    ) {
        const survivor = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0.977268040180206, // 10-year survival probability
            0, 0, 0, 0, 0
        ];
        
        // Conditional arrays for ethnicity and smoking
        const Iethrisk = [
            0,
            0,
            0.27719248760308279,
            0.47446360714931268,
            0.52961729919689371,
            0.0351001591862990170000000,
            -0.35807899669327919,
            -0.4005648523216514,
            -0.41522792889830173,
            -0.26321348134749967
        ];
        
        const Ismoke = [
            0,
            0.19128222863388983,
            0.55241588192645552,
            0.63835053027506072,
            0.78983819881858019
        ];
        
        // Applying fractional polynomial transforms
        const dage = age / 10;
        let age_1 = Math.pow(dage, -1);
        let age_2 = Math.pow(dage, 3);
        
        const dbmi = bmi / 10;
        let bmi_1 = Math.pow(dbmi, -2);
        let bmi_2 = Math.pow(dbmi, -2) * Math.log(dbmi);
        
        // Centering continuous variables
        age_1 = age_1 - 0.234766781330109;
        age_2 = age_2 - 77.284080505371094;
        bmi_1 = bmi_1 - 0.149176135659218;
        bmi_2 = bmi_2 - 0.141913309693336;
        const rati_c = rati - 4.300998687744141;
        const sbp_c = sbp - 128.571578979492190;
        const sbps5_c = sbps5 - 8.756621360778809;
        const town_c = town - 0.526304900646210;
        
        // Start of sum
        let a = 0;
        
        // Conditional sums
        a += Iethrisk[ethrisk];
        a += Ismoke[smoke_cat];
        
        // Sum from continuous values
        a += age_1 * -17.839781666005575;
        a += age_2 * 0.0022964880605765492000000;
        a += bmi_1 * 2.4562776660536358;
        a += bmi_2 * -8.3011122314711354;
        a += rati_c * 0.17340196856327111;
        a += sbp_c * 0.0129101265425533050000000;
        a += sbps5_c * 0.0102519142912904560000000;
        a += town_c * 0.0332682012772872950000000;
        
        // Sum from boolean values
        a += b_AF * 0.88209236928054657;
        a += b_atypicalantipsy * 0.13046879855173513;
        a += b_corticosteroids * 0.45485399750445543;
        a += b_impotence2 * 0.22251859086705383;
        a += b_migraine * 0.25584178074159913;
        a += b_ra * 0.20970658013956567;
        a += b_renal * 0.71853261288274384;
        a += b_semi * 0.12133039882047164;
        a += b_sle * 0.4401572174457522;
        a += b_treatedhyp * 0.51659871082695474;
        a += b_type1 * 1.2343425521675175;
        a += b_type2 * 0.85942071430932221;
        a += fh_cvd * 0.54055469009390156;
        
        // Sum from interaction terms
        a += age_1 * (smoke_cat === 1 ? 1 : 0) * -0.21011133933516346;
        a += age_1 * (smoke_cat === 2 ? 1 : 0) * 0.75268676447503191;
        a += age_1 * (smoke_cat === 3 ? 1 : 0) * 0.99315887556405791;
        a += age_1 * (smoke_cat === 4 ? 1 : 0) * 2.1331163414389076;
        a += age_1 * b_AF * 3.4896675530623207;
        a += age_1 * b_corticosteroids * 1.1708133653489108;
        a += age_1 * b_impotence2 * -1.506400985745431;
        a += age_1 * b_migraine * 2.3491159871402441;
        a += age_1 * b_renal * -0.50656716327223694;
        a += age_1 * b_treatedhyp * 6.5114581098532671;
        a += age_1 * b_type1 * 5.3379864878006531;
        a += age_1 * b_type2 * 3.6461817406221311;
        a += age_1 * bmi_1 * 31.004952956033886;
        a += age_1 * bmi_2 * -111.29157184391643;
        a += age_1 * fh_cvd * 2.7808628508531887;
        a += age_1 * sbp_c * 0.0188585244698658530000000;
        a += age_1 * town_c * -0.1007554870063731;
        a += age_2 * (smoke_cat === 1 ? 1 : 0) * -0.0004985487027532612100000;
        a += age_2 * (smoke_cat === 2 ? 1 : 0) * -0.0007987563331738541400000;
        a += age_2 * (smoke_cat === 3 ? 1 : 0) * -0.0008370618426625129600000;
        a += age_2 * (smoke_cat === 4 ? 1 : 0) * -0.0007840031915563728900000;
        a += age_2 * b_AF * -0.0003499560834063604900000;
        a += age_2 * b_corticosteroids * -0.0002496045095297166000000;
        a += age_2 * b_impotence2 * -0.0011058218441227373000000;
        a += age_2 * b_migraine * 0.0001989644604147863100000;
        a += age_2 * b_renal * -0.0018325930166498813000000;
        a += age_2 * b_treatedhyp * 0.0006383805310416501300000;
        a += age_2 * b_type1 * 0.0006409780808752897000000;
        a += age_2 * b_type2 * -0.0002469569558886831500000;
        a += age_2 * bmi_1 * 0.0050380102356322029000000;
        a += age_2 * bmi_2 * -0.0130744830025243190000000;
        a += age_2 * fh_cvd * -0.0002479180990739603700000;
        a += age_2 * sbp_c * -0.0000127187419158845700000;
        a += age_2 * town_c * -0.0000932996423232728880000;
        
        // Calculate the score
        const score = 100.0 * (1 - Math.pow(survivor[surv], Math.exp(a)));
        return score;
    }
    
    /**
     * Identify contributing risk factors from the data
     * @param {Object} data - Patient data
     * @returns {Array} - List of contributing risk factors
     */
    function getContributingFactors(data) {
        const factors = [];
        
        // Add factors based on patient data
        if (data.age >= 65) {
            factors.push({
                name: 'Advanced age',
                impact: 'high',
                description: 'Age is a strong independent risk factor for CVD'
            });
        } else if (data.age >= 55) {
            factors.push({
                name: 'Age',
                impact: 'moderate',
                description: 'Age is a significant risk factor for CVD'
            });
        }
        
        if (data.smoker && data.smoker !== 'non') {
            const smokingImpact = data.smoker === 'heavy' ? 'high' :
                (data.smoker === 'moderate' ? 'moderate' : 'low');
            factors.push({
                name: 'Smoking',
                impact: smokingImpact,
                description: 'Smoking significantly increases CVD risk'
            });
        }
        
        if (data.bmi >= 30) {
            factors.push({
                name: 'Obesity',
                impact: 'moderate',
                description: 'BMI 30 kg/m increases CVD risk'
            });
        } else if (data.bmi >= 25) {
            factors.push({
                name: 'Overweight',
                impact: 'low',
                description: 'BMI 25-29.9 kg/m slightly increases CVD risk'
            });
        }
        
        if (data.sbp >= 160) {
            factors.push({
                name: 'Severe hypertension',
                impact: 'high',
                description: 'Systolic BP 160 mmHg significantly increases CVD risk'
            });
        } else if (data.sbp >= 140) {
            factors.push({
                name: 'Hypertension',
                impact: 'moderate',
                description: 'Systolic BP 140-159 mmHg increases CVD risk'
            });
        }
        
        if (data.cholRatio >= 6) {
            factors.push({
                name: 'Poor cholesterol ratio',
                impact: 'high',
                description: 'Total:HDL cholesterol ratio 6 significantly increases risk'
            });
        } else if (data.cholRatio >= 4.5) {
            factors.push({
                name: 'Elevated cholesterol ratio',
                impact: 'moderate',
                description: 'Total:HDL cholesterol ratio 4.5-5.9 increases risk'
            });
        }
        
        if (data.diabetes === 'type1') {
            factors.push({
                name: 'Type 1 diabetes',
                impact: 'high',
                description: 'Type 1 diabetes significantly increases CVD risk'
            });
        } else if (data.diabetes === 'type2') {
            factors.push({
                name: 'Type 2 diabetes',
                impact: 'high',
                description: 'Type 2 diabetes significantly increases CVD risk'
            });
        }
        
        if (data.familyHistory) {
            factors.push({
                name: 'Family history of CVD',
                impact: 'moderate',
                description: 'Premature CVD in first-degree relative increases risk'
            });
        }
        
        // Medical conditions
        if (data.atrialFibrillation) {
            factors.push({
                name: 'Atrial fibrillation',
                impact: 'high',
                description: 'Atrial fibrillation substantially increases stroke risk'
            });
        }
        
        if (data.chronicKidneyDisease) {
            factors.push({
                name: 'Chronic kidney disease',
                impact: 'high',
                description: 'CKD stages 3-5 significantly increases CVD risk'
            });
        }
        
        if (data.rheumatoidArthritis) {
            factors.push({
                name: 'Rheumatoid arthritis',
                impact: 'moderate',
                description: 'Rheumatoid arthritis increases CVD risk'
            });
        }
        
        if (data.systemicLupusErythematosus) {
            factors.push({
                name: 'Systemic lupus erythematosus',
                impact: 'moderate',
                description: 'SLE increases CVD risk'
            });
        }
        
        if (data.migraine) {
            factors.push({
                name: 'Migraine',
                impact: 'low',
                description: 'Migraine slightly increases stroke risk'
            });
        }
        
        if (data.severeMentalIllness) {
            factors.push({
                name: 'Severe mental illness',
                impact: 'low',
                description: 'Severe mental illness slightly increases CVD risk'
            });
        }
        
        if (data.erectileDysfunction && data.sex === 'male') {
            factors.push({
                name: 'Erectile dysfunction',
                impact: 'moderate',
                description: 'Erectile dysfunction is associated with increased CVD risk in men'
            });
        }
        
        // Medications
        if (data.atypicalAntipsychotics) {
            factors.push({
                name: 'Atypical antipsychotics',
                impact: 'low',
                description: 'Atypical antipsychotics slightly increase CVD risk'
            });
        }
        
        if (data.regularSteroids) {
            factors.push({
                name: 'Corticosteroids',
                impact: 'moderate',
                description: 'Regular corticosteroid use increases CVD risk'
            });
        }
        
        // Lp(a)
        if (data.lpa !== null && data.lpa !== undefined) {
            let lpaValue = data.lpa;
            if (data.lpaUnit === 'nmol/L') {
                lpaValue = convertLpa(lpaValue, 'nmol/L', 'mg/dL');
            }
            
            if (lpaValue >= 180) {
                factors.push({
                    name: 'Very high Lp(a)',
                    impact: 'high',
                    description: 'Lp(a) 180 mg/dL substantially increases CVD risk'
                });
            } else if (lpaValue >= 50) {
                factors.push({
                    name: 'Elevated Lp(a)',
                    impact: 'moderate',
                    description: 'Lp(a) 50 mg/dL increases CVD risk'
                });
            } else if (lpaValue >= 30) {
                factors.push({
                    name: 'Borderline Lp(a)',
                    impact: 'low',
                    description: 'Lp(a) 30-49 mg/dL slightly increases CVD risk'
                });
            }
        }
        
        return factors;
    }
    
    /**
     * Calculate BMI from height and weight
     * @param {number} height - Height in cm
     * @param {number} weight - Weight in kg
     * @returns {number} - BMI value
     */
    function calculateBMI(height, weight) {
        if (!height || !weight) return null;
        // Convert height from cm to meters
        const heightInM = height / 100;
        return weight / (heightInM * heightInM);
    }
    
    /**
     * Format BMI with risk category
     * @param {number} bmi - BMI value
     * @returns {string} - Formatted BMI with category
     */
    function formatBMI(bmi) {
        if (!bmi) return "Not available";
        
        let category;
        if (bmi < 18.5) {
            category = "Underweight";
        } else if (bmi < 25) {
            category = "Normal weight";
        } else if (bmi < 30) {
            category = "Overweight";
        } else {
            category = "Obese";
        }
        
        return bmi.toFixed(1) + " kg/m (" + category + ")";
    }
    
    /**
     * Update the comparison tab status
     * @param {string} calculator - 'frs' or 'qrisk'
     * @param {boolean} completed - Whether the calculator has been completed
     */
    function updateComparisonTabStatus(calculator, completed) {
        const statusElement = document.getElementById(`${calculator}-status`);
        const iconElement = document.getElementById(`${calculator}-status-icon`);
        
        if (statusElement && iconElement) {
            if (completed) {
                statusElement.textContent = 'Completed';
                statusElement.classList.add('status-complete');
                
                // Update icon to checkmark
                iconElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>';
                iconElement.classList.add('status-icon-complete');
            } else {
                statusElement.textContent = 'Not completed';
                statusElement.classList.remove('status-complete');
                
                // Update icon to X
                iconElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>';
                iconElement.classList.remove('status-icon-complete');
            }
        }
    }
    
    /**
     * Determine treatment recommendation based on CCS guidelines and risk score
     * @param {number} riskScore - 10-year CVD risk percentage
     * @param {number} ldl - LDL cholesterol value (if available)
     * @param {boolean} hasDiabetes - Whether patient has diabetes
     * @param {number} age - Patient age
     * @returns {string} - HTML-formatted treatment recommendation
     */
    function getCCSRecommendation(riskScore, ldl = null, hasDiabetes = false, age = null) {
        // Determine if Lp(a) is elevated based on global variables or DOM elements
        let hasHighLpa = false;
        
        // Try to get Lp(a) value from FRS form
        const frsLpa = document.getElementById('frs-lpa');
        if (frsLpa && frsLpa.value) {
            let lpaValue = parseFloat(frsLpa.value);
            const lpaUnit = document.getElementById('frs-lpa-unit').value;
            
            if (lpaUnit === 'nmol/L') {
                lpaValue = convertLpa(lpaValue, 'nmol/L', 'mg/dL');
            }
            
            hasHighLpa = lpaValue >= 50; // 50 mg/dL threshold for "elevated"
        }
        
        // If not found in FRS form, try QRISK form
        if (!hasHighLpa) {
            const qriskLpa = document.getElementById('qrisk-lpa');
            if (qriskLpa && qriskLpa.value) {
                let lpaValue = parseFloat(qriskLpa.value);
                const lpaUnit = document.getElementById('qrisk-lpa-unit').value;
                
                if (lpaUnit === 'nmol/L') {
                    lpaValue = convertLpa(lpaValue, 'nmol/L', 'mg/dL');
                }
                
                hasHighLpa = lpaValue >= 50; // 50 mg/dL threshold for "elevated"
            }
        }
        
        // Get enhanced recommendations that include rationales
        const recommendations = {
            statinChange: null,
            ezetimibeChange: null,
            pcsk9Change: null,
            otherChanges: [],
            nonPharmacological: [
                'Reinforce therapeutic lifestyle changes including Mediterranean or DASH diet',
                'Encourage regular physical activity (150+ minutes/week of moderate activity)',
                'Smoking cessation for all smokers'
            ]
        };
        
        // High risk (20%)
        if (riskScore >= 20) {
            recommendations.statinChange = 'High-intensity statin therapy is strongly recommended';
            
            if (ldl !== null && ldl >= 1.8) {
                recommendations.ezetimibeChange = 'Add ezetimibe if LDL-C remains 1.8 mmol/L despite maximum statin';
                
                if (ldl >= 2.5) {
                    recommendations.pcsk9Change = 'Consider PCSK9 inhibitor if LDL-C remains 2.5 mmol/L despite maximum tolerated statin plus ezetimibe';
                }
            }
            
            if (hasHighLpa) {
                recommendations.otherChanges.push('More aggressive LDL-C targets may be beneficial with elevated Lp(a)');
            }
        }
        // Intermediate risk (10-19.9%)
        else if (riskScore >= 10) {
            if (ldl !== null && ldl >= 3.5) {
                recommendations.statinChange = 'Statin therapy recommended as LDL-C 3.5 mmol/L';
            } else if (hasDiabetes && age >= 40) {
                recommendations.statinChange = 'Statin therapy recommended for diabetes patients 40 years';
            } else {
                recommendations.statinChange = 'Consider moderate to high-intensity statin therapy';
            }
            
            if (ldl !== null && ldl >= 2.0) {
                recommendations.ezetimibeChange = 'Consider adding ezetimibe if LDL-C remains 2.0 mmol/L despite statin';
            }
        }
        // Low risk (<10%)
        else {
            if (ldl !== null && ldl >= 5.0) {
                recommendations.statinChange = 'Consider statin therapy as LDL-C 5.0 mmol/L';
                recommendations.otherChanges.push('Consider referral for genetic testing for familial hypercholesterolemia');
            } else {
                recommendations.statinChange = 'Pharmacotherapy generally not recommended';
            }
        }
        
        const targets = {
            riskCategory: riskScore >= 20 ? 'High Risk' : (riskScore >= 10 ? 'Intermediate Risk' : 'Low Risk'),
            hasElevatedLpa: hasHighLpa
        };
        
        const assessment = {
            atLDLTarget: ldl !== null ? (ldl < (riskScore >= 20 ? 1.8 : 2.0)) : false,
            gapToLDLTarget: ldl !== null ? (ldl - (riskScore >= 20 ? 1.8 : 2.0)) : 0
        };
        
        // Return formatted recommendations
        return getFormattedRecommendations(recommendations, targets, assessment);
    }
    
    /**
     * Format recommendations with guideline citations and rationales
     * @param {Object} recommendations - Treatment recommendations
     * @param {Object} targets - Target levels
     * @param {Object} assessment - Current therapy assessment
     * @returns {string} - Formatted HTML for recommendations
     */
    function getFormattedRecommendations(recommendations, targets, assessment) {
        let html = '';
        
        // Statin recommendations with guideline support
        if (recommendations.statinChange) {
            html += `<div class="recommendation-item">
                <h5 class="recommendation-title">Statin Therapy</h5>
                <p>${recommendations.statinChange}</p>
                <div class="guideline-rationale">
                    <p><strong>Guideline Rationale:</strong> `;
            
            if (recommendations.statinChange.includes('high-intensity')) {
                html += `CCS Guidelines recommend high-intensity statin therapy for patients with LDL-C 3.5 mmol/L, 
                        established ASCVD, or high cardiovascular risk. High-intensity statin therapy is associated with 
                        50% reduction in LDL-C <span class="evidence-quality high">High-Quality Evidence</span>`;
            } else if (recommendations.statinChange.includes('moderate-intensity')) {
                html += `CCS Guidelines recommend moderate-intensity statin therapy for intermediate risk patients 
                        to achieve 30-50% reduction in LDL-C <span class="evidence-quality moderate">Moderate-Quality Evidence</span>`;
            } else if (recommendations.statinChange.includes('not recommended')) {
                html += `CCS Guidelines recommend pharmacotherapy only for specific indications in low-risk patients, 
                        emphasizing lifestyle modifications as primary preventive strategy 
                        <span class="evidence-quality high">High-Quality Evidence</span>`;
            }
            
            html += `</p>
                </div>
            </div>`;
        }
        
        // Ezetimibe recommendations with guideline support
        if (recommendations.ezetimibeChange) {
            html += `<div class="recommendation-item">
                <h5 class="recommendation-title">Ezetimibe</h5>
                <p>${recommendations.ezetimibeChange}</p>
                <div class="guideline-rationale">
                    <p><strong>Guideline Rationale:</strong> CCS Guidelines recommend adding ezetimibe for patients not at target 
                    despite maximum tolerated statin therapy. Ezetimibe typically provides an additional 15-25% 
                    reduction in LDL-C <span class="evidence-quality high">High-Quality Evidence</span>`;
                    
            if (!assessment.atLDLTarget) {
                html += ` Current LDL-C of ${assessment.gapToLDLTarget.toFixed(2)} mmol/L above target.`;
            }
                    
            html += `</p>
                </div>
            </div>`;
        }
        
        // PCSK9 inhibitor recommendations with guideline support
        if (recommendations.pcsk9Change) {
            html += `<div class="recommendation-item">
                <h5 class="recommendation-title">PCSK9 Inhibitor</h5>
                <p>${recommendations.pcsk9Change}</p>
                <div class="guideline-rationale">
                    <p><strong>Guideline Rationale:</strong> CCS Guidelines recommend considering PCSK9 inhibitors for 
                    patients with established ASCVD, FH, or high cardiovascular risk who have not achieved target LDL-C 
                    despite maximum tolerated statin and ezetimibe therapy <span class="evidence-quality high">High-Quality Evidence</span>. 
                    PCSK9 inhibitors typically reduce LDL-C by an additional 50-60%.`;
                    
            if (targets.riskCategory.includes('High')) {
                html += ` For ${targets.riskCategory} patients, more aggressive LDL-C lowering provides additional 
                        benefit (CCS Guidelines 2021).`;
            }
                    
            html += `</p>
                </div>
            </div>`;
        }
        
        // Additional recommendations
        if (recommendations.otherChanges.length > 0) {
            html += `<div class="recommendation-item">
                <h5 class="recommendation-title">Additional Recommendations</h5>
                <ul>
                    ${recommendations.otherChanges.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
                <div class="guideline-rationale">
                    <p><strong>Guideline Rationale:</strong> `;
            
            if (recommendations.otherChanges.some(rec => rec.includes('Lp(a)'))) {
                html += `CCS Guidelines recognize elevated Lp(a) (50 mg/dL or 100 nmol/L) as an independent risk 
                        factor warranting more aggressive LDL-C targets and family screening 
                        <span class="evidence-quality moderate">Moderate-Quality Evidence</span>. `;
            }
            
            if (recommendations.otherChanges.some(rec => rec.includes('genetic'))) {
                html += `LDL-C 5.0 mmol/L may indicate familial hypercholesterolemia, which requires specific 
                        management and family screening <span class="evidence-quality high">High-Quality Evidence</span>. `;
            }
            
            html += `</p>
                </div>
            </div>`;
        }
        
        // Non-pharmacological recommendations
        if (recommendations.nonPharmacological.length > 0) {
            html += `<div class="recommendation-item">
                <h5 class="recommendation-title">Non-Pharmacological Therapy</h5>
                <ul>
                    ${recommendations.nonPharmacological.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
                <div class="guideline-rationale">
                    <p><strong>Guideline Rationale:</strong> CCS Guidelines emphasize that lifestyle modifications should 
                    be prescribed in all patients, including nutritional counseling and regular physical activity, 
                    independent of pharmacologic therapy <span class="evidence-quality high">High-Quality Evidence</span>.</p>
                </div>
            </div>`;
        }
        
        // Add final guideline reference
        html += `
            <div class="guideline-citation">
                <p><strong>References:</strong></p>
                <ol>
                    <li>Pearson GJ, et al. 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in Adults. Can J Cardiol. 2021;37(8):1129-1150.</li>
                    <li>Anderson TJ, et al. 2016 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult. Can J Cardiol. 2016;32(11):1263-1282.</li>
                </ol>
            </div>
        `;
        
        return html;
    }
    
    /***********************************
     * DISPLAY RESULTS FUNCTIONS
     ***********************************/
    
    /**
     * Display FRS results in the results section
     * @param {Object} data - Input data from the form
     * @param {Object} results - Calculation results
     * @param {string} recommendations - HTML-formatted treatment recommendations
     */
    function displayFRSResults(data, results, recommendations) {
        const resultsContainer = document.getElementById('results-container');
        const resultsDiv = document.getElementById('risk-results');
        
        if (!resultsContainer || !resultsDiv) {
            console.error('Results container not found');
            return;
        }
        
        // Get result template
        const template = document.getElementById('single-risk-template');
        if (!template) {
            console.error('Result template not found');
            return;
        }
        
        // Create a new results card (don't clear previous results)
        const resultCard = template.content.cloneNode(true);
        
        // Set title
        resultCard.querySelector('.risk-title').textContent = 'Framingham Risk Score Results';
        
        // Set risk values
        resultCard.querySelector('.risk-value').textContent = `${results.modifiedRisk.toFixed(1)}%`;
        resultCard.querySelector('.base-risk').textContent = `${results.baseRisk.toFixed(1)}%`;
        
        // Set Lp(a) modifier
        const modifierRow = resultCard.querySelector('.lpa-modifier-row');
        if (results.lpaModifier > 1.0) {
            resultCard.querySelector('.lpa-modifier').textContent = `${results.lpaModifier.toFixed(1)}x`;
        } else {
            modifierRow.style.display = 'none';
        }
        
        resultCard.querySelector('.adjusted-risk').textContent = `${results.modifiedRisk.toFixed(1)}%`;
        resultCard.querySelector('.risk-badge').textContent = results.riskCategory.charAt(0).toUpperCase() + results.riskCategory.slice(1);
        resultCard.querySelector('.risk-badge').classList.add(results.riskCategory);
        
        // Risk category in results
        resultCard.querySelector('.risk-category').textContent = 
            results.riskCategory.charAt(0).toUpperCase() + results.riskCategory.slice(1) + ' Risk';
        
        // Set interpretation
        resultCard.querySelector('.risk-interpretation').innerHTML = `
            <p>Based on the FRS calculator, this individual has a ${results.modifiedRisk.toFixed(1)}% risk of experiencing a cardiovascular event in the next 10 years, which is classified as <strong>${results.riskCategory} risk</strong>.</p>
            ${data.lpa ? `<p>The baseline risk of ${results.baseRisk.toFixed(1)}% has been modified by a factor of ${results.lpaModifier.toFixed(1)}x due to the Lp(a) level.</p>` : ''}
        `;
        
        // Add to results - prepend to show newest result at top
        const timestamp = new Date();
        const resultCardElement = document.createElement('div');
        resultCardElement.className = 'result-card-wrapper';
        resultCardElement.innerHTML = `<div class="result-timestamp">Calculated on ${timestamp.toLocaleString()}</div>`;
        resultCardElement.appendChild(resultCard);
        resultsDiv.insertBefore(resultCardElement, resultsDiv.firstChild);
        
        // Show treatment recommendations
        document.getElementById('recommendations-content').innerHTML = recommendations;
        
        // Set date and show results container
        document.querySelector('#results-date span').textContent = new Date().toLocaleDateString();
        resultsContainer.style.display = 'block';
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    /**
     * Display QRISK3 results in the results section
     * @param {Object} data - Input data from the form
     * @param {Object} results - Calculation results
     * @param {string} recommendations - HTML-formatted treatment recommendations
     */
    function displayQRISKResults(data, results, recommendations) {
        const resultsContainer = document.getElementById('results-container');
        const resultsDiv = document.getElementById('risk-results');
        
        if (!resultsContainer || !resultsDiv) {
            console.error('Results container not found');
            return;
        }
        
        // Get result template
        const template = document.getElementById('single-risk-template');
        if (!template) {
            console.error('Result template not found');
            return;
        }
        
        // Create a new results card (don't clear previous results)
        const resultCard = template.content.cloneNode(true);
        
        // Set title
        resultCard.querySelector('.risk-title').textContent = 'QRISK3 Results';
        
        // Set risk values
        resultCard.querySelector('.risk-value').textContent = `${results.modifiedRisk.toFixed(1)}%`;
        resultCard.querySelector('.base-risk').textContent = `${results.baseRisk.toFixed(1)}%`;
        
        // Set Lp(a) modifier
        const modifierRow = resultCard.querySelector('.lpa-modifier-row');
        if (results.lpaModifier > 1.0) {
            resultCard.querySelector('.lpa-modifier').textContent = `${results.lpaModifier.toFixed(1)}x`;
        } else {
            modifierRow.style.display = 'none';
        }
        
        resultCard.querySelector('.adjusted-risk').textContent = `${results.modifiedRisk.toFixed(1)}%`;
        resultCard.querySelector('.risk-badge').textContent = results.riskCategory.charAt(0).toUpperCase() + results.riskCategory.slice(1);
        resultCard.querySelector('.risk-badge').classList.add(results.riskCategory);
        
        // Risk category in results
        resultCard.querySelector('.risk-category').textContent = 
            results.riskCategory.charAt(0).toUpperCase() + results.riskCategory.slice(1) + ' Risk';
        
        // Additional factors considered by QRISK3
        let additionalFactors = [];
        if (data.familyHistory) additionalFactors.push('Family history of CVD');
        if (data.ethnicity !== 'white') additionalFactors.push('Ethnicity factors');
        if (data.atrialFibrillation) additionalFactors.push('Atrial fibrillation');
        if (data.rheumatoidArthritis) additionalFactors.push('Rheumatoid arthritis');
        if (data.chronicKidneyDisease) additionalFactors.push('Chronic kidney disease');
        if (data.migraine) additionalFactors.push('Migraine');
        if (data.systemicLupusErythematosus) additionalFactors.push('Systemic lupus erythematosus');
        if (data.severeMentalIllness) additionalFactors.push('Severe mental illness');
        if (data.erectileDysfunction && data.sex === 'male') additionalFactors.push('Erectile dysfunction');
        if (data.atypicalAntipsychotics) additionalFactors.push('Atypical antipsychotics');
        if (data.regularSteroids) additionalFactors.push('Regular corticosteroids');
        
        // Set interpretation
        resultCard.querySelector('.risk-interpretation').innerHTML = `
            <p>Based on the QRISK3 calculator, this individual has a ${results.modifiedRisk.toFixed(1)}% risk of experiencing a cardiovascular event in the next 10 years, which is classified as <strong>${results.riskCategory} risk</strong>.</p>
            ${data.lpa ? `<p>The baseline risk of ${results.baseRisk.toFixed(1)}% has been modified by a factor of ${results.lpaModifier.toFixed(1)}x due to the Lp(a) level.</p>` : ''}
            ${additionalFactors.length > 0 ? `<p>Additional factors considered in QRISK3: ${additionalFactors.join(', ')}.</p>` : ''}
        `;
        
        // Add to results - prepend to show newest result at top
        const timestamp = new Date();
        const resultCardElement = document.createElement('div');
        resultCardElement.className = 'result-card-wrapper';
        resultCardElement.innerHTML = `<div class="result-timestamp">Calculated on ${timestamp.toLocaleString()}</div>`;
        resultCardElement.appendChild(resultCard);
        resultsDiv.insertBefore(resultCardElement, resultsDiv.firstChild);
        
        // Show treatment recommendations
        document.getElementById('recommendations-content').innerHTML = recommendations;
        
        // Set date and show results container
        document.querySelector('#results-date span').textContent = new Date().toLocaleDatetitle" id="disclaimer-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Legal Disclaimer
                </h3>
                <button type="button" class="modal-close" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="disclaimer-content">
                    <h4>Healthcare Professional Use Only</h4>
                    <p>This CVD Risk Toolkit is intended exclusively for use by qualified healthcare professionals as a supplement to, not a replacement for, clinical judgment. This tool should not be used by individuals to self-diagnose or self-treat cardiovascular disease or related conditions.</p>
                    
                    <h4>No Substitute for Clinical Judgment</h4>
                    <p>The risk calculations, modifiers, and treatment recommendations provided by this tool are based on statistical models and clinical guidelines which may not account for all individual patient factors. Healthcare professionals must exercise their own clinical judgment when interpreting results and determining appropriate patient care.</p>
                    
                    <h4>Evolving Research Area</h4>
                    <p>The Lp(a) risk modifier implementation is based on current evidence as of 2025, but this is an evolving area of research. The specific risk multipliers may change as new research emerges, and the clinical significance of elevated Lp(a) may vary among different patient populations.</p>
                    
                    <h4>Guideline-Based Recommendations</h4>
                    <p>Treatment recommendations are derived from published clinical guidelines including the 2021 Canadian Cardiovascular Society Guidelines, 2019 ESC/EAS Guidelines, and 2018 AHA/ACC Guidelines. Healthcare professionals should consult the most current guidelines when making treatment decisions.</p>
                    
                    <h4>No Data Storage</h4>
                    <p>This tool performs all calculations locally in your web browser and does not transmit or store patient data. No information entered into this tool is saved after you close or reload the page, unless you explicitly export or print the results.</p>
                    
                    <h4>Limitations</h4>
                    <p>The risk calculators used in this toolkit have known limitations:</p>
                    <ul>
                        <li>The Framingham Risk Score was developed in a predominantly white North American population and may not be as accurate in other ethnic groups.</li>
                        <li>QRISK3, while more inclusive of ethnicities, was developed in the UK population and may need adjustment for use in other countries.</li>
                        <li>Both calculators may over- or under-estimate risk in certain populations or individuals with unusual risk factor profiles.</li>
                        <li>The 10-year risk prediction provides only a medium-term view and may not fully reflect lifetime risk, especially in younger individuals.</li>
                    </ul>
                    
                    <h4>No Warranty</h4>
                    <p>This tool is provided "as is" without warranties of any kind, either expressed or implied, including but not limited to implied warranties of merchantability and fitness for a particular purpose.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="secondary-btn close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Core JavaScript - at the end of the body to improve page load performance -->
    <script type="text/javascript">
    /**
     * CVD Risk Toolkit with Lp(a) Post-Test Modifier
     * Version: 3.0.1
     * Last Updated: May 04, 2025
     * 
     * This script includes all necessary functionality for the application:
     * - User interface interactions
     * - Form validation
     * - Risk calculations
     * - Results display
     * - Medication recommendations
     * - Data management
     */
    
    // Application state
    const appState = {
        frsCalculated: false,
        qriskCalculated: false,
        frsResults: null,
        qriskResults: null,
        medicationRecommendation: null,
        theme: localStorage.getItem('theme') || 'light',
        offline: !navigator.onLine
    };
    
    /**
     * Initialize the application when DOM is fully loaded
     */
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Initializing CVD Risk Toolkit v3.0.1");
        
        // Setup UI interactions
        setupTabNavigation();
        setupCardHeaders();
        setupModalHandlers();
        setupThemeToggle();
        setupTooltips();
        
        // Setup form interactions
        setupFormValidation();
        setupUnitConversions();
        setupDynamicFormElements();
        setupFormResetButtons();
        
        // Setup buttons
        setupCalculationButtons();
        setupExportButtons();
        setupFooterLinks();
        
        // Add window event listeners
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Set current date in results section
        document.querySelector('#results-date span').textContent = new Date().toLocaleDateString();
        
        // Initialize form state from localStorage if available
        loadSavedFormState();
        
        // Check if Juno integration is available
        checkJunoIntegration();
        
        console.log("CVD Risk Toolkit initialization complete");
    });
    
    /***********************************
     * USER INTERFACE FUNCTIONS
     ***********************************/
    
    /**
     * Set up tab navigation
     */
    function setupTabNavigation() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function(event) {
                event.preventDefault();
                const tabId = this.getAttribute('data-tab');
                openTab(event, tabId);
            });
        });
        
        // Help modal tabs
        const helpTabs = document.querySelectorAll('.help-tab');
        helpTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and content
                document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.help-content').forEach(c => {
                    c.classList.remove('active');
                    c.hidden = true;
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                
                // Show corresponding content
                const tabId = this.getAttribute('data-tab');
                const content = document.getElementById(tabId);
                content.classList.add('active');
                content.hidden = false;
                content.setAttribute('aria-hidden', 'false');
            });
        });
    }
    
    /**
     * Opens the specified tab and handles tab switching
     * @param {Event} evt - The click event
     * @param {string} tabId - The ID of the tab to open
     */
    function openTab(evt, tabId) {
        // Hide all tab content
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove("active");
            tabContents[i].setAttribute('aria-hidden', 'true');
        }
        
        // Remove active class from all tabs
        const tabs = document.getElementsByClassName("tab");
        for (let i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove("active");
            tabs[i].setAttribute('aria-selected', 'false');
        }
        
        // Show the selected tab content and mark the button as active
        document.getElementById(tabId).classList.add("active");
        document.getElementById(tabId).setAttribute('aria-hidden', 'false');
        evt.currentTarget.classList.add("active");
        evt.currentTarget.setAttribute('aria-selected', 'true');
    }
    
    /**
     * Set up expandable/collapsible card headers
     */
    function setupCardHeaders() {
        const cardHeaders = document.querySelectorAll('.card-header');
        
        cardHeaders.forEach(header => {
            header.addEventListener('click', function() {
                // Toggle active class for header
                this.classList.toggle('active');
                
                // Check if the header is now active
                const isActive = this.classList.contains('active');
                
                // Update aria-expanded attribute
                this.setAttribute('aria-expanded', isActive);
                
                // Toggle the display of card body
                const body = this.nextElementSibling;
                body.classList.toggle('active');
                
                // Update toggle icon
                const toggleIcon = this.querySelector('.toggle-icon');
                toggleIcon.textContent = isActive ? '' : '';
            });
        });
    }
    
    /**
     * Setup modal close functionality
     */
    function setupModalHandlers() {
        // Close modal when close button is clicked
        const closeButtons = document.querySelectorAll('.close-btn, .modal-close');
        closeButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) {
                    closeModal(modal);
                }
            });
        });
        
        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(function(modal) {
                if (event.target === modal) {
                    closeModal(modal);
                }
            });
        });
        
        // Close modal with Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const visibleModal = document.querySelector('.modal[style*="display: block"]');
                if (visibleModal) {
                    closeModal(visibleModal);
                }
            }
        });
    }
    
    /**
     * Close a modal dialog
     * @param {HTMLElement} modal - The modal to close
     */
    function closeModal(modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        
        // Return focus to the element that opened the modal
        const returnFocus = modal.returnFocusElement;
        if (returnFocus && typeof returnFocus.focus === 'function') {
            returnFocus.focus();
        }
    }
    
    /**
     * Open a modal dialog
     * @param {string} modalId - The ID of the modal to open
     * @param {HTMLElement} focusAfterClose - Element to focus after closing
     */
    function openModal(modalId, focusAfterClose) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        // Save the element to return focus to
        modal.returnFocusElement = focusAfterClose || document.activeElement;
        
        // Display the modal
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
        
        // Focus the first focusable element in the modal
        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (focusableElements.length > 0) {
            focusableElements[0].focus();
        }
    }
    
    /**
     * Initialize tooltips for informational icons
     */
    function setupTooltips() {
        const tooltipContainers = document.querySelectorAll('.tooltip-container');
        
        tooltipContainers.forEach(function(container) {
            const infoIcon = container.querySelector('.info-icon');
            const tooltipText = container.querySelector('.tooltip-text');
            
            if (infoIcon && tooltipText) {
                // Show tooltip on click
                infoIcon.addEventListener('click', function(event) {
                    event.stopPropagation();
                    toggleTooltip(tooltipText);
                });
                
                // Show tooltip on focus (for keyboard navigation)
                infoIcon.addEventListener('focus', function() {
                    showTooltip(tooltipText);
                });
                
                // Hide tooltip on blur
                infoIcon.addEventListener('blur', function() {
                    hideTooltip(tooltipText);
                });
                
                // Escape key closes tooltip
                infoIcon.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        hideTooltip(tooltipText);
                    }
                });
            }
        });
        
        // Hide any visible tooltips when clicking elsewhere
        document.addEventListener('click', function() {
            const visibleTooltips = document.querySelectorAll('.tooltip-text[style*="visibility: visible"]');
            visibleTooltips.forEach(hideTooltip);
        });
    }
    
    /**
     * Toggle tooltip visibility
     * @param {HTMLElement} tooltip - The tooltip element
     */
    function toggleTooltip(tooltip) {
        if (tooltip.style.visibility === 'visible') {
            hideTooltip(tooltip);
        } else {
            showTooltip(tooltip);
        }
    }
    
    /**
     * Show a tooltip
     * @param {HTMLElement} tooltip - The tooltip element
     */
    function showTooltip(tooltip) {
        tooltip.style.visibility = 'visible';
        tooltip.style.opacity = '1';
        tooltip.setAttribute('aria-hidden', 'false');
    }
    
    /**
     * Hide a tooltip
     * @param {HTMLElement} tooltip - The tooltip element
     */
    function hideTooltip(tooltip) {
        tooltip.style.visibility = 'hidden';
        tooltip.style.opacity = '0';
        tooltip.setAttribute('aria-hidden', 'true');
    }
    
    /**
     * Setup dark/light theme toggle
     */
    function setupThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            // Set initial theme based on localStorage or system preference
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Initialize theme
            const initialTheme = storedTheme || (prefersDark ? 'dark' : 'light');
            document.body.classList.toggle('dark-theme', initialTheme === 'dark');
            appState.theme = initialTheme;
            
            // Update icon based on current theme
            updateThemeIcon(initialTheme === 'dark');
            
            // Add click event
            themeToggle.addEventListener('click', function() {
                // Toggle theme
                const isDarkTheme = document.body.classList.toggle('dark-theme');
                appState.theme = isDarkTheme ? 'dark' : 'light';
                
                // Save preference
                localStorage.setItem('theme', appState.theme);
                
                // Update icon
                updateThemeIcon(isDarkTheme);
            });
        }
    }
    
    /**
     * Update theme toggle icon based on current theme
     * @param {boolean} isDarkTheme - Whether dark theme is active
     */
    function updateThemeIcon(isDarkTheme) {
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            if (isDarkTheme) {
                themeToggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"></path></svg>';
                themeToggle.setAttribute('aria-label', 'Switch to light mode');
            } else {
                themeToggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>';
                themeToggle.setAttribute('aria-label', 'Switch to dark mode');
            }
        }
    }
    
    /**
     * Setup footer link handlers
     */
    function setupFooterLinks() {
        // Help button
        document.getElementById('show-help-button').addEventListener('click', function() {
            openModal('help-modal', this);
        });
        
        // Help button in header
        document.getElementById('help-button').addEventListener('click', function() {
            openModal('help-modal', this);
        });
        
        // Disclaimer button
        document.getElementById('show-disclaimer-button').addEventListener('click', function() {
            openModal('disclaimer-modal', this);
        });
        
        // References button
        document.getElementById('show-references-button').addEventListener('click', function() {
            openModal('references-modal', this);
        });
    }
    
    /**
     * Update online/offline status display
     */
    function updateOnlineStatus() {
        const isOnline = navigator.onLine;
        appState.offline = !isOnline;
        
        if (!isOnline) {
            // Show offline notification
            showNotification('You are currently offline. Some features may be limited.', 'warning');
        } else {
            // Show online notification if we were previously offline
            if (appState.offline) {
                showNotification('You are back online.', 'success');
            }
        }
    }
    
    /**
     * Show a notification message
     * @param {string} message - The message to display
     * @param {string} type - The type of notification (info, success, warning, error)
     */
    function showNotification(message, type = 'info') {
        // Check if notification container exists, create if not
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.marginBottom = '10px';
        notification.style.padding = '10px 15px';
        notification.style.borderRadius = '4px';
        notification.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
        notification.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        notification.setAttribute('role', 'alert');
        
        // Set notification color based on type
        switch (type) {
            case 'success':
                notification.style.backgroundColor = 'var(--success-color, #4CAF50)';
                notification.style.color = 'white';
                break;
            case 'warning':
                notification.style.backgroundColor = 'var(--warning-color, #FF9800)';
                notification.style.color = 'black';
                break;
            case 'error':
                notification.style.backgroundColor = 'var(--error-color, #F44336)';
                notification.style.color = 'white';
                break;
            default: // info
                notification.style.backgroundColor = 'var(--info-color, #2196F3)';
                notification.style.color = 'white';
        }
        
        // Add close button
        const closeButton = document.createElement('button');
        closeButton.innerHTML = '&times;';
        closeButton.style.marginLeft = '10px';
        closeButton.style.background = 'none';
        closeButton.style.border = 'none';
        closeButton.style.cursor = 'pointer';
        closeButton.style.color = 'inherit';
        closeButton.style.fontSize = '20px';
        closeButton.addEventListener('click', () => container.removeChild(notification));
        notification.appendChild(closeButton);
        
        // Add to container
        container.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateY(0)';
        }, 10);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (container.contains(notification)) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }
        }, 5000);
    }
    
    /***********************************
     * FORM HANDLING FUNCTIONS
     ***********************************/
    
    /**
     * Set up form validation for all forms
     */
    function setupFormValidation() {
        // Add input event listeners to validate inputs as they change
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateInput(this);
                });
                
                input.addEventListener('blur', function() {
                    validateInput(this, true);
                });
            });
        });
        
        // Set up specific cross-field validations
        setupCrossFieldValidation();
    }
    
    /**
     * Validate a specific input field
     * @param {HTMLElement} input - The input element to validate
     * @param {boolean} showError - Whether to show error message
     * @returns {boolean} - Whether the input is valid
     */
    function validateInput(input, showError = false) {
        // Get validation parameters
        const min = input.hasAttribute('min') ? parseFloat(input.getAttribute('min')) : null;
        const max = input.hasAttribute('max') ? parseFloat(input.getAttribute('max')) : null;
        const required = input.hasAttribute('required');
        const pattern = input.hasAttribute('pattern') ? new RegExp(input.getAttribute('pattern')) : null;
        
        // Find error message element - look for a specific one for this input
        const errorId = input.id + '-validation';
        const errorDisplay = document.getElementById(errorId) || 
                            input.parentElement.querySelector('.error-message') || 
                            input.closest('.form-group')?.querySelector('.error-message');
        
        let isValid = true;
        let errorMessage = '';
        
        // Skip validation for disabled inputs
        if (input.disabled) {
            input.classList.remove('error');
            if (errorDisplay) errorDisplay.style.display = 'none';
            return true;
        }
        
        // Validate based on input type
        if (input.type === 'number') {
            // Required check
            if (required && !input.value.trim()) {
                isValid = false;
                errorMessage = 'This field is required';
            } 
            // Parse value if not empty
            else if (input.value.trim()) {
                const numValue = parseFloat(input.value);
                
                // Check if it's a valid number
                if (isNaN(numValue)) {
                    isValid = false;
                    errorMessage = 'Please enter a valid number';
                } 
                // Check range
                else if ((min !== null && numValue < min) || (max !== null && numValue > max)) {
                    isValid = false;
                    errorMessage = `Value must be between ${min} and ${max}`;
                }
                
                // Check pattern if specified
                if (pattern && !pattern.test(input.value)) {
                    isValid = false;
                    errorMessage = input.title || 'Invalid format';
                }
            }
        } 
        else if (input.type === 'text') {
            // Required check
            if (required && !input.value.trim()) {
                isValid = false;
                errorMessage = 'This field is required';
            }
            // Check pattern if specified
            else if (pattern && input.value.trim() && !pattern.test(input.value)) {
                isValid = false;
                errorMessage = input.title || 'Invalid format';
            }
        } 
        else if (input.tagName === 'SELECT') {
            // Required check
            if (required && (!input.value || (input.selectedIndex === 0 && input.options[0].disabled))) {
                isValid = false;
                errorMessage = 'Please make a selection';
            }
        }
        
        // Update UI with validation result
        if (!isValid && showError) {
            input.classList.add('error');
            input.setAttribute('aria-invalid', 'true');
            if (errorDisplay) {
                errorDisplay.textContent = errorMessage;
                errorDisplay.style.display = 'block';
            }
        } else {
            input.classList.remove('error');
            input.setAttribute('aria-invalid', 'false');
            if (errorDisplay) errorDisplay.style.display = 'none';
        }
        
        // Return validation result
        return isValid;
    }
    
    /**
     * Set up cross-field validations (interdependent fields)
     */
    function setupCrossFieldValidation() {
        // Set up medical conditions specific to sex (e.g., ED for males only)
        const qriskSexSelect = document.getElementById('qrisk-sex');
        const edContainer = document.getElementById('qrisk-ed-container');
        
        if (qriskSexSelect && edContainer) {
            qriskSexSelect.addEventListener('change', function() {
                edContainer.style.display = this.value === 'male' ? 'block' : 'none';
                if (this.value !== 'male') {
                    document.getElementById('qrisk-ed').checked = false;
                }
            });
        }
        
        // Set up PCSK9 inhibitor fields display when checkbox is checked
        const pcsk9Checkbox = document.getElementById('med-pcsk9');
        const pcsk9Details = document.getElementById('pcsk9-details');
        
        if (pcsk9Checkbox && pcsk9Details) {
            pcsk9Checkbox.addEventListener('change', function() {
                pcsk9Details.style.display = this.checked ? 'block' : 'none';
                
                // Reset fields if not checked
                if (!this.checked) {
                    document.getElementById('med-pcsk9-type').value = '';
                    document.getElementById('med-pcsk9-dose').value = '';
                    document.getElementById('med-max-therapy-duration').value = '';
                    document.getElementById('med-ldl-reduction').value = '';
                }
            });
        }
        
        // Set up statin dose options based on selected statin
        const statinSelect = document.getElementById('med-statin');
        const statinDoseSelect = document.getElementById('med-statin-dose');
        
        if (statinSelect && statinDoseSelect) {
            statinSelect.addEventListener('change', function() {
                // Clear and disable dose select if "None" selected
                if (this.value === 'none') {
                    statinDoseSelect.innerHTML = '<option value="" selected>Select dose</option>';
                    statinDoseSelect.disabled = true;
                    return;
                }
                
                // Enable dose select and populate options
                statinDoseSelect.disabled = false;
                updateStatinDoseOptions(this.value);
            });
        }
        
        // Set up statin intolerance details based on intolerance selection
        const intoleranceSelect = document.getElementById('med-statin-intolerance');
        const intoleranceTypeSelect = document.getElementById('med-intolerance-type');
        
        if (intoleranceSelect && intoleranceTypeSelect) {
            intoleranceSelect.addEventListener('change', function() {
                intoleranceTypeSelect.disabled = this.value === 'no';
                if (this.value === 'no') {
                    intoleranceTypeSelect.value = '';
                }
            });
        }
        
        // Set up prevention category details based on category selection
        const preventionCategorySelect = document.getElementById('prevention-category');
        const secondaryDetailsSelect = document.getElementById('secondary-details');
        
        if (preventionCategorySelect && secondaryDetailsSelect) {
            preventionCategorySelect.addEventListener('change', function() {
                secondaryDetailsSelect.disabled = this.value !== 'secondary';
                if (this.value !== 'secondary') {
                    secondaryDetailsSelect.value = '';
                }
            });
        }
        
        // Set up toggle for manual entry of non-HDL
        const toggleNonHDLBtn = document.getElementById('toggle-manual-non-hdl');
        const nonHDLInput = document.getElementById('med-non-hdl');
        
        if (toggleNonHDLBtn && nonHDLInput) {
            toggleNonHDLBtn.addEventListener('click', function() {
                const isDisabled = nonHDLInput.disabled;
                nonHDLInput.disabled = !isDisabled;
                this.textContent = isDisabled ? 'Auto-calculate' : 'Enter manually';
                
                if (!isDisabled) {
                    // Switching to auto-calculate
                    calculateNonHDL();
                } else {
                    // Switching to manual entry
                    nonHDLInput.value = '';
                    nonHDLInput.focus();
                }
            });
        }
    }
    
    /**
     * Update the statin dose options based on selected statin
     * @param {string} statin - The selected statin
     */
    function updateStatinDoseOptions(statin) {
        const doseSelect = document.getElementById('med-statin-dose');
        if (!doseSelect) return;
        
        // Clear current options
        doseSelect.innerHTML = '<option value="" selected>Select dose</option>';
        
        // Define dose options with intensity markers for each statin
        const statinDoses = {
            atorvastatin: [
                { value: '10', text: '10 mg', intensity: 'moderate' },
                { value: '20', text: '20 mg', intensity: 'high' },
                { value: '40', text: '40 mg', intensity: 'high' },
                { value: '80', text: '80 mg', intensity: 'high' }
            ],
            rosuvastatin: [
                { value: '5', text: '5 mg', intensity: 'moderate' },
                { value: '10', text: '10 mg', intensity: 'high' },
                { value: '20', text: '20 mg', intensity: 'high' },
                { value: '40', text: '40 mg', intensity: 'high' }
            ],
            simvastatin: [
                { value: '10', text: '10 mg', intensity: 'low' },
                { value: '20', text: '20 mg', intensity: 'moderate' },
                { value: '40', text: '40 mg', intensity: 'moderate' }
            ],
            pravastatin: [
                { value: '10', text: '10 mg', intensity: 'low' },
                { value: '20', text: '20 mg', intensity: 'low' },
                { value: '40', text: '40 mg', intensity: 'moderate' },
                { value: '80', text: '80 mg', intensity: 'moderate' }
            ],
            lovastatin: [
                { value: '20', text: '20 mg', intensity: 'low' },
                { value: '40', text: '40 mg', intensity: 'moderate' }
            ],
            fluvastatin: [
                { value: '20', text: '20 mg', intensity: 'low' },
                { value: '40', text: '40 mg', intensity: 'low' },
                { value: '80', text: '80 mg (XL)', intensity: 'moderate' }
            ],
            pitavastatin: [
                { value: '1', text: '1 mg', intensity: 'low' },
                { value: '2', text: '2 mg', intensity: 'moderate' },
                { value: '4', text: '4 mg', intensity: 'moderate' }
            ]
        };
        
        // Add options for selected statin
        if (statinDoses[statin]) {
            statinDoses[statin].forEach(dose => {
                const option = document.createElement('option');
                option.value = dose.value;
                option.textContent = dose.text;
                option.dataset.intensity = dose.intensity;
                doseSelect.appendChild(option);
            });
        }
    }
    
    /**
     * Update PCSK9 inhibitor dose options based on selected inhibitor
     * @param {string} inhibitor - The selected PCSK9 inhibitor
     */
    function updatePCSK9DoseOptions(inhibitor) {
        const doseSelect = document.getElementById('med-pcsk9-dose');
        if (!doseSelect) return;
        
        // Clear current options
        doseSelect.innerHTML = '<option value="" selected>Select dose</option>';
        
        // Define dose options for each PCSK9 inhibitor
        const pcsk9Doses = {
            evolocumab: [
                { value: '140_bi', text: '140 mg every 2 weeks' },
                { value: '420_mo', text: '420 mg once monthly' }
            ],
            alirocumab: [
                { value: '75_bi', text: '75 mg every 2 weeks' },
                { value: '150_bi', text: '150 mg every 2 weeks' },
                { value: '300_mo', text: '300 mg once monthly' }
            ],
            inclisiran: [
                { value: '284_initial', text: '284 mg initial dose' },
                { value: '284_3mo', text: '284 mg at 3 months' },
                { value: '284_6mo', text: '284 mg every 6 months' }
            ]
        };
        
        // Add options for selected inhibitor
        if (pcsk9Doses[inhibitor]) {
            pcsk9Doses[inhibitor].forEach(dose => {
                const option = document.createElement('option');
                option.value = dose.value;
                option.textContent = dose.text;
                doseSelect.appendChild(option);
            });
            
            // Enable the select
            doseSelect.disabled = false;
        } else {
            doseSelect.disabled = true;
        }
    }
    
    /**
     * Calculate non-HDL cholesterol from total cholesterol and HDL
     */
    function calculateNonHDL() {
        const totalCholInput = document.getElementById('med-total-chol');
        const hdlInput = document.getElementById('med-hdl');
        const nonHDLInput = document.getElementById('med-non-hdl');
        const nonHDLUnitSpan = document.getElementById('med-non-hdl-unit');
        
        if (totalCholInput && hdlInput && nonHDLInput && nonHDLInput.disabled) {
            const totalCholUnit = document.getElementById('med-total-chol-unit').value;
            const hdlUnit = document.getElementById('med-hdl-unit').value;
            
            let totalChol = parseFloat(totalCholInput.value);
            let hdl = parseFloat(hdlInput.value);
            
            if (!isNaN(totalChol) && !isNaN(hdl)) {
                // Convert units if needed
                if (totalCholUnit === 'mg/dL') {
                    totalChol = convertCholesterol(totalChol, 'mg/dL', 'mmol/L');
                }
                if (hdlUnit === 'mg/dL') {
                    hdl = convertCholesterol(hdl, 'mg/dL', 'mmol/L');
                }
                
                // Calculate non-HDL
                const nonHDL = totalChol - hdl;
                nonHDLInput.value = nonHDL.toFixed(2);
                nonHDLUnitSpan.textContent = 'mmol/L';
            }
        }
    }
    
    /**
     * Set up the dynamic BMI calculation based on height and weight inputs
     */
    function setupBMICalculation() {
        const heightInput = document.getElementById('qrisk-height');
        const heightUnitSelect = document.getElementById('qrisk-height-unit');
        const heightFeetInput = document.getElementById('qrisk-height-feet');
        const heightInchesInput = document.getElementById('qrisk-height-inches');
        const weightInput = document.getElementById('qrisk-weight');
        const weightUnitSelect = document.getElementById('qrisk-weight-unit');
        const bmiDisplay = document.getElementById('qrisk-bmi-display');
        const bmiHidden = document.getElementById('qrisk-bmi');
        
        // Function to calculate and display BMI
        const updateBMI = () => {
            let heightCm = 0;
            let weightKg = 0;
            
            // Get height in cm
            if (heightUnitSelect.value === 'cm' && heightInput.value) {
                heightCm = parseFloat(heightInput.value);
            } else if (heightUnitSelect.value === 'ft/in' && heightFeetInput.value) {
                const feet = parseFloat(heightFeetInput.value) || 0;
                const inches = parseFloat(heightInchesInput.value) || 0;
                heightCm = convertHeightToCm(feet, inches);
            }
            
            // Get weight in kg
            if (weightInput.value) {
                weightKg = parseFloat(weightInput.value);
                if (weightUnitSelect.value === 'lb') {
                    weightKg = convertWeightToKg(weightKg);
                }
            }
            
            // Calculate BMI if both height and weight are available
            if (heightCm > 0 && weightKg > 0) {
                const bmi = calculateBMI(heightCm, weightKg);
                
                // Update displays
                bmiDisplay.value = formatBMI(bmi);
                bmiHidden.value = bmi.toFixed(1);
            } else {
                bmiDisplay.value = '';
                bmiHidden.value = '';
            }
        };
        
        // Add event listeners to update BMI when inputs change
        [heightInput, heightFeetInput, heightInchesInput, weightInput].forEach(input => {
            if (input) {
                input.addEventListener('input', updateBMI);
            }
        });
        
        [heightUnitSelect, weightUnitSelect].forEach(select => {
            if (select) {
                select.addEventListener('change', updateBMI);
            }
        });
    }
    
    /**
     * Set up the cholesterol ratio calculation for QRISK3
     */
    function setupCholesterolRatioCalculation() {
        const totalCholInput = document.getElementById('qrisk-total-chol');
        const hdlInput = document.getElementById('qrisk-hdl');
        const ratioDisplay = document.getElementById('qrisk-ratio-display');
        const ratioHidden = document.getElementById('qrisk-chol-ratio');
        
        // Function to calculate and display ratio
        const updateRatio = () => {
            const totalCholUnit = document.getElementById('qrisk-total-chol-unit').value;
            const hdlUnit = document.getElementById('qrisk-hdl-unit').value;
            
            let totalChol = parseFloat(totalCholInput.value);
            let hdl = parseFloat(hdlInput.value);
            
            if (!isNaN(totalChol) && !isNaN(hdl) && hdl > 0) {
                // Convert units if needed to ensure same units for ratio
                if (totalCholUnit !== hdlUnit) {
                    if (totalCholUnit === 'mg/dL') {
                        totalChol = convertCholesterol(totalChol, 'mg/dL', 'mmol/L');
                    } else {
                        hdl = convertCholesterol(hdl, 'mg/dL', 'mmol/L');
                    }
                }
                
                // Calculate ratio
                const ratio = totalChol / hdl;
                
                // Update displays
                ratioDisplay.value = ratio.toFixed(2);
                ratioHidden.value = ratio.toFixed(2);
            } else {
                ratioDisplay.value = '';
                ratioHidden.value = '';
            }
        };
        
        // Add event listeners
        [totalCholInput, hdlInput].forEach(input => {
            if (input) {
                input.addEventListener('input', updateRatio);
                input.addEventListener('change', updateRatio);
            }
        });
        
        const totalCholUnitSelect = document.getElementById('qrisk-total-chol-unit');
        const hdlUnitSelect = document.getElementById('qrisk-hdl-unit');
        
        [totalCholUnitSelect, hdlUnitSelect].forEach(select => {
            if (select) {
                select.addEventListener('change', updateRatio);
            }
        });
    }
    
    /**
     * Setup height toggle between cm and ft/in
     */
    function setupHeightToggle() {
        const heightUnitSelects = document.querySelectorAll('[id$="-height-unit"]');
        
        heightUnitSelects.forEach(select => {
            if (select) {
                // Get the prefix (e.g., "qrisk" from "qrisk-height-unit")
                const prefix = select.id.split('-')[0];
                
                select.addEventListener('change', function() {
                    toggleHeightInputs(prefix);
                });
            }
        });
    }
    
    /**
     * Toggle height inputs between cm and ft/in
     * @param {string} prefix - Form prefix ('qrisk')
     */
    function toggleHeightInputs(prefix) {
        const heightUnit = document.getElementById(`${prefix}-height-unit`).value;
        const heightInput = document.getElementById(`${prefix}-height`);
        const heightFtContainer = document.getElementById(`${prefix}-height-ft-container`);
        
        if (!heightInput || !heightFtContainer) return;
        
        if (heightUnit === 'cm') {
            heightInput.style.display = 'block';
            heightFtContainer.style.display = 'none';
            
            // If feet/inches values exist, convert to cm
            const feetInput = document.getElementById(`${prefix}-height-feet`);
            const inchesInput = document.getElementById(`${prefix}-height-inches`);
            
            if (feetInput?.value && feetInput.value.trim() !== '') {
                const feet = parseFloat(feetInput.value) || 0;
                const inches = parseFloat(inchesInput?.value) || 0;
                const cm = convertHeightToCm(feet, inches);
                heightInput.value = cm.toFixed(1);
            }
        } else {
            heightInput.style.display = 'none';
            heightFtContainer.style.display = 'flex';
            
            // If cm value exists, convert to feet/inches
            if (heightInput.value && heightInput.value.trim() !== '') {
                const cm = parseFloat(heightInput.value);
                const totalInches = cm / 2.54;
                const feet = Math.floor(totalInches / 12);
                const inches = Math.round(totalInches % 12);
                
                document.getElementById(`${prefix}-height-feet`).value = feet;
                document.getElementById(`${prefix}-height-inches`).value = inches;
            }
        }
        
        // For QRISK, update BMI if those fields exist
        if (prefix === 'qrisk') {
            const bmiDisplay = document.getElementById('qrisk-bmi-display');
            if (bmiDisplay) {
                const event = new Event('input');
                document.getElementById('qrisk-height').dispatchEvent(event);
            }
        }
    }
    
    /**
     * Set up SBP readings toggle and validation
     */
    function setupSBPReadingsValidation() {
        // Set up toggling SBP readings sections
        const toggleLink = document.getElementById('qrisk-toggle-sbp-readings');
        if (toggleLink) {
            toggleLink.addEventListener('click', function() {
                const readingsDiv = document.getElementById('qrisk-sbp-readings');
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                
                this.setAttribute('aria-expanded', !isExpanded);
                readingsDiv.style.display = isExpanded ? 'none' : 'block';
                readingsDiv.setAttribute('aria-hidden', isExpanded);
                
                this.textContent = isExpanded ? 'Calculate from multiple readings' : 'Hide readings form';
            });
        }
        
        // Set up SBP SD calculation button
        const calcButton = document.getElementById('calculate-sbp-sd-btn');
        if (calcButton) {
            calcButton.addEventListener('click', calculateSBPStandardDeviationHandler);
        }
        
        // Set up single reading checkbox
        const singleReadingCheckbox = document.getElementById('qrisk-single-sbp-reading');
        if (singleReadingCheckbox) {
            singleReadingCheckbox.addEventListener('change', function() {
                // Disable all readings except the first one if checked
                const readings = document.querySelectorAll('[id^="qrisk-sbp-reading-"]');
                for (let i = 1; i < readings.length; i++) {
                    readings[i].disabled = this.checked;
                    if (this.checked) {
                        readings[i].value = '';
                    }
                }
            });
        }
    }
    
    /**
     * Calculate SBP standard deviation from multiple readings
     */
    function calculateSBPStandardDeviationHandler() {
        // Get the readings
        const readings = [];
        for (let i = 1; i <= 6; i++) {
            const reading = parseFloat(document.getElementById(`qrisk-sbp-reading-${i}`).value);
            if (!isNaN(reading)) {
                readings.push(reading);
            }
        }
        
        // Check if single reading is checked
        const singleReadingChecked = document.getElementById('qrisk-single-sbp-reading').checked;
        
        // Check if we have enough readings
        if (readings.length === 0) {
            showModal('Please enter at least one systolic blood pressure reading.');
            return;
        } else if (readings.length === 1 && !singleReadingChecked) {
            showModal('Please enter at least 2 systolic blood pressure readings or check the "I only have 1 systolic reading" box.');
            return;
        }
        
        // If only one reading and checkbox is checked, use a default SD
        if (readings.length === 1 && singleReadingChecked) {
            const resultDiv = document.getElementById('qrisk-sbp-sd-result');
            document.getElementById('qrisk-sbp-sd').value = '10.0';
            
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Standard Deviation: 10.0 mmHg (default for single reading)';
            resultDiv.setAttribute('aria-live', 'polite');
            return;
        }
        
        // Calculate mean
        const sum = readings.reduce((a, b) => a + b, 0);
        const mean = sum / readings.length;
        
        // Calculate sum of squared differences
        const squaredDifferencesSum = readings.reduce((sum, value) => {
            return sum + Math.pow(value - mean, 2);
        }, 0);
        
        // Calculate standard deviation
        // Use n-1 for sample standard deviation
        const standardDeviation = Math.sqrt(squaredDifferencesSum / (readings.length - 1));
        
        // Display result and update input field
        const resultDiv = document.getElementById('qrisk-sbp-sd-result');
        resultDiv.style.display = 'block';
        resultDiv.textContent = `Standard Deviation: ${standardDeviation.toFixed(1)} mmHg (from ${readings.length} readings)`;
        resultDiv.setAttribute('aria-live', 'polite');
        
        document.getElementById('qrisk-sbp-sd').value = standardDeviation.toFixed(1);
    }
    
    /**
     * Set up reset buttons for all forms
     */
    function setupFormResetButtons() {
        const resetButtons = document.querySelectorAll('[data-reset-form]');
        resetButtons.forEach(button => {
            button.addEventListener('click', function() {
                const formId = this.getAttribute('data-reset-form');
                resetForm(formId);
            });
        });
    }
    
    /**
     * Reset form to default values
     * @param {string} formId - ID of the form to reset
     */
    function resetForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        // Reset all inputs to default values
        form.reset();
        
        // Clear any error styling
        const errorFields = form.querySelectorAll('.error');
        errorFields.forEach(field => field.classList.remove('error'));
        
        // Hide error messages
        const errorMessages = form.querySelectorAll('.error-message');
        errorMessages.forEach(message => message.style.display = 'none');
        
        // Reset specific form elements based on form ID
        switch (formId) {
            case 'medication-form':
                resetMedicationForm();
                break;
            case 'qrisk-form':
                resetQRISKForm();
                break;
            case 'frs-form':
                resetFRSForm();
                break;
        }
        
        // Update comparison tab status if applicable
        if (formId === 'frs-form') {
            updateComparisonTabStatus('frs', false);
            appState.frsCalculated = false;
        } else if (formId === 'qrisk-form') {
            updateComparisonTabStatus('qrisk', false);
            appState.qriskCalculated = false;
        }
    }
    
    /**
     * Reset specific elements in the medication form
     */
    function resetMedicationForm() {
        // Clear any calculated values
        const nonHDLInput = document.getElementById('med-non-hdl');
        if (nonHDLInput) {
            nonHDLInput.value = '';
            nonHDLInput.disabled = true;
            const toggleLink = document.getElementById('toggle-manual-non-hdl');
            if (toggleLink) toggleLink.textContent = 'Enter manually';
        }
        
        // Reset PCSK9 details
        const pcsk9Details = document.getElementById('pcsk9-details');
        if (pcsk9Details) pcsk9Details.style.display = 'none';
        
        // Reset dependent fields
        const statinDoseSelect = document.getElementById('med-statin-dose');
        if (statinDoseSelect) {
            statinDoseSelect.innerHTML = '<option value="" selected>Select dose</option>';
            statinDoseSelect.disabled = true;
        }
        
        const secondaryDetails = document.getElementById('secondary-details');
        if (secondaryDetails) secondaryDetails.disabled = true;
        
        const intoleranceType = document.getElementById('med-intolerance-type');
        if (intoleranceType) intoleranceType.disabled = true;
    }
    
    /**
     * Reset specific elements in the QRISK form
     */
    function resetQRISKForm() {
        // Reset SBP readings
        for (let i = 1; i <= 6; i++) {
            const reading = document.getElementById(`qrisk-sbp-reading-${i}`);
            if (reading) reading.value = '';
        }
        
        const sbpResult = document.getElementById('qrisk-sbp-sd-result');
        if (sbpResult) sbpResult.style.display = 'none';
        
        // Reset height/feet view if applicable
        const heightUnit = document.getElementById('qrisk-height-unit');
        if (heightUnit && heightUnit.value === 'ft/in') {
            heightUnit.value = 'cm';
            toggleHeightInputs('qrisk');
        }
        
        // Reset ED container visibility
        const edContainer = document.getElementById('qrisk-ed-container');
        if (edContainer) edContainer.style.display = 'none';
        
        // Reset BMI display
        const bmiDisplay = document.getElementById('qrisk-bmi-display');
        if (bmiDisplay) bmiDisplay.value = '';
        
        // Reset cholesterol ratio
        const ratioDisplay = document.getElementById('qrisk-ratio-display');
        if (ratioDisplay) ratioDisplay.value = '';
    }
    
    /**
     * Reset specific elements in the FRS form
     */
    function resetFRSForm() {
        // Currently, no specific resets needed for FRS form
    }
    
    /**
     * Set up dynamic form elements
     */
    function setupDynamicFormElements() {
        // Set up height toggle
        setupHeightToggle();
        
        // Set up BMI calculation
        setupBMICalculation();
        
        // Set up cholesterol ratio calculation
        setupCholesterolRatioCalculation();
        
        // Set up PCSK9 type-dose relationship
        setupPCSK9TypeDoseRelationship();
        
        // Set up automatic non-HDL calculation
        setupNonHDLAutoCalculation();
        
        // Set up SBP readings calculation
        setupSBPReadingsValidation();
    }
    
    /**
     * Set up PCSK9 inhibitor type and dose relationship
     */
    function setupPCSK9TypeDoseRelationship() {
        const pcsk9TypeSelect = document.getElementById('med-pcsk9-type');
        if (pcsk9TypeSelect) {
            pcsk9TypeSelect.addEventListener('change', function() {
                updatePCSK9DoseOptions(this.value);
            });
        }
    }
    
    /**
     * Set up automatic non-HDL calculation when total cholesterol or HDL change
     */
    function setupNonHDLAutoCalculation() {
        const totalCholInput = document.getElementById('med-total-chol');
        const hdlInput = document.getElementById('med-hdl');
        const nonHDLInput = document.getElementById('med-non-hdl');
        
        if (totalCholInput && hdlInput && nonHDLInput) {
            [totalCholInput, hdlInput].forEach(input => {
                input.addEventListener('input', function() {
                    if (nonHDLInput.disabled) {
                        calculateNonHDL();
                    }
                });
                
                input.addEventListener('change', function() {
                    if (nonHDLInput.disabled) {
                        calculateNonHDL();
                    }
                });
            });
            
            // Also recalculate when units change
            document.getElementById('med-total-chol-unit').addEventListener('change', function() {
                if (nonHDLInput.disabled) {
                    calculateNonHDL();
                }
            });
            
            document.getElementById('med-hdl-unit').addEventListener('change', function() {
                if (nonHDLInput.disabled) {
                    calculateNonHDL();
                }
            });
        }
    }
    
    /**
     * Setup calculation buttons
     */
    function setupCalculationButtons() {
        // FRS calculation
        document.getElementById('calculate-frs-button').addEventListener('click', calculateFRS);
        
        // QRISK calculation
        document.getElementById('calculate-qrisk-button').addEventListener('click', calculateQRISK);
        
        // Both calculation
        document.getElementById('calculate-both-button').addEventListener('click', calculateBoth);
        
        // Medication evaluation
        document.getElementById('evaluate-medications-button').addEventListener('click', evaluateMedicationsHandler);
    }
    
    /**
     * Setup export and print buttons
     */
    function setupExportButtons() {
        // CSV export
        document.getElementById('export-csv').addEventListener('click', function() {
            exportToCSV();
        });
        
        // PDF export
        document.getElementById('export-pdf').addEventListener('click', function() {
            showPdfPreview();
        });
        
        // PDF download from preview
        document.getElementById('download-pdf-btn').addEventListener('click', function() {
            generatePDF();
        });
        
        // Print results
        document.getElementById('print-results').addEventListener('click', function() {
            window.print();
        });
    }
    
    /***********************************
     * RISK CALCULATION FUNCTIONS
     ***********************************/
    
    /**
     * Calculates Framingham Risk Score and displays results
     */
    function calculateFRS() {
        // Show loading indicator
        showLoading();
        
        try {
            // Validate form
            const validationResult = validateFRSForm();
            if (!validationResult.isValid) {
                hideLoading();
                displayErrors(validationResult.errors);
                return;
            }
            
            const data = validationResult.data;
            
            // Calculate risk score
            const results = calculateFraminghamRiskScore(data);
            
            // Store results for later use
            appState.frsResults = results;
            appState.frsCalculated = true;
            
            // Get LDL value for treatment recommendations if available
            let ldlValue = null;
            if (data.ldl !== null) {
                ldlValue = data.ldl;
                if (data.ldlUnit === 'mg/dL') {
                    ldlValue = convertCholesterol(ldlValue, 'mg/dL', 'mmol/L');
                }
            }
            
            // Get treatment recommendations
            const recommendations = getCCSRecommendation(
                results.modifiedRisk, 
                ldlValue, 
                data.diabetes, 
                data.age
            );
            
            // Display results
            displayFRSResults(data, results, recommendations);
            
            // Save form state
            saveFormState('frs-form');
            
            // Update comparison tab status
            updateComparisonTabStatus('frs', true);
            
            // Save risk score for medication tab
            sessionStorage.setItem('last-risk-score', results.modifiedRisk.toFixed(1));
            sessionStorage.setItem('risk-calculator-used', 'FRS');
            
            // Hide loading indicator
            hideLoading();
            
            // Show success notification
            showNotification('Framingham Risk Score calculation completed successfully.', 'success');
        } catch (error) {
            // Hide loading indicator
            hideLoading();
            
            // Show error
            console.error('Error calculating FRS:', error);
            showModal('An error occurred while calculating the Framingham Risk Score: ' + error.message);
        }
    }
    
    /**
     * Validate FRS form inputs
     * @returns {Object} - { isValid: boolean, data: Object, errors: Array }
     */
    function validateFRSForm() {
        const errors = [];
        const data = {};
        
        // Validate age
        const ageInput = document.getElementById('frs-age');
        if (!validateInput(ageInput, true)) {
            errors.push('Please enter a valid age between 30 and 74');
        } else {
            data.age = parseFloat(ageInput.value);
        }
        
        // Validate sex
        const sexSelect = document.getElementById('frs-sex');
        if (!validateInput(sexSelect, true)) {
            errors.push('Please select sex');
        } else {
            data.sex = sexSelect.value;
        }
        
        // Validate total cholesterol
        const totalCholInput = document.getElementById('frs-total-chol');
        if (!validateInput(totalCholInput, true)) {
            errors.push('Please enter a valid total cholesterol value');
        } else {
            data.totalChol = parseFloat(totalCholInput.value);
            data.totalCholUnit = document.getElementById('frs-total-chol-unit').value;
        }
        
        // Validate HDL cholesterol
        const hdlInput = document.getElementById('frs-hdl');
        if (!validateInput(hdlInput, true)) {
            errors.push('Please enter a valid HDL cholesterol value');
        } else {
            data.hdl = parseFloat(hdlInput.value);
            data.hdlUnit = document.getElementById('frs-hdl-unit').value;
        }
        
        // Validate systolic blood pressure
        const sbpInput = document.getElementById('frs-sbp');
        if (!validateInput(sbpInput, true)) {
            errors.push('Please enter a valid systolic blood pressure value');
        } else {
            data.sbp = parseFloat(sbpInput.value);
        }
        
        // Validate BP treatment
        const bpTreatmentSelect = document.getElementById('frs-bp-treatment');
        if (!validateInput(bpTreatmentSelect, true)) {
            errors.push('Please select blood pressure treatment status');
        } else {
            data.bpTreatment = bpTreatmentSelect.value === 'yes';
        }
        
        // Validate smoker status
        const smokerSelect = document.getElementById('frs-smoker');
        if (!validateInput(smokerSelect, true)) {
            errors.push('Please select smoker status');
        } else {
            data.smoker = smokerSelect.value === 'yes';
        }
        
        // Validate diabetes (not required)
        data.diabetes = document.getElementById('frs-diabetes').value === 'yes';
        
        // Validate Lp(a) (not required)
        const lpaInput = document.getElementById('frs-lpa');
        if (lpaInput.value && !validateInput(lpaInput, true)) {
            errors.push('Please enter a valid Lp(a) value between 0 and 500');
        } else if (lpaInput.value) {
            data.lpa = parseFloat(lpaInput.value);
            data.lpaUnit = document.getElementById('frs-lpa-unit').value;
        } else {
            data.lpa =<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
    =========================================================================
    Enhanced CVD Risk Toolkit with Lp(a) Post-Test Modifier
    Version: 3.0.1 (ESM Edition)
    Last Updated: May 04, 2025
    
    Security and accessibility improvements added May 2025
    
    PURPOSE AND FUNCTION:
    This toolkit provides healthcare professionals with a comprehensive platform for 
    cardiovascular disease risk assessment. It incorporates established risk calculators 
    (Framingham Risk Score and QRISK3) with additional adjustments for lipoprotein(a), 
    a significant independent risk factor for cardiovascular disease.
    
    SCIENTIFIC REFERENCES:
    - Framingham Risk Score: D'Agostino RB Sr, et al. Circulation 2008;117:743-53
    - QRISK3 algorithm: Hippisley-Cox J, et al. BMJ 2017;357:j2099
    - Lp(a) adjustments based on: Willeit P, et al. Lancet 2018;392:1311-1320
    - CCS Guidelines: Pearson GJ, et al. Can J Cardiol. 2021;37(8):1129-1150
    =========================================================================
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CVD Risk Toolkit with Lp(a) Post-Test Modifier for cardiovascular risk assessment with lipoprotein(a) adjustment">
    <meta name="author" content="CVD Risk Toolkit Team">
    <meta name="theme-color" content="#4a90e2">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self'; worker-src 'self'; manifest-src 'self';">
    
    <title>CVD Risk Toolkit with Lp(a) Post-Test Modifier</title>
    
    <!-- Preconnect to external domains for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Primary stylesheet -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- PWA icons -->
    <link rel="icon" type="image/svg+xml" href="icons/icon-192x192.svg">
    <link rel="apple-touch-icon" href="icons/icon-192x192.svg">
    <link rel="manifest" href="manifest.json">
    
    <!-- Print stylesheet -->
    <style media="print">
        body { background-color: white; }
        .main-header, .tabs, .form-actions, .export-section, button, .tab-content:not(.active) { display: none !important; }
        .page-container { padding: 0; margin: 0; }
        .results-section, .main-content { padding: 0; }
        .card { break-inside: avoid; page-break-inside: avoid; }
        .results-card, .recommendation-item { border: 1px solid #ddd; margin-bottom: 15px; }
        .container { width: 100%; max-width: 100%; margin: 0; padding: 0; }
        @page { size: portrait; margin: 0.5cm; }
        .legal-disclaimer { font-size: 8pt; }
        .no-print { display: none !important; }
        .print-only { display: block !important; }
    </style>
</head>
<body class="no-js">
    <script>document.body.classList.remove('no-js');</script>
    <div class="page-container">
        <header class="main-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-container">
                        <h1>CVD Risk Toolkit</h1>
                        <span class="tagline">with Lp(a) Post-Test Modifier</span>
                    </div>
                    <div class="header-actions">
                        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        </button>
                        <button class="help-button" id="help-button" aria-label="Help">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9 9a3 3 0 0 1 5.12-2.12A3 3 0 0 1 12 15"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </button>
                    </div>
                </div>
                <p class="header-description">Calculate 10-year cardiovascular disease risk using established risk calculators with lipoprotein(a) adjustment</p>
            </div>
        </header>
        
        <main class="main-content">
            <div class="container">
                <div class="legal-disclaimer-banner" role="alert">
                    <strong>Healthcare Professional Use Only:</strong> This tool is designed to support clinical decision-making, not replace it. Always use clinical judgment.
                </div>
                
                <div class="loading-container" id="loading-container" style="display: none;" aria-live="polite" role="status">
                    <div class="loading-spinner" aria-hidden="true"></div>
                    <p class="loading-text">Processing data...</p>
                </div>
                
                <noscript>
                    <div class="error-message-container" role="alert">
                        <p>This application requires JavaScript to function. Please enable JavaScript in your browser settings and reload the page.</p>
                    </div>
                </noscript>
                
                <div class="tabs-container">
                    <div class="tabs" role="tablist">
                        <button class="tab" data-tab="medication-tab" role="tab" aria-selected="false" id="tab-medication" aria-controls="medication-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                            <span>Medication Management</span>
                        </button>
                        <button class="tab active" data-tab="frs-tab" role="tab" aria-selected="true" id="tab-frs" aria-controls="frs-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H7"></path></svg>
                            <span>Framingham Risk Score</span>
                        </button>
                        <button class="tab" data-tab="qrisk-tab" role="tab" aria-selected="false" id="tab-qrisk" aria-controls="qrisk-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"></path><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"></path><circle cx="20" cy="10" r="2"></circle></svg>
                            <span>QRISK3</span>
                        </button>
                        <button class="tab" data-tab="both-tab" role="tab" aria-selected="false" id="tab-both" aria-controls="both-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                            <span>Compare Both</span>
                        </button>
                    </div>

                    <!-- Framingham Risk Score Tab -->
                    <div id="frs-tab" class="tab-content active" role="tabpanel" aria-labelledby="tab-frs">
                        <form id="frs-form" class="clinical-form" novalidate>
                            <div class="form-header">
                                <h2 class="section-title">Framingham Risk Score Calculator</h2>
                                <p class="section-description">The Framingham Risk Score estimates 10-year cardiovascular disease risk based on the Framingham Heart Study.</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Patient Demographics</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-age" class="required">Age</label>
                                            <input type="number" id="frs-age" name="frs-age" min="30" max="74" placeholder="30-74 years" required pattern="[3-7][0-9]" title="Age must be between 30 and 74" aria-describedby="frs-age-validation">
                                            <div id="frs-age-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="frs-sex" class="required">Sex</label>
                                            <select id="frs-sex" name="frs-sex" required aria-describedby="frs-sex-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                            <div id="frs-sex-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Lipid Profile</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-total-chol" class="required">Total Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-total-chol" name="frs-total-chol" min="1" max="15" placeholder="Enter value" required step="0.1" aria-describedby="frs-total-chol-validation">
                                                <select id="frs-total-chol-unit" name="frs-total-chol-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="frs-total-chol-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="frs-hdl" class="required">HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-hdl" name="frs-hdl" min="0.5" max="3" placeholder="Enter value" required step="0.1" aria-describedby="frs-hdl-validation">
                                                <select id="frs-hdl-unit" name="frs-hdl-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="frs-hdl-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-ldl">LDL Cholesterol
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about LDL cholesterol">i</div>
                                                    <div class="tooltip-text" role="tooltip" id="frs-ldl-tooltip">LDL cholesterol level is used to determine specific treatment recommendations according to clinical guidelines.</div>
                                                </div>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="frs-ldl" name="frs-ldl" min="0.5" max="10" placeholder="Enter value (optional)" step="0.1" aria-describedby="frs-ldl-tooltip frs-ldl-validation">
                                                <select id="frs-ldl-unit" name="frs-ldl-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="frs-ldl-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Blood Pressure</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-sbp" class="required">Systolic Blood Pressure</label>
                                            <div class="input-group">
                                                <input type="number" id="frs-sbp" name="frs-sbp" min="90" max="200" placeholder="Enter value" required aria-describedby="frs-sbp-validation">
                                                <span class="unit-selector">mmHg</span>
                                            </div>
                                            <div id="frs-sbp-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="frs-bp-treatment" class="required">Blood Pressure Treatment</label>
                                            <select id="frs-bp-treatment" name="frs-bp-treatment" required aria-describedby="frs-bp-treatment-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="yes">Yes</option>
                                                <option value="no">No</option>
                                            </select>
                                            <div id="frs-bp-treatment-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Risk Factors</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-smoker" class="required">Smoker</label>
                                            <select id="frs-smoker" name="frs-smoker" required aria-describedby="frs-smoker-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="yes">Yes</option>
                                                <option value="no">No</option>
                                            </select>
                                            <div id="frs-smoker-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="frs-diabetes">Diabetes</label>
                                            <select id="frs-diabetes" name="frs-diabetes">
                                                <option value="no" selected>No</option>
                                                <option value="yes">Yes</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header" aria-expanded="false">
                                    <h3>Lipoprotein(a) Modifier</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body">
                                    <!-- Area for Lp(a) research update notices -->
                                    <div id="lpa-research-updates" class="research-update-container" style="display: none;" aria-live="polite">
                                        <!-- Dynamically updated with new research -->
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frs-lpa">Lp(a) Level
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about Lp(a)">i</div>
                                                    <div class="tooltip-text" role="tooltip" id="frs-lpa-tooltip">Elevated Lp(a) (50 mg/dL or 100 nmol/L) is an independent risk factor that increases cardiovascular risk.</div>
                                                </div>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="frs-lpa" name="frs-lpa" min="0" max="500" placeholder="Enter value (optional)" step="1" aria-describedby="frs-lpa-tooltip frs-lpa-validation">
                                                <select id="frs-lpa-unit" name="frs-lpa-unit" class="unit-selector">
                                                    <option value="mg/dL">mg/dL</option>
                                                    <option value="nmol/L">nmol/L</option>
                                                </select>
                                            </div>
                                            <div id="frs-lpa-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="secondary-btn" id="reset-frs-button" data-reset-form="frs-form">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                Compare Both Scores
                            </button>
                        </div>
                    </div>

                    <!-- Medication Management Tab -->
                    <div id="medication-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-medication">
                        <form id="medication-form" class="clinical-form" novalidate>
                            <div class="form-header">
                                <h2 class="section-title">Medication Management</h2>
                                <p class="section-description">Evaluate current lipid-lowering therapy and receive personalized medication recommendations based on risk assessment and clinical guidelines.</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Prevention Category</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="prevention-category" class="required">Prevention Category
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about prevention categories">i</div>
                                                    <div class="tooltip-text" role="tooltip">Primary prevention is for patients without established cardiovascular disease. Secondary prevention is for patients with existing cardiovascular disease.</div>
                                                </div>
                                            </label>
                                            <select id="prevention-category" name="prevention-category" required aria-describedby="prevention-category-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="primary">Primary Prevention</option>
                                                <option value="secondary">Secondary Prevention</option>
                                            </select>
                                            <div id="prevention-category-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="secondary-details">Secondary Prevention Details
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about secondary prevention details">i</div>
                                                    <div class="tooltip-text" role="tooltip">Specify qualifying condition(s) for secondary prevention. This affects treatment targets and PCSK9 inhibitor coverage criteria.</div>
                                                </div>
                                            </label>
                                            <select id="secondary-details" name="secondary-details" disabled aria-describedby="secondary-details-validation">
                                                <option value="" selected disabled>Select if applicable</option>
                                                <option value="mi">MI or ACS within past 2 years</option>
                                                <option value="stroke">Ischemic stroke/TIA</option>
                                                <option value="cad">Coronary artery disease (other)</option>
                                                <option value="pad">Peripheral arterial disease</option>
                                                <option value="multi">Multiple vascular territories</option>
                                            </select>
                                            <div id="secondary-details-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Current Lipid Profile</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-total-chol" class="required">Total Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-total-chol" name="med-total-chol" min="1" max="15" placeholder="Enter value" required step="0.1" aria-describedby="med-total-chol-validation">
                                                <select id="med-total-chol-unit" name="med-total-chol-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="med-total-chol-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="med-ldl" class="required">LDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-ldl" name="med-ldl" min="0.5" max="10" placeholder="Enter value" required step="0.1" aria-describedby="med-ldl-validation">
                                                <select id="med-ldl-unit" name="med-ldl-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="med-ldl-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-hdl" class="required">HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-hdl" name="med-hdl" min="0.5" max="3" placeholder="Enter value" required step="0.1" aria-describedby="med-hdl-validation">
                                                <select id="med-hdl-unit" name="med-hdl-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="med-hdl-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="med-trig" class="required">Triglycerides</label>
                                            <div class="input-group">
                                                <input type="number" id="med-trig" name="med-trig" min="0.5" max="15" placeholder="Enter value" required step="0.1" aria-describedby="med-trig-validation">
                                                <select id="med-trig-unit" name="med-trig-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="med-trig-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-non-hdl">Non-HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="med-non-hdl" name="med-non-hdl" placeholder="Auto-calculated" disabled step="0.1" aria-describedby="med-non-hdl-validation">
                                                <span class="unit-selector" id="med-non-hdl-unit">mmol/L</span>
                                            </div>
                                            <button type="button" class="toggle-link" id="toggle-manual-non-hdl">Enter manually</button>
                                            <div id="med-non-hdl-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="med-apob">ApoB
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about ApoB">i</div>
                                                    <div class="tooltip-text" role="tooltip">ApoB is now recommended as a risk marker in certain high-risk patients and is required for PCSK9 inhibitor coverage.</div>
                                                </div>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="med-apob" name="med-apob" min="0.2" max="2.5" placeholder="Enter value (optional)" step="0.01" aria-describedby="med-apob-validation">
                                                <select id="med-apob-unit" name="med-apob-unit" class="unit-selector">
                                                    <option value="g/L">g/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="med-apob-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-lpa">Lp(a)
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about Lp(a)">i</div>
                                                    <div class="tooltip-text" role="tooltip">Elevated Lp(a) levels 50 mg/dL (or 100 nmol/L) are associated with increased cardiovascular risk and may influence treatment decisions.</div>
                                                </div>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="med-lpa" name="med-lpa" min="0" max="500" placeholder="Enter value (optional)" step="1" aria-describedby="med-lpa-validation">
                                                <select id="med-lpa-unit" name="med-lpa-unit" class="unit-selector">
                                                    <option value="mg/dL">mg/dL</option>
                                                    <option value="nmol/L">nmol/L</option>
                                                </select>
                                            </div>
                                            <div id="med-lpa-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Current Lipid-Lowering Medications</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <!-- Statins -->
                                    <div class="medication-section">
                                        <h4 class="medication-category">Statin Therapy</h4>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="med-statin">Statin</label>
                                                <select id="med-statin" name="med-statin">
                                                    <option value="none" selected>None</option>
                                                    <option value="atorvastatin">Atorvastatin (Lipitor)</option>
                                                    <option value="rosuvastatin">Rosuvastatin (Crestor)</option>
                                                    <option value="simvastatin">Simvastatin (Zocor)</option>
                                                    <option value="pravastatin">Pravastatin (Pravachol)</option>
                                                    <option value="lovastatin">Lovastatin (Mevacor)</option>
                                                    <option value="fluvastatin">Fluvastatin (Lescol)</option>
                                                    <option value="pitavastatin">Pitavastatin (Livalo)</option>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="med-statin-dose">Statin Dose</label>
                                                <select id="med-statin-dose" name="med-statin-dose" disabled aria-describedby="med-statin-dose-validation">
                                                    <option value="" selected>Select dose</option>
                                                    <!-- Options will be populated by JavaScript based on selected statin -->
                                                </select>
                                                <div id="med-statin-dose-validation" class="error-message" aria-live="polite"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="med-statin-intolerance">Statin Intolerance</label>
                                                <select id="med-statin-intolerance" name="med-statin-intolerance">
                                                    <option value="no" selected>No</option>
                                                    <option value="partial">Partial (tolerates lower doses)</option>
                                                    <option value="complete">Complete (cannot tolerate any statin)</option>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="med-intolerance-type">Intolerance Details
                                                    <div class="tooltip-container">
                                                        <div class="info-icon" tabindex="0" aria-label="Information about statin intolerance">i</div>
                                                        <div class="tooltip-text" role="tooltip">Documentation of intolerance is required for PCSK9 inhibitor coverage.</div>
                                                    </div>
                                                </label>
                                                <select id="med-intolerance-type" name="med-intolerance-type" disabled aria-describedby="med-intolerance-type-validation">
                                                    <option value="" selected>Select if applicable</option>
                                                    <option value="myalgia">Myalgia without CK elevation</option>
                                                    <option value="myositis">Myositis (CK elevation &lt;10 ULN)</option>
                                                    <option value="myopathy">Myopathy (CK elevation 10 ULN)</option>
                                                    <option value="rhabdo">Rhabdomyolysis</option>
                                                    <option value="liver">Liver enzyme elevation 3 ULN</option>
                                                    <option value="other">Other documented intolerance</option>
                                                </select>
                                                <div id="med-intolerance-type-validation" class="error-message" aria-live="polite"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Other medications -->
                                    <div class="medication-section">
                                        <h4 class="medication-category">Additional Lipid-Lowering Therapies</h4>
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="med-ezetimibe" name="med-ezetimibe">
                                                <label for="med-ezetimibe">Ezetimibe (Ezetrol)</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="med-pcsk9" name="med-pcsk9">
                                                <label for="med-pcsk9">PCSK9 Inhibitor</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="med-fibrate" name="med-fibrate">
                                                <label for="med-fibrate">Fibrate</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="med-niacin" name="med-niacin">
                                                <label for="med-niacin">Niacin</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="med-bile-acid" name="med-bile-acid">
                                                <label for="med-bile-acid">Bile Acid Sequestrant</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PCSK9 specific fields, conditionally displayed -->
                            <div class="card" id="pcsk9-details" style="display: none;">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>PCSK9 Inhibitor Details</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-pcsk9-type">PCSK9 Inhibitor Type</label>
                                            <select id="med-pcsk9-type" name="med-pcsk9-type" aria-describedby="med-pcsk9-type-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="evolocumab">Evolocumab (Repatha)</option>
                                                <option value="alirocumab">Alirocumab (Praluent)</option>
                                                <option value="inclisiran">Inclisiran (Leqvio)</option>
                                            </select>
                                            <div id="med-pcsk9-type-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="med-pcsk9-dose">PCSK9 Inhibitor Dose</label>
                                            <select id="med-pcsk9-dose" name="med-pcsk9-dose" disabled aria-describedby="med-pcsk9-dose-validation">
                                                <option value="" selected>Select dose</option>
                                                <!-- Options will be populated by JavaScript based on selected PCSK9 inhibitor -->
                                            </select>
                                            <div id="med-pcsk9-dose-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="med-max-therapy-duration">Duration on Maximum Therapy
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about maximum therapy duration">i</div>
                                                    <div class="tooltip-text" role="tooltip">BC PharmaCare requires at least 3 months on maximum tolerated statin + ezetimibe before PCSK9 inhibitor coverage.</div>
                                                </div>
                                            </label>
                                            <select id="med-max-therapy-duration" name="med-max-therapy-duration" aria-describedby="med-max-therapy-duration-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="<3">&lt;3 months</option>
                                                <option value="3-6">3-6 months</option>
                                                <option value=">6">&gt;6 months</option>
                                            </select>
                                            <div id="med-max-therapy-duration-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="med-ldl-reduction">LDL Reduction on Current Therapy</label>
                                            <div class="input-group">
                                                <input type="number" id="med-ldl-reduction" name="med-ldl-reduction" min="0" max="100" placeholder="% reduction" aria-describedby="med-ldl-reduction-validation">
                                                <span class="unit-selector">%</span>
                                            </div>
                                            <div id="med-ldl-reduction-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="alert alert-info">
                                            <strong>BC PharmaCare Coverage Criteria</strong>
                                            <ul>
                                                <li>For secondary prevention: LDL 2.0 mmol/L despite maximum tolerated statin + ezetimibe</li>
                                                <li>For FH with DLCN score 6: LDL 3.5 mmol/L despite maximum tolerated statin + ezetimibe</li>
                                                <li>For primary prevention with high risk: LDL 3.5 mmol/L despite maximum tolerated statin + ezetimibe</li>
                                                <li>Baseline and follow-up lipid panels are required</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="secondary-btn" id="reset-medication-button" data-reset-form="medication-form">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                                    Reset Form
                                </button>
                                <button type="button" class="primary-btn" id="evaluate-medications-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                                    Generate Recommendations
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="results-section" id="results-container" style="display: none;">
                    <div class="results-header">
                        <h2 class="section-title">CVD Risk Assessment Results</h2>
                        <div class="results-meta">
                            <div class="meta-item" id="results-date">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                <span></span>
                            </div>
                            <div class="meta-item" id="results-id">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                <span>Anonymous Assessment</span>
                            </div>
                        </div>
                    </div>
            
                    <!-- Risk results will be populated here -->
                    <div id="risk-results">
                        <!-- This section is initially empty and will be populated when calculations are performed -->
                    </div>
                    
                    <!-- Treatment recommendations section -->
                    <div class="treatment-recommendations" id="treatment-recommendations">
                        <h3 class="section-title">Treatment Recommendations</h3>
                        <div class="recommendations-content" id="recommendations-content">
                            <!-- Will be populated with recommendations -->
                        </div>
                        
                        <!-- Clinical guidelines citations -->
                        <div class="guidelines-citation">
                            <h4>Clinical Guidelines Reference</h4>
                            <div class="citation-content">
                                <p>Recommendations based on:</p>
                                <ul>
                                    <li>2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in Adults</li>
                                    <li>2019 ESC/EAS Guidelines for the management of dyslipidaemias</li>
                                    <li>2018 AHA/ACC/AACVPR/AAPA/ABC/ACPM/ADA/AGS/APhA/ASPC/NLA/PCNA Guideline on the Management of Blood Cholesterol</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export and actions section -->
                    <div class="export-section">
                        <h3 class="section-title">Export & Actions</h3>
                        <div class="export-buttons">
                            <button type="button" id="export-csv" class="export-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Export to CSV
                            </button>
                            <button type="button" id="export-pdf" class="export-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                Export to PDF
                            </button>
                            <button type="button" id="print-results" class="export-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                Print Results
                            </button>
                        </div>
                    </div>
                    
                    <!-- Legal disclaimer -->
                    <div class="legal-disclaimer">
                        <h5>Disclaimer</h5>
                        <p>This risk assessment tool is intended to support clinical decision-making by qualified healthcare professionals. The calculations are based on established risk algorithms but have inherent limitations and should not be the sole basis for diagnosis or treatment decisions.</p>
                        <p>The Lp(a) risk modification is based on current evidence but is an evolving area of research. Always exercise clinical judgment and refer to updated guidelines when making treatment decisions.</p>
                        <p>This tool does not store or transmit patient information. All calculations are performed locally in your browser.</p>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="main-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-logo">
                        <p>CVD Risk Toolkit</p>
                        <span class="tagline">with Lp(a) Post-Test Modifier</span>
                    </div>
                    <div class="footer-links">
                        <button type="button" id="show-help-button" class="footer-link">Help & Instructions</button>
                        <button type="button" id="show-disclaimer-button" class="footer-link">Legal Disclaimer</button>
                        <button type="button" id="show-references-button" class="footer-link">Scientific References</button>
                    </div>
                    <div class="footer-copyright">
                        <p>&copy; 2025 CVD Risk Toolkit Team</p>
                        <p>Version 3.0.1</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Templates -->
    <!-- Single Risk Result Template -->
    <template id="single-risk-template">
        <div class="results-card">
            <div class="risk-header">
                <h3 class="risk-title"></h3>
                <div class="risk-badge"></div>
            </div>
            
            <div class="risk-visualization">
                <div class="risk-gauge">
                    <div class="gauge-value">
                        <span class="risk-value"></span>
                    </div>
                    <div class="gauge-scale">
                        <div class="scale-marker low" style="left: 10%;">
                            <span>Low</span>
                        </div>
                        <div class="scale-marker moderate" style="left: 30%;">
                            <span>Moderate</span>
                        </div>
                        <div class="scale-marker high" style="left: 70%;">
                            <span>High</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="risk-details">
                <div class="results-row">
                    <div class="results-label">Base Risk:</div>
                    <div class="results-value base-risk"></div>
                </div>
                <div class="results-row lpa-modifier-row">
                    <div class="results-label">Lp(a) Modifier:</div>
                    <div class="results-value lpa-modifier"></div>
                </div>
                <div class="results-row">
                    <div class="results-label">Adjusted Risk:</div>
                    <div class="results-value adjusted-risk"></div>
                </div>
                <div class="results-row risk-category-row">
                    <div class="results-label">Risk Category:</div>
                    <div class="results-value risk-category"></div>
                </div>
            </div>
            
            <div class="risk-interpretation"></div>
        </div>
    </template>
    
    <!-- Comparison Result Template -->
    <template id="comparison-risk-template">
        <div class="results-card comparison-card">
            <div class="risk-header">
                <h3 class="risk-title">Comparison of Risk Assessments</h3>
            </div>
            
            <div class="comparison-visualization">
                <div class="comparison-chart">
                    <div class="chart-container" id="comparison-chart-container">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
            </div>
            
            <div class="comparison-details">
                <div class="comparison-table">
                    <div class="table-header">
                        <div class="table-cell"></div>
                        <div class="table-cell">Framingham</div>
                        <div class="table-cell">QRISK3</div>
                    </div>
                    <div class="table-row">
                        <div class="table-cell">Base Risk</div>
                        <div class="table-cell" id="compare-frs-base"></div>
                        <div class="table-cell" id="compare-qrisk-base"></div>
                    </div>
                    <div class="table-row">
                        <div class="table-cell">Lp(a) Modifier</div>
                        <div class="table-cell" id="compare-frs-lpa"></div>
                        <div class="table-cell" id="compare-qrisk-lpa"></div>
                    </div>
                    <div class="table-row">
                        <div class="table-cell">Adjusted Risk</div>
                        <div class="table-cell" id="compare-frs-adjusted"></div>
                        <div class="table-cell" id="compare-qrisk-adjusted"></div>
                    </div>
                    <div class="table-row">
                        <div class="table-cell">Risk Category</div>
                        <div class="table-cell" id="compare-frs-category"></div>
                        <div class="table-cell" id="compare-qrisk-category"></div>
                    </div>
                </div>
            </div>
            
            <div class="comparison-conclusion">
                <h4>Clinical Interpretation</h4>
                <p id="comparison-interpretation"></p>
            </div>
        </div>
    </template>
    
    <!-- Modals -->
    <!-- Warning Modal -->
    <div id="warning-modal" class="modal" role="dialog" aria-labelledby="warning-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="warning-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Attention Required
                </h3>
                <button type="button" class="modal-close" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <p id="modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="secondary-btn close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Clinical Info Modal -->
    <div id="clinical-info-modal" class="modal" role="dialog" aria-labelledby="clinical-info-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="clinical-info-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Clinical Information
                </h3>
                <button type="button" class="modal-close" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="clinical-info-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="secondary-btn close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- PDF Export Preview Modal -->
    <div id="pdf-preview-modal" class="modal" role="dialog" aria-labelledby="pdf-preview-modal-title" aria-hidden="true">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="pdf-preview-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    PDF Preview
                </h3>
                <button type="button" class="modal-close" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="pdf-preview-content"></div>
            </div>
            <div class="modal-footer">
                <div class="modal-options">
                    <div class="form-group inline-group">
                        <label for="pdf-include-logo">Include Header</label>
                        <input type="checkbox" id="pdf-include-logo" checked>
                    </div>
                    <div class="form-group inline-group">
                        <label for="pdf-include-disclaimer">Include Disclaimer</label>
                        <input type="checkbox" id="pdf-include-disclaimer" checked>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn close-btn">Cancel</button>
                    <button type="button" class="primary-btn" id="download-pdf-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="modal" role="dialog" aria-labelledby="help-modal-title" aria-hidden="true">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="help-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9 9a3 3 0 0 1 5.12-2.12A3 3 0 0 1 12 15"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Help & Instructions
                </h3>
                <button type="button" class="modal-close" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="help-tabs" role="tablist">
                    <button class="help-tab active" data-tab="general-help" role="tab" aria-selected="true" id="tab-general-help" aria-controls="general-help">General</button>
                    <button class="help-tab" data-tab="frs-help" role="tab" aria-selected="false" id="tab-frs-help" aria-controls="frs-help">FRS</button>
                    <button class="help-tab" data-tab="qrisk-help" role="tab" aria-selected="false" id="tab-qrisk-help" aria-controls="qrisk-help">QRISK3</button>
                    <button class="help-tab" data-tab="lpa-help" role="tab" aria-selected="false" id="tab-lpa-help" aria-controls="lpa-help">Lp(a)</button>
                    <button class="help-tab" data-tab="med-help" role="tab" aria-selected="false" id="tab-med-help" aria-controls="med-help">Medications</button>
                </div>
                
                <div class="help-content active" id="general-help" role="tabpanel" aria-labelledby="tab-general-help">
                    <h4>General Instructions</h4>
                    <p>The CVD Risk Toolkit allows you to calculate and compare cardiovascular risk using multiple validated risk calculators with the additional ability to factor in Lipoprotein(a) levels as a risk modifier.</p>
                    
                    <h5>Getting Started</h5>
                    <ol>
                        <li>Select the appropriate tab for the risk calculator you wish to use</li>
                        <li>Fill in the required information (marked with *)</li>
                        <li>Click the calculate button to generate results</li>
                        <li>View treatment recommendations based on clinical guidelines</li>
                    </ol>
                    
                    <h5>Features</h5>
                    <ul>
                        <li><strong>Unit Conversion:</strong> The toolkit automatically handles unit conversions between mmol/L and mg/dL for lipid values</li>
                        <li><strong>Lp(a) Modifier:</strong> Incorporate Lp(a) levels as a risk modifier based on current evidence</li>
                        <li><strong>Treatment Recommendations:</strong> Receive guideline-based medication recommendations</li>
                        <li><strong>Export Options:</strong> Export results as PDF or CSV, or print for patient records</li>
                    </ul>
                </div>
                
                <div class="help-content" id="frs-help" role="tabpanel" aria-labelledby="tab-frs-help" hidden>
                    <h4>Framingham Risk Score</h4>
                    <p>The Framingham Risk Score (FRS) estimates 10-year risk of cardiovascular disease based on the Framingham Heart Study. It's widely validated and used in North American guidelines.</p>
                    
                    <h5>Required Information</h5>
                    <ul>
                        <li><strong>Age:</strong> 30-74 years</li>
                        <li><strong>Sex:</strong> Male or Female</li>
                        <li><strong>Total Cholesterol:</strong> In mmol/L or mg/dL</li>
                        <li><strong>HDL Cholesterol:</strong> In mmol/L or mg/dL</li>
                        <li><strong>Systolic Blood Pressure:</strong> In mmHg</li>
                        <li><strong>Blood Pressure Treatment:</strong> Yes or No</li>
                        <li><strong>Smoking Status:</strong> Yes or No</li>
                    </ul>
                    
                    <h5>Optional Information</h5>
                    <ul>
                        <li><strong>Diabetes Status:</strong> Enhances risk assessment</li>
                        <li><strong>LDL Cholesterol:</strong> Used for treatment recommendations</li>
                        <li><strong>Lp(a) Level:</strong> Used as a risk modifier</li>
                    </ul>
                    
                    <h5>Interpretation</h5>
                    <ul>
                        <li><strong>Low Risk:</strong> &lt;10% 10-year risk</li>
                        <li><strong>Moderate Risk:</strong> 10-19% 10-year risk</li>
                        <li><strong>High Risk:</strong> 20% 10-year risk</li>
                    </ul>
                </div>
                
                <div class="help-content" id="qrisk-help" role="tabpanel" aria-labelledby="tab-qrisk-help" hidden>
                    <h4>QRISK3</h4>
                    <p>QRISK3 is a cardiovascular risk prediction algorithm developed in the UK. It includes additional factors not considered in FRS.</p>
                    
                    <h5>Additional Features in QRISK3</h5>
                    <ul>
                        <li>Ethnicity considerations</li>
                        <li>Family history of cardiovascular disease</li>
                        <li>More detailed smoking categories</li>
                        <li>Specific medical conditions (atrial fibrillation, rheumatoid arthritis, CKD)</li>
                        <li>Blood pressure variability</li>
                    </ul>
                    
                    <h5>When to Consider QRISK3</h5>
                    <ul>
                        <li>For diverse ethnic populations</li>
                        <li>When the patient has conditions not captured by FRS</li>
                        <li>When blood pressure variability data is available</li>
                        <li>For comparing risk assessments from different algorithms</li>
                    </ul>
                </div>
                
                <div class="help-content" id="lpa-help" role="tabpanel" aria-labelledby="tab-lpa-help" hidden>
                    <h4>Understanding Lp(a) as a Risk Modifier</h4>
                    <p>Lipoprotein(a) is an independent risk factor for cardiovascular disease that is not captured in traditional risk calculators.</p>
                    
                    <h5>Lp(a) Risk Modification</h5>
                    <ul>
                        <li><strong>Normal Lp(a) levels:</strong> &lt;30 mg/dL or &lt;75 nmol/L (no additional risk)</li>
                        <li><strong>Borderline elevated:</strong> 30-50 mg/dL or 75-125 nmol/L (1.0-1.3x risk)</li>
                        <li><strong>Elevated:</strong> 50-100 mg/dL or 125-250 nmol/L (1.3-1.6x risk)</li>
                        <li><strong>High:</strong> 100-200 mg/dL or 250-500 nmol/L (1.6-2.0x risk)</li>
                        <li><strong>Very high:</strong> &gt;200 mg/dL or &gt;500 nmol/L (2.0-3.0x risk)</li>
                    </ul>
                    
                    <h5>Clinical Implications</h5>
                    <p>Elevated Lp(a) may warrant:</p>
                    <ul>
                        <li>More aggressive LDL-C targets</li>
                        <li>Earlier initiation of preventive therapy</li>
                        <li>Family screening</li>
                        <li>Consideration of specialized therapies in development</li>
                    </ul>
                </div>
                
                <div class="help-content" id="med-help" role="tabpanel" aria-labelledby="tab-med-help" hidden>
                    <h4>Medication Management</h4>
                    <p>The medication management tab provides guideline-based therapy recommendations based on risk assessment and current treatments.</p>
                    
                    <h5>Guideline-based Treatment Recommendations</h5>
                    <ul>
                        <li>Based on 2021 Canadian Cardiovascular Society Guidelines</li>
                        <li>Includes 2019 ESC/EAS and 2018 AHA/ACC Guidelines principles</li>
                        <li>Factors in BC PharmaCare coverage criteria for PCSK9 inhibitors</li>
                    </ul>
                    
                    <h5>Medication Options</h5>
                    <ul>
                        <li><strong>Statins:</strong> First-line therapy stratified by intensity</li>
                        <li><strong>Ezetimibe:</strong> Second-line therapy or add-on to statins</li>
                        <li><strong>PCSK9 Inhibitors:</strong> For high-risk patients who don't achieve targets with maximally tolerated statin and ezetimibe</li>
                        <li><strong>Other Options:</strong> Fibrates, bile acid sequestrants, niacin</li>
                    </ul>
                    
                    <h5>BC PharmaCare Coverage Criteria for PCSK9 Inhibitors</h5>
                    <p>Coverage requires:</p>
                    <ul>
                        <li>Documented cardiovascular disease or familial hypercholesterolemia</li>
                        <li>LDL-C above target despite maximum tolerated statin + ezetimibe for at least 3 months</li>
                        <li>Special Authority application with detailed documentation</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="secondary-btn close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Scientific References Modal -->
    <div id="references-modal" class="modal" role="dialog" aria-labelledby="references-modal-title" aria-hidden="true">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="references-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
                    Scientific References
                </h3>
                <button type="button" class="modal-close" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="references-section">
                    <h4>Risk Calculators</h4>
                    <div class="reference-item">
                        <h5>Framingham Risk Score</h5>
                        <p>D'Agostino RB Sr, Vasan RS, Pencina MJ, Wolf PA, Cobain M, Massaro JM, Kannel WB. General cardiovascular risk profile for use in primary care: the Framingham Heart Study. Circulation. 2008 Feb 12;117(6):743-53.</p>
                    </div>
                    <div class="reference-item">
                        <h5>QRISK3</h5>
                        <p>Hippisley-Cox J, Coupland C, Brindle P. Development and validation of QRISK3 risk prediction algorithms to estimate future risk of cardiovascular disease: prospective cohort study. BMJ. 2017 May 23;357:j2099.</p>
                    </div>
                </div>
                
                <div class="references-section">
                    <h4>Lipoprotein(a)</h4>
                    <div class="reference-item">
                        <h5>Lp(a) as Risk Factor</h5>
                        <p>Willeit P, Kiechl S, Kronenberg F, Witztum JL, Santer P, Mayr M, Xu Q, Mayr A, Willeit J, Tsimikas S. Discrimination and net reclassification of cardiovascular risk with lipoprotein(a): prospective 15-year outcomes in the Bruneck Study. J Am Coll Cardiol. 2014 Sep 9;64(9):851-60.</p>
                    </div>
                    <div class="reference-item">
                        <h5>Lp(a) Risk Modification</h5>
                        <p>Willeit P, Ridker PM, Nestel PJ, Simes J, Tonkin AM, Pedersen TR, Schwartz GG, Olsson AG, Colhoun HM, Kronenberg F, Drechsler C, Wanner C, Mora S, Lesogor A, Tsimikas S. Baseline and on-statin treatment lipoprotein(a) levels for prediction of cardiovascular events: individual patient-data meta-analysis of statin outcome trials. Lancet. 2018 Oct 13;392(10155):1311-1320.</p>
                    </div>
                </div>
                
                <div class="references-section">
                    <h4>Clinical Guidelines</h4>
                    <div class="reference-item">
                        <h5>CCS Guidelines</h5>
                        <p>Pearson GJ, Thanassoulis G, Anderson TJ, Barry AR, Couture P, Dayan N, Francis GA, Genest J, Grgoire J, Grover SA, Gupta M, Hegele RA, Lau D, Leiter LA, Leung AA, Lonn E, Mancini GBJ, Manjoo P, McPherson R, Ngui D, Potvin M, Raggi P, Stone J, Svendsen AM, Ward R, Wray W, Grgoire J. 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in Adults. Can J Cardiol. 2021 Aug;37(8):1129-1150.</p>
                    </div>
                    <div class="reference-item">
                        <h5>ESC/EAS Guidelines</h5>
                        <p>Mach F, Baigent C, Catapano AL, Koskinas KC, Casula M, Badimon L, Chapman MJ, De Backer GG, Delgado V, Ference BA, Graham IM, Halliday A, Landmesser U, Mihaylova B, Pedersen TR, Riccardi G, Richter DJ, Sabatine MS, Taskinen MR, Tokgozoglu L, Wiklund O; ESC Scientific Document Group. 2019 ESC/EAS Guidelines for the management of dyslipidaemias: lipid modification to reduce cardiovascular risk. Eur Heart J. 2020 Jan 1;41(1):111-188.</p>
                    </div>
                    <div class="reference-item">
                        <h5>AHA/ACC Guidelines</h5>
                        <p>Grundy SM, Stone NJ, Bailey AL, Beam C, Birtcher KK, Blumenthal RS, Braun LT, de Ferranti S, Faiella-Tommasino J, Forman DE, Goldberg R, Heidenreich PA, Hlatky MA, Jones DW, Lloyd-Jones D, Lopez-Pajares N, Ndumele CE, Orringer CE, Peralta CA, Saseen JJ, Smith SC Jr, Sperling L, Virani SS, Yeboah J. 2018 AHA/ACC/AACVPR/AAPA/ABC/ACPM/ADA/AGS/APhA/ASPC/NLA/PCNA Guideline on the Management of Blood Cholesterol: A Report of the American College of Cardiology/American Heart Association Task Force on Clinical Practice Guidelines. Circulation. 2019 Jun 18;139(25):e1082-e1143.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="secondary-btn close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Full Legal Disclaimer Modal -->
    <div id="disclaimer-modal" class="modal" role="dialog" aria-labelledby="disclaimer-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal- fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                                    Reset Form
                                </button>
                                <button type="button" class="primary-btn" id="calculate-frs-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                                    Calculate FRS Risk
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- QRISK3 Tab -->
                    <div id="qrisk-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-qrisk">
                        <form id="qrisk-form" class="clinical-form" novalidate>
                            <div class="form-header">
                                <h2 class="section-title">QRISK3 Calculator</h2>
                                <p class="section-description">QRISK3 estimates 10-year cardiovascular risk, accounting for multiple factors including ethnicity and additional health conditions.</p>
                                <div class="algorithm-info">
                                    <p class="algorithm-note"><strong>Note:</strong> This is a simplified implementation of the QRISK3 algorithm. While it includes the main risk factors, it may not exactly match the official QRISK3 calculator results.</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Patient Demographics</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-age" class="required">Age</label>
                                            <input type="number" id="qrisk-age" name="qrisk-age" min="25" max="84" placeholder="25-84 years" required pattern="[2-8][0-9]" title="Age must be between 25 and 84" aria-describedby="qrisk-age-validation">
                                            <div id="qrisk-age-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="qrisk-sex" class="required">Sex</label>
                                            <select id="qrisk-sex" name="qrisk-sex" required aria-describedby="qrisk-sex-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                            <div id="qrisk-sex-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-ethnicity" class="required">Ethnicity</label>
                                            <select id="qrisk-ethnicity" name="qrisk-ethnicity" required aria-describedby="qrisk-ethnicity-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="white">White</option>
                                                <option value="indian">Indian</option>
                                                <option value="pakistani">Pakistani</option>
                                                <option value="bangladeshi">Bangladeshi</option>
                                                <option value="other_asian">Other Asian</option>
                                                <option value="black_caribbean">Black Caribbean</option>
                                                <option value="black_african">Black African</option>
                                                <option value="chinese">Chinese</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <div id="qrisk-ethnicity-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="qrisk-townsend">Townsend Deprivation Score
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about Townsend Score">i</div>
                                                    <div class="tooltip-text" role="tooltip">A measure of material deprivation. UK average is 0. Higher scores indicate more deprived areas. If unknown, leave at default value of 0.</div>
                                                </div>
                                            </label>
                                            <input type="number" id="qrisk-townsend" name="qrisk-townsend" min="-6" max="10" placeholder="Default: 0" value="0" step="0.1" aria-describedby="qrisk-townsend-validation">
                                            <div id="qrisk-townsend-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Physical Measurements</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-height" class="required">Height</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-height" name="qrisk-height" min="100" max="250" placeholder="Enter value" required aria-describedby="qrisk-height-validation">
                                                <select id="qrisk-height-unit" name="qrisk-height-unit" class="unit-selector">
                                                    <option value="cm">cm</option>
                                                    <option value="ft/in">ft/in</option>
                                                </select>
                                            </div>
                                            <div id="qrisk-height-ft-container" class="height-ft-container" style="display: none;">
                                                <input type="number" id="qrisk-height-feet" name="qrisk-height-feet" min="3" max="7" placeholder="Feet" aria-label="Height in feet">
                                                <input type="number" id="qrisk-height-inches" name="qrisk-height-inches" min="0" max="11" placeholder="Inches" aria-label="Height in inches">
                                            </div>
                                            <div id="qrisk-height-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="qrisk-weight" class="required">Weight</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-weight" name="qrisk-weight" min="30" max="200" placeholder="Enter value" required aria-describedby="qrisk-weight-validation">
                                                <select id="qrisk-weight-unit" name="qrisk-weight-unit" class="unit-selector">
                                                    <option value="kg">kg</option>
                                                    <option value="lb">lb</option>
                                                </select>
                                            </div>
                                            <div id="qrisk-weight-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-bmi-display">Body Mass Index (BMI)</label>
                                            <div class="input-group">
                                                <input type="text" id="qrisk-bmi-display" name="qrisk-bmi-display" disabled placeholder="Auto-calculated" aria-live="polite">
                                                <span class="unit-selector">kg/m</span>
                                            </div>
                                            <!-- Hidden field to store the actual numeric BMI value for calculations -->
                                            <input type="hidden" id="qrisk-bmi" name="qrisk-bmi">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Blood Pressure</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-sbp" class="required">Systolic Blood Pressure</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-sbp" name="qrisk-sbp" min="70" max="210" placeholder="Enter value" required aria-describedby="qrisk-sbp-validation">
                                                <span class="unit-selector">mmHg</span>
                                            </div>
                                            <div id="qrisk-sbp-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="qrisk-sbp-sd">Standard Deviation of Systolic Blood Pressure
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about SBP standard deviation">i</div>
                                                    <div class="tooltip-text" role="tooltip">Variability in blood pressure is a risk factor. If unknown, you can calculate it from multiple readings below.</div>
                                                </div>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-sbp-sd" name="qrisk-sbp-sd" min="0" max="30" placeholder="Enter if known" aria-describedby="qrisk-sbp-sd-validation">
                                                <span class="unit-selector">mmHg</span>
                                            </div>
                                            <button type="button" class="toggle-link" id="qrisk-toggle-sbp-readings" aria-expanded="false" aria-controls="qrisk-sbp-readings">Calculate from multiple readings</button>
                                            <div id="qrisk-sbp-sd-validation" class="error-message" aria-live="polite"></div>
                                            
                                            <div id="qrisk-sbp-readings" style="display: none; margin-top: 10px;" aria-hidden="true">
                                                <div class="sbp-readings-container">
                                                    <div class="sbp-reading">
                                                        <label for="qrisk-sbp-reading-1">Reading 1</label>
                                                        <input type="number" id="qrisk-sbp-reading-1" name="qrisk-sbp-reading-1" min="70" max="210" placeholder="mmHg">
                                                    </div>
                                                    <div class="sbp-reading">
                                                        <label for="qrisk-sbp-reading-2">Reading 2</label>
                                                        <input type="number" id="qrisk-sbp-reading-2" name="qrisk-sbp-reading-2" min="70" max="210" placeholder="mmHg">
                                                    </div>
                                                    <div class="sbp-reading">
                                                        <label for="qrisk-sbp-reading-3">Reading 3</label>
                                                        <input type="number" id="qrisk-sbp-reading-3" name="qrisk-sbp-reading-3" min="70" max="210" placeholder="mmHg">
                                                    </div>
                                                    <div class="sbp-reading">
                                                        <label for="qrisk-sbp-reading-4">Reading 4</label>
                                                        <input type="number" id="qrisk-sbp-reading-4" name="qrisk-sbp-reading-4" min="70" max="210" placeholder="mmHg">
                                                    </div>
                                                    <div class="sbp-reading">
                                                        <label for="qrisk-sbp-reading-5">Reading 5</label>
                                                        <input type="number" id="qrisk-sbp-reading-5" name="qrisk-sbp-reading-5" min="70" max="210" placeholder="mmHg">
                                                    </div>
                                                    <div class="sbp-reading">
                                                        <label for="qrisk-sbp-reading-6">Reading 6</label>
                                                        <input type="number" id="qrisk-sbp-reading-6" name="qrisk-sbp-reading-6" min="70" max="210" placeholder="mmHg">
                                                    </div>
                                                </div>
                                                <div class="checkbox-item" style="margin-top: 10px;">
                                                    <input type="checkbox" id="qrisk-single-sbp-reading" name="qrisk-single-sbp-reading">
                                                    <label for="qrisk-single-sbp-reading">I only have 1 systolic reading</label>
                                                </div>
                                                <button type="button" class="sbp-calc-btn" id="calculate-sbp-sd-btn">Calculate SD</button>
                                                <div id="qrisk-sbp-sd-result" class="sbp-result" aria-live="polite"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-bp-treatment">On Blood Pressure Treatment</label>
                                            <select id="qrisk-bp-treatment" name="qrisk-bp-treatment">
                                                <option value="no" selected>No</option>
                                                <option value="yes">Yes</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Lipid Profile</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-total-chol" class="required">Total Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-total-chol" name="qrisk-total-chol" min="1" max="15" placeholder="Enter value" required step="0.1" aria-describedby="qrisk-total-chol-validation">
                                                <select id="qrisk-total-chol-unit" name="qrisk-total-chol-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="qrisk-total-chol-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="qrisk-hdl" class="required">HDL Cholesterol</label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-hdl" name="qrisk-hdl" min="0.5" max="3" placeholder="Enter value" required step="0.1" aria-describedby="qrisk-hdl-validation">
                                                <select id="qrisk-hdl-unit" name="qrisk-hdl-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="qrisk-hdl-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-ldl">LDL Cholesterol
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about LDL cholesterol">i</div>
                                                    <div class="tooltip-text" role="tooltip">LDL cholesterol level is used to determine specific treatment recommendations according to clinical guidelines.</div>
                                                </div>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-ldl" name="qrisk-ldl" min="0.5" max="10" placeholder="Enter value (optional)" step="0.1" aria-describedby="qrisk-ldl-validation">
                                                <select id="qrisk-ldl-unit" name="qrisk-ldl-unit" class="unit-selector">
                                                    <option value="mmol/L">mmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                            </div>
                                            <div id="qrisk-ldl-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="qrisk-ratio-display">Total Cholesterol:HDL Ratio</label>
                                            <div class="input-group">
                                                <input type="text" id="qrisk-ratio-display" name="qrisk-ratio-display" disabled placeholder="Auto-calculated" aria-live="polite">
                                                <span class="unit-selector">ratio</span>
                                            </div>
                                            <!-- Hidden field to store the actual numeric ratio value for calculations -->
                                            <input type="hidden" id="qrisk-chol-ratio" name="qrisk-chol-ratio">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Risk Factors</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-smoker" class="required">Smoker Status</label>
                                            <select id="qrisk-smoker" name="qrisk-smoker" required aria-describedby="qrisk-smoker-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="non">Non-smoker</option>
                                                <option value="ex">Ex-smoker</option>
                                                <option value="light">Light smoker (< 10/day)</option>
                                                <option value="moderate">Moderate smoker (10-19/day)</option>
                                                <option value="heavy">Heavy smoker (20+/day)</option>
                                            </select>
                                            <div id="qrisk-smoker-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="qrisk-diabetes" class="required">Diabetes Status</label>
                                            <select id="qrisk-diabetes" name="qrisk-diabetes" required aria-describedby="qrisk-diabetes-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="none">None</option>
                                                <option value="type1">Type 1</option>
                                                <option value="type2">Type 2</option>
                                            </select>
                                            <div id="qrisk-diabetes-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-family-history" class="required">Family History of CVD</label>
                                            <select id="qrisk-family-history" name="qrisk-family-history" required aria-describedby="qrisk-family-history-validation">
                                                <option value="" selected disabled>Select</option>
                                                <option value="yes">Yes</option>
                                                <option value="no">No</option>
                                            </select>
                                            <div id="qrisk-family-history-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Medical Conditions</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-af" name="qrisk-af">
                                            <label for="qrisk-af">Atrial Fibrillation</label>
                                        </div>
                                        
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-ra" name="qrisk-ra">
                                            <label for="qrisk-ra">Rheumatoid Arthritis</label>
                                        </div>
                                        
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-ckd" name="qrisk-ckd">
                                            <label for="qrisk-ckd">Chronic Kidney Disease (Stage 3, 4, or 5)</label>
                                        </div>
                                        
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-migraine" name="qrisk-migraine">
                                            <label for="qrisk-migraine">Migraine</label>
                                        </div>
                                        
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-sle" name="qrisk-sle">
                                            <label for="qrisk-sle">Systemic Lupus Erythematosus (SLE)</label>
                                        </div>
                                        
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-semi" name="qrisk-semi">
                                            <label for="qrisk-semi">Severe Mental Illness</label>
                                        </div>
                                        
                                        <div class="checkbox-item" id="qrisk-ed-container" style="display: none;">
                                            <input type="checkbox" id="qrisk-ed" name="qrisk-ed">
                                            <label for="qrisk-ed">Erectile Dysfunction/Impotence</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header active" aria-expanded="true">
                                    <h3>Medications</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body active">
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-atypical-antipsychotics" name="qrisk-atypical-antipsychotics">
                                            <label for="qrisk-atypical-antipsychotics">On Atypical Antipsychotics</label>
                                        </div>
                                        
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="qrisk-corticosteroids" name="qrisk-corticosteroids">
                                            <label for="qrisk-corticosteroids">On Regular Corticosteroids</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header" aria-expanded="false">
                                    <h3>Lipoprotein(a) Modifier</h3>
                                    <span class="toggle-icon" aria-hidden="true"></span>
                                </div>
                                <div class="card-body">
                                    <!-- Area for Lp(a) research update notices -->
                                    <div id="qrisk-lpa-research-updates" class="research-update-container" style="display: none;" aria-live="polite">
                                        <!-- Dynamically updated with new research -->
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="qrisk-lpa">Lp(a) Level
                                                <div class="tooltip-container">
                                                    <div class="info-icon" tabindex="0" aria-label="Information about Lp(a)">i</div>
                                                    <div class="tooltip-text" role="tooltip" id="qrisk-lpa-tooltip">Elevated Lp(a) (50 mg/dL or 100 nmol/L) is an independent risk factor that increases cardiovascular risk.</div>
                                                </div>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="qrisk-lpa" name="qrisk-lpa" min="0" max="500" placeholder="Enter value (optional)" step="1" aria-describedby="qrisk-lpa-tooltip qrisk-lpa-validation">
                                                <select id="qrisk-lpa-unit" name="qrisk-lpa-unit" class="unit-selector">
                                                    <option value="mg/dL">mg/dL</option>
                                                    <option value="nmol/L">nmol/L</option>
                                                </select>
                                            </div>
                                            <div id="qrisk-lpa-validation" class="error-message" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="secondary-btn" id="reset-qrisk-button" data-reset-form="qrisk-form">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                                    Reset Form
                                </button>
                                <button type="button" class="primary-btn" id="calculate-qrisk-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                                    Calculate QRISK3 Score
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Compare Both Tab -->
                    <div id="both-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-both">
                        <div class="form-header">
                            <h2 class="section-title">Compare Risk Assessment Methods</h2>
                            <p class="section-description">Calculate and compare both Framingham Risk Score and QRISK3 to provide a more comprehensive assessment.</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header active" aria-expanded="true">
                                <h3>Instructions</h3>
                                <span class="toggle-icon" aria-hidden="true"></span>
                            </div>
                            <div class="card-body active">
                                <div class="info-box">
                                    <div class="info-icon-large" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                                    </div>
                                    <div class="info-content">
                                        <h4>How to use this comparison tool:</h4>
                                        <ol>
                                            <li>Complete <strong>both</strong> the Framingham Risk Score and QRISK3 calculator forms</li>
                                            <li>Click the "Compare Both Scores" button below</li>
                                            <li>The results will show both risk scores side by side with their respective risk modifiers</li>
                                            <li>Treatment recommendations will be based on the higher risk score in accordance with clinical guidelines</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div class="comparison-status" aria-live="polite">
                                    <div class="status-item">
                                        <div class="status-icon" id="frs-status-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>
                                        </div>
                                        <div class="status-text">
                                            <span class="status-label">Framingham Risk Score:</span>
                                            <span class="status-value" id="frs-status">Not completed</span>
                                        </div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-icon" id="qrisk-status-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>
                                        </div>
                                        <div class="status-text">
                                            <span class="status-label">QRISK3:</span>
                                            <span class="status-value" id="qrisk-status">Not completed</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header active" aria-expanded="true">
                                <h3>Why Compare Both Methods?</h3>
                                <span class="toggle-icon" aria-hidden="true"></span>
                            </div>
                            <div class="card-body active">
                                <div class="comparison-benefits">
                                    <div class="benefit-item">
                                        <div class="benefit-icon" aria-hidden="true">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                                        </div>
                                        <div class="benefit-content">
                                            <h4>Different Populations</h4>
                                            <p>Framingham is derived from a US cohort while QRISK3 is UK-based. Different demographics may be better represented by one score or the other.</p>
                                        </div>
                                    </div>
                                    <div class="benefit-item">
                                        <div class="benefit-icon" aria-hidden="true">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6"></path><path d="M9 22h9a2 2 0 0 0 2-2v-7"></path><path d="M13 5v6"></path><path d="M10 8h6"></path><circle cx="17" cy="17" r="3"></circle></svg>
                                        </div>
                                        <div class="benefit-content">
                                            <h4>Additional Risk Factors</h4>
                                            <p>QRISK3 includes additional factors like ethnicity, family history, and specific medical conditions that Framingham does not consider.</p>
                                        </div>
                                    </div>
                                    <div class="benefit-item">
                                        <div class="benefit-icon" aria-hidden="true">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                        </div>
                                        <div class="benefit-content">
                                            <h4>Improved Accuracy</h4>
                                            <p>Combining risk assessment methods can provide a more comprehensive evaluation, potentially identifying at-risk individuals who might be missed by a single calculator.</p>
                                        </div>
                                    </div>
                                    <div class="benefit-item">
                                        <div class="benefit-icon" aria-hidden="true">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                                        </div>
                                        <div class="benefit-content">
                                            <h4>Clinical Decision Support</h4>
                                            <p>When risk scores differ, it prompts clinicians to explore potential factors that may be influencing cardiovascular risk assessment.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header" aria-expanded="false">
                                <h3>Comparison Limitations</h3>
                                <span class="toggle-icon" aria-hidden="true"></span>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <p><strong>Important considerations when comparing risk scores:</strong></p>
                                    <ul>
                                        <li>These scores are developed from different populations with different baseline risks</li>
                                        <li>Both calculators have their own limitations and may over- or under-estimate risk in certain individuals</li>
                                        <li>Clinical judgment should always be used alongside these risk estimation tools</li>
                                        <li>Treatment decisions should consider individual patient factors, preferences, and risk-benefit discussions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="primary-btn calculate-both-btn" id="calculate-both-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"