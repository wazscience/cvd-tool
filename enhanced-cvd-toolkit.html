        <!-- QRISK3 Tab -->
        <div class="tab-content" id="qrisk-tab-content">
            <h2>QRISK3 Calculator</h2>
            <form id="qrisk-form">
                <!-- Patient Information Section -->
                <div class="section">
                    <h3>Patient Information</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-age">Age (25-84 years)</label>
                                <input type="number" id="qrisk-age" name="qrisk-age" class="form-control" min="25" max="84" required data-validation-type="age" data-param-type="age">
                                <div id="qrisk-age-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-sex">Sex</label>
                                <select id="qrisk-sex" name="qrisk-sex" class="form-control" required data-validation-type="sex">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                                <div id="qrisk-sex-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-ethnicity">Ethnicity</label>
                                <select id="qrisk-ethnicity" name="qrisk-ethnicity" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="WHITE_OR_NOT_STATED">White or not stated</option>
                                    <option value="WHITE_IRISH">White Irish</option>
                                    <option value="WHITE_GYPSY">White Gypsy</option>
                                    <option value="OTHER_WHITE">Other White</option>
                                    <option value="WHITE_BLACK_CARIBBEAN">White + Black Caribbean</option>
                                    <option value="WHITE_BLACK_AFRICAN">White + Black African</option>
                                    <option value="WHITE_ASIAN">White + Asian</option>
                                    <option value="OTHER_MIXED">Other mixed</option>
                                    <option value="INDIAN">Indian</option>
                                    <option value="PAKISTANI">Pakistani</option>
                                    <option value="BANGLADESHI">Bangladeshi</option>
                                    <option value="OTHER_ASIAN">Other Asian</option>
                                    <option value="BLACK_CARIBBEAN">Black Caribbean</option>
                                    <option value="BLACK_AFRICAN">Black African</option>
                                    <option value="OTHER_BLACK">Other Black</option>
                                    <option value="CHINESE">Chinese</option>
                                    <option value="OTHER">Other</option>
                                </select>
                                <div id="qrisk-ethnicity-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-height">Height</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-height" name="qrisk-height" class="form-control" min="100" max="250" step="0.1" data-validation-type="height" data-param-type="height_cm" data-physiological="true">
                                    <select id="qrisk-height-unit" name="qrisk-height-unit" class="form-control">
                                        <option value="cm">cm</option>
                                        <option value="in">in</option>
                                    </select>
                                </div>
                                <div id="qrisk-height-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-weight">Weight</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-weight" name="qrisk-weight" class="form-control" min="20" max="300" step="0.1" data-validation-type="weight" data-param-type="weight_kg" data-physiological="true">
                                    <select id="qrisk-weight-unit" name="qrisk-weight-unit" class="form-control">
                                        <option value="kg">kg</option>
                                        <option value="lb">lb</option>
                                    </select>
                                </div>
                                <div id="qrisk-weight-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-bmi">BMI (kg/m²)</label>
                                <input type="number" id="qrisk-bmi" name="qrisk-bmi" class="form-control" readonly data-param-type="bmi">
                                <div id="qrisk-bmi-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Clinical Parameters Section -->
                <div class="section">
                    <h3>Clinical Parameters</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-sbp">Systolic Blood Pressure (mmHg)</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-sbp" name="qrisk-sbp" class="form-control" min="70" max="250" required data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                    <div class="form-check">
                                        <input type="checkbox" id="qrisk-multiple-sbp" name="qrisk-multiple-sbp" class="form-check-input">
                                        <label for="qrisk-multiple-sbp" class="form-check-label">Multiple readings</label>
                                    </div>
                                </div>
                                <div id="qrisk-sbp-validation" class="error-message"></div>
                            </div>
                            <div id="qrisk-sbp-readings" class="form-group" style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-1">Reading 1</label>
                                        <input type="number" id="qrisk-sbp-1" name="qrisk-sbp-1" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-1-validation" class="error-message"></div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-2">Reading 2</label>
                                        <input type="number" id="qrisk-sbp-2" name="qrisk-sbp-2" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-2-validation" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="qrisk-sbp-readings-extra" class="form-group" style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-3">Reading 3</label>
                                        <input type="number" id="qrisk-sbp-3" name="qrisk-sbp-3" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-3-validation" class="error-message"></div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-4">Reading 4</label>
                                        <input type="number" id="qrisk-sbp-4" name="qrisk-sbp-4" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-4-validation" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="qrisk-sbp-readings-extra2" class="form-group" style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-5">Reading 5</label>
                                        <input type="number" id="qrisk-sbp-5" name="qrisk-sbp-5" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-5-validation" class="error-message"></div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-6">Reading 6</label>
                                        <input type="number" id="qrisk-sbp-6" name="qrisk-sbp-6" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-6-validation" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="qrisk-sbp-sd-container" class="form-group" style="display: none;">
                                <label class="form-label" for="qrisk-sbp-sd">SBP Standard Deviation</label>
                                <input type="number" id="qrisk-sbp-sd" name="qrisk-sbp-sd" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-bp-treatment">On Blood Pressure Treatment?</label>
                                <select id="qrisk-bp-treatment" name="qrisk-bp-treatment" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                                <div id="qrisk-bp-treatment-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="qrisk-smoker">Smoking Status</label>
                                <select id="qrisk-smoker" name="qrisk-smoker" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="non">Non-smoker</option>
                                    <option value="ex">Ex-smoker</option>
                                    <option value="light">Light smoker (< 10/day)</option>
                                    <option value="moderate">Moderate smoker (10-19/day)</option>
                                    <option value="heavy">Heavy smoker (≥ 20/day)</option>
                                </select>
                                <div id="qrisk-smoker-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="qrisk-diabetes">Diabetes Status</label>
                                <select id="qrisk-diabetes" name="qrisk-diabetes" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="none">No diabetes</option>
                                    <option value="pre">Pre-diabetes</option>
                                    <option value="type1">Type 1 diabetes</option>
                                    <option value="type2">Type 2 diabetes</option>
                                </select>
                                <div id="qrisk-diabetes-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lipid Parameters Section -->
                <div class="section">
                    <h3>Lipid Parameters</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-total-chol">Total Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-total-chol" name="qrisk-total-chol" class="form-control" min="1" max="15" step="0.1" required data-validation-type="cholesterol" data-param-type="totalCholesterol" data-physiological="true">
                                    <select id="qrisk-total-chol-unit" name="qrisk-total-chol-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="qrisk-total-chol-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-hdl">HDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-hdl" name="qrisk-hdl" class="form-control" min="0.4" max="5" step="0.1" required data-validation-type="hdl" data-param-type="hdl" data-physiological="true">
                                    <select id="qrisk-hdl-unit" name="qrisk-hdl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="qrisk-hdl-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-cholesterol-ratio">Total Chol:HDL Ratio</label>
                                <input type="number" id="qrisk-cholesterol-ratio" name="qrisk-cholesterol-ratio" class="form-control" readonly min="1" max="15" step="0.1">
                                <div id="qrisk-cholesterol-ratio-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Risk Factors Section -->
                <div class="section">
                    <h3>Additional Risk Factors</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label">Family History of CVD?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-family-history" name="qrisk-family-history" class="form-check-input">
                                    <label for="qrisk-family-history" class="form-check-label">Yes (angina or heart attack in a 1st degree relative < 60 years)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Chronic Kidney Disease (Stage 3, 4, or 5)?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-chronic-kidney-disease" name="qrisk-chronic-kidney-disease" class="form-check-input">
                                    <label for="qrisk-chronic-kidney-disease" class="form-check-label">Yes</label>
                                                                <div class="chart-y-tick" style="bottom: 75%;">${(maxRisk * 0.75).toFixed(0)}%</div>
                                <div class="chart-y-tick" style="bottom: 100%;">${maxRisk.toFixed(0)}%</div>
                            </div>
                        </div>
                        <div class="chart-grid">
                            <div class="chart-grid-line" style="bottom: 0%;"></div>
                            <div class="chart-grid-line" style="bottom: 25%;"></div>
                            <div class="chart-grid-line" style="bottom: 50%;"></div>
                            <div class="chart-grid-line" style="bottom: 75%;"></div>
                            <div class="chart-grid-line" style="bottom: 100%;"></div>
                        </div>
                        <div class="chart-lines">
            `;
            
            // Add natural progression line
            html += `<div class="chart-line natural">`;
            
            for (let i = 0; i < timePoints.length; i++) {
                if (naturalRisks[i] === null) continue;
                
                const x = (i / (timePoints.length - 1)) * 100;
                const y = (naturalRisks[i] / maxRisk) * 100;
                
                html += `<div class="chart-point" style="left: ${x}%; bottom: ${y}%;" data-age="${timePoints[i]}" data-risk="${naturalRisks[i].toFixed(1)}%"></div>`;
            }
            
            html += `</div>`;
            
            // Add intervention line if applicable
            if (interventionRisks.some(r => r !== null)) {
                html += `<div class="chart-line intervention">`;
                
                for (let i = 0; i < timePoints.length; i++) {
                    if (interventionRisks[i] === null) continue;
                    
                    const x = (i / (timePoints.length - 1)) * 100;
                    const y = (interventionRisks[i] / maxRisk) * 100;
                    
                    html += `<div class="chart-point" style="left: ${x}%; bottom: ${y}%;" data-age="${timePoints[i]}" data-risk="${interventionRisks[i].toFixed(1)}%"></div>`;
                }
                
                html += `</div>`;
            }
            
            html += `
                        </div>
                        <div class="chart-x-axis">
                            <div class="chart-x-label">Age (years)</div>
                            <div class="chart-x-ticks">
            `;
            
            // Add x-axis ticks
            const numTicks = Math.min(timePoints.length, 5);
            for (let i = 0; i < numTicks; i++) {
                const idx = Math.floor((i / (numTicks - 1)) * (timePoints.length - 1));
                const x = (idx / (timePoints.length - 1)) * 100;
                html += `<div class="chart-x-tick" style="left: ${x}%;">${timePoints[idx]}</div>`;
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                </div>
                <div class="progression-legend">
                    <div class="legend-item">
                        <div class="legend-color natural"></div>
                        <div class="legend-label">Natural Progression</div>
                    </div>
            `;
            
            if (interventionRisks.some(r => r !== null)) {
                html += `
                    <div class="legend-item">
                        <div class="legend-color intervention"></div>
                        <div class="legend-label">With Intervention (Starting at Age ${interventionAge})</div>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div class="progression-summary">
                    <p>This chart shows how cardiovascular risk increases with age, both with and without intervention.</p>
                    <p>Risk thresholds: Low risk (<10%), Intermediate risk (10-19%), High risk (≥20%).</p>
                    ${interventionRisks.some(r => r !== null) ? `
                    <p>The intervention model assumes treatment begins at age ${interventionAge} and includes moderate-intensity statin therapy, which typically reduces LDL-C by ~30%.</p>
                    ` : ''}
                </div>
            `;
            
            // Update visualization container
            visualizationContainer.innerHTML = html;
        }
        
        /**
         * Calculate risk calculator sensitivity
         */
        function calculateSensitivity() {
            // Get parameters
            const calculator = document.getElementById('sensitivity-calculator').value;
            const factor = document.getElementById('sensitivity-factor').value;
            
            // Get base risk parameters
            let frsParams = null;
            let qriskParams = null;
            
            if (window.lastFrsResult) {
                frsParams = window.lastFrsResult.inputs;
            }
            
            if (window.lastQriskResult) {
                qriskParams = window.lastQriskResult.inputs;
            }
            
            // Check if selected calculator results are available
            if (calculator === 'frs' && !frsParams) {
                alert('Please calculate Framingham Risk Score first.');
                return;
            } else if (calculator === 'qrisk' && !qriskParams) {
                alert('Please calculate QRISK3 first.');
                return;
            } else if (calculator === 'both' && (!frsParams || !qriskParams)) {
                alert('Please calculate both Framingham Risk Score and QRISK3 first.');
                return;
            }
            
            // Show loading
            const visualizationContainer = document.getElementById('sensitivity-analysis-visualization');
            if (visualizationContainer) {
                visualizationContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Calculating...</p></div>';
            }
            
            try {
                // Create range of values for the selected factor
                const values = [];
                const frsRisks = [];
                const qriskRisks = [];
                
                // Define factor ranges based on factor type
                let minValue, maxValue, step, frsBaseValue, qriskBaseValue;
                
                switch (factor) {
                    case 'age':
                        minValue = 30;
                        maxValue = 79;
                        step = 5;
                        frsBaseValue = frsParams ? frsParams.age : null;
                        qriskBaseValue = qriskParams ? qriskParams.age : null;
                        break;
                        
                    case 'sbp':
                        minValue = 90;
                        maxValue = 200;
                        step = 10;
                        frsBaseValue = frsParams ? frsParams.sbp : null;
                        qriskBaseValue = qriskParams ? qriskParams.sbp : null;
                        break;
                        
                    case 'cholesterol':
                        minValue = 3;
                        maxValue = 8;
                        step = 0.5;
                        frsBaseValue = frsParams ? frsParams.cholesterol : null;
                        qriskBaseValue = qriskParams ? qriskParams.cholHDLRatio : null;
                        break;
                        
                    case 'hdl':
                        minValue = 0.5;
                        maxValue = 3;
                        step = 0.2;
                        frsBaseValue = frsParams ? frsParams.hdl : null;
                        qriskBaseValue = qriskParams ? qriskParams.hdl : null;
                        break;
                        
                    case 'smoking':
                        // Special case for smoking
                        if (calculator === 'frs' || calculator === 'both') {
                            values.push('Non-smoker');
                            values.push('Smoker');
                            
                            // Calculate FRS risk for each smoking status
                            if (frsParams) {
                                for (let i = 0; i < 2; i++) {
                                    const params = { ...frsParams };
                                    params.smoking = i === 1;
                                    
                                    const result = window.framinghamCalculator.calculateRisk(params);
                                    
                                    if (result.success) {
                                        frsRisks.push(result.risk);
                                    } else {
                                        frsRisks.push(null);
                                    }
                                }
                            }
                        }
                        
                        if (calculator === 'qrisk' || calculator === 'both') {
                            // Adjust values for QRISK3
                            if (calculator === 'qrisk') {
                                values.push('Non-smoker');
                                values.push('Ex-smoker');
                                values.push('Light smoker');
                                values.push('Moderate smoker');
                                values.push('Heavy smoker');
                            }
                            
                            // Calculate QRISK3 risk for each smoking status
                            if (qriskParams) {
                                const smokingStatuses = ['non', 'ex', 'light', 'moderate', 'heavy'];
                                
                                for (let i = 0; i < smokingStatuses.length; i++) {
                                    const params = { ...qriskParams };
                                    params.smoking = smokingStatuses[i];
                                    
                                    const result = window.qrisk3Calculator.calculateRisk(params);
                                    
                                    if (result.success) {
                                        qriskRisks.push(result.risk);
                                    } else {
                                        qriskRisks.push(null);
                                    }
                                }
                            }
                        }
                        
                        // Create visualization
                        createSensitivityVisualization(values, frsRisks, qriskRisks, 'Smoking Status');
                        return;
                }
                
                // Create range of values
                for (let value = minValue; value <= maxValue; value += step) {
                    values.push(value);
                    
                    // Calculate FRS risk for this value
                    if ((calculator === 'frs' || calculator === 'both') && frsParams) {
                        const params = { ...frsParams };
                        
                        // Set factor value
                        switch (factor) {
                            case 'age':
                                params.age = value;
                                break;
                                
                            case 'sbp':
                                params.sbp = value;
                                break;
                                
                            case 'cholesterol':
                                params.cholesterol = value;
                                break;
                                
                            case 'hdl':
                                params.hdl = value;
                                break;
                        }
                        
                        // Calculate risk
                        const result = window.framinghamCalculator.calculateRisk(params);
                        
                        if (result.success) {
                            frsRisks.push(result.risk);
                        } else {
                            frsRisks.push(null);
                        }
                    }
                    
                    // Calculate QRISK3 risk for this value
                    if ((calculator === 'qrisk' || calculator === 'both') && qriskParams) {
                        const params = { ...qriskParams };
                        
                        // Set factor value
                        switch (factor) {
                            case 'age':
                                params.age = value;
                                break;
                                
                            case 'sbp':
                                params.sbp = value;
                                break;
                                
                            case 'cholesterol':
                                if (factor === 'cholesterol') {
                                    // For QRISK3, we need to adjust the cholesterol:HDL ratio
                                    const hdl = params.hdl;
                                    params.cholHDLRatio = value / hdl;
                                }
                                break;
                                
                            case 'hdl':
                                params.hdl = value;
                                // Adjust cholesterol:HDL ratio
                                if (params.cholHDLRatio) {
                                    const totalChol = params.cholHDLRatio * params.hdl;
                                    params.cholHDLRatio = totalChol / value;
                                }
                                break;
                        }
                        
                        // Calculate risk
                        const result = window.qrisk3Calculator.calculateRisk(params);
                        
                        if (result.success) {
                            qriskRisks.push(result.risk);
                        } else {
                            qriskRisks.push(null);
                        }
                    }
                }
                
                // Create visualization
                let factorLabel = '';
                
                switch (factor) {
                    case 'age':
                        factorLabel = 'Age (years)';
                        break;
                        
                    case 'sbp':
                        factorLabel = 'Systolic Blood Pressure (mmHg)';
                        break;
                        
                    case 'cholesterol':
                        factorLabel = calculator === 'qrisk' ? 'Total Cholesterol:HDL Ratio' : 'Total Cholesterol (mmol/L)';
                        if (calculator === 'both') {
                            factorLabel = 'Total Cholesterol (mmol/L) / Cholesterol:HDL Ratio';
                        }
                        break;
                        
                    case 'hdl':
                        factorLabel = 'HDL Cholesterol (mmol/L)';
                        break;
                }
                
                createSensitivityVisualization(
                    values, 
                    frsRisks, 
                    qriskRisks, 
                    factorLabel, 
                    frsBaseValue, 
                    qriskBaseValue
                );
            } catch (error) {
                console.error('Sensitivity analysis calculation error:', error);
                
                // Show error
                if (visualizationContainer) {
                    visualizationContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Calculation Error</h4>
                            <p>An unexpected error occurred while performing sensitivity analysis.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Create sensitivity analysis visualization
         * @param {Array} values - Factor values
         * @param {Array} frsRisks - FRS risks
         * @param {Array} qriskRisks - QRISK3 risks
         * @param {string} factorLabel - Factor label
         * @param {number} [frsBaseValue] - FRS base value
         * @param {number} [qriskBaseValue] - QRISK3 base value
         */
        function createSensitivityVisualization(values, frsRisks, qriskRisks, factorLabel, frsBaseValue, qriskBaseValue) {
            const visualizationContainer = document.getElementById('sensitivity-analysis-visualization');
            if (!visualizationContainer) return;
            
            // Determine which calculators to show
            const showFrs = frsRisks.length > 0;
            const showQrisk = qriskRisks.length > 0;
            
            // Find maximum risk for scaling
            const maxFrsRisk = showFrs ? Math.max(...frsRisks.filter(r => r !== null)) : 0;
            const maxQriskRisk = showQrisk ? Math.max(...qriskRisks.filter(r => r !== null)) : 0;
            const maxRisk = Math.max(maxFrsRisk, maxQriskRisk, 20); // At least 20% for scaling
            
            // Create HTML for visualization
            let html = `
                <div class="sensitivity-chart">
                    <h4>Sensitivity Analysis: Impact of ${factorLabel} on CVD Risk</h4>
                    <div class="chart-body">
                        <div class="chart-y-axis">
                            <div class="chart-y-label">10-Year CVD Risk (%)</div>
                            <div class="chart-y-ticks">
                                <div class="chart-y-tick" style="bottom: 0%;">0%</div>
                                <div class="chart-y-tick" style="bottom: 25%;">${(maxRisk * 0.25).toFixed(0)}%</div>
                                <div class="chart-y-tick" style="bottom: 50%;">${(maxRisk * 0.5).toFixed(0)}%</div>
                                <div class="chart-y-tick" style="bottom: 75%;">${(maxRisk * 0.75).toFixed(0)}%</div>
                                <div class="chart-y-tick" style="bottom: 100%;">${maxRisk.toFixed(0)}%</div>
                            </div>
                        </div>
                        <div class="chart-grid">
                            <div class="chart-grid-line" style="bottom: 0%;"></div>
                            <div class="chart-grid-line" style="bottom: 25%;"></div>
                            <div class="chart-grid-line" style="bottom: 50%;"></div>
                            <div class="chart-grid-line" style="bottom: 75%;"></div>
                            <div class="chart-grid-line" style="bottom: 100%;"></div>
                        </div>
                        <div class="chart-lines">
            `;
            
            // Add FRS line
            if (showFrs) {
                html += `<div class="chart-line frs">`;
                
                for (let i = 0; i < values.length; i++) {
                    if (frsRisks[i] === null) continue;
                    
                    const x = (i / (values.length - 1)) * 100;
                    const y = (frsRisks[i] / maxRisk) * 100;
                    
                    html += `<div class="chart-point" style="left: ${x}%; bottom: ${y}%;" data-value="${values[i]}" data-risk="${frsRisks[i].toFixed(1)}%"></div>`;
                }
                
                html += `</div>`;
            }
            
            // Add QRISK3 line
            if (showQrisk) {
                html += `<div class="chart-line qrisk">`;
                
                for (let i = 0; i < values.length; i++) {
                    if (qriskRisks[i] === null) continue;
                    
                    const x = (i / (values.length - 1)) * 100;
                    const y = (qriskRisks[i] / maxRisk) * 100;
                    
                    html += `<div class="chart-point" style="left: ${x}%; bottom: ${y}%;" data-value="${values[i]}" data-risk="${qriskRisks[i].toFixed(1)}%"></div>`;
                }
                
                html += `</div>`;
            }
            
            // Add base value markers
            if (frsBaseValue !== null && showFrs) {
                // Find closest value
                let closestIdx = 0;
                let minDiff = Math.abs(values[0] - frsBaseValue);
                
                for (let i = 1; i < values.length; i++) {
                    const diff = Math.abs(values[i] - frsBaseValue);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIdx = i;
                    }
                }
                
                const x = (closestIdx / (values.length - 1)) * 100;
                const y = (frsRisks[closestIdx] / maxRisk) * 100;
                
                html += `<div class="chart-base-marker frs" style="left: ${x}%; bottom: ${y}%;" data-value="${values[closestIdx]}" data-risk="${frsRisks[closestIdx].toFixed(1)}%"></div>`;
            }
            
            if (qriskBaseValue !== null && showQrisk) {
                // Find closest value
                let closestIdx = 0;
                let minDiff = Math.abs(values[0] - qriskBaseValue);
                
                for (let i = 1; i < values.length; i++) {
                    const diff = Math.abs(values[i] - qriskBaseValue);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIdx = i;
                    }
                }
                
                const x = (closestIdx / (values.length - 1)) * 100;
                const y = (qriskRisks[closestIdx] / maxRisk) * 100;
                
                html += `<div class="chart-base-marker qrisk" style="left: ${x}%; bottom: ${y}%;" data-value="${values[closestIdx]}" data-risk="${qriskRisks[closestIdx].toFixed(1)}%"></div>`;
            }
            
            html += `
                        </div>
                        <div class="chart-x-axis">
                            <div class="chart-x-label">${factorLabel}</div>
                            <div class="chart-x-ticks">
            `;
            
            // Add x-axis ticks
            const numTicks = Math.min(values.length, 5);
            for (let i = 0; i < numTicks; i++) {
                const idx = Math.floor((i / (numTicks - 1)) * (values.length - 1));
                const x = (idx / (values.length - 1)) * 100;
                html += `<div class="chart-x-tick" style="left: ${x}%;">${values[idx]}</div>`;
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sensitivity-legend">
            `;
            
            if (showFrs) {
                html += `
                    <div class="legend-item">
                        <div class="legend-color frs"></div>
                        <div class="legend-label">Framingham Risk Score</div>
                    </div>
                `;
            }
            
            if (showQrisk) {
                html += `
                    <div class="legend-item">
                        <div class="legend-color qrisk"></div>
                        <div class="legend-label">QRISK3</div>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div class="sensitivity-summary">
                    <p>This chart shows how changes in ${factorLabel.toLowerCase()} affect the predicted 10-year cardiovascular risk.</p>
                    <p>Points represent calculated risk values at different levels of the selected factor. Lines show the overall trend in risk.</p>
                    ${frsBaseValue !== null || qriskBaseValue !== null ? `
                    <p>Markers indicate the patient's current values: 
                        ${frsBaseValue !== null ? `FRS: ${frsBaseValue} (${frsRisks.find((_, i) => values[i] === frsBaseValue)?.toFixed(1) || '?'}%)` : ''}
                        ${frsBaseValue !== null && qriskBaseValue !== null ? ' | ' : ''}
                        ${qriskBaseValue !== null ? `QRISK3: ${qriskBaseValue} (${qriskRisks.find((_, i) => values[i] === qriskBaseValue)?.toFixed(1) || '?'}%)` : ''}
                    </p>
                    ` : ''}
                </div>
            `;
            
            // Update visualization container
            visualizationContainer.innerHTML = html;
        }
        
        /**
         * Submit research contact form
         */
        function submitResearchContact() {
            // Get form data
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const institution = document.getElementById('contact-institution').value;
            const message = document.getElementById('contact-message').value;
            
            // Validate required fields
            if (!name || !email || !message) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Show submission message
            alert('Thank you for your interest in collaboration! Your message has been submitted. This is a placeholder for actual form submission functionality.');
            
            // Reset form
            document.getElementById('research-contact-form').reset();
            
            // In a real implementation, you would send the form data to a server endpoint
            /*
            fetch('/api/research-contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    institution: institution,
                    message: message,
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to submit form');
            })
            .then(data => {
                alert('Thank you for your interest in collaboration! Your message has been submitted.');
                document.getElementById('research-contact-form').reset();
            })
            .catch(error => {
                alert('Failed to submit form: ' + error.message);
            });
            */
        }
        
        /**
         * Initialize module loading
         * @returns {Promise} Promise that resolves when all modules are loaded
         */
        function initializeModuleLoading() {
            return new Promise((resolve, reject) => {
                try {
                    // Define module loader function
                    function importModule(path) {
                        return new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.type = 'module';
                            script.src = path;
                            script.onload = () => resolve();
                            script.onerror = (error) => reject(new Error(`Failed to load module: ${path}`));
                            document.head.appendChild(script);
                        });
                    }
                    
                    // Import essential modules
                    Promise.all([
                        importModule('js/utils/event-bus.js'),
                        importModule('js/utils/security-validation.js'),
                        importModule('js/utils/input-sanitizer.js'),
                        importModule('js/utils/legal-disclaimers.js'),
                        importModule('js/utils/cross-tab-sync.js'),
                        importModule('js/utils/risk-visualization.js'),
                        importModule('js/utils/data-import-export.js'),
                        importModule('js/utils/advanced-visualizations.js'),
                        importModule('js/calculations/framingham-algorithm.js'),
                        importModule('js/calculations/qrisk3-algorithm.js'),
                        importModule('js/calculations/medication-evaluation.js'),
                        importModule('js/utils/error-detection-system.js'),
                        importModule('js/utils/runtime-protection.js'),
                        importModule('js/utils/encryption-service.js')
                    ]).then((modules) => {
                        console.log('All modules loaded successfully');
                        resolve();
                    }).catch((error) => {
                        console.error('Module loading error:', error);
                        
                        // Continue with fallback
                        console.log('Continuing with in-page implementations');
                        resolve();
                    });
                } catch (error) {
                    console.error('Module initialization error:', error);
                    
                    // Continue with fallback
                    console.log('Continuing with in-page implementations');
                    resolve();
                }
            });
        }
        
        // Advanced error handling system
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize error tracking mechanisms
            let errorCorrectionEnabled = true;
            let errorHistory = [];
            const maxErrorHistorySize = 50;
            const criticalErrorTypes = ['ReferenceError', 'TypeError', 'SyntaxError'];
            
            // Setup global error handler
            window.onerror = function(message, source, lineno, colno, error) {
                handleJavaScriptError(message, source, lineno, colno, error);
                return true; // Prevents the default browser error handling
            };
            
            // Handle unhandled promise rejections
            window.onunhandledrejection = function(event) {
                handleJavaScriptError(
                    event.reason ? (event.reason.message || 'Unhandled Promise Rejection') : 'Unhandled Promise Rejection',
                    'promise',
                    0,
                    0,
                    event.reason
                );
            };
            
            // Error handler function
            function handleJavaScriptError(message, source, lineno, colno, error) {
                // Create error object
                const errorObj = {
                    timestamp: new Date(),
                    message: message,
                    source: source,
                    lineno: lineno,
                    colno: colno,
                    stack: error && error.stack ? error.stack : null,
                    type: error ? error.constructor.name : 'Unknown',
                    handled: false,
                    corrected: false,
                    correction: null
                };
                
                // Add to error history
                errorHistory.push(errorObj);
                
                // Limit history size
                if (errorHistory.length > maxErrorHistorySize) {
                    errorHistory.shift();
                }
                
                // Log error
                console.error('Error detected:', errorObj);
                
                // Check if error can be automatically corrected
                if (errorCorrectionEnabled) {
                    const correction = attemptErrorCorrection(errorObj);
                    
                    if (correction) {
                        errorObj.handled = true;
                        errorObj.corrected = true;
                        errorObj.correction = correction;
                        
                        // Show error correction notification
                        showErrorCorrectionNotification(errorObj, correction);
                    } else if (criticalErrorTypes.includes(errorObj.type)) {
                        // Show error correction modal for critical errors
                        showErrorCorrectionModal(errorObj);
                    }
                }
            }
            
            // Attempt to automatically correct common errors
            function attemptErrorCorrection(errorObj) {
                const message = errorObj.message;
                
                // Check for common error patterns
                
                // Undefined variable
                const undefinedVarMatch = message.match(/(\w+) is not defined/);
                if (undefinedVarMatch) {
                    const varName = undefinedVarMatch[1];
                    
                    // Check if it's a DOM element that doesn't exist
                    if (varName.startsWith('document') || varName.startsWith('window')) {
                        return null; // Can't correct this automatically
                    }
                    
                    // Check if it's a function that should be defined
                    if (varName.endsWith('Function') || varName.includes('callback')) {
                        return {
                            type: 'variable',
                            original: varName,
                            correction: `function ${varName}() { console.warn("Placeholder function created by error handler"); }`,
                            explanation: `Created empty placeholder for missing function '${varName}'.`
                        };
                    }
                    
                    return {
                        type: 'variable',
                        original: varName,
                        correction: `var ${varName} = null;`,
                        explanation: `Initialized missing variable '${varName}' as null.`
                    };
                }
                
                // Null or undefined property access
                const nullPropertyMatch = message.match(/Cannot read propert(?:y|ies) '?(\w+)'? of (null|undefined)/);
                if (nullPropertyMatch) {
                    const property = nullPropertyMatch[1];
                    const objectType = nullPropertyMatch[2];
                    
                    return {
                        type: 'nullcheck',
                        original: `obj.${property}`,
                        correction: `(obj && obj.${property})`,
                        explanation: `Added null check for property '${property}' access on ${objectType} object.`
                    };
                }
                
                // No correction found
                return null;
            }
            
            // Show error correction notification
            function showErrorCorrectionNotification(errorObj, correction) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'error-correction-notification';
                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">Error Automatically Corrected</div>
                        <div class="notification-close">&times;</div>
                    </div>
                    <div class="notification-body">
                        ${correction.explanation}
                    </div>
                `;
                
                // Add event listener to close button
                const closeButton = notification.querySelector('.notification-close');
                if (closeButton) {
                    closeButton.addEventListener('click', function() {
                        notification.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 300);
                    });
                }
                
                // Add to body
                document.body.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode === document.body) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
            }
            
            // Show error correction modal
            function showErrorCorrectionModal(errorObj) {
                // Get template
                const template = document.getElementById('error-correction-template');
                
                if (!template) {
                    console.error('Error correction template not found');
                    return;
                }
                
                // Create modal from template
                const modalContainer = document.createElement('div');
                modalContainer.className = 'modal';
                modalContainer.innerHTML = template.innerHTML;
                
                // Update modal content
                const errorType = modalContainer.querySelector('.error-type');
                const errorMessage = modalContainer.querySelector('.error-message');
                const errorLocation = modalContainer.querySelector('.error-location');
                const correctionMessage = modalContainer.querySelector('.correction-message');
                const originalCode = modalContainer.querySelector('.original-code pre');
                const correctedCode = modalContainer.querySelector('.corrected-code pre');
                
                if (errorType) {
                    errorType.textContent = errorObj.type;
                }
                
                if (errorMessage) {
                    errorMessage.textContent = errorObj.message;
                }
                
                if (errorLocation) {
                    errorLocation.textContent = `${errorObj.source} (line ${errorObj.lineno}, col ${errorObj.colno})`;
                }
                
                // No automatic correction available
                if (correctionMessage) {
                    correctionMessage.textContent = 'No automatic correction available. Please review the error details.';
                }
                
                if (originalCode) {
                    originalCode.textContent = 'Original code not available.';
                }
                
                if (correctedCode) {
                    correctedCode.textContent = 'Suggested correction not available.';
                }
                
                // Add event listeners
                const closeButton = modalContainer.querySelector('.modal-close');
                const ignoreButton = modalContainer.querySelector('.error-ignore');
                const applyButton = modalContainer.querySelector('.error-apply');
                
                if (closeButton) {
                    closeButton.addEventListener('click', function() {
                        modalContainer.classList.remove('active');
                        setTimeout(() => {
                            document.body.removeChild(modalContainer);
                        }, 300);
                    });
                }
                
                if (ignoreButton) {
                    ignoreButton.addEventListener('click', function() {
                        modalContainer.classList.remove('active');
                        setTimeout(() => {
                            document.body.removeChild(modalContainer);
                        }, 300);
                    });
                }
                
                if (applyButton) {
                    // Disable apply button since no correction is available
                    applyButton.disabled = true;
                }
                
                // Add modal to body
                document.body.appendChild(modalContainer);
                
                // Show modal
                setTimeout(() => {
                    modalContainer.classList.add('active');
                }, 10);
            }
        });
        
        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load modules first
            initializeModuleLoading().then(() => {
                // Initialize tab navigation
                initializeTabs();
                
                // Initialize form handlers
                initializeFormHandlers();
                
                // Initialize unit converters
                initializeUnitConverters();
                
                // Initialize EMR integration buttons
                initializeIntegrationButtons();
                
                // Initialize form validation
                initializeFormValidation();
                
                // Initialize cross-tab synchronization
                initializeCrossTabSync();
                
                console.log('Application initialization complete.');
            });
        });
    </script>
    
    <!-- Inline CSS for immediate loading - Critical for core functionality -->
    <style>
        /* Organization: CSS is now organized by component type
         * 1. Core Elements & Variables
         * 2. Layout Components 
         * 3. Form Components
         * 4. Interactive Elements
         * 5. Data Visualization
         * 6. Utility Classes
         * 7. Responsive Adjustments
         * 8. Print Styles
         * 9. Accessibility Enhancements
         */
        
        /* Advanced Visualization Styles - Improved with better organization and consistent naming */
        /* Base chart styles shared by all visualization types */
        .chart-container {
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #fff;
            box-shadow: var(--box-shadow);
            transition: box-shadow 0.3s ease;
        }
        
        .chart-container:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        
        /* Specific chart types using the common base */
        .impact-chart,
        .treatment-effect-chart,
        .progression-chart,
        .sensitivity-chart {
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #fff;
        }
        
        .chart-body {
            position: relative;
            height: 300px;
            margin: 2rem 3rem 2rem 3rem;
        }
        
        .chart-y-axis {
            position: absolute;
            left: -2.5rem;
            top: 0;
            bottom: 0;
            width: 2.5rem;
        }
        
        .chart-y-label {
            position: absolute;
            transform: rotate(-90deg);
            top: 50%;
            left: -3rem;
            white-space: nowrap;
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        .chart-y-ticks {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 2.5rem;
        }
        
        .chart-y-tick {
            position: absolute;
            right: 0;
            font-size: 0.75rem;
            color: var(--secondary-color);
            transform: translateY(50%);
        }
        
        .chart-x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -2rem;
            height: 2rem;
        }
        
        .chart-x-label {
            position: absolute;
            bottom: -1rem;
            width: 100%;
            text-align: center;
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        .chart-x-ticks {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            height: 2rem;
        }
        
        .chart-x-tick {
            position: absolute;
            top: 0;
            font-size: 0.75rem;
            color: var(--secondary-color);
            transform: translateX(-50%);
        }
        
        .chart-grid {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .chart-grid-line {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px dashed #eee;
        }
        
        .chart-lines {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .chart-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .chart-point {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transform: translate(-50%, 50%);
            cursor: pointer;
        }
        
        .chart-line.natural {
            border-bottom: 2px solid #ff7f0e;
        }
        
        .chart-line.intervention {
            border-bottom: 2px solid #2ca02c;
        }
        
        .chart-line.frs {
            border-bottom: 2px solid #1f77b4;
        }
        
        .chart-line.qrisk {
            border-bottom: 2px solid #d62728;
        }
        
        .chart-line.natural .chart-point {
            background-color: #ff7f0e;
        }
        
        .chart-line.intervention .chart-point {
            background-color: #2ca02c;
        }
        
        .chart-line.frs .chart-point {
            background-color: #1f77b4;
        }
        
        .chart-line.qrisk .chart-point {
            background-color: #d62728;
        }
        
        .chart-base-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, 50%);
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
        }
        
        .chart-base-marker.frs {
            background-color: #1f77b4;
        }
        
        .chart-base-marker.qrisk {
            background-color: #d62728;
        }
        
        .progression-legend,
        .sensitivity-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-color {
            width: 16px;
            height: 8px;
            border-radius: 4px;
        }
        
        .legend-color.natural {
            background-color: #ff7f0e;
        }
        
        .legend-color.intervention {
            background-color: #2ca02c;
        }
        
        .legend-color.frs {
            background-color: #1f77b4;
        }
        
        .legend-color.qrisk {
            background-color: #d62728;
        }
        
        .legend-label {
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        .progression-summary,
        .sensitivity-summary {
            font-size: 0.875rem;
            color: var(--secondary-color);
            margin-top: 1rem;
        }
        
        /* Impact Bar Chart Styles */
        .impact-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .impact-value {
            width: 80px;
            font-size: 0.875rem;
            text-align: right;
            padding-right: 0.5rem;
        }
        
        .impact-value.base-value {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .impact-bar {
            flex: 1;
            height: 24px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .impact-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
        }
        
        .impact-bar-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        /* Treatment Effect Styles */
        .treatment-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .treatment-label {
            width: 120px;
            font-size: 0.875rem;
            text-align: right;
            padding-right: 0.5rem;
        }
        
        .treatment-bar {
            flex: 1;
            height: 32px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .treatment-bar-fill {
            height: 100%;
        }
        
        .treatment-bar-fill.baseline {
            background-color: #ff7f0e;
        }
        
        .treatment-bar-fill.modified {
            background-color: #2ca02c;
        }
        
        .treatment-bar-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        .effect-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .effect-item {
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .effect-label {
            font-size: 0.875rem;
            color: var(--secondary-color);
            margin-bottom: 0.25rem;
        }
        
        .effect-value {
            font-size: 1.125rem;
            font-weight: bold;
        }
        
        /* LDL Meter Styles */
        .ldl-meter {
            height: 32px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin-bottom: 0.25rem;
        }
        
        .ldl-meter-bar {
            height: 100%;
            background-color: #ff7f0e;
        }
        
        .ldl-meter-target {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background-color: #2ca02c;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
        }
        
        .ldl-meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--secondary-color);
        }
        
        .ldl-meter-title {
            text-align: center;
            font-size: 0.875rem;
            color: var(--secondary-color);
            margin-top: 0.25rem;
        }
        
        /* Comparison Chart Styles */
        .comparison-chart {
            margin-top: 1rem;
        }
        
        .chart-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .chart-label {
            width: 80px;
            font-size: 0.875rem;
            text-align: right;
            padding-right: 0.5rem;
        }
        
        .chart-bar {
            flex: 1;
            height: 32px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .chart-bar-fill {
            height: 100%;
        }
        
        .chart-bar-container:first-child .chart-bar-fill {
            background-color: #1f77b4;
        }
        
        .chart-bar-container:last-child .chart-bar-fill {
            background-color: #d62728;
        }
        
        .chart-bar-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .status-indicator.incomplete {
            background-color: rgba(108, 117, 125, 0.2);
            color: var(--secondary-color);
        }
        
        .status-indicator.complete {
            background-color: rgba(40, 167, 69, 0.2);
            color: #155724;
        }
    </style>
</body>
</html>            // Skip validation for null or undefined values
            if (value === null || value === undefined || value === '') {
                return value;
            }
            
            // Convert column name to lowercase for case-insensitive matching
            const columnLower = column.toLowerCase();
            
            // Validate numeric columns
            if (columnLower.includes('age')) {
                return validateNumericValue(value, 18, 120, autoCorrect);
            } else if (columnLower.includes('sbp') || columnLower.includes('systolic')) {
                return validateNumericValue(value, 70, 250, autoCorrect);
            } else if (columnLower.includes('dbp') || columnLower.includes('diastolic')) {
                return validateNumericValue(value, 40, 150, autoCorrect);
            } else if (columnLower.includes('height')) {
                return validateNumericValue(value, 100, 220, autoCorrect);
            } else if (columnLower.includes('weight')) {
                return validateNumericValue(value, 30, 300, autoCorrect);
            } else if (columnLower.includes('bmi')) {
                return validateNumericValue(value, 15, 60, autoCorrect);
            } else if (columnLower.includes('ldl')) {
                return validateNumericValue(value, 0.5, 15, autoCorrect);
            } else if (columnLower.includes('hdl')) {
                return validateNumericValue(value, 0.4, 5, autoCorrect);
            } else if (columnLower.includes('total') && columnLower.includes('chol')) {
                return validateNumericValue(value, 1, 15, autoCorrect);
            } else if (columnLower.includes('triglycerides') || columnLower.includes('trig')) {
                return validateNumericValue(value, 0.2, 20, autoCorrect);
            } else if (columnLower.includes('lpa') || columnLower.includes('lipoprotein')) {
                return validateNumericValue(value, 0, 500, autoCorrect);
            } else if (columnLower.includes('hba1c')) {
                return validateNumericValue(value, 3, 20, autoCorrect);
            } else if (columnLower.includes('apob')) {
                return validateNumericValue(value, 0.1, 3, autoCorrect);
            }
            
            // Validate boolean columns (yes/no, true/false)
            if (columnLower.includes('smoker') || 
                columnLower.includes('diabetes') || 
                columnLower.includes('hypertension') || 
                columnLower.includes('treated')) {
                return validateBooleanValue(value, autoCorrect);
            }
            
            // No specific validation rules for this column, return as is
            return value;
        }
        
        /**
         * Validate numeric value
         * @param {any} value - Value to validate
         * @param {number} min - Minimum value
         * @param {number} max - Maximum value
         * @param {boolean} autoCorrect - Whether to auto-correct value
         * @returns {number|null} Validated value
         */
        function validateNumericValue(value, min, max, autoCorrect) {
            // Convert to number
            let num = Number(value);
            
            // Check if valid number
            if (isNaN(num)) {
                if (autoCorrect) {
                    return null;
                } else {
                    throw new Error(`Invalid numeric value: ${value}`);
                }
            }
            
            // Check range
            if (num < min || num > max) {
                if (autoCorrect) {
                    // Clamp to range
                    return Math.max(min, Math.min(max, num));
                } else {
                    throw new Error(`Value ${num} is outside the allowed range (${min}-${max})`);
                }
            }
            
            return num;
        }
        
        /**
         * Validate boolean value
         * @param {any} value - Value to validate
         * @param {boolean} autoCorrect - Whether to auto-correct value
         * @returns {boolean|null} Validated value
         */
        function validateBooleanValue(value, autoCorrect) {
            // Handle already boolean values
            if (typeof value === 'boolean') {
                return value;
            }
            
            // Handle string values
            if (typeof value === 'string') {
                const valueLower = value.toLowerCase().trim();
                
                if (['yes', 'true', '1', 'y', 't'].includes(valueLower)) {
                    return true;
                } else if (['no', 'false', '0', 'n', 'f'].includes(valueLower)) {
                    return false;
                }
            }
            
            // Handle numeric values
            if (typeof value === 'number') {
                return value !== 0;
            }
            
            // Invalid boolean value
            if (autoCorrect) {
                return null;
            } else {
                throw new Error(`Invalid boolean value: ${value}`);
            }
        }
        
        /**
         * Show data preview
         * @param {Array} data - Parsed data
         */
        function showDataPreview(data) {
            const previewContent = document.getElementById('data-preview-content');
            if (!previewContent || !data || data.length === 0) return;
            
            // Create table
            const table = document.createElement('table');
            table.className = 'data-preview-table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const columns = Object.keys(data[0]);
            
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            // Show first 10 rows
            const rowsToShow = Math.min(data.length, 10);
            
            for (let i = 0; i < rowsToShow; i++) {
                const row = document.createElement('tr');
                
                columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = data[i][column] !== null ? data[i][column] : '';
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            
            // Add table to preview
            previewContent.innerHTML = '';
            previewContent.appendChild(table);
            
            // Show row count
            const rowCount = document.createElement('p');
            rowCount.className = 'text-right';
            rowCount.textContent = `Showing ${rowsToShow} of ${data.length} records`;
            previewContent.appendChild(rowCount);
        }
        
        /**
         * Export data to selected format
         * @param {string} format - Export format (pdf, json, csv)
         */
        function exportData(format) {
            // Get selected data
            const exportDataSelection = document.getElementById('export-data-selection').value;
            
            let data;
            
            if (exportDataSelection === 'current') {
                // Export current assessment
                if (window.lastFrsResult) {
                    data = {
                        type: 'frs',
                        result: window.lastFrsResult,
                        date: new Date().toISOString()
                    };
                } else if (window.lastQriskResult) {
                    data = {
                        type: 'qrisk',
                        result: window.lastQriskResult,
                        date: new Date().toISOString()
                    };
                } else {
                    alert('No assessment results available to export.');
                    return;
                }
            } else if (exportDataSelection === 'all') {
                // Export all assessments
                data = {
                    frs: window.lastFrsResult,
                    qrisk: window.lastQriskResult,
                    date: new Date().toISOString()
                };
            } else if (exportDataSelection === 'selected') {
                // Export selected fields
                const selectedFields = [];
                const fieldCheckboxes = document.querySelectorAll('.export-field:checked');
                
                fieldCheckboxes.forEach(checkbox => {
                    selectedFields.push(checkbox.id.replace('export-field-', ''));
                });
                
                if (selectedFields.length === 0) {
                    alert('Please select at least one field to export.');
                    return;
                }
                
                // Create data object with selected fields
                data = {
                    date: new Date().toISOString(),
                    fields: {}
                };
                
                selectedFields.forEach(field => {
                    // Extract data based on field
                    switch (field) {
                        case 'patient-info':
                            data.fields.patientInfo = {
                                age: document.getElementById('frs-age')?.value || document.getElementById('qrisk-age')?.value,
                                sex: document.getElementById('frs-sex')?.value || document.getElementById('qrisk-sex')?.value,
                                height: document.getElementById('frs-height')?.value || document.getElementById('qrisk-height')?.value,
                                weight: document.getElementById('frs-weight')?.value || document.getElementById('qrisk-weight')?.value,
                                bmi: document.getElementById('frs-bmi')?.value || document.getElementById('qrisk-bmi')?.value
                            };
                            break;
                            
                        case 'lipids':
                            data.fields.lipids = {
                                totalCholesterol: document.getElementById('frs-total-chol')?.value || document.getElementById('qrisk-total-chol')?.value,
                                hdl: document.getElementById('frs-hdl')?.value || document.getElementById('qrisk-hdl')?.value,
                                ldl: document.getElementById('frs-ldl')?.value,
                                triglycerides: document.getElementById('frs-trig')?.value,
                                apoB: document.getElementById('frs-apob')?.value,
                                lpa: document.getElementById('frs-lpa')?.value || document.getElementById('qrisk-lpa')?.value
                            };
                            break;
                            
                        case 'bp':
                            data.fields.bloodPressure = {
                                systolic: document.getElementById('frs-sbp')?.value || document.getElementById('qrisk-sbp')?.value,
                                diastolic: document.getElementById('med-dbp')?.value,
                                treated: document.getElementById('frs-bp-treatment')?.value === 'yes' || document.getElementById('qrisk-bp-treatment')?.value === 'true'
                            };
                            break;
                            
                        case 'conditions':
                            data.fields.conditions = [];
                            
                            // Check medical conditions
                            const selectedConditions = document.getElementById('frs-medical-conditions')?.selectedOptions;
                            if (selectedConditions) {
                                for (let i = 0; i < selectedConditions.length; i++) {
                                    data.fields.conditions.push(selectedConditions[i].value);
                                }
                            }
                            
                            // Check QRISK conditions
                            const qriskConditions = [
                                { id: 'qrisk-family-history', name: 'Family History of CVD' },
                                { id: 'qrisk-chronic-kidney-disease', name: 'Chronic Kidney Disease' },
                                { id: 'qrisk-atrial-fibrillation', name: 'Atrial Fibrillation' },
                                { id: 'qrisk-migraine', name: 'Migraine' },
                                { id: 'qrisk-rheumatoid-arthritis', name: 'Rheumatoid Arthritis' },
                                { id: 'qrisk-sle', name: 'Systemic Lupus Erythematosus' },
                                { id: 'qrisk-severe-mental-illness', name: 'Severe Mental Illness' },
                                { id: 'qrisk-atypical-antipsychotics', name: 'On Atypical Antipsychotics' },
                                { id: 'qrisk-regular-steroids', name: 'On Regular Steroid Tablets' },
                                { id: 'qrisk-erectile-dysfunction', name: 'Erectile Dysfunction' }
                            ];
                            
                            qriskConditions.forEach(condition => {
                                const element = document.getElementById(condition.id);
                                if (element && element.checked) {
                                    data.fields.conditions.push(condition.name);
                                }
                            });
                            break;
                            
                        case 'results':
                            data.fields.results = {
                                frs: window.lastFrsResult ? {
                                    risk: window.lastFrsResult.risk,
                                    category: window.lastFrsResult.riskCategory
                                } : null,
                                qrisk: window.lastQriskResult ? {
                                    risk: window.lastQriskResult.risk,
                                    category: window.lastQriskResult.riskCategory
                                } : null
                            };
                            break;
                            
                        case 'medications':
                            data.fields.medications = {
                                lipid: [],
                                bp: []
                            };
                            
                            // Get lipid medications
                            for (let i = 1; i <= 3; i++) {
                                const name = document.getElementById(`med-lipid-name-${i}`)?.value;
                                const dose = document.getElementById(`med-lipid-dose-${i}`)?.value;
                                const duration = document.getElementById(`med-lipid-duration-${i}`)?.value;
                                
                                if (name) {
                                    data.fields.medications.lipid.push({
                                        name: name,
                                        dose: dose,
                                        duration: duration
                                    });
                                }
                            }
                            
                            // Get BP medications
                            for (let i = 1; i <= 4; i++) {
                                const name = document.getElementById(`med-htn-name-${i}`)?.value;
                                const dose = document.getElementById(`med-htn-dose-${i}`)?.value;
                                const duration = document.getElementById(`med-htn-duration-${i}`)?.value;
                                
                                if (name) {
                                    data.fields.medications.bp.push({
                                        name: name,
                                        dose: dose,
                                        duration: duration
                                    });
                                }
                            }
                            break;
                            
                        case 'recommendations':
                            data.fields.recommendations = {
                                frs: window.lastFrsResult ? {
                                    primary: document.querySelector('.treatment-primary')?.textContent,
                                    secondary: Array.from(document.querySelectorAll('.treatment-secondary li')).map(li => li.textContent)
                                } : null,
                                qrisk: window.lastQriskResult ? {
                                    primary: document.querySelector('.treatment-primary')?.textContent,
                                    secondary: Array.from(document.querySelectorAll('.treatment-secondary li')).map(li => li.textContent)
                                } : null,
                                medication: document.querySelector('.changes-primary')?.textContent
                            };
                            break;
                    }
                });
            }
            
            // Check for encryption
            const encryptData = document.getElementById('encrypt-exported-data')?.checked;
            
            if (encryptData) {
                const password = document.getElementById('export-encryption-password')?.value;
                
                if (!password) {
                    alert('Please enter an encryption password.');
                    return;
                }
                
                // Encrypt data
                if (window.encryptionService) {
                    data = window.encryptionService.encrypt(data, password);
                } else {
                    alert('Encryption service not available.');
                    return;
                }
            }
            
            // Export based on format
            switch (format) {
                case 'pdf':
                    exportAsPDF(data, encryptData);
                    break;
                    
                case 'json':
                    exportAsJSON(data, encryptData);
                    break;
                    
                case 'csv':
                    exportAsCSV(data, encryptData);
                    break;
                    
                case 'emr':
                    exportToEMR(data);
                    break;
            }
        }
        
        /**
         * Export data as PDF
         * @param {Object} data - Data to export
         * @param {boolean} encrypted - Whether data is encrypted
         */
        function exportAsPDF(data, encrypted) {
            alert('PDF export function would generate a PDF file here. This is a placeholder for actual PDF generation functionality.');
            
            // In a real implementation, you would use a library like jsPDF to generate a PDF
            /*
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('CVD Risk Assessment Report', 20, 20);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
            
            // Add content based on data type
            if (!encrypted) {
                // Export unencrypted data
                if (data.type === 'frs') {
                    // Add FRS results
                    doc.setFontSize(16);
                    doc.text('Framingham Risk Score Assessment', 20, 40);
                    
                    doc.setFontSize(12);
                    doc.text(`10-Year CVD Risk: ${data.result.risk}%`, 20, 50);
                    doc.text(`Risk Category: ${data.result.categoryDescription}`, 20, 60);
                    
                    // Add recommendations
                    doc.setFontSize(14);
                    doc.text('Recommendations:', 20, 80);
                    
                    // Add more content...
                } else if (data.type === 'qrisk') {
                    // Add QRISK3 results
                }
            } else {
                // Export encrypted data with warning
                doc.setFontSize(14);
                doc.text('This report contains encrypted data.', 20, 40);
                doc.text('Use the import function with the correct password to access the data.', 20, 50);
                
                // Add encrypted data as JSON
                doc.setFontSize(10);
                doc.text('Encrypted data:', 20, 70);
                doc.text(JSON.stringify(data), 20, 80);
            }
            
            // Save PDF
            doc.save('cvd-risk-assessment.pdf');
            */
        }
        
        /**
         * Export data as JSON
         * @param {Object} data - Data to export
         * @param {boolean} encrypted - Whether data is encrypted
         */
        function exportAsJSON(data, encrypted) {
            // Create file content
            const jsonString = JSON.stringify(data, null, 2);
            
            // Create blob
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = encrypted ? 'cvd-assessment-encrypted.json' : 'cvd-assessment.json';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            URL.revokeObjectURL(url);
        }
        
        /**
         * Export data as CSV
         * @param {Object} data - Data to export
         * @param {boolean} encrypted - Whether data is encrypted
         */
        function exportAsCSV(data, encrypted) {
            // Cannot export encrypted data as CSV
            if (encrypted) {
                alert('Cannot export encrypted data as CSV. Please choose JSON format for encrypted data.');
                return;
            }
            
            // Create CSV content
            let csvContent = '';
            
            // Handle different data structures
            if (data.type === 'frs' || data.type === 'qrisk') {
                // Export single assessment
                csvContent = exportSingleAssessmentCSV(data);
            } else if (data.frs || data.qrisk) {
                // Export all assessments
                csvContent = exportAllAssessmentsCSV(data);
            } else if (data.fields) {
                // Export selected fields
                csvContent = exportSelectedFieldsCSV(data);
            }
            
            // Create blob
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'cvd-assessment.csv';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            URL.revokeObjectURL(url);
        }
        
        /**
         * Export single assessment as CSV
         * @param {Object} data - Assessment data
         * @returns {string} CSV content
         */
        function exportSingleAssessmentCSV(data) {
            // Create header
            const header = ['Parameter', 'Value'];
            
            // Create rows
            let rows = [];
            
            // Add metadata
            rows.push(['Assessment Type', data.type.toUpperCase()]);
            rows.push(['Date', new Date(data.date).toLocaleString()]);
            rows.push(['10-Year CVD Risk', data.result.risk + '%']);
            rows.push(['Risk Category', data.result.categoryDescription]);
            
            // Add inputs if available
            if (data.result.inputs) {
                rows.push(['', '']); // Empty row
                rows.push(['Input Parameters', '']);
                
                for (const key in data.result.inputs) {
                    rows.push([key, data.result.inputs[key]]);
                }
            }
            
            // Convert to CSV
            return [
                header.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
        }
        
        /**
         * Export all assessments as CSV
         * @param {Object} data - Assessment data
         * @returns {string} CSV content
         */
        function exportAllAssessmentsCSV(data) {
            // Create header
            const header = ['Parameter', 'FRS Value', 'QRISK3 Value'];
            
            // Create rows
            let rows = [];
            
            // Add date
            rows.push(['Date', new Date(data.date).toLocaleString(), new Date(data.date).toLocaleString()]);
            
            // Add risk values
            rows.push(['10-Year CVD Risk', data.frs ? data.frs.risk + '%' : 'N/A', data.qrisk ? data.qrisk.risk + '%' : 'N/A']);
            rows.push(['Risk Category', data.frs ? data.frs.categoryDescription : 'N/A', data.qrisk ? data.qrisk.categoryDescription : 'N/A']);
            
            // Convert to CSV
            return [
                header.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
        }
        
        /**
         * Export selected fields as CSV
         * @param {Object} data - Selected fields data
         * @returns {string} CSV content
         */
        function exportSelectedFieldsCSV(data) {
            // Create rows
            let rows = [];
            
            // Add date
            rows.push(['Date', new Date(data.date).toLocaleString()]);
            
            // Add fields
            for (const field in data.fields) {
                rows.push(['', '']); // Empty row
                
                switch (field) {
                    case 'patientInfo':
                        rows.push(['Patient Information', '']);
                        for (const key in data.fields.patientInfo) {
                            if (data.fields.patientInfo[key]) {
                                rows.push([key, data.fields.patientInfo[key]]);
                            }
                        }
                        break;
                        
                    case 'lipids':
                        rows.push(['Lipid Parameters', '']);
                        for (const key in data.fields.lipids) {
                            if (data.fields.lipids[key]) {
                                rows.push([key, data.fields.lipids[key]]);
                            }
                        }
                        break;
                        
                    case 'bloodPressure':
                        rows.push(['Blood Pressure', '']);
                        for (const key in data.fields.bloodPressure) {
                            if (data.fields.bloodPressure[key] !== undefined) {
                                rows.push([key, data.fields.bloodPressure[key]]);
                            }
                        }
                        break;
                        
                    case 'conditions':
                        rows.push(['Medical Conditions', '']);
                        data.fields.conditions.forEach(condition => {
                            rows.push(['condition', condition]);
                        });
                        break;
                        
                    case 'results':
                        rows.push(['Risk Assessment Results', '']);
                        if (data.fields.results.frs) {
                            rows.push(['FRS Risk', data.fields.results.frs.risk + '%']);
                            rows.push(['FRS Category', data.fields.results.frs.category]);
                        }
                        if (data.fields.results.qrisk) {
                            rows.push(['QRISK3 Risk', data.fields.results.qrisk.risk + '%']);
                            rows.push(['QRISK3 Category', data.fields.results.qrisk.category]);
                        }
                        break;
                        
                    case 'medications':
                        rows.push(['Medications', '']);
                        
                        if (data.fields.medications.lipid.length > 0) {
                            rows.push(['Lipid Medications', '']);
                            data.fields.medications.lipid.forEach(med => {
                                rows.push([med.name, `${med.dose} (${med.duration} months)`]);
                            });
                        }
                        
                        if (data.fields.medications.bp.length > 0) {
                            rows.push(['Blood Pressure Medications', '']);
                            data.fields.medications.bp.forEach(med => {
                                rows.push([med.name, `${med.dose} (${med.duration} months)`]);
                            });
                        }
                        break;
                        
                    case 'recommendations':
                        rows.push(['Recommendations', '']);
                        
                        if (data.fields.recommendations.frs) {
                            rows.push(['FRS Primary Recommendation', data.fields.recommendations.frs.primary]);
                            data.fields.recommendations.frs.secondary.forEach((rec, index) => {
                                rows.push([`FRS Secondary Recommendation ${index + 1}`, rec]);
                            });
                        }
                        
                        if (data.fields.recommendations.qrisk) {
                            rows.push(['QRISK3 Primary Recommendation', data.fields.recommendations.qrisk.primary]);
                            data.fields.recommendations.qrisk.secondary.forEach((rec, index) => {
                                rows.push([`QRISK3 Secondary Recommendation ${index + 1}`, rec]);
                            });
                        }
                        
                        if (data.fields.recommendations.medication) {
                            rows.push(['Medication Recommendation', data.fields.recommendations.medication]);
                        }
                        break;
                }
            }
            
            // Convert to CSV
            return rows.map(row => row.join(',')).join('\n');
        }
        
        /**
         * Export results as PDF
         * @param {string} calculatorType - Calculator type (frs, qrisk, medication, comparison)
         */
        function exportResultsAsPDF(calculatorType) {
            alert(`PDF export for ${calculatorType} would be implemented here. This is a placeholder for actual PDF generation functionality.`);
            
            // In a real implementation, you would use a library like jsPDF to generate a PDF
            /*
            const doc = new jsPDF();
            
            // Get result container
            let resultsContainer;
            
            switch (calculatorType) {
                case 'frs':
                    resultsContainer = document.getElementById('frs-results-container');
                    break;
                    
                case 'qrisk':
                    resultsContainer = document.getElementById('qrisk-results-container');
                    break;
                    
                case 'medication':
                    resultsContainer = document.getElementById('medication-results-container');
                    break;
                    
                case 'comparison':
                    resultsContainer = document.getElementById('comparison-results-container');
                    break;
            }
            
            // Add content to PDF
            if (resultsContainer) {
                // Add title
                doc.setFontSize(18);
                doc.text('CVD Risk Assessment Report', 20, 20);
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
                
                // Add content based on calculator type
                // ...
            }
            
            // Save PDF
            doc.save('cvd-risk-assessment.pdf');
            */
        }
        
        /**
         * Export data to EMR
         * @param {Object} data - Data to export
         */
        function exportToEMR(data) {
            // Check if EMR integration is configured
            const emrSettings = window.encryptionService.secureRetrieve('emr_integration');
            
            if (!emrSettings) {
                alert('EMR integration is not configured. Please set up EMR integration first.');
                showIntegrationModal('emr');
                return;
            }
            
            // Show progress
            alert('EMR export function would send data to the EMR system here. This is a placeholder for actual EMR integration functionality.');
            
            // In a real implementation, you would send data to the EMR system using API calls
            /*
            // Prepare data for export
            const exportData = {
                patientId: '12345', // This would come from the EMR integration settings
                assessmentType: data.type || 'multiple',
                results: {
                    frs: data.frs || (data.type === 'frs' ? data.result : null),
                    qrisk: data.qrisk || (data.type === 'qrisk' ? data.result : null)
                },
                date: new Date().toISOString()
            };
            
            // Send data to EMR
            fetch(emrSettings.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + emrSettings.auth.token // Or other auth method
                },
                body: JSON.stringify(exportData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to export to EMR: ' + response.status);
            })
            .then(data => {
                alert('Successfully exported to EMR.');
            })
            .catch(error => {
                alert('Failed to export to EMR: ' + error.message);
            });
            */
        }
        
        /**
         * Calculate risk factor impact
         */
        function calculateRiskFactorImpact() {
            // Get parameters
            const factor = document.getElementById('impact-factor').value;
            const range = document.getElementById('impact-range').value;
            
            // Get base risk parameters from last calculation
            let baseParams = null;
            let calculator = null;
            
            if (window.lastFrsResult) {
                baseParams = window.lastFrsResult.inputs;
                calculator = 'frs';
            } else if (window.lastQriskResult) {
                baseParams = window.lastQriskResult.inputs;
                calculator = 'qrisk';
            } else {
                alert('Please calculate a risk score first.');
                return;
            }
            
            // Show loading
            const visualizationContainer = document.getElementById('risk-factor-impact-visualization');
            if (visualizationContainer) {
                visualizationContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Calculating...</p></div>';
            }
            
            // Create range of values for the selected factor
            const values = [];
            const risks = [];
            
            try {
                // Define factor ranges based on factor type
                let minValue, maxValue, step, baseValue;
                
                switch (factor) {
                    case 'sbp':
                        minValue = 90;
                        maxValue = 200;
                        step = 10;
                        baseValue = baseParams.sbp;
                        break;
                        
                    case 'cholesterol':
                        minValue = 3;
                        maxValue = 8;
                        step = 0.5;
                        baseValue = calculator === 'frs' ? baseParams.cholesterol : baseParams.cholHDLRatio;
                        break;
                        
                    case 'hdl':
                        minValue = 0.5;
                        maxValue = 3;
                        step = 0.2;
                        baseValue = baseParams.hdl;
                        break;
                        
                    case 'smoking':
                        // Special case for smoking
                        values.push('Non-smoker');
                        values.push('Ex-smoker');
                        values.push('Light smoker');
                        values.push('Moderate smoker');
                        values.push('Heavy smoker');
                        
                        // Calculate risk for each smoking status
                        const smokingStatuses = calculator === 'frs' ? 
                            [false, false, true, true, true] : // FRS only has yes/no
                            ['non', 'ex', 'light', 'moderate', 'heavy']; // QRISK3 has more options
                        
                        for (let i = 0; i < smokingStatuses.length; i++) {
                            const params = { ...baseParams };
                            
                            if (calculator === 'frs') {
                                params.smoking = smokingStatuses[i];
                            } else {
                                params.smoking = smokingStatuses[i];
                            }
                            
                            const result = calculator === 'frs' ? 
                                window.framinghamCalculator.calculateRisk(params) : 
                                window.qrisk3Calculator.calculateRisk(params);
                            
                            if (result.success) {
                                risks.push(result.risk);
                            } else {
                                risks.push(null);
                            }
                        }
                        
                        // Create visualization
                        createRiskFactorImpactVisualization(values, risks, 'Smoking Status');
                        return;
                        
                    case 'diabetes':
                        // Special case for diabetes
                        if (calculator === 'frs') {
                            values.push('No diabetes');
                            values.push('Diabetes');
                            
                            // Calculate risk for each diabetes status
                            for (let i = 0; i < 2; i++) {
                                const params = { ...baseParams };
                                params.diabetes = i === 1;
                                
                                const result = window.framinghamCalculator.calculateRisk(params);
                                
                                if (result.success) {
                                    risks.push(result.risk);
                                } else {
                                    risks.push(null);
                                }
                            }
                        } else {
                            values.push('No diabetes');
                            values.push('Type 1 diabetes');
                            values.push('Type 2 diabetes');
                            
                            // Calculate risk for each diabetes status
                            const diabetesStatuses = ['none', 'type1', 'type2'];
                            
                            for (let i = 0; i < diabetesStatuses.length; i++) {
                                const params = { ...baseParams };
                                params.diabetes = diabetesStatuses[i];
                                
                                const result = window.qrisk3Calculator.calculateRisk(params);
                                
                                if (result.success) {
                                    risks.push(result.risk);
                                } else {
                                    risks.push(null);
                                }
                            }
                        }
                        
                        // Create visualization
                        createRiskFactorImpactVisualization(values, risks, 'Diabetes Status');
                        return;
                        
                    case 'age':
                        minValue = calculator === 'frs' ? 30 : 25;
                        maxValue = calculator === 'frs' ? 79 : 84;
                        step = 5;
                        baseValue = baseParams.age;
                        break;
                        
                    case 'lpa':
                        if (!baseParams.lpaModifier) {
                            alert('Lipoprotein(a) data not available.');
                            return;
                        }
                        
                        values.push('Normal (< 30 mg/dL)');
                        values.push('Borderline (30-50 mg/dL)');
                        values.push('High (50-100 mg/dL)');
                        values.push('Very High (> 100 mg/dL)');
                        
                        // Calculate risk for each Lp(a) level
                        const lpaModifiers = ['low', 'moderate', 'high', 'very-high'];
                        
                        for (let i = 0; i < lpaModifiers.length; i++) {
                            const params = { ...baseParams };
                            params.lpaModifier = lpaModifiers[i];
                            
                            const result = calculator === 'frs' ? 
                                window.framinghamCalculator.calculateRisk(params) : 
                                window.qrisk3Calculator.calculateRisk(params);
                            
                            if (result.success) {
                                risks.push(result.risk);
                            } else {
                                risks.push(null);
                            }
                        }
                        
                        // Create visualization
                        createRiskFactorImpactVisualization(values, risks, 'Lipoprotein(a) Level');
                        return;
                }
                
                // Create range of values
                for (let value = minValue; value <= maxValue; value += step) {
                    values.push(value);
                    
                    // Calculate risk for this value
                    const params = { ...baseParams };
                    
                    // Set factor value
                    switch (factor) {
                        case 'sbp':
                            params.sbp = value;
                            break;
                            
                        case 'cholesterol':
                            if (calculator === 'frs') {
                                params.cholesterol = value;
                            } else {
                                params.cholHDLRatio = value;
                            }
                            break;
                            
                        case 'hdl':
                            params.hdl = value;
                            break;
                            
                        case 'age':
                            params.age = value;
                            break;
                    }
                    
                    // Calculate risk
                    const result = calculator === 'frs' ? 
                        window.framinghamCalculator.calculateRisk(params) : 
                        window.qrisk3Calculator.calculateRisk(params);
                    
                    if (result.success) {
                        risks.push(result.risk);
                    } else {
                        risks.push(null);
                    }
                }
                
                // Create visualization
                let factorLabel = '';
                
                switch (factor) {
                    case 'sbp':
                        factorLabel = 'Systolic Blood Pressure (mmHg)';
                        break;
                        
                    case 'cholesterol':
                        factorLabel = calculator === 'frs' ? 'Total Cholesterol (mmol/L)' : 'Total Cholesterol:HDL Ratio';
                        break;
                        
                    case 'hdl':
                        factorLabel = 'HDL Cholesterol (mmol/L)';
                        break;
                        
                    case 'age':
                        factorLabel = 'Age (years)';
                        break;
                }
                
                createRiskFactorImpactVisualization(values, risks, factorLabel, baseValue);
            } catch (error) {
                console.error('Risk factor impact calculation error:', error);
                
                // Show error
                if (visualizationContainer) {
                    visualizationContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Calculation Error</h4>
                            <p>An unexpected error occurred while calculating risk factor impact.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Create risk factor impact visualization
         * @param {Array} values - Factor values
         * @param {Array} risks - Calculated risks
         * @param {string} factorLabel - Factor label
         * @param {number} [baseValue] - Base value
         */
        function createRiskFactorImpactVisualization(values, risks, factorLabel, baseValue) {
            const visualizationContainer = document.getElementById('risk-factor-impact-visualization');
            if (!visualizationContainer) return;
            
            // Create HTML for visualization
            let html = `
                <div class="impact-chart">
                    <h4>Impact of ${factorLabel} on CVD Risk</h4>
                    <div class="chart-body">
            `;
            
            // Find maximum risk for scaling
            const maxRisk = Math.max(...risks.filter(r => r !== null));
            
            // Create bars for each value
            for (let i = 0; i < values.length; i++) {
                const value = values[i];
                const risk = risks[i];
                
                if (risk === null) continue;
                
                const barWidth = Math.min(100, (risk / maxRisk) * 100);
                
                // Determine if this is the base value
                const isBaseValue = baseValue !== undefined && value === baseValue;
                
                html += `
                    <div class="impact-bar-container">
                        <div class="impact-value ${isBaseValue ? 'base-value' : ''}">${value}</div>
                        <div class="impact-bar">
                            <div class="impact-bar-fill" style="width: ${barWidth}%;"></div>
                            <span class="impact-bar-value">${risk.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
                <div class="impact-summary">
                    <p>This chart shows how the 10-year CVD risk varies based on changes to ${factorLabel.toLowerCase()}.</p>
                    <p>Individuals with higher risk may consider lifestyle modifications or medical interventions to address modifiable risk factors.</p>
                </div>
            `;
            
            // Update visualization container
            visualizationContainer.innerHTML = html;
        }
        
        /**
         * Calculate treatment effect
         */
        function calculateTreatmentEffect() {
            // Get parameters
            const treatmentType = document.getElementById('treatment-type').value;
            const intensity = document.getElementById('treatment-intensity').value;
            
            // Get base risk parameters from last calculation
            let baseParams = null;
            let calculator = null;
            
            if (window.lastFrsResult) {
                baseParams = window.lastFrsResult.inputs;
                calculator = 'frs';
            } else if (window.lastQriskResult) {
                baseParams = window.lastQriskResult.inputs;
                calculator = 'qrisk';
            } else {
                alert('Please calculate a risk score first.');
                return;
            }
            
            // Show loading
            const visualizationContainer = document.getElementById('treatment-comparison-visualization');
            if (visualizationContainer) {
                visualizationContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Calculating...</p></div>';
            }
            
            try {
                // Calculate base risk
                const baseRisk = calculator === 'frs' ? 
                    window.lastFrsResult.risk : 
                    window.lastQriskResult.risk;
                
                // Calculate modified risk based on treatment
                let modifiedParams = { ...baseParams };
                let ldlReduction = 0;
                let sbpReduction = 0;
                
                switch (treatmentType) {
                    case 'statins':
                        // Apply statin effect on lipids
                        if (intensity === 'low') {
                            ldlReduction = 20; // 20% reduction
                        } else if (intensity === 'moderate') {
                            ldlReduction = 30; // 30% reduction
                        } else if (intensity === 'high') {
                            ldlReduction = 50; // 50% reduction
                        }
                        
                        // Modify parameters
                        if (calculator === 'frs') {
                            modifiedParams.cholesterol = baseParams.cholesterol * (1 - (ldlReduction / 100));
                        } else {
                            // For QRISK3, modify cholesterol:HDL ratio
                            const hdl = baseParams.hdl;
                            const totalChol = baseParams.cholHDLRatio * hdl;
                            const ldl = totalChol - hdl;
                            const newLdl = ldl * (1 - (ldlReduction / 100));
                            const newTotalChol = newLdl + hdl;
                            modifiedParams.cholHDLRatio = newTotalChol / hdl;
                        }
                        break;
                        
                    case 'ezetimibe':
                        // Ezetimibe typically reduces LDL by ~18%
                        ldlReduction = 18;
                        
                        // Modify parameters
                        if (calculator === 'frs') {
                            modifiedParams.cholesterol = baseParams.cholesterol * (1 - (ldlReduction / 100));
                        } else {
                            // For QRISK3, modify cholesterol:HDL ratio
                            const hdl = baseParams.hdl;
                            const totalChol = baseParams.cholHDLRatio * hdl;
                            const ldl = totalChol - hdl;
                            const newLdl = ldl * (1 - (ldlReduction / 100));
                            const newTotalChol = newLdl + hdl;
                            modifiedParams.cholHDLRatio = newTotalChol / hdl;
                        }
                        break;
                        
                    case 'pcsk9':
                        // PCSK9 inhibitors typically reduce LDL by ~60%
                        ldlReduction = 60;
                        
                        // Modify parameters
                        if (calculator === 'frs') {
                            modifiedParams.cholesterol = baseParams.cholesterol * (1 - (ldlReduction / 100));
                        } else {
                            // For QRISK3, modify cholesterol:HDL ratio
                            const hdl = baseParams.hdl;
                            const totalChol = baseParams.cholHDLRatio * hdl;
                            const ldl = totalChol - hdl;
                            const newLdl = ldl * (1 - (ldlReduction / 100));
                            const newTotalChol = newLdl + hdl;
                            modifiedParams.cholHDLRatio = newTotalChol / hdl;
                        }
                        break;
                        
                    case 'combined':
                        // Combined therapy (statin + ezetimibe or PCSK9)
                        let statinReduction = 0;
                        let additionalReduction = 0;
                        
                        if (intensity === 'low') {
                            statinReduction = 20; // 20% reduction
                            additionalReduction = 18; // Ezetimibe
                        } else if (intensity === 'moderate') {
                            statinReduction = 30; // 30% reduction
                            additionalReduction = 18; // Ezetimibe
                        } else if (intensity === 'high') {
                            statinReduction = 50; // 50% reduction
                            additionalReduction = 60; // PCSK9 inhibitor
                        }
                        
                        // Calculate combined effect (not additive, but sequential)
                        const remainingAfterStatin = 1 - (statinReduction / 100);
                        const remainingAfterAdditional = 1 - (additionalReduction / 100);
                        ldlReduction = (1 - (remainingAfterStatin * remainingAfterAdditional)) * 100;
                        
                        // Modify parameters
                        if (calculator === 'frs') {
                            modifiedParams.cholesterol = baseParams.cholesterol * (1 - (ldlReduction / 100));
                        } else {
                            // For QRISK3, modify cholesterol:HDL ratio
                            const hdl = baseParams.hdl;
                            const totalChol = baseParams.cholHDLRatio * hdl;
                            const ldl = totalChol - hdl;
                            const newLdl = ldl * (1 - (ldlReduction / 100));
                            const newTotalChol = newLdl + hdl;
                            modifiedParams.cholHDLRatio = newTotalChol / hdl;
                        }
                        break;
                }
                
                // Calculate modified risk
                const modifiedResult = calculator === 'frs' ? 
                    window.framinghamCalculator.calculateRisk(modifiedParams) : 
                    window.qrisk3Calculator.calculateRisk(modifiedParams);
                
                if (modifiedResult.success) {
                    // Create visualization
                    createTreatmentEffectVisualization(
                        baseRisk, 
                        modifiedResult.risk, 
                        getTreatmentTypeLabel(treatmentType, intensity),
                        ldlReduction,
                        sbpReduction
                    );
                } else {
                    throw new Error('Failed to calculate modified risk.');
                }
            } catch (error) {
                console.error('Treatment effect calculation error:', error);
                
                // Show error
                if (visualizationContainer) {
                    visualizationContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Calculation Error</h4>
                            <p>An unexpected error occurred while calculating treatment effect.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Get treatment type label
         * @param {string} treatmentType - Treatment type
         * @param {string} intensity - Treatment intensity
         * @returns {string} Treatment type label
         */
        function getTreatmentTypeLabel(treatmentType, intensity) {
            switch (treatmentType) {
                case 'statins':
                    return `${intensity.charAt(0).toUpperCase() + intensity.slice(1)}-intensity statin therapy`;
                    
                case 'ezetimibe':
                    return 'Ezetimibe therapy';
                    
                case 'pcsk9':
                    return 'PCSK9 inhibitor therapy';
                    
                case 'combined':
                    if (intensity === 'high') {
                        return 'High-intensity statin + PCSK9 inhibitor';
                    } else {
                        return `${intensity.charAt(0).toUpperCase() + intensity.slice(1)}-intensity statin + ezetimibe`;
                    }
                    
                default:
                    return 'Unknown treatment';
            }
        }
        
        /**
         * Create treatment effect visualization
         * @param {number} baseRisk - Base risk
         * @param {number} modifiedRisk - Modified risk
         * @param {string} treatmentLabel - Treatment label
         * @param {number} ldlReduction - LDL reduction percentage
         * @param {number} sbpReduction - SBP reduction
         */
        function createTreatmentEffectVisualization(baseRisk, modifiedRisk, treatmentLabel, ldlReduction, sbpReduction) {
            const visualizationContainer = document.getElementById('treatment-comparison-visualization');
            if (!visualizationContainer) return;
            
            // Calculate absolute and relative risk reduction
            const absoluteReduction = baseRisk - modifiedRisk;
            const relativeReduction = (absoluteReduction / baseRisk) * 100;
            
            // Calculate NNT (Number Needed to Treat) - simplified
            const nnt = Math.round(100 / absoluteReduction);
            
            // Create HTML for visualization
            const html = `
                <div class="treatment-effect-chart">
                    <h4>Impact of ${treatmentLabel} on CVD Risk</h4>
                    <div class="chart-body">
                        <div class="treatment-bar-container">
                            <div class="treatment-label">Baseline Risk</div>
                            <div class="treatment-bar">
                                <div class="treatment-bar-fill baseline" style="width: ${Math.min(100, baseRisk * 2)}%;"></div>
                                <span class="treatment-bar-value">${baseRisk.toFixed(1)}%</span>
                            </div>
                        </div>
                        <div class="treatment-bar-container">
                            <div class="treatment-label">With Treatment</div>
                            <div class="treatment-bar">
                                <div class="treatment-bar-fill modified" style="width: ${Math.min(100, modifiedRisk * 2)}%;"></div>
                                <span class="treatment-bar-value">${modifiedRisk.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="treatment-effect-summary">
                    <h4>Summary of Treatment Effect</h4>
                    <div class="effect-details">
                        <div class="effect-item">
                            <div class="effect-label">Absolute Risk Reduction:</div>
                            <div class="effect-value">${absoluteReduction.toFixed(1)}%</div>
                        </div>
                        <div class="effect-item">
                            <div class="effect-label">Relative Risk Reduction:</div>
                            <div class="effect-value">${relativeReduction.toFixed(1)}%</div>
                        </div>
                        <div class="effect-item">
                            <div class="effect-label">Number Needed to Treat (NNT):</div>
                            <div class="effect-value">${nnt}</div>
                        </div>
                        ${ldlReduction > 0 ? `
                        <div class="effect-item">
                            <div class="effect-label">Expected LDL-C Reduction:</div>
                            <div class="effect-value">${ldlReduction.toFixed(0)}%</div>
                        </div>
                        ` : ''}
                        ${sbpReduction > 0 ? `
                        <div class="effect-item">
                            <div class="effect-label">Expected SBP Reduction:</div>
                            <div class="effect-value">${sbpReduction.toFixed(0)} mmHg</div>
                        </div>
                        ` : ''}
                    </div>
                    <p>The Number Needed to Treat (NNT) represents the number of patients who need to be treated with ${treatmentLabel.toLowerCase()} for 5 years to prevent one cardiovascular event.</p>
                </div>
            `;
            
            // Update visualization container
            visualizationContainer.innerHTML = html;
        }
        
        /**
         * Calculate risk progression over time
         */
        function calculateRiskProgression() {
            // Get parameters
            const years = document.getElementById('progression-years').value;
            const interventionAge = parseInt(document.getElementById('intervention-age').value) || null;
            
            // Get base risk parameters from last calculation
            let baseParams = null;
            let calculator = null;
            
            if (window.lastFrsResult) {
                baseParams = window.lastFrsResult.inputs;
                calculator = 'frs';
            } else if (window.lastQriskResult) {
                baseParams = window.lastQriskResult.inputs;
                calculator = 'qrisk';
            } else {
                alert('Please calculate a risk score first.');
                return;
            }
            
            // Show loading
            const visualizationContainer = document.getElementById('risk-progression-visualization');
            if (visualizationContainer) {
                visualizationContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Calculating...</p></div>';
            }
            
            try {
                const currentAge = baseParams.age;
                const maxAge = calculator === 'frs' ? 79 : 84; // Maximum age for each calculator
                
                // Determine number of years to project
                let projectionYears;
                if (years === 'lifetime') {
                    projectionYears = maxAge - currentAge;
                } else {
                    projectionYears = parseInt(years);
                }
                
                if (projectionYears <= 0) {
                    throw new Error('Cannot project risk: Current age exceeds maximum age for risk calculator.');
                }
                
                // Calculate projected risks for each year
                const timePoints = [];
                const naturalRisks = [];
                const interventionRisks = [];
                
                for (let year = 0; year <= projectionYears; year++) {
                    const age = currentAge + year;
                    
                    if (age > maxAge) break;
                    
                    timePoints.push(age);
                    
                    // Calculate natural progression (no intervention)
                    const naturalParams = { ...baseParams };
                    naturalParams.age = age;
                    
                    const naturalResult = calculator === 'frs' ? 
                        window.framinghamCalculator.calculateRisk(naturalParams) : 
                        window.qrisk3Calculator.calculateRisk(naturalParams);
                    
                    if (naturalResult.success) {
                        naturalRisks.push(naturalResult.risk);
                    } else {
                        naturalRisks.push(null);
                    }
                    
                    // Calculate intervention effect if applicable
                    if (interventionAge !== null && age >= interventionAge) {
                        // Apply intervention effect
                        // For simplicity, assume intervention reduces cholesterol by 30%
                        const interventionParams = { ...naturalParams };
                        
                        if (calculator === 'frs') {
                            interventionParams.cholesterol = naturalParams.cholesterol * 0.7;
                        } else {
                            // For QRISK3, modify cholesterol:HDL ratio
                            const hdl = naturalParams.hdl;
                            const totalChol = naturalParams.cholHDLRatio * hdl;
                            const ldl = totalChol - hdl;
                            const newLdl = ldl * 0.7;
                            const newTotalChol = newLdl + hdl;
                            interventionParams.cholHDLRatio = newTotalChol / hdl;
                        }
                        
                        const interventionResult = calculator === 'frs' ? 
                            window.framinghamCalculator.calculateRisk(interventionParams) : 
                            window.qrisk3Calculator.calculateRisk(interventionParams);
                        
                        if (interventionResult.success) {
                            interventionRisks.push(interventionResult.risk);
                        } else {
                            interventionRisks.push(null);
                        }
                    } else {
                        // No intervention yet
                        interventionRisks.push(null);
                    }
                }
                
                // Create visualization
                createRiskProgressionVisualization(timePoints, naturalRisks, interventionRisks, interventionAge);
            } catch (error) {
                console.error('Risk progression calculation error:', error);
                
                // Show error
                if (visualizationContainer) {
                    visualizationContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Calculation Error</h4>
                            <p>An unexpected error occurred while calculating risk progression.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Create risk progression visualization
         * @param {Array} timePoints - Time points (ages)
         * @param {Array} naturalRisks - Natural progression risks
         * @param {Array} interventionRisks - Intervention risks
         * @param {number} interventionAge - Age at intervention
         */
        function createRiskProgressionVisualization(timePoints, naturalRisks, interventionRisks, interventionAge) {
            const visualizationContainer = document.getElementById('risk-progression-visualization');
            if (!visualizationContainer) return;
            
            // Find maximum risk for scaling
            const maxNaturalRisk = Math.max(...naturalRisks.filter(r => r !== null));
            const maxInterventionRisk = Math.max(...interventionRisks.filter(r => r !== null));
            const maxRisk = Math.max(maxNaturalRisk, maxInterventionRisk, 20); // At least 20% for scaling
            
            // Create HTML for visualization
            let html = `
                <div class="progression-chart">
                    <h4>CVD Risk Progression Over Time</h4>
                    <div class="chart-body">
                        <div class="chart-y-axis">
                            <div class="chart-y-label">10-Year CVD Risk (%)</div>
                            <div class="chart-y-ticks">
                                <div class="chart-y-tick" style="bottom: 0%;">0%</div>
                                <div class="chart-y-tick" style="bottom: 25%;">${(maxRisk * 0.25).toFixed(0)}%</div>
                                <div class="chart-y-tick" style="bottom: 50%;">${(maxRisk * 0.5).toFixed(0)}%</div>
                                <div class="chart-y-tick" style="bottom:             // Clear container and add results
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(resultsContent);
            
            // Store result for comparison
            window.lastQriskResult = result;
        }
        
        /**
         * Evaluate medications based on current lipid levels and risk
         */
        function evaluateMedications() {
            // Show loading indicator
            const loadingIndicator = document.getElementById('medication-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            // Get form data
            const form = document.getElementById('medication-form');
            const formData = new FormData(form);
            
            // Create parameters object for medication evaluation
            const params = {
                age: parseInt(formData.get('med-age')),
                sex: formData.get('med-sex'),
                ldl: parseFloat(formData.get('med-ldl')),
                totalChol: parseFloat(formData.get('med-total-chol')),
                hdl: parseFloat(formData.get('med-hdl')),
                triglycerides: parseFloat(formData.get('med-trig')),
                nonHdl: parseFloat(formData.get('med-nonhdl')),
                lpa: parseFloat(formData.get('med-lpa')),
                hba1c: parseFloat(formData.get('med-hba1c')),
                apoB: parseFloat(formData.get('med-apob')),
                sbp: parseInt(formData.get('med-sbp')),
                dbp: parseInt(formData.get('med-dbp'))
            };
            
            // Get medication information
            const lipidMedications = [];
            for (let i = 1; i <= 3; i++) {
                const name = formData.get(`med-lipid-name-${i}`);
                if (name) {
                    lipidMedications.push({
                        name: name,
                        dose: formData.get(`med-lipid-dose-${i}`),
                        duration: parseInt(formData.get(`med-lipid-duration-${i}`)) || 0
                    });
                }
            }
            
            const bpMedications = [];
            for (let i = 1; i <= 4; i++) {
                const name = formData.get(`med-htn-name-${i}`);
                if (name) {
                    bpMedications.push({
                        name: name,
                        dose: formData.get(`med-htn-dose-${i}`),
                        duration: parseInt(formData.get(`med-htn-duration-${i}`)) || 0
                    });
                }
            }
            
            // Get medical conditions
            const medicalConditions = [];
            for (let i = 1; i <= 6; i++) {
                const condition = formData.get(`med-condition-${i}`);
                if (condition) {
                    medicalConditions.push({
                        name: condition,
                        duration: parseInt(formData.get(`med-condition-${i}-duration`)) || 0
                    });
                }
            }
            
            // Add medications and conditions to parameters
            params.lipidMedications = lipidMedications;
            params.bpMedications = bpMedications;
            params.medicalConditions = medicalConditions;
            
            // Check if using existing risk assessment
            const useRisk = formData.get('med-use-risk');
            
            if (useRisk === 'frs' && window.lastFrsResult) {
                params.riskAssessment = {
                    type: 'frs',
                    risk: window.lastFrsResult.risk,
                    category: window.lastFrsResult.riskCategory
                };
            } else if (useRisk === 'qrisk' && window.lastQriskResult) {
                params.riskAssessment = {
                    type: 'qrisk',
                    risk: window.lastQriskResult.risk,
                    category: window.lastQriskResult.riskCategory
                };
            }
            
            // Unit conversions
            // Convert LDL to mmol/L if needed
            if (document.getElementById('med-ldl-unit').value === 'mg/dL') {
                params.ldl = params.ldl / 38.67;
            }
            
            // Convert Total Cholesterol to mmol/L if needed
            if (document.getElementById('med-total-chol-unit').value === 'mg/dL') {
                params.totalChol = params.totalChol / 38.67;
            }
            
            // Convert HDL to mmol/L if needed
            if (document.getElementById('med-hdl-unit').value === 'mg/dL') {
                params.hdl = params.hdl / 38.67;
            }
            
            // Convert Non-HDL to mmol/L if needed
            if (document.getElementById('med-nonhdl-unit').value === 'mg/dL') {
                params.nonHdl = params.nonHdl / 38.67;
            }
            
            // Convert Triglycerides to mmol/L if needed
            if (document.getElementById('med-trig-unit').value === 'mg/dL') {
                params.triglycerides = params.triglycerides / 88.57;
            }
            
            // Convert Lp(a) to mg/dL if needed
            if (document.getElementById('med-lpa-unit').value === 'nmol/L') {
                params.lpa = params.lpa / 2.5;
            }
            
            // Convert HbA1c to % if needed
            if (document.getElementById('med-hba1c-unit').value === 'mmol/mol') {
                params.hba1c = (params.hba1c / 10.929) + 2.15;
            }
            
            // Convert ApoB to g/L if needed
            if (document.getElementById('med-apob-unit').value === 'mg/dL') {
                params.apoB = params.apoB / 100;
            }
            
            try {
                // Evaluate medications
                const result = evaluateMedicationRegimen(params);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Display results
                displayMedicationResults(result);
            } catch (error) {
                console.error('Medication evaluation error:', error);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Show error
                const resultsContainer = document.getElementById('medication-results-container');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Evaluation Error</h4>
                            <p>An unexpected error occurred while evaluating medications.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Evaluate medication regimen and provide recommendations
         * @param {Object} params - Evaluation parameters
         * @returns {Object} Evaluation result
         */
        function evaluateMedicationRegimen(params) {
            // Determine statin intensity based on medications
            let statinIntensity = 'none';
            let ezetimibePresent = false;
            let pcsk9Present = false;
            
            // Check for statins
            params.lipidMedications.forEach(med => {
                const name = med.name.toLowerCase();
                const dose = parseFloat(med.dose) || 0;
                
                if (name.includes('atorvastatin')) {
                    if (dose >= 40) {
                        statinIntensity = 'high';
                    } else if (dose >= 10) {
                        statinIntensity = 'moderate';
                    }
                } else if (name.includes('rosuvastatin')) {
                    if (dose >= 20) {
                        statinIntensity = 'high';
                    } else if (dose >= 5) {
                        statinIntensity = 'moderate';
                    }
                } else if (name.includes('simvastatin')) {
                    if (dose >= 80) {
                        statinIntensity = 'high';
                    } else if (dose >= 20) {
                        statinIntensity = 'moderate';
                    } else {
                        statinIntensity = 'low';
                    }
                } else if (name.includes('pravastatin')) {
                    if (dose >= 40) {
                        statinIntensity = 'moderate';
                    } else {
                        statinIntensity = 'low';
                    }
                } else if (name.includes('lovastatin')) {
                    if (dose >= 40) {
                        statinIntensity = 'moderate';
                    } else {
                        statinIntensity = 'low';
                    }
                } else if (name.includes('fluvastatin')) {
                    if (dose >= 80) {
                        statinIntensity = 'moderate';
                    } else {
                        statinIntensity = 'low';
                    }
                } else if (name.includes('pitavastatin')) {
                    if (dose >= 2) {
                        statinIntensity = 'moderate';
                    } else {
                        statinIntensity = 'low';
                    }
                } else if (name.includes('ezetimibe')) {
                    ezetimibePresent = true;
                } else if (name.includes('evolocumab') || name.includes('alirocumab') || name.includes('inclisiran')) {
                    pcsk9Present = true;
                }
            });
            
            // Determine risk category
            let riskCategory = 'unknown';
            
            if (params.riskAssessment) {
                riskCategory = params.riskAssessment.category;
            } else {
                // Determine risk based on medical conditions and lipid values
                
                // Check for very high risk conditions
                const veryHighRiskConditions = [
                    'mi', 'myocardial infarction', 'heart attack',
                    'stroke', 'tia', 'transient ischemic attack', 
                    'cabg', 'coronary artery bypass', 'stent', 'angioplasty',
                    'peripheral artery disease', 'pad', 'claudication',
                    'aortic aneurysm', 'aneurysm',
                    'carotid stenosis'
                ];
                
                const hasVeryHighRiskCondition = params.medicalConditions.some(condition => 
                    veryHighRiskConditions.some(term => 
                        condition.name.toLowerCase().includes(term)
                    )
                );
                
                // Check for diabetes with end-organ damage or long duration
                const hasDiabetes = params.medicalConditions.some(condition => 
                    condition.name.toLowerCase().includes('diabetes')
                );
                
                const diabetesDuration = params.medicalConditions.find(condition => 
                    condition.name.toLowerCase().includes('diabetes')
                )?.duration || 0;
                
                const hasEndOrganDamage = params.medicalConditions.some(condition => 
                    condition.name.toLowerCase().includes('retinopathy') ||
                    condition.name.toLowerCase().includes('nephropathy') ||
                    condition.name.toLowerCase().includes('neuropathy')
                );
                
                const hasFamilialHypercholesterolemia = params.medicalConditions.some(condition => 
                    condition.name.toLowerCase().includes('familial hypercholesterolemia') ||
                    condition.name.toLowerCase().includes('fh')
                ) || params.ldl >= 5.0;
                
                // Determine risk category
                if (hasVeryHighRiskCondition || 
                    (hasDiabetes && (hasEndOrganDamage || diabetesDuration >= 180)) || // 15 years = 180 months
                    hasFamilialHypercholesterolemia) {
                    riskCategory = 'very-high';
                } else if (params.ldl >= 4.9) {
                    riskCategory = 'high';
                } else if (params.ldl >= 3.5) {
                    riskCategory = 'intermediate';
                } else {
                    riskCategory = 'low';
                }
            }
            
            // Determine LDL targets based on risk category
            let ldlTarget = null;
            let ldlReductionTarget = 0;
            
            switch (riskCategory) {
                case 'low':
                    ldlReductionTarget = 0;
                    break;
                    
                case 'intermediate':
                    ldlReductionTarget = 30;
                    break;
                    
                case 'high':
                    ldlTarget = 2.0;
                    ldlReductionTarget = 50;
                    break;
                    
                case 'very-high':
                    ldlTarget = 1.8;
                    ldlReductionTarget = 50;
                    break;
            }
            
            // Calculate target status
            let targetStatus = 'unknown';
            let targetLDL = null;
            
            if (ldlTarget !== null) {
                targetLDL = ldlTarget;
                targetStatus = params.ldl <= ldlTarget ? 'at target' : 'not at target';
            } else if (ldlReductionTarget > 0) {
                // Estimate baseline LDL
                let baselineLDL = params.ldl;
                
                // Adjust for statin intensity
                if (statinIntensity === 'high') {
                    baselineLDL = params.ldl / 0.5; // Assuming 50% reduction
                } else if (statinIntensity === 'moderate') {
                    baselineLDL = params.ldl / 0.7; // Assuming 30% reduction
                } else if (statinIntensity === 'low') {
                    baselineLDL = params.ldl / 0.8; // Assuming 20% reduction
                }
                
                // Adjust for ezetimibe (additional 18% reduction)
                if (ezetimibePresent) {
                    baselineLDL = baselineLDL / 0.82;
                }
                
                // Adjust for PCSK9 inhibitor (additional 60% reduction)
                if (pcsk9Present) {
                    baselineLDL = baselineLDL / 0.4;
                }
                
                // Calculate target LDL
                targetLDL = baselineLDL * (1 - (ldlReductionTarget / 100));
                
                // Compare current LDL with target
                targetStatus = params.ldl <= targetLDL ? 'at target' : 'not at target';
            }
            
            // Determine PCSK9 inhibitor eligibility
            const pcsk9Eligibility = determinePCSK9Eligibility(params, riskCategory, statinIntensity, ezetimibePresent);
            
            // Generate recommended changes
            const recommendedChanges = generateMedicationRecommendations(
                params, 
                riskCategory, 
                statinIntensity, 
                ezetimibePresent, 
                pcsk9Present, 
                targetStatus, 
                pcsk9Eligibility
            );
            
            // Create result object
            return {
                currentTherapy: {
                    statinIntensity: statinIntensity,
                    ezetimibe: ezetimibePresent,
                    pcsk9: pcsk9Present,
                    medications: [...params.lipidMedications]
                },
                ldlValues: {
                    current: params.ldl,
                    target: targetLDL,
                    status: targetStatus
                },
                riskCategory: riskCategory,
                pcsk9Eligibility: pcsk9Eligibility,
                recommendedChanges: recommendedChanges,
                otherMetrics: {
                    nonHdl: params.nonHdl,
                    apoB: params.apoB,
                    triglycerides: params.triglycerides,
                    lpa: params.lpa
                }
            };
        }
        
        /**
         * Determine PCSK9 inhibitor eligibility
         * @param {Object} params - Evaluation parameters
         * @param {string} riskCategory - Risk category
         * @param {string} statinIntensity - Current statin intensity
         * @param {boolean} ezetimibePresent - Whether ezetimibe is present
         * @returns {Object} Eligibility result
         */
        function determinePCSK9Eligibility(params, riskCategory, statinIntensity, ezetimibePresent) {
            const result = {
                eligible: false,
                status: '',
                details: []
            };
            
            // Check for high-risk conditions that might qualify for PCSK9 inhibitor
            const pcsk9EligibleConditions = ['MI', 'myocardial infarction', 'heart attack', 'stroke', 'TIA', 'PAD', 'peripheral arterial disease', 'FH', 'familial hypercholesterolemia'];
            
            const hasPCSK9EligibleCondition = params.medicalConditions.some(condition => 
                pcsk9EligibleConditions.some(term => 
                    condition.name.toLowerCase().includes(term.toLowerCase())
                )
            );
            
            // Check for familial hypercholesterolemia
            const hasFH = params.medicalConditions.some(condition => 
                condition.name.toLowerCase().includes('familial hypercholesterolemia') || 
                condition.name.toLowerCase().includes('fh')
            ) || params.ldl >= 5.0;
            
            // Check medication requirements
            const onMaximallyToleratedStatin = statinIntensity === 'high' || statinIntensity === 'moderate';
            const onEzetimibe = ezetimibePresent;
            
            // Check LDL threshold criteria
            const ldlAboveThresholdASCVD = params.ldl >= 1.8;
            const ldlAboveThresholdFH = params.ldl >= 2.5;
            
            if (hasFH) {
                // FH criteria
                if (onMaximallyToleratedStatin && onEzetimibe && ldlAboveThresholdFH) {
                    result.eligible = true;
                    result.status = 'Eligible - FH Criteria';
                    result.details = [
                        'Diagnosis of Familial Hypercholesterolemia',
                        'On maximally tolerated statin therapy',
                        'On ezetimibe',
                        'LDL-C ≥ 2.5 mmol/L'
                    ];
                } else {
                    result.eligible = false;
                    result.status = 'Not Eligible - FH Criteria Not Fully Met';
                    
                    if (!onMaximallyToleratedStatin) {
                        result.details.push('Not on maximally tolerated statin therapy');
                    }
                    
                    if (!onEzetimibe) {
                        result.details.push('Not on ezetimibe');
                    }
                    
                    if (!ldlAboveThresholdFH) {
                        result.details.push('LDL-C < 2.5 mmol/L');
                    }
                }
            } else if (hasPCSK9EligibleCondition) {
                // ASCVD criteria
                if (onMaximallyToleratedStatin && onEzetimibe && ldlAboveThresholdASCVD) {
                    result.eligible = true;
                    result.status = 'Eligible - ASCVD Criteria';
                    result.details = [
                        'Diagnosis of Atherosclerotic Cardiovascular Disease',
                        'On maximally tolerated statin therapy',
                        'On ezetimibe',
                        'LDL-C ≥ 1.8 mmol/L'
                    ];
                } else {
                    result.eligible = false;
                    result.status = 'Not Eligible - ASCVD Criteria Not Fully Met';
                    
                    if (!onMaximallyToleratedStatin) {
                        result.details.push('Not on maximally tolerated statin therapy');
                    }
                    
                    if (!onEzetimibe) {
                        result.details.push('Not on ezetimibe');
                    }
                    
                    if (!ldlAboveThresholdASCVD) {
                        result.details.push('LDL-C < 1.8 mmol/L');
                    }
                }
            } else {
                result.eligible = false;
                result.status = 'Not Eligible - No Qualifying Condition';
                result.details = [
                    'No diagnosis of Atherosclerotic Cardiovascular Disease or Familial Hypercholesterolemia'
                ];
            }
            
            return result;
        }
        
        /**
         * Generate medication recommendations
         * @param {Object} params - Evaluation parameters
         * @param {string} riskCategory - Risk category
         * @param {string} statinIntensity - Current statin intensity
         * @param {boolean} ezetimibePresent - Whether ezetimibe is present
         * @param {boolean} pcsk9Present - Whether PCSK9 inhibitor is present
         * @param {string} targetStatus - Target status
         * @param {Object} pcsk9Eligibility - PCSK9 inhibitor eligibility
         * @returns {Object} Recommended changes
         */
        function generateMedicationRecommendations(params, riskCategory, statinIntensity, ezetimibePresent, pcsk9Present, targetStatus, pcsk9Eligibility) {
            const result = {
                primary: '',
                secondary: [],
                rationale: ''
            };
            
            // If already at target, no changes needed
            if (targetStatus === 'at target') {
                result.primary = 'No changes to lipid-lowering therapy required.';
                result.secondary = ['Current therapy is appropriate for risk category.', 'Continue monitoring lipid values periodically.'];
                result.rationale = 'Patient has achieved target LDL-C levels based on risk category. No changes to current therapy are recommended at this time.';
                return result;
            }
            
            // Generate recommendations based on risk category
            switch (riskCategory) {
                case 'low':
                    result.primary = 'Focus on lifestyle modifications.';
                    result.secondary = [
                        'Emphasize healthy diet, regular physical activity, and smoking cessation if applicable.',
                        'Monitor lipid profile annually.'
                    ];
                    result.rationale = 'For low-risk patients, pharmacological therapy is generally not required unless lifestyle modifications fail to achieve significant improvements in lipid profile over 3-6 months.';
                    break;
                    
                case 'intermediate':
                    if (params.ldl >= 3.5) {
                        if (statinIntensity === 'none') {
                            result.primary = 'Consider initiating moderate-intensity statin therapy.';
                            result.secondary = [
                                'Target ≥ 30% reduction in LDL-C.',
                                'Recommend atorvastatin 10-20 mg or rosuvastatin 5-10 mg or equivalent.',
                                'Reassess in 6-12 weeks after initiation.',
                                'Continue lifestyle modifications.'
                            ];
                            result.rationale = 'For intermediate-risk patients with LDL-C ≥ 3.5 mmol/L, statin therapy is recommended with a target of at least 30% reduction in LDL-C.';
                        } else if (targetStatus === 'not at target') {
                            if (statinIntensity === 'low') {
                                result.primary = 'Increase to moderate-intensity statin therapy.';
                                result.secondary = [
                                    'Consider atorvastatin 20 mg or rosuvastatin 10 mg or equivalent.',
                                    'Reassess in 6-12 weeks after dose adjustment.',
                                    'Continue lifestyle modifications.'
                                ];
                                result.rationale = 'Current low-intensity statin therapy has not achieved target reduction in LDL-C. Increasing to moderate-intensity therapy is recommended.';
                            } else {
                                result.primary = 'Consider adding ezetimibe.';
                                result.secondary = [
                                    'Add ezetimibe 10 mg daily.',
                                    'Reassess in 6-12 weeks after addition.',
                                    'Continue lifestyle modifications.'
                                ];
                                result.rationale = 'Current moderate-intensity statin therapy has not achieved target reduction in LDL-C. Adding ezetimibe is recommended to further lower LDL-C.';
                            }
                        }
                    } else {
                        result.primary = 'Continue lifestyle modifications.';
                        result.secondary = [
                            'No specific pharmacological therapy indicated at this time.',
                            'Continue to monitor lipid profile annually.'
                        ];
                        result.rationale = 'For intermediate-risk patients with LDL-C < 3.5 mmol/L, pharmacological therapy is generally not required unless other risk factors are present.';
                    }
                    break;
                    
                case 'high':
                case 'very-high':
                    if (statinIntensity === 'none') {
                        result.primary = 'Initiate high-intensity statin therapy.';
                        result.secondary = [
                            'Recommend atorvastatin 40-80 mg or rosuvastatin 20-40 mg.',
                            'Target LDL-C reduction of ≥ 50%.',
                            `Target LDL-C < ${riskCategory === 'very-high' ? '1.8' : '2.0'} mmol/L.`,
                            'Reassess in 6-12 weeks after initiation.'
                        ];
                        result.rationale = `For ${riskCategory}-risk patients, high-intensity statin therapy is recommended to achieve significant LDL-C reduction.`;
                    } else if (statinIntensity === 'low' || statinIntensity === 'moderate') {
                        result.primary = 'Increase to high-intensity statin therapy.';
                        result.secondary = [
                            'Recommend atorvastatin 40-80 mg or rosuvastatin 20-40 mg.',
                            'Target LDL-C reduction of ≥ 50%.',
                            `Target LDL-C < ${riskCategory === 'very-high' ? '1.8' : '2.0'} mmol/L.`,
                            'Reassess in 6-12 weeks after dose adjustment.'
                        ];
                        result.rationale = `Current ${statinIntensity}-intensity statin therapy has not achieved target LDL-C levels. High-intensity statin therapy is recommended for ${riskCategory}-risk patients.`;
                    } else if (statinIntensity === 'high' && !ezetimibePresent) {
                        result.primary = 'Add ezetimibe to high-intensity statin therapy.';
                        result.secondary = [
                            'Add ezetimibe 10 mg daily.',
                            `Target LDL-C < ${riskCategory === 'very-high' ? '1.8' : '2.0'} mmol/L.`,
                            'Reassess in 6-12 weeks after addition.'
                        ];
                        result.rationale = 'Current high-intensity statin therapy has not achieved target LDL-C levels. Adding ezetimibe is recommended to further lower LDL-C.';
                    } else if (statinIntensity === 'high' && ezetimibePresent && !pcsk9Present) {
                        if (pcsk9Eligibility.eligible) {
                            result.primary = 'Consider adding a PCSK9 inhibitor.';
                            result.secondary = [
                                'Add evolocumab 140 mg every 2 weeks or 420 mg monthly, OR',
                                'Add alirocumab 75-150 mg every 2 weeks.',
                                `Target LDL-C < ${riskCategory === 'very-high' ? '1.8' : '2.0'} mmol/L.`,
                                'Reassess in 6-12 weeks after addition.'
                            ];
                            result.rationale = 'Current high-intensity statin therapy plus ezetimibe has not achieved target LDL-C levels. Adding a PCSK9 inhibitor is recommended for eligible patients.';
                        } else {
                            result.primary = 'Continue current therapy and monitor closely.';
                            result.secondary = [
                                'Maximize adherence to current therapy.',
                                'Consider dietary consultation for additional LDL-C reduction.',
                                'Monitor lipid profile every 3-6 months.'
                            ];
                            result.rationale = 'Current therapy has not achieved target LDL-C levels, but patient does not meet eligibility criteria for PCSK9 inhibitor therapy. Focus on optimizing current therapy and lifestyle modifications.';
                        }
                    }
                    break;
            }
            
            return result;
        }
        
        /**
         * Display medication evaluation results
         * @param {Object} result - Evaluation result
         */
        function displayMedicationResults(result) {
            // Get results container
            const resultsContainer = document.getElementById('medication-results-container');
            if (!resultsContainer) return;
            
            // Get results template
            const resultsTemplate = document.getElementById('medication-results-template');
            if (!resultsTemplate) {
                resultsContainer.innerHTML = '<p>Results template not found.</p>';
                return;
            }
            
            // Clone template
            const resultsContent = document.importNode(resultsTemplate.content, true);
            
            // Set title and date
            const resultsDate = resultsContent.querySelector('.results-date');
            if (resultsDate) {
                resultsDate.textContent = new Date().toLocaleString();
            }
            
            // Set risk category
            const riskCategory = resultsContent.querySelector('.risk-category');
            if (riskCategory) {
                let categoryText = '';
                
                switch (result.riskCategory) {
                    case 'low':
                        categoryText = 'Low Risk (<10%)';
                        riskCategory.className = 'result-value risk-category low-risk';
                        break;
                        
                    case 'intermediate':
                        categoryText = 'Intermediate Risk (10-19%)';
                        riskCategory.className = 'result-value risk-category moderate-risk';
                        break;
                        
                    case 'high':
                        categoryText = 'High Risk (≥20%)';
                        riskCategory.className = 'result-value risk-category high-risk';
                        break;
                        
                    case 'very-high':
                        categoryText = 'Very High Risk';
                        riskCategory.className = 'result-value risk-category very-high-risk';
                        break;
                        
                    default:
                        categoryText = 'Unknown Risk';
                        break;
                }
                
                riskCategory.textContent = categoryText;
            }
            
            // Set current therapy
            const currentTherapy = resultsContent.querySelector('.current-therapy');
            if (currentTherapy) {
                let therapyText = '';
                
                if (result.currentTherapy.statinIntensity === 'none') {
                    therapyText = 'No statin therapy';
                } else {
                    therapyText = `${result.currentTherapy.statinIntensity.charAt(0).toUpperCase() + result.currentTherapy.statinIntensity.slice(1)}-intensity statin`;
                    
                    if (result.currentTherapy.ezetimibe) {
                        therapyText += ' + Ezetimibe';
                    }
                    
                    if (result.currentTherapy.pcsk9) {
                        therapyText += ' + PCSK9 inhibitor';
                    }
                }
                
                currentTherapy.textContent = therapyText;
            }
            
            // Set LDL values
            const currentLDL = resultsContent.querySelector('.current-ldl');
            if (currentLDL) {
                currentLDL.textContent = `${result.ldlValues.current.toFixed(1)} mmol/L`;
            }
            
            const targetLDL = resultsContent.querySelector('.target-ldl');
            if (targetLDL) {
                if (result.ldlValues.target !== null) {
                    targetLDL.textContent = `${result.ldlValues.target.toFixed(1)} mmol/L`;
                } else {
                    targetLDL.textContent = 'Not applicable';
                }
            }
            
            const targetStatus = resultsContent.querySelector('.target-status');
            if (targetStatus) {
                let statusText = '';
                let statusClass = '';
                
                switch (result.ldlValues.status) {
                    case 'at target':
                        statusText = 'At Target';
                        statusClass = 'text-success';
                        break;
                        
                    case 'not at target':
                        statusText = 'Not At Target';
                        statusClass = 'text-danger';
                        break;
                        
                    default:
                        statusText = 'Unknown';
                        break;
                }
                
                targetStatus.textContent = statusText;
                targetStatus.className = `result-value target-status ${statusClass}`;
            }
            
            // Set recommended changes
            const changesPrimary = resultsContent.querySelector('.changes-primary');
            if (changesPrimary) {
                changesPrimary.textContent = result.recommendedChanges.primary;
            }
            
            const changesSecondary = resultsContent.querySelector('.changes-secondary');
            if (changesSecondary) {
                changesSecondary.innerHTML = '';
                
                result.recommendedChanges.secondary.forEach(change => {
                    const li = document.createElement('li');
                    li.textContent = change;
                    changesSecondary.appendChild(li);
                });
            }
            
            // Set PCSK9 eligibility
            const eligibilityStatus = resultsContent.querySelector('.eligibility-status');
            if (eligibilityStatus) {
                eligibilityStatus.textContent = result.pcsk9Eligibility.status;
                
                if (result.pcsk9Eligibility.eligible) {
                    eligibilityStatus.className = 'eligibility-status text-success';
                } else {
                    eligibilityStatus.className = 'eligibility-status';
                }
            }
            
            const eligibilityDetails = resultsContent.querySelector('.eligibility-details');
            if (eligibilityDetails) {
                eligibilityDetails.innerHTML = '';
                
                if (result.pcsk9Eligibility.details.length > 0) {
                    const ul = document.createElement('ul');
                    
                    result.pcsk9Eligibility.details.forEach(detail => {
                        const li = document.createElement('li');
                        li.textContent = detail;
                        ul.appendChild(li);
                    });
                    
                    eligibilityDetails.appendChild(ul);
                }
            }
            
            // Set rationale
            const changesRationale = resultsContent.querySelector('.changes-rationale');
            if (changesRationale) {
                changesRationale.innerHTML = `
                    <h4>Clinical Rationale</h4>
                    <p>${result.recommendedChanges.rationale}</p>
                    <p>Recommendations are based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult.</p>
                `;
            }
            
            // Create visualization (placeholder for now)
            const medicationVisualization = resultsContent.querySelector('.medication-visualization');
            if (medicationVisualization) {
                medicationVisualization.innerHTML = `
                    <div class="visualization-placeholder">
                        <div class="therapy-chart">
                            <div class="ldl-meter">
                                <div class="ldl-meter-bar" style="width: ${Math.min(result.ldlValues.current / 5 * 100, 100)}%;"></div>
                                <div class="ldl-meter-target" style="left: ${Math.min(result.ldlValues.target / 5 * 100, 100)}%;"></div>
                                <div class="ldl-meter-labels">
                                    <span>0</span>
                                    <span>1</span>
                                    <span>2</span>
                                    <span>3</span>
                                    <span>4</span>
                                    <span>5+</span>
                                </div>
                            </div>
                            <div class="ldl-meter-title">LDL-C (mmol/L)</div>
                        </div>
                    </div>
                `;
            }
            
            // Add event listeners to buttons
            const printButton = resultsContent.querySelector('.results-print');
            const exportButton = resultsContent.querySelector('.results-export');
            
            if (printButton) {
                printButton.addEventListener('click', function() {
                    window.print();
                });
            }
            
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    exportResultsAsPDF('medication');
                });
            }
            
            // Clear container and add results
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(resultsContent);
        }
        
        /**
         * Run risk comparison
         */
        function runRiskComparison() {
            // Check if both calculations are available
            if (!window.lastFrsResult || !window.lastQriskResult) {
                alert('Please calculate both FRS and QRISK3 risks first.');
                return;
            }
            
            // Show loading indicator
            const loadingIndicator = document.getElementById('comparison-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            try {
                // Get results
                const frsRisk = window.lastFrsResult.risk;
                const qriskRisk = window.lastQriskResult.risk;
                
                // Calculate differences
                const absoluteDifference = Math.abs(frsRisk - qriskRisk);
                const relativeDifference = frsRisk > 0 
                    ? Math.round((absoluteDifference / frsRisk) * 100) 
                    : 0;
                
                // Determine which calculator to recommend
                const recommendedCalculator = determineRecommendedCalculator(
                    window.lastFrsResult, 
                    window.lastQriskResult
                );
                
                // Prepare comparison result
                const result = {
                    frs: window.lastFrsResult,
                    qrisk: window.lastQriskResult,
                    differences: {
                        absolute: absoluteDifference,
                        relative: relativeDifference
                    },
                    explanation: explainRiskDifferences(window.lastFrsResult, window.lastQriskResult),
                    recommendation: recommendedCalculator
                };
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Display comparison
                displayComparisonResults(result);
                
                // Broadcast calculation completion
                broadcastCalculationComplete('comparison');
            } catch (error) {
                console.error('Comparison error:', error);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Show error
                const resultsContainer = document.getElementById('comparison-results-container');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Comparison Error</h4>
                            <p>An unexpected error occurred while comparing risk scores.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Determine recommended calculator based on patient characteristics
         * @param {Object} frsResult - FRS result
         * @param {Object} qriskResult - QRISK3 result
         * @returns {Object} Recommendation
         */
        function determineRecommendedCalculator(frsResult, qriskResult) {
            // Check if QRISK3 includes additional risk factors not in FRS
            const hasAdditionalRiskFactors = qriskResult.inputs.family === 1 || 
                qriskResult.inputs.af === 1 || 
                qriskResult.inputs.renal === 1 || 
                qriskResult.inputs.migraines === 1 || 
                qriskResult.inputs.ra === 1 || 
                qriskResult.inputs.sle === 1 || 
                qriskResult.inputs.psychosis === 1 || 
                qriskResult.inputs.atypicalAntipsy === 1 || 
                qriskResult.inputs.steroids === 1;
            
            // Check if patient is of non-white ethnicity
            const nonWhiteEthnicity = qriskResult.inputs.ethnicity && 
                qriskResult.inputs.ethnicity !== 'WHITE_OR_NOT_STATED';
            
            let recommendedCalculator = 'frs';
            let rationale = 'The Framingham Risk Score is recommended as it aligns with the Canadian Cardiovascular Society Guidelines.';
            
            // Determine which calculator to recommend
            if (hasAdditionalRiskFactors || nonWhiteEthnicity) {
                recommendedCalculator = 'qrisk';
                
                let factors = [];
                
                if (qriskResult.inputs.family === 1) factors.push('family history of CVD');
                if (qriskResult.inputs.af === 1) factors.push('atrial fibrillation');
                if (qriskResult.inputs.renal === 1) factors.push('chronic kidney disease');
                if (qriskResult.inputs.migraines === 1) factors.push('migraines');
                if (qriskResult.inputs.ra === 1) factors.push('rheumatoid arthritis');
                if (qriskResult.inputs.sle === 1) factors.push('SLE');
                if (qriskResult.inputs.psychosis === 1) factors.push('severe mental illness');
                if (qriskResult.inputs.atypicalAntipsy === 1) factors.push('atypical antipsychotic use');
                if (qriskResult.inputs.steroids === 1) factors.push('steroid use');
                
                if (nonWhiteEthnicity) {
                    factors.push('ethnicity considerations');
                }
                
                rationale = `QRISK3 is recommended as it accounts for additional risk factors present in this patient: ${factors.join(', ')}.`;
            } else if (Math.abs(frsResult.risk - qriskResult.risk) > 5) {
                // If difference is significant but no additional risk factors
                if (qriskResult.risk > frsResult.risk) {
                    recommendedCalculator = 'qrisk';
                    rationale = 'QRISK3 tends to provide a more conservative risk estimate for this patient, which may be appropriate for clinical decision making.';
                } else {
                    recommendedCalculator = 'frs';
                    rationale = 'Framingham Risk Score is recommended as it aligns with the Canadian Cardiovascular Society Guidelines and provides a more conservative risk estimate for this patient.';
                }
            }
            
            return {
                calculator: recommendedCalculator,
                rationale: rationale
            };
        }
        
        /**
         * Explain risk differences between calculators
         * @param {Object} frsResult - FRS result
         * @param {Object} qriskResult - QRISK3 result
         * @returns {string} Explanation
         */
        function explainRiskDifferences(frsResult, qriskResult) {
            let explanation = `The Framingham Risk Score (FRS) estimates a 10-year cardiovascular risk of ${frsResult.risk}%, while QRISK3 estimates a risk of ${qriskResult.risk}%. `;
            
            // Explain differences based on calculator methodology
            explanation += 'The differences between these risk estimates can be attributed to the following factors:';
            
            const differences = [
                'The FRS was developed based on a U.S. population, while QRISK3 was developed based on a U.K. population.',
                'QRISK3 includes additional risk factors not considered in the FRS, such as ethnicity, family history, chronic kidney disease, atrial fibrillation, rheumatoid arthritis, and more.',
                'The definition of cardiovascular events differs slightly between the calculators, with QRISK3 including a broader range of events.',
                'The statistical methodology used to develop each calculator differs, which can result in different risk estimates for the same patient.'
            ];
            
            // Add specific differences based on patient characteristics
            if (qriskResult.inputs.family === 1) {
                differences.push('This patient has a family history of cardiovascular disease, which is factored into QRISK3 but not FRS.');
            }
            
            if (qriskResult.inputs.af === 1) {
                differences.push('This patient has atrial fibrillation, which is factored into QRISK3 but not FRS.');
            }
            
            if (qriskResult.inputs.renal === 1) {
                differences.push('This patient has chronic kidney disease, which is factored into QRISK3 but not FRS.');
            }
            
            if (qriskResult.inputs.ethnicity && qriskResult.inputs.ethnicity !== 'WHITE_OR_NOT_STATED') {
                differences.push('This patient\'s ethnicity is factored into QRISK3 but not FRS, which can significantly impact risk estimates.');
            }
            
            // Format explanation as HTML
            const formattedExplanation = `
                <p>${explanation}</p>
                <ul>
                    ${differences.map(diff => `<li>${diff}</li>`).join('')}
                </ul>
                <p>Despite these differences, both calculators provide valuable information for cardiovascular risk assessment and should be interpreted in the context of the individual patient's clinical presentation.</p>
            `;
            
            return formattedExplanation;
        }
        
        /**
         * Display comparison results
         * @param {Object} result - Comparison result
         */
        function displayComparisonResults(result) {
            // Get results container
            const resultsContainer = document.getElementById('comparison-results-container');
            if (!resultsContainer) return;
            
            // Get results template
            const resultsTemplate = document.getElementById('comparison-results-template');
            if (!resultsTemplate) {
                resultsContainer.innerHTML = '<p>Results template not found.</p>';
                return;
            }
            
            // Clone template
            const resultsContent = document.importNode(resultsTemplate.content, true);
            
            // Set date
            const resultsDate = resultsContent.querySelector('.results-date');
            if (resultsDate) {
                resultsDate.textContent = new Date().toLocaleString();
            }
            
            // Set risk values
            const frsRisk = resultsContent.querySelector('.frs-risk');
            if (frsRisk) {
                frsRisk.textContent = `${result.frs.risk}%`;
            }
            
            const qriskRisk = resultsContent.querySelector('.qrisk-risk');
            if (qriskRisk) {
                qriskRisk.textContent = `${result.qrisk.risk}%`;
            }
            
            // Set difference values
            const riskDifference = resultsContent.querySelector('.risk-difference');
            if (riskDifference) {
                riskDifference.textContent = `${result.differences.absolute.toFixed(1)}%`;
            }
            
            const relativeDifference = resultsContent.querySelector('.relative-difference');
            if (relativeDifference) {
                relativeDifference.textContent = `${result.differences.relative}%`;
            }
            
            // Set explanation
            const explanation = resultsContent.querySelector('.explanation-content');
            if (explanation) {
                explanation.innerHTML = result.explanation;
            }
            
            // Set recommendation
            const recommendation = resultsContent.querySelector('.recommendation-content');
            if (recommendation) {
                recommendation.innerHTML = `
                    <p>Based on this patient's risk profile, the <strong>${result.recommendation.calculator === 'frs' ? 'Framingham Risk Score' : 'QRISK3'}</strong> is recommended for clinical decision making.</p>
                    <p>${result.recommendation.rationale}</p>
                    <p>Consider using the recommended calculator to guide treatment decisions in accordance with the Canadian Cardiovascular Society Guidelines.</p>
                `;
            }
            
            // Create visualization
            const comparisonVisualization = resultsContent.querySelector('.comparison-visualization');
            if (comparisonVisualization) {
                comparisonVisualization.innerHTML = `
                    <div class="comparison-chart">
                        <div class="chart-bar-container">
                            <div class="chart-label">FRS</div>
                            <div class="chart-bar">
                                <div class="chart-bar-fill" style="width: ${Math.min(result.frs.risk * 2, 100)}%;"></div>
                                <span class="chart-bar-value">${result.frs.risk}%</span>
                            </div>
                        </div>
                        <div class="chart-bar-container">
                            <div class="chart-label">QRISK3</div>
                            <div class="chart-bar">
                                <div class="chart-bar-fill" style="width: ${Math.min(result.qrisk.risk * 2, 100)}%;"></div>
                                <span class="chart-bar-value">${result.qrisk.risk}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add event listeners to buttons
            const printButton = resultsContent.querySelector('.results-print');
            const exportButton = resultsContent.querySelector('.results-export');
            
            if (printButton) {
                printButton.addEventListener('click', function() {
                    window.print();
                });
            }
            
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    exportResultsAsPDF('comparison');
                });
            }
            
            // Clear container and add results
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(resultsContent);
        }
        
        /**
         * Broadcast calculation completion to other tabs
         * @param {string} calculationType - Type of calculation
         */
        function broadcastCalculationComplete(calculationType) {
            // Use BroadcastChannel if available
            if (window.calculationChannel) {
                window.calculationChannel.postMessage({
                    type: 'calculation_complete',
                    calculationType: calculationType,
                    timestamp: new Date().getTime()
                });
            } else {
                // Fallback to LocalStorage
                try {
                    const status = JSON.parse(localStorage.getItem('cvd_risk_calculation_status') || '{}');
                    status[calculationType] = true;
                    localStorage.setItem('cvd_risk_calculation_status', JSON.stringify(status));
                } catch (error) {
                    console.error('Error broadcasting calculation status:', error);
                }
            }
        }
        
        /**
         * Import patient data
         */
        function importPatientData() {
            const fileInput = document.getElementById('patient-data-import');
            const importFormat = document.getElementById('import-format').value;
            const validateDataTypes = document.getElementById('validate-data-types').checked;
            const autoCorrectValues = document.getElementById('auto-correct-values').checked;
            const skipInvalidRows = document.getElementById('skip-invalid-rows').checked;
            const encryptData = document.getElementById('encrypt-imported-data').checked;
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to import.');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Show loading indicator
            const loadingIndicator = document.getElementById('data-preview-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            // Clear previous preview
            const previewContent = document.getElementById('data-preview-content');
            if (previewContent) {
                previewContent.innerHTML = '';
            }
            
            // Update status
            const importStatus = document.getElementById('import-status');
            if (importStatus) {
                importStatus.textContent = 'Reading file...';
            }
            
            // Read file
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const data = event.target.result;
                    
                    // Process data based on format
                    let parsedData;
                    
                    if (importFormat === 'auto') {
                        // Detect format based on file extension
                        if (file.name.endsWith('.csv')) {
                            parsedData = parseCSV(data, validateDataTypes, autoCorrectValues, skipInvalidRows);
                        } else if (file.name.endsWith('.json')) {
                            parsedData = parseJSON(data, validateDataTypes, autoCorrectValues);
                        } else if (file.name.endsWith('.xlsx')) {
                            parsedData = parseExcel(data, validateDataTypes, autoCorrectValues, skipInvalidRows);
                        } else {
                            throw new Error('Unsupported file format. Please use CSV, JSON, or Excel.');
                        }
                    } else if (importFormat === 'csv') {
                        parsedData = parseCSV(data, validateDataTypes, autoCorrectValues, skipInvalidRows);
                    } else if (importFormat === 'json') {
                        parsedData = parseJSON(data, validateDataTypes, autoCorrectValues);
                    } else if (importFormat === 'xlsx') {
                        parsedData = parseExcel(data, validateDataTypes, autoCorrectValues, skipInvalidRows);
                    }
                    
                    // Store data securely if encryption is enabled
                    if (encryptData && window.encryptionService) {
                        const encryptedData = window.encryptionService.encrypt(parsedData);
                        window.encryptionService.secureStore('importedPatientData', encryptedData);
                    } else {
                        // Store in session storage
                        sessionStorage.setItem('importedPatientData', JSON.stringify(parsedData));
                    }
                    
                    // Show preview
                    showDataPreview(parsedData);
                    
                    // Update status
                    if (importStatus) {
                        importStatus.textContent = 'Import successful: ' + parsedData.length + ' records imported.';
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    
                    // Update status
                    if (importStatus) {
                        importStatus.textContent = 'Import failed: ' + error.message;
                    }
                    
                    // Show error in preview
                    if (previewContent) {
                        previewContent.innerHTML = `
                            <div class="error-alert">
                                <h4>Import Error</h4>
                                <p>${error.message}</p>
                            </div>
                        `;
                    }
                } finally {
                    // Hide loading indicator
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                }
            };
            
            reader.onerror = function() {
                console.error('File read error');
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Update status
                if (importStatus) {
                    importStatus.textContent = 'Import failed: Error reading file.';
                }
            };
            
            // Read file as text or array buffer depending on format
            if (importFormat === 'xlsx' || (importFormat === 'auto' && file.name.endsWith('.xlsx'))) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }
        
        /**
         * Parse CSV data
         * @param {string} data - CSV data
         * @param {boolean} validateDataTypes - Whether to validate data types
         * @param {boolean} autoCorrectValues - Whether to auto-correct values
         * @param {boolean} skipInvalidRows - Whether to skip invalid rows
         * @returns {Array} Parsed data
         */
        function parseCSV(data, validateDataTypes, autoCorrectValues, skipInvalidRows) {
            // Simple CSV parser
            const rows = data.split('\n');
            const header = rows[0].split(',').map(h => h.trim());
            const result = [];
            
            for (let i = 1; i < rows.length; i++) {
                if (!rows[i].trim()) continue; // Skip empty rows
                
                const values = rows[i].split(',').map(v => v.trim());
                
                // Skip rows with wrong number of columns if skipInvalidRows is true
                if (values.length !== header.length) {
                    if (skipInvalidRows) {
                        continue;
                    } else {
                        throw new Error(`Row ${i + 1} has ${values.length} columns, expected ${header.length}.`);
                    }
                }
                
                const row = {};
                
                for (let j = 0; j < header.length; j++) {
                    let value = values[j];
                    
                    // Validate and auto-correct values if enabled
                    if (validateDataTypes) {
                        value = validateDataValue(header[j], value, autoCorrectValues);
                    }
                    
                    row[header[j]] = value;
                }
                
                result.push(row);
            }
            
            return result;
        }
        
        /**
         * Parse JSON data
         * @param {string} data - JSON data
         * @param {boolean} validateDataTypes - Whether to validate data types
         * @param {boolean} autoCorrectValues - Whether to auto-correct values
         * @returns {Array} Parsed data
         */
        function parseJSON(data, validateDataTypes, autoCorrectValues) {
            try {
                const parsed = JSON.parse(data);
                
                // Ensure parsed data is an array
                if (!Array.isArray(parsed)) {
                    throw new Error('JSON data must be an array of objects.');
                }
                
                // Validate and auto-correct values if enabled
                if (validateDataTypes) {
                    for (let i = 0; i < parsed.length; i++) {
                        const row = parsed[i];
                        
                        for (const key in row) {
                            row[key] = validateDataValue(key, row[key], autoCorrectValues);
                        }
                    }
                }
                
                return parsed;
            } catch (error) {
                throw new Error('Failed to parse JSON: ' + error.message);
            }
        }
        
        /**
         * Parse Excel data
         * @param {ArrayBuffer} data - Excel data
         * @param {boolean} validateDataTypes - Whether to validate data types
         * @param {boolean} autoCorrectValues - Whether to auto-correct values
         * @param {boolean} skipInvalidRows - Whether to skip invalid rows
         * @returns {Array} Parsed data
         */
        function parseExcel(data, validateDataTypes, autoCorrectValues, skipInvalidRows) {
            // Excel parsing requires the SheetJS library
            if (typeof XLSX === 'undefined') {
                throw new Error('Excel parsing requires the SheetJS library.');
            }
            
            try {
                // Parse workbook
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                // Extract header and data
                const header = jsonData[0];
                const result = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const values = jsonData[i];
                    
                    // Skip empty rows
                    if (!values || values.length === 0) continue;
                    
                    // Skip rows with wrong number of columns if skipInvalidRows is true
                    if (values.length !== header.length) {
                        if (skipInvalidRows) {
                            continue;
                        } else {
                            throw new Error(`Row ${i + 1} has ${values.length} columns, expected ${header.length}.`);
                        }
                    }
                    
                    const row = {};
                    
                    for (let j = 0; j < header.length; j++) {
                        let value = values[j];
                        
                        // Validate and auto-correct values if enabled
                        if (validateDataTypes) {
                            value = validateDataValue(header[j], value, autoCorrectValues);
                        }
                        
                        row[header[j]] = value;
                    }
                    
                    result.push(row);
                }
                
                return result;
            } catch (error) {
                throw new Error('Failed to parse Excel: ' + error.message);
            }
        }
        
        /**
         * Validate data value based on column name
         * @param {string} column - Column name
         * @param {any} value - Value to validate
         * @param {boolean} autoCorrect - Whether to auto-correct value
         * @returns {any} Validated value
         */
        function validateDataValue(column, value, autoCorrect) {
            // Skip validation for null or undefined values            if (!heightInput || !weightInput || !bmiOutput) return;
            
            if (!heightInput.value || !weightInput.value) {
                bmiOutput.value = '';
                return;
            }
            
            let height = parseFloat(heightInput.value);
            let weight = parseFloat(weightInput.value);
            
            // Convert units if needed
            if (heightUnitSelector && heightUnitSelector.value === 'in') {
                height = height * 2.54; // inches to cm
            }
            
            if (weightUnitSelector && weightUnitSelector.value === 'lb') {
                weight = weight * 0.453592; // pounds to kg
            }
            
            // Calculate BMI (weight in kg / height in m²)
            const heightM = height / 100; // cm to m
            const bmi = weight / (heightM * heightM);
            
            // Round to 1 decimal place
            bmiOutput.value = Math.round(bmi * 10) / 10;
        }
        
        /**
         * Update cholesterol ratio calculation
         * @param {string} prefix - Form prefix (frs, qrisk, med)
         */
        function updateCholesterolRatio(prefix) {
            const totalCholInput = document.getElementById(`${prefix}-total-chol`);
            const hdlInput = document.getElementById(`${prefix}-hdl`);
            const ratioOutput = document.getElementById(`${prefix}-cholesterol-ratio`);
            const totalCholUnitSelector = document.getElementById(`${prefix}-total-chol-unit`);
            const hdlUnitSelector = document.getElementById(`${prefix}-hdl-unit`);
            
            if (!totalCholInput || !hdlInput || !ratioOutput) return;
            
            if (!totalCholInput.value || !hdlInput.value) {
                ratioOutput.value = '';
                return;
            }
            
            let totalChol = parseFloat(totalCholInput.value);
            let hdl = parseFloat(hdlInput.value);
            
            // Ensure matching units
            if (totalCholUnitSelector && hdlUnitSelector && totalCholUnitSelector.value !== hdlUnitSelector.value) {
                // Convert to mmol/L for consistency
                if (totalCholUnitSelector.value === 'mg/dL') {
                    totalChol = totalChol / 38.67; // mg/dL to mmol/L
                }
                
                if (hdlUnitSelector.value === 'mg/dL') {
                    hdl = hdl / 38.67; // mg/dL to mmol/L
                }
            }
            
            // Calculate ratio
            const ratio = totalChol / hdl;
            
            // Round to 1 decimal place
            ratioOutput.value = Math.round(ratio * 10) / 10;
        }
        
        /**
         * Initialize EMR/FHIR integration buttons
         */
        function initializeIntegrationButtons() {
            const fhirButton = document.getElementById('fhir-integration-button');
            const emrButton = document.getElementById('emr-integration-button');
            
            if (fhirButton) {
                fhirButton.addEventListener('click', function() {
                    showIntegrationModal('fhir');
                });
            }
            
            if (emrButton) {
                emrButton.addEventListener('click', function() {
                    showIntegrationModal('emr');
                });
            }
        }
        
        /**
         * Initialize form validation
         */
        function initializeFormValidation() {
            // Get all forms
            const forms = document.querySelectorAll('form');
            
            forms.forEach(form => {
                // Add validation on submit
                form.addEventListener('submit', function(event) {
                    const isValid = window.inputSanitizer.sanitizeForm(form);
                    
                    if (!isValid) {
                        event.preventDefault();
                        
                        // Show error message
                        const formId = form.id;
                        const prefix = formId.split('-')[0];
                        const errorContainer = document.getElementById(`${prefix}-form-error`);
                        
                        if (errorContainer) {
                            errorContainer.textContent = 'Please correct the errors in the form.';
                            errorContainer.style.display = 'block';
                            
                            // Scroll to first error
                            const firstError = form.querySelector('.error');
                            if (firstError) {
                                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    }
                });
                
                // Add validation on input change for required fields
                const requiredInputs = form.querySelectorAll('[required]');
                requiredInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        window.inputSanitizer.validateAndSanitizeInput(input);
                    });
                });
                
                // Add validation for physiological values
                const physiologicalInputs = form.querySelectorAll('[data-physiological="true"]');
                physiologicalInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        validatePhysiologicalValues(input);
                    });
                });
            });
        }
        
        /**
         * Validate physiological values for medical plausibility
         * @param {HTMLElement} input - Input element
         */
        function validatePhysiologicalValues(input) {
            if (!input || !input.value) return true;
            
            const paramType = input.getAttribute('data-param-type');
            const value = parseFloat(input.value);
            const validationMessage = document.getElementById(input.id + '-validation');
            
            // Clear previous validation
            input.classList.remove('error');
            if (validationMessage) {
                validationMessage.textContent = '';
                validationMessage.style.display = 'none';
            }
            
            let isValid = true;
            let errorMessage = '';
            
            // Enhanced physiological validation checks
            switch (paramType) {
                case 'age':
                    // Check for unrealistic age
                    if (value > 110) {
                        isValid = false;
                        errorMessage = 'Age seems unusually high. Please verify.';
                    }
                    break;
                    
                case 'height_cm':
                    // Check for unrealistic height
                    if (value < 50) {
                        isValid = false;
                        errorMessage = 'Height seems unusually low. Please verify.';
                    } else if (value > 220) {
                        isValid = false;
                        errorMessage = 'Height seems unusually high. Please verify.';
                    }
                    break;
                    
                case 'weight_kg':
                    // Check for unrealistic weight
                    if (value < 30) {
                        isValid = false;
                        errorMessage = 'Weight seems unusually low for an adult. Please verify.';
                    } else if (value > 300) {
                        isValid = false;
                        errorMessage = 'Weight seems unusually high. Please verify.';
                    }
                    break;
                    
                case 'bmi':
                    // Check for unrealistic BMI
                    if (value < 15) {
                        isValid = false;
                        errorMessage = 'BMI is extremely low. Please verify height and weight.';
                    } else if (value > 60) {
                        isValid = false;
                        errorMessage = 'BMI is extremely high. Please verify height and weight.';
                    }
                    break;
                    
                case 'sbp':
                    // Check for unrealistic systolic BP
                    if (value < 70) {
                        isValid = false;
                        errorMessage = 'Systolic BP is extremely low. Please verify.';
                    } else if (value > 220) {
                        isValid = false;
                        errorMessage = 'Systolic BP is extremely high. Please verify.';
                    }
                    break;
                    
                case 'dbp':
                    // Check for unrealistic diastolic BP
                    if (value < 40) {
                        isValid = false;
                        errorMessage = 'Diastolic BP is extremely low. Please verify.';
                    } else if (value > 140) {
                        isValid = false;
                        errorMessage = 'Diastolic BP is extremely high. Please verify.';
                    }
                    break;
                    
                case 'totalCholesterol':
                    // Check for unrealistic total cholesterol
                    // Get unit for conversion
                    const cholUnit = input.nextElementSibling ? input.nextElementSibling.value : 'mmol/L';
                    let cholValue = value;
                    
                    // Convert to mmol/L if needed
                    if (cholUnit === 'mg/dL') {
                        cholValue = value / 38.67;
                    }
                    
                    if (cholValue < 2.0) {
                        isValid = false;
                        errorMessage = 'Total cholesterol is extremely low. Please verify.';
                    } else if (cholValue > 15.0) {
                        isValid = false;
                        errorMessage = 'Total cholesterol is extremely high. Please verify.';
                    }
                    break;
                    
                case 'ldl':
                    // Check for unrealistic LDL cholesterol
                    // Get unit for conversion
                    const ldlUnit = input.nextElementSibling ? input.nextElementSibling.value : 'mmol/L';
                    let ldlValue = value;
                    
                    // Convert to mmol/L if needed
                    if (ldlUnit === 'mg/dL') {
                        ldlValue = value / 38.67;
                    }
                    
                    if (ldlValue < 0.5) {
                        isValid = false;
                        errorMessage = 'LDL cholesterol is extremely low. Please verify.';
                    } else if (ldlValue > 10.0) {
                        isValid = false;
                        errorMessage = 'LDL cholesterol is extremely high. Please verify.';
                    }
                    break;
                    
                case 'hdl':
                    // Check for unrealistic HDL cholesterol
                    // Get unit for conversion
                    const hdlUnit = input.nextElementSibling ? input.nextElementSibling.value : 'mmol/L';
                    let hdlValue = value;
                    
                    // Convert to mmol/L if needed
                    if (hdlUnit === 'mg/dL') {
                        hdlValue = value / 38.67;
                    }
                    
                    if (hdlValue < 0.4) {
                        isValid = false;
                        errorMessage = 'HDL cholesterol is extremely low. Please verify.';
                    } else if (hdlValue > 3.0) {
                        isValid = false;
                        errorMessage = 'HDL cholesterol is extremely high. Please verify.';
                    }
                    break;
                    
                // Add more physiological checks as needed
            }
            
            // Show validation message if invalid
            if (!isValid) {
                input.classList.add('error');
                if (validationMessage) {
                    validationMessage.textContent = errorMessage;
                    validationMessage.style.display = 'block';
                }
            }
            
            return isValid;
        }
        
        /**
         * Initialize cross-tab synchronization
         */
        function initializeCrossTabSync() {
            // Check for BroadcastChannel API support
            if (typeof BroadcastChannel !== 'undefined') {
                const calculationChannel = new BroadcastChannel('cvd_risk_calculations');
                
                // Listen for calculation events from other tabs
                calculationChannel.onmessage = function(event) {
                    if (event.data && event.data.type === 'calculation_complete') {
                        // Update UI based on calculation type
                        const calculationType = event.data.calculationType;
                        
                        switch (calculationType) {
                            case 'frs':
                                updateFrsStatusIndicator(true);
                                break;
                                
                            case 'qrisk':
                                updateQriskStatusIndicator(true);
                                break;
                                
                            case 'comparison':
                                // No specific action needed
                                break;
                        }
                        
                        // Check if comparison should be enabled
                        updateComparisonButtonState();
                    }
                };
                
                // Store channel for later use
                window.calculationChannel = calculationChannel;
            } else {
                // Fallback to LocalStorage for older browsers
                window.addEventListener('storage', function(event) {
                    if (event.key === 'cvd_risk_calculation_status') {
                        try {
                            const status = JSON.parse(event.newValue);
                            
                            if (status.frs) {
                                updateFrsStatusIndicator(true);
                            }
                            
                            if (status.qrisk) {
                                updateQriskStatusIndicator(true);
                            }
                            
                            // Check if comparison should be enabled
                            updateComparisonButtonState();
                        } catch (error) {
                            console.error('Error parsing calculation status:', error);
                        }
                    }
                });
            }
        }
        
        /**
         * Update FRS status indicator
         * @param {boolean} isComplete - Whether calculation is complete
         */
        function updateFrsStatusIndicator(isComplete) {
            const frsStatus = document.getElementById('frs-status');
            if (frsStatus) {
                frsStatus.textContent = isComplete ? 'Calculated' : 'Not calculated';
                frsStatus.classList.remove('incomplete');
                
                if (isComplete) {
                    frsStatus.classList.add('complete');
                } else {
                    frsStatus.classList.add('incomplete');
                }
            }
        }
        
        /**
         * Update QRISK status indicator
         * @param {boolean} isComplete - Whether calculation is complete
         */
        function updateQriskStatusIndicator(isComplete) {
            const qriskStatus = document.getElementById('qrisk-status');
            if (qriskStatus) {
                qriskStatus.textContent = isComplete ? 'Calculated' : 'Not calculated';
                qriskStatus.classList.remove('incomplete');
                
                if (isComplete) {
                    qriskStatus.classList.add('complete');
                } else {
                    qriskStatus.classList.add('incomplete');
                }
            }
        }
        
        /**
         * Update comparison button state
         */
        function updateComparisonButtonState() {
            const frsStatus = document.getElementById('frs-status');
            const qriskStatus = document.getElementById('qrisk-status');
            const comparisonButton = document.getElementById('run-comparison');
            const comparisonTab = document.getElementById('comparison-tab');
            
            if (frsStatus && qriskStatus && comparisonButton && comparisonTab) {
                const frsComplete = frsStatus.classList.contains('complete');
                const qriskComplete = qriskStatus.classList.contains('complete');
                
                if (frsComplete && qriskComplete) {
                    comparisonButton.disabled = false;
                    comparisonTab.disabled = false;
                } else {
                    comparisonButton.disabled = true;
                }
            }
        }
        
        /**
         * Show integration setup modal
         * @param {string} integrationType - Integration type (fhir, emr)
         */
        function showIntegrationModal(integrationType) {
            // Get template
            const integrationTemplate = document.getElementById('integration-setup-template');
            
            if (!integrationTemplate) {
                console.error('Integration setup template not found');
                return;
            }
            
            // Create modal from template
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal';
            modalContainer.innerHTML = integrationTemplate.innerHTML;
            
            // Update title based on integration type
            const title = modalContainer.querySelector('.modal-header h2');
            if (title) {
                title.textContent = integrationType.toUpperCase() + ' Integration Setup';
            }
            
            // Add event listeners
            const closeButton = modalContainer.querySelector('.modal-close');
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    modalContainer.classList.remove('active');
                    setTimeout(() => {
                        document.body.removeChild(modalContainer);
                    }, 300);
                });
            }
            
            const testButton = modalContainer.querySelector('#test-connection');
            if (testButton) {
                testButton.addEventListener('click', function() {
                    testIntegrationConnection(integrationType, modalContainer);
                });
            }
            
            const saveButton = modalContainer.querySelector('#save-connection');
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    saveIntegrationSettings(integrationType, modalContainer);
                });
            }
            
            // Update auth type dropdown
            const authTypeSelect = modalContainer.querySelector('#integration-auth');
            if (authTypeSelect) {
                authTypeSelect.addEventListener('change', function() {
                    updateAuthFields(this.value, modalContainer);
                });
            }
            
            // Add modal to body
            document.body.appendChild(modalContainer);
            
            // Show modal
            setTimeout(() => {
                modalContainer.classList.add('active');
            }, 10);
        }
        
        /**
         * Update authentication fields based on selected type
         * @param {string} authType - Authentication type
         * @param {HTMLElement} modalContainer - Modal container
         */
        function updateAuthFields(authType, modalContainer) {
            const authDetailsContainer = modalContainer.querySelector('#auth-details');
            
            if (!authDetailsContainer) return;
            
            // Clear previous fields
            authDetailsContainer.innerHTML = '';
            
            // Add fields based on auth type
            switch (authType) {
                case 'basic':
                    authDetailsContainer.innerHTML = `
                        <div class="form-group">
                            <label for="auth-username">Username:</label>
                            <input type="text" id="auth-username" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="auth-password">Password:</label>
                            <input type="password" id="auth-password" class="form-control" />
                        </div>
                    `;
                    break;
                    
                case 'oauth':
                    authDetailsContainer.innerHTML = `
                        <div class="form-group">
                            <label for="auth-client-id">Client ID:</label>
                            <input type="text" id="auth-client-id" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="auth-client-secret">Client Secret:</label>
                            <input type="password" id="auth-client-secret" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="auth-token-url">Token URL:</label>
                            <input type="text" id="auth-token-url" class="form-control" />
                        </div>
                    `;
                    break;
                    
                case 'token':
                    authDetailsContainer.innerHTML = `
                        <div class="form-group">
                            <label for="auth-token">API Token:</label>
                            <input type="password" id="auth-token" class="form-control" />
                        </div>
                    `;
                    break;
            }
        }
        
        /**
         * Test integration connection
         * @param {string} integrationType - Integration type
         * @param {HTMLElement} modalContainer - Modal container
         */
        function testIntegrationConnection(integrationType, modalContainer) {
            const endpoint = modalContainer.querySelector('#integration-endpoint').value;
            const authType = modalContainer.querySelector('#integration-auth').value;
            
            if (!endpoint) {
                alert('Please enter an API endpoint');
                return;
            }
            
            // Gather auth details
            let authDetails = {};
            
            switch (authType) {
                case 'basic':
                    authDetails.username = modalContainer.querySelector('#auth-username').value;
                    authDetails.password = modalContainer.querySelector('#auth-password').value;
                    break;
                    
                case 'oauth':
                    authDetails.clientId = modalContainer.querySelector('#auth-client-id').value;
                    authDetails.clientSecret = modalContainer.querySelector('#auth-client-secret').value;
                    authDetails.tokenUrl = modalContainer.querySelector('#auth-token-url').value;
                    break;
                    
                case 'token':
                    authDetails.token = modalContainer.querySelector('#auth-token').value;
                    break;
            }
            
            // Show test in progress
            const testButton = modalContainer.querySelector('#test-connection');
            const originalText = testButton.textContent;
            testButton.disabled = true;
            testButton.textContent = 'Testing...';
            
            // Simulate test - in a real application, this would make an actual API call
            setTimeout(() => {
                testButton.disabled = false;
                testButton.textContent = originalText;
                
                // Show success message
                alert('Connection test successful!');
                
                // In a real app, you would actually test the connection:
                /*
                fetch(endpoint + '/metadata', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authDetails.token // Or other auth method
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Connection test successful!');
                    } else {
                        alert('Connection test failed: ' + response.status);
                    }
                })
                .catch(error => {
                    alert('Connection test failed: ' + error.message);
                })
                .finally(() => {
                    testButton.disabled = false;
                    testButton.textContent = originalText;
                });
                */
            }, 1500);
        }
        
        /**
         * Save integration settings
         * @param {string} integrationType - Integration type
         * @param {HTMLElement} modalContainer - Modal container
         */
        function saveIntegrationSettings(integrationType, modalContainer) {
            const endpoint = modalContainer.querySelector('#integration-endpoint').value;
            const authType = modalContainer.querySelector('#integration-auth').value;
            
            if (!endpoint) {
                alert('Please enter an API endpoint');
                return;
            }
            
            // Gather auth details
            let authDetails = {
                type: authType
            };
            
            switch (authType) {
                case 'basic':
                    authDetails.username = modalContainer.querySelector('#auth-username').value;
                    authDetails.password = modalContainer.querySelector('#auth-password').value;
                    break;
                    
                case 'oauth':
                    authDetails.clientId = modalContainer.querySelector('#auth-client-id').value;
                    authDetails.clientSecret = modalContainer.querySelector('#auth-client-secret').value;
                    authDetails.tokenUrl = modalContainer.querySelector('#auth-token-url').value;
                    break;
                    
                case 'token':
                    authDetails.token = modalContainer.querySelector('#auth-token').value;
                    break;
            }
            
            // Save settings - in a real app, you would save to secure storage
            const settings = {
                endpoint: endpoint,
                auth: authDetails
            };
            
            // Encrypt sensitive data before storing
            const encryptedSettings = window.encryptionService.encrypt(settings);
            
            // Store in secure storage
            window.encryptionService.secureStore(`${integrationType}_integration`, encryptedSettings);
            
            // Update integration status
            const integrationButton = document.getElementById(`${integrationType}-integration-button`);
            if (integrationButton) {
                integrationButton.classList.add('connected');
                integrationButton.textContent = `${integrationType.toUpperCase()} (Connected)`;
            }
            
            // Close modal
            modalContainer.classList.remove('active');
            setTimeout(() => {
                document.body.removeChild(modalContainer);
            }, 300);
            
            // Show success message
            alert(`${integrationType.toUpperCase()} integration settings saved successfully!`);
        }
        
        /**
         * Show disclaimer modal
         * @param {string} disclaimerId - Disclaimer ID
         */
        function showDisclaimerModal(disclaimerId) {
            // Get modal template
            const modalTemplate = document.getElementById('modal-template');
            
            if (!modalTemplate) {
                console.error('Modal template not found');
                return;
            }
            
            // Create modal from template
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal';
            modalContainer.innerHTML = modalTemplate.innerHTML;
            
            // Set title and content based on disclaimer type
            const title = modalContainer.querySelector('.modal-title');
            const body = modalContainer.querySelector('.modal-body');
            
            if (title && body) {
                switch (disclaimerId) {
                    case 'show-clinical-disclaimer':
                        title.textContent = 'Clinical Use Disclaimer';
                        body.innerHTML = `
                            <p>This tool is intended for use by healthcare professionals only as a supplementary aid in cardiovascular risk assessment and management. The results provided are based on epidemiological data and should not replace clinical judgment.</p>
                            <p>Individual patient factors may not be fully captured by these risk algorithms, and the actual risk of a specific patient may differ from the calculated estimate. This calculator does not account for all possible risk factors or genetic predispositions.</p>
                            <p>Risk calculators are generally validated for specific populations and may have limited applicability to individuals from different ethnic backgrounds or those with specific medical conditions not accounted for in the underlying algorithms.</p>
                            <h4>Medical Responsibility</h4>
                            <p>The healthcare provider using this tool bears full responsibility for all medical decisions made with the assistance of this calculator. The developers of this tool accept no liability for any adverse outcomes resulting from decisions made based on the results provided.</p>
                            <h4>Data Privacy</h4>
                            <p>All patient data entered into this tool should be handled in accordance with applicable privacy laws and regulations. The tool itself does not store or transmit any patient data unless explicitly configured to do so via the EMR integration features.</p>
                        `;
                        break;
                        
                    case 'show-terms':
                        title.textContent = 'Terms of Use';
                        body.innerHTML = `
                            <p>By using this CVD Risk Toolkit, you agree to the following terms and conditions:</p>
                            <ol>
                                <li>This tool is provided "as is" without warranty of any kind, express or implied, including but not limited to the warranties of merchantability, fitness for a particular purpose, and non-infringement.</li>
                                <li>The developers of this tool shall not be liable for any direct, indirect, incidental, special, consequential, or exemplary damages resulting from the use or inability to use this tool.</li>
                                <li>This tool is intended for use by qualified healthcare professionals only. By using this tool, you represent that you are a qualified healthcare professional with appropriate training and licensure.</li>
                                <li>You agree not to modify, distribute, or create derivative works based on this tool without express written permission from the developers.</li>
                                <li>All patient data entered into this tool remains your responsibility. The tool does not store patient data unless configured to do so through EMR integration features.</li>
                                <li>You agree to use this tool in compliance with all applicable laws and regulations, including but not limited to healthcare privacy laws.</li>
                            </ol>
                            <p>These terms may be updated periodically. Continued use of the tool constitutes acceptance of any changes to these terms.</p>
                        `;
                        break;
                        
                    case 'show-privacy':
                        title.textContent = 'Privacy Notice';
                        body.innerHTML = `
                            <p>This privacy notice describes how patient data is handled when using this tool:</p>
                            <h4>Data Collection and Storage</h4>
                            <p>By default, this tool does not permanently store any patient data. All data entered is processed locally in your browser and is cleared when you close the application or browser tab.</p>
                            <p>If you enable the EMR integration features, patient data may be transmitted to and from your electronic medical record system according to the configuration you establish.</p>
                            <h4>Data Security</h4>
                            <p>All data processing occurs locally on your device. Any data that is temporarily stored uses industry-standard encryption.</p>
                            <p>When using the EMR integration features, data transmission occurs over secure, encrypted connections.</p>
                            <h4>Your Responsibilities</h4>
                            <p>As a healthcare professional, you remain responsible for ensuring that your use of this tool complies with all applicable privacy laws and regulations, including but not limited to HIPAA (in the United States) or similar healthcare privacy regulations in your jurisdiction.</p>
                            <p>You should not enter any personally identifiable information that is not necessary for risk calculation purposes.</p>
                        `;
                        break;
                        
                    case 'show-canadian':
                        title.textContent = 'Canadian Cardiovascular Society Guidelines';
                        body.innerHTML = `
                            <p>This tool implements recommendations from the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult.</p>
                            <h4>Risk Categories</h4>
                            <ul>
                                <li><strong>Low Risk (&lt;10%):</strong> Consider lifestyle modifications if risk factors present.</li>
                                <li><strong>Intermediate Risk (10-19%):</strong> Consider statin therapy if LDL-C ≥ 3.5 mmol/L. Target ≥ 30% reduction in LDL-C.</li>
                                <li><strong>High Risk (≥20%):</strong> Statin therapy recommended. Target LDL-C reduction of ≥ 50% and &lt; 2.0 mmol/L.</li>
                                <li><strong>Very High Risk:</strong> Intensive statin therapy recommended. Target LDL-C reduction of ≥ 50% and &lt; 1.8 mmol/L. Consider PCSK9 inhibitor if targets not achieved with statin + ezetimibe.</li>
                            </ul>
                            <h4>Very High Risk Criteria</h4>
                            <p>Patients with any of the following are considered at very high risk:</p>
                            <ul>
                                <li>Clinical atherosclerosis (coronary, cerebrovascular, or peripheral)</li>
                                <li>Abdominal aortic aneurysm</li>
                                <li>Diabetes with target organ damage or duration >15 years</li>
                                <li>Chronic kidney disease (eGFR <30 mL/min/1.73m²)</li>
                                <li>LDL-C ≥5.0 mmol/L (genetic dyslipidemia)</li>
                                <li>FRS ≥20% with additional risk factors</li>
                            </ul>
                            <p>For the full guidelines, please refer to the <a href="https://www.onlinecjc.ca/article/S0828-282X(21)00165-3/fulltext" target="_blank">Canadian Journal of Cardiology</a>.</p>
                        `;
                        break;
                        
                    case 'show-pcsk9':
                        title.textContent = 'PCSK9 Inhibitor Information';
                        body.innerHTML = `
                            <h4>PCSK9 Inhibitor Eligibility</h4>
                            <p>According to Canadian guidelines, PCSK9 inhibitors may be considered for patients with:</p>
                            <ul>
                                <li>Atherosclerotic cardiovascular disease (ASCVD) AND</li>
                                <li>LDL-C ≥1.8 mmol/L despite maximally tolerated statin therapy and ezetimibe</li>
                            </ul>
                            <p>OR</p>
                            <ul>
                                <li>Heterozygous familial hypercholesterolemia (HeFH) AND</li>
                                <li>LDL-C ≥2.5 mmol/L despite maximally tolerated statin therapy and ezetimibe</li>
                            </ul>
                            
                            <h4>BC PharmaCare Special Authority Criteria</h4>
                            <p>In British Columbia, coverage for PCSK9 inhibitors requires meeting the following criteria:</p>
                            <ol>
                                <li>Patient has either:</li>
                                <ul>
                                    <li>Clinical atherosclerosis (coronary, cerebrovascular, or peripheral arterial disease), OR</li>
                                    <li>Heterozygous familial hypercholesterolemia diagnosed by either genetic testing or clinical criteria</li>
                                </ul>
                                <li>Patient is at high cardiovascular risk based on:</li>
                                <ul>
                                    <li>A recent hospitalization for acute coronary syndrome, OR</li>
                                    <li>A history of myocardial infarction, OR</li>
                                    <li>A history of ischemic stroke, OR</li>
                                    <li>Symptomatic peripheral arterial disease</li>
                                </ul>
                                <li>Patient must be on maximally tolerated statin therapy for at least 3 months</li>
                                <li>Patient must be on ezetimibe for at least 3 months</li>
                                <li>LDL-C must remain ≥1.8 mmol/L (for ASCVD) or ≥2.5 mmol/L (for HeFH)</li>
                            </ol>
                            
                            <p>Note: Coverage criteria may change. Verify current criteria before submitting coverage applications.</p>
                        `;
                        break;
                        
                    default:
                        title.textContent = 'Information';
                        body.innerHTML = '<p>No content available.</p>';
                }
            }
            
            // Update buttons
            const cancelButton = modalContainer.querySelector('.modal-cancel');
            const acceptButton = modalContainer.querySelector('.modal-accept');
            
            if (cancelButton) {
                cancelButton.textContent = 'Close';
            }
            
            if (acceptButton) {
                acceptButton.style.display = 'none';
            }
            
            // Add event listeners
            const closeButton = modalContainer.querySelector('.modal-close');
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    modalContainer.classList.remove('active');
                    setTimeout(() => {
                        document.body.removeChild(modalContainer);
                    }, 300);
                });
            }
            
            if (cancelButton) {
                cancelButton.addEventListener('click', function() {
                    modalContainer.classList.remove('active');
                    setTimeout(() => {
                        document.body.removeChild(modalContainer);
                    }, 300);
                });
            }
            
            // Add modal to body
            document.body.appendChild(modalContainer);
            
            // Show modal
            setTimeout(() => {
                modalContainer.classList.add('active');
            }, 10);
        }
        
        /**
         * Calculate BP statistics (mean and standard deviation)
         */
        function calculateBpStatistics() {
            // Get all forms with BP readings
            const forms = ['frs', 'qrisk', 'med'];
            
            forms.forEach(formPrefix => {
                // Get SBP readings
                const readings = [];
                
                for (let i = 1; i <= 6; i++) {
                    const input = document.getElementById(`${formPrefix}-sbp-${i}`);
                    if (input && input.value) {
                        readings.push(parseFloat(input.value));
                    }
                }
                
                // Need at least 2 readings
                if (readings.length < 2) {
                    continue;
                }
                
                // Calculate mean
                const sum = readings.reduce((a, b) => a + b, 0);
                const mean = sum / readings.length;
                
                // Calculate standard deviation
                const squaredDiffs = readings.map(x => Math.pow(x - mean, 2));
                const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / readings.length;
                const standardDeviation = Math.sqrt(avgSquaredDiff);
                
                // Update fields
                const meanField = document.getElementById(`${formPrefix}-sbp-mean`);
                const sdField = document.getElementById(`${formPrefix}-sbp-sd`);
                
                if (meanField) {
                    meanField.value = Math.round(mean * 10) / 10; // Round to 1 decimal
                }
                
                if (sdField) {
                    sdField.value = Math.round(standardDeviation * 10) / 10; // Round to 1 decimal
                }
                
                // Update main SBP field with mean
                const sbpField = document.getElementById(`${formPrefix}-sbp`);
                if (sbpField) {
                    sbpField.value = Math.round(mean);
                }
            });
        }
        
        /**
         * Calculate Framingham Risk Score
         */
        function calculateFrsRisk() {
            // Show loading indicator
            const loadingIndicator = document.getElementById('frs-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            // Get form data
            const form = document.getElementById('frs-form');
            const formData = new FormData(form);
            
            // Create parameters object
            const params = {
                age: parseInt(formData.get('frs-age')),
                sex: formData.get('frs-sex'),
                sbp: parseInt(formData.get('frs-sbp')),
                cholesterol: parseFloat(formData.get('frs-total-chol')),
                hdl: parseFloat(formData.get('frs-hdl')),
                smoking: formData.get('frs-smoker') === 'yes',
                diabetes: formData.get('frs-diabetes') === 'yes',
                bpTreated: formData.get('frs-bp-treatment') === 'yes'
            };
            
            // Check for Lp(a) values
            const lpaInput = document.getElementById('frs-lpa');
            if (lpaInput && lpaInput.value) {
                const lpaValue = parseFloat(lpaInput.value);
                const lpaUnit = document.getElementById('frs-lpa-unit').value;
                
                // Standardize to mg/dL
                let lpaStandardized = lpaValue;
                if (lpaUnit === 'nmol/L') {
                    lpaStandardized = lpaValue / 2.5; // Approximate conversion
                }
                
                // Determine Lp(a) modifier
                if (lpaStandardized < 30) {
                    params.lpaModifier = 'low';
                } else if (lpaStandardized < 50) {
                    params.lpaModifier = 'moderate';
                } else if (lpaStandardized < 100) {
                    params.lpaModifier = 'high';
                } else {
                    params.lpaModifier = 'very-high';
                }
            }
            
            // Unit conversions
            const totalCholUnit = document.getElementById('frs-total-chol-unit').value;
            const hdlUnit = document.getElementById('frs-hdl-unit').value;
            
            // Convert to mmol/L if needed
            if (totalCholUnit === 'mg/dL') {
                params.cholesterol = params.cholesterol / 38.67;
            }
            
            if (hdlUnit === 'mg/dL') {
                params.hdl = params.hdl / 38.67;
            }
            
            try {
                // Calculate risk using Framingham calculator
                const result = window.framinghamCalculator.calculateRisk(params);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                if (result.success) {
                    // Create and display results
                    displayFrsResults(result);
                    
                    // Update comparison status
                    updateFrsStatusIndicator(true);
                    
                    // Check if comparison should be enabled
                    updateComparisonButtonState();
                    
                    // Broadcast calculation completion
                    broadcastCalculationComplete('frs');
                } else {
                    // Show error
                    const resultsContainer = document.getElementById('frs-results-container');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = `
                            <div class="error-alert">
                                <h4>Calculation Error</h4>
                                <p>${result.error}</p>
                                <p>${result.details ? JSON.stringify(result.details) : ''}</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('FRS calculation error:', error);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Show error
                const resultsContainer = document.getElementById('frs-results-container');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Calculation Error</h4>
                            <p>An unexpected error occurred while calculating the risk score.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Display Framingham Risk Score results
         * @param {Object} result - Calculation result
         */
        function displayFrsResults(result) {
            // Get results container
            const resultsContainer = document.getElementById('frs-results-container');
            if (!resultsContainer) return;
            
            // Get results template
            const resultsTemplate = document.getElementById('results-template');
            if (!resultsTemplate) {
                resultsContainer.innerHTML = '<p>Results template not found.</p>';
                return;
            }
            
            // Clone template
            const resultsContent = document.importNode(resultsTemplate.content, true);
            
            // Set title and date
            const resultsTitle = resultsContent.querySelector('.results-title');
            if (resultsTitle) {
                resultsTitle.textContent = 'Framingham Risk Score Assessment';
            }
            
            const resultsDate = resultsContent.querySelector('.results-date');
            if (resultsDate) {
                resultsDate.textContent = new Date().toLocaleString();
            }
            
            // Set risk values
            const baseRisk = resultsContent.querySelector('.base-risk');
            if (baseRisk) {
                baseRisk.textContent = `${result.risk}%`;
            }
            
            const modifiedRisk = resultsContent.querySelector('.modified-risk');
            if (modifiedRisk) {
                modifiedRisk.textContent = `${result.risk}%`;
            }
            
            // Show Lp(a) modifier if present
            if (result.lpaModifier && result.lpaModifier !== 'none') {
                const lpaContainer = resultsContent.querySelector('.lpa-modifier-container');
                const lpaValue = resultsContent.querySelector('.lpa-modifier');
                
                if (lpaContainer && lpaValue) {
                    lpaContainer.style.display = 'block';
                    
                    let modifierText = '';
                    switch (result.lpaModifier) {
                        case 'low':
                            modifierText = 'No increase';
                            break;
                        case 'moderate':
                            modifierText = '20% increase';
                            break;
                        case 'high':
                            modifierText = '50% increase';
                            break;
                        case 'very-high':
                            modifierText = '100% increase';
                            break;
                    }
                    
                    lpaValue.textContent = modifierText;
                }
            }
            
            // Set risk category
            const riskCategory = resultsContent.querySelector('.risk-category');
            if (riskCategory) {
                riskCategory.textContent = result.categoryDescription;
                riskCategory.className = 'risk-category ' + result.riskCategory + '-risk';
            }
            
            // Set treatment recommendations
            const treatmentPrimary = resultsContent.querySelector('.treatment-primary');
            const treatmentSecondary = resultsContent.querySelector('.treatment-secondary');
            
            if (treatmentPrimary && treatmentSecondary) {
                // Set recommendations based on risk category
                switch (result.riskCategory) {
                    case 'low':
                        treatmentPrimary.textContent = 'Consider lifestyle modifications if risk factors present.';
                        treatmentSecondary.innerHTML = `
                            <li>Emphasize healthy diet, regular physical activity, and smoking cessation if applicable.</li>
                            <li>Monitor lipid profile annually.</li>
                            <li>Reassess cardiovascular risk every 5 years.</li>
                        `;
                        break;
                        
                    case 'intermediate':
                        treatmentPrimary.textContent = 'Consider statin therapy if LDL-C ≥ 3.5 mmol/L.';
                        treatmentSecondary.innerHTML = `
                            <li>Target ≥ 30% reduction in LDL-C.</li>
                            <li>Lifestyle modifications strongly recommended.</li>
                            <li>Monitor lipid profile every 6-12 months.</li>
                            <li>Consider additional risk factors (family history, Lp(a), etc.) for decision-making.</li>
                        `;
                        break;
                        
                    case 'high':
                        treatmentPrimary.textContent = 'Statin therapy recommended.';
                        treatmentSecondary.innerHTML = `
                            <li>Target LDL-C reduction of ≥ 50% and < 2.0 mmol/L.</li>
                            <li>Consider high-intensity statin therapy (atorvastatin 40-80 mg or rosuvastatin 20-40 mg).</li>
                            <li>If target not achieved, consider adding ezetimibe.</li>
                            <li>Monitor lipid profile every 3-6 months until target achieved, then annually.</li>
                            <li>Lifestyle modifications strongly recommended.</li>
                        `;
                        break;
                }
            }
            
            // Set rationale
            const rationale = resultsContent.querySelector('.treatment-rationale');
            if (rationale) {
                rationale.innerHTML = `
                    <h4>Clinical Rationale</h4>
                    <p>Recommendations are based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult.</p>
                    <p>The Framingham Risk Score estimates the 10-year risk of developing cardiovascular disease based on age, sex, smoking status, systolic blood pressure, blood pressure treatment, diabetes status, and lipid profile.</p>
                `;
            }
            
            // Create visualization
            createRiskMeter(resultsContent.querySelector('.risk-meter-marker'), result.risk);
            
            // Add event listeners to buttons
            const printButton = resultsContent.querySelector('.results-print');
            const exportButton = resultsContent.querySelector('.results-export');
            
            if (printButton) {
                printButton.addEventListener('click', function() {
                    window.print();
                });
            }
            
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    exportResultsAsPDF('frs');
                });
            }
            
            // Clear container and add results
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(resultsContent);
            
            // Store result for comparison
            window.lastFrsResult = result;
        }
        
        /**
         * Create risk meter visualization
         * @param {HTMLElement} marker - Risk meter marker element
         * @param {number} risk - Risk percentage
         */
        function createRiskMeter(marker, risk) {
            if (!marker) return;
            
            // Cap risk at 30% for visualization
            const cappedRisk = Math.min(risk, 30);
            
            // Calculate position (0% = left edge, 30% = right edge)
            const position = (cappedRisk / 30) * 100;
            
            // Set marker position
            marker.style.left = `${position}%`;
            
            // Set marker color based on risk category
            if (risk < 10) {
                marker.style.backgroundColor = '#28a745'; // Green for low risk
            } else if (risk < 20) {
                marker.style.backgroundColor = '#ffc107'; // Yellow for intermediate risk
            } else {
                marker.style.backgroundColor = '#dc3545'; // Red for high risk
            }
        }
        
        /**
         * Calculate QRISK3 score
         */
        function calculateQriskRisk() {
            // Show loading indicator
            const loadingIndicator = document.getElementById('qrisk-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            // Get form data
            const form = document.getElementById('qrisk-form');
            const formData = new FormData(form);
            
            // Create parameters object
            const params = {
                age: parseInt(formData.get('qrisk-age')),
                sex: formData.get('qrisk-sex'),
                ethnicity: formData.get('qrisk-ethnicity'),
                sbp: parseInt(formData.get('qrisk-sbp')),
                cholHDLRatio: parseFloat(formData.get('qrisk-cholesterol-ratio')),
                smoking: formData.get('qrisk-smoker'),
                diabetes: formData.get('qrisk-diabetes'),
                treatedHyp: formData.get('qrisk-bp-treatment') === 'true',
                family: formData.get('qrisk-family-history') === 'on',
                af: formData.get('qrisk-atrial-fibrillation') === 'on',
                renal: formData.get('qrisk-chronic-kidney-disease') === 'on',
                migraines: formData.get('qrisk-migraine') === 'on',
                ra: formData.get('qrisk-rheumatoid-arthritis') === 'on',
                sle: formData.get('qrisk-sle') === 'on',
                psychosis: formData.get('qrisk-severe-mental-illness') === 'on',
                atypicalAntipsy: formData.get('qrisk-atypical-antipsychotics') === 'on',
                steroids: formData.get('qrisk-regular-steroids') === 'on',
                erectileDys: formData.get('qrisk-erectile-dysfunction') === 'on'
            };
            
            // Add BMI or height/weight
            const bmiInput = document.getElementById('qrisk-bmi');
            if (bmiInput && bmiInput.value) {
                params.bmi = parseFloat(bmiInput.value);
            } else {
                const heightInput = document.getElementById('qrisk-height');
                const weightInput = document.getElementById('qrisk-weight');
                
                if (heightInput && weightInput && heightInput.value && weightInput.value) {
                    let height = parseFloat(heightInput.value);
                    let weight = parseFloat(weightInput.value);
                    
                    // Convert units if needed
                    const heightUnit = document.getElementById('qrisk-height-unit').value;
                    const weightUnit = document.getElementById('qrisk-weight-unit').value;
                    
                    if (heightUnit === 'in') {
                        height = height * 2.54; // inches to cm
                    }
                    
                    if (weightUnit === 'lb') {
                        weight = weight * 0.453592; // pounds to kg
                    }
                    
                    params.height = height;
                    params.weight = weight;
                }
            }
            
            // Add Townsend score if provided
            const townsendInput = document.getElementById('qrisk-townsend');
            if (townsendInput && townsendInput.value) {
                params.town = parseFloat(townsendInput.value);
            }
            
            // Add BP readings if available
            const sbpReadings = [];
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`qrisk-sbp-${i}`);
                if (input && input.value) {
                    sbpReadings.push(parseFloat(input.value));
                }
            }
            
            if (sbpReadings.length >= 2) {
                params.sbpReadings = sbpReadings;
            }
            
            // Check for Lp(a) values
            const lpaInput = document.getElementById('qrisk-lpa');
            if (lpaInput && lpaInput.value) {
                const lpaValue = parseFloat(lpaInput.value);
                const lpaUnit = document.getElementById('qrisk-lpa-unit').value;
                
                // Standardize to mg/dL
                let lpaStandardized = lpaValue;
                if (lpaUnit === 'nmol/L') {
                    lpaStandardized = lpaValue / 2.5; // Approximate conversion
                }
                
                // Determine Lp(a) modifier
                if (lpaStandardized < 30) {
                    params.lpaModifier = 'low';
                } else if (lpaStandardized < 50) {
                    params.lpaModifier = 'moderate';
                } else if (lpaStandardized < 100) {
                    params.lpaModifier = 'high';
                } else {
                    params.lpaModifier = 'very-high';
                }
            }
            
            try {
                // Calculate risk using QRISK3 calculator
                const result = window.qrisk3Calculator.calculateRisk(params);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                if (result.success) {
                    // Create and display results
                    displayQriskResults(result);
                    
                    // Update comparison status
                    updateQriskStatusIndicator(true);
                    
                    // Check if comparison should be enabled
                    updateComparisonButtonState();
                    
                    // Broadcast calculation completion
                    broadcastCalculationComplete('qrisk');
                } else {
                    // Show error
                    const resultsContainer = document.getElementById('qrisk-results-container');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = `
                            <div class="error-alert">
                                <h4>Calculation Error</h4>
                                <p>${result.error}</p>
                                <p>${result.details ? JSON.stringify(result.details) : ''}</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('QRISK3 calculation error:', error);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Show error
                const resultsContainer = document.getElementById('qrisk-results-container');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="error-alert">
                            <h4>Calculation Error</h4>
                            <p>An unexpected error occurred while calculating the risk score.</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Display QRISK3 results
         * @param {Object} result - Calculation result
         */
        function displayQriskResults(result) {
            // Get results container
            const resultsContainer = document.getElementById('qrisk-results-container');
            if (!resultsContainer) return;
            
            // Get results template
            const resultsTemplate = document.getElementById('results-template');
            if (!resultsTemplate) {
                resultsContainer.innerHTML = '<p>Results template not found.</p>';
                return;
            }
            
            // Clone template
            const resultsContent = document.importNode(resultsTemplate.content, true);
            
            // Set title and date
            const resultsTitle = resultsContent.querySelector('.results-title');
            if (resultsTitle) {
                resultsTitle.textContent = 'QRISK3 Assessment';
            }
            
            const resultsDate = resultsContent.querySelector('.results-date');
            if (resultsDate) {
                resultsDate.textContent = new Date().toLocaleString();
            }
            
            // Set risk values
            const baseRisk = resultsContent.querySelector('.base-risk');
            if (baseRisk) {
                baseRisk.textContent = `${result.risk}%`;
            }
            
            const modifiedRisk = resultsContent.querySelector('.modified-risk');
            if (modifiedRisk) {
                modifiedRisk.textContent = `${result.risk}%`;
            }
            
            // Show Lp(a) modifier if present
            if (result.lpaModifier && result.lpaModifier !== 'none') {
                const lpaContainer = resultsContent.querySelector('.lpa-modifier-container');
                const lpaValue = resultsContent.querySelector('.lpa-modifier');
                
                if (lpaContainer && lpaValue) {
                    lpaContainer.style.display = 'block';
                    
                    let modifierText = '';
                    switch (result.lpaModifier) {
                        case 'low':
                            modifierText = 'No increase';
                            break;
                        case 'moderate':
                            modifierText = '20% increase';
                            break;
                        case 'high':
                            modifierText = '50% increase';
                            break;
                        case 'very-high':
                            modifierText = '100% increase';
                            break;
                    }
                    
                    lpaValue.textContent = modifierText;
                }
            }
            
            // Set risk category
            const riskCategory = resultsContent.querySelector('.risk-category');
            if (riskCategory) {
                riskCategory.textContent = result.categoryDescription;
                riskCategory.className = 'risk-category ' + result.riskCategory + '-risk';
            }
            
            // Set treatment recommendations
            const treatmentPrimary = resultsContent.querySelector('.treatment-primary');
            const treatmentSecondary = resultsContent.querySelector('.treatment-secondary');
            
            if (treatmentPrimary && treatmentSecondary) {
                // Set recommendations based on risk category
                switch (result.riskCategory) {
                    case 'low':
                        treatmentPrimary.textContent = 'Consider lifestyle modifications if risk factors present.';
                        treatmentSecondary.innerHTML = `
                            <li>Emphasize healthy diet, regular physical activity, and smoking cessation if applicable.</li>
                            <li>Monitor lipid profile annually.</li>
                            <li>Reassess cardiovascular risk every 5 years.</li>
                        `;
                        break;
                        
                    case 'intermediate':
                        treatmentPrimary.textContent = 'Consider statin therapy if LDL-C ≥ 3.5 mmol/L.';
                        treatmentSecondary.innerHTML = `
                            <li>Target ≥ 30% reduction in LDL-C.</li>
                            <li>Lifestyle modifications strongly recommended.</li>
                            <li>Monitor lipid profile every 6-12 months.</li>
                            <li>Consider additional risk factors (family history, Lp(a), etc.) for decision-making.</li>
                        `;
                        break;
                        
                    case 'high':
                        treatmentPrimary.textContent = 'Statin therapy recommended.';
                        treatmentSecondary.innerHTML = `
                            <li>Target LDL-C reduction of ≥ 50% and < 2.0 mmol/L.</li>
                            <li>Consider high-intensity statin therapy (atorvastatin 40-80 mg or rosuvastatin 20-40 mg).</li>
                            <li>If target not achieved, consider adding ezetimibe.</li>
                            <li>Monitor lipid profile every 3-6 months until target achieved, then annually.</li>
                            <li>Lifestyle modifications strongly recommended.</li>
                        `;
                        break;
                }
            }
            
            // Set rationale
            const rationale = resultsContent.querySelector('.treatment-rationale');
            if (rationale) {
                rationale.innerHTML = `
                    <h4>Clinical Rationale</h4>
                    <p>Recommendations are based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult.</p>
                    <p>QRISK3 is a comprehensive risk calculator that includes additional risk factors such as ethnicity, family history, atrial fibrillation, rheumatoid arthritis, and more. It estimates the 10-year risk of developing cardiovascular disease.</p>
                `;
            }
            
            // Create visualization
            createRiskMeter(resultsContent.querySelector('.risk-meter-marker'), result.risk);
            
            // Add event listeners to buttons
            const printButton = resultsContent.querySelector('.results-print');
            const exportButton = resultsContent.querySelector('.results-export');
            
            if (printButton) {
                printButton.addEventListener('click', function() {
                    window.print();
                });
            }
            
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    exportResultsAsPDF('qrisk');
                });
            }
            
            // Clear container and add results
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(resul                // Add other risk factors
                score += coef.cholHDLRatio * (params.cholHDLRatio - constants.cholHDLRatio);
                
                // Add smoking categories
                if (params.smokeCat === 2) score += coef.smokeCat2;
                if (params.smokeCat === 3) score += coef.smokeCat3;
                if (params.smokeCat === 4) score += coef.smokeCat4;
                
                // Add diabetes categories
                if (params.diabCat === 1) score += coef.diab1;
                if (params.diabCat === 2) score += coef.diab2;
                
                // Add all other binary factors
                if (params.family === 1) score += coef.family;
                if (params.af === 1) score += coef.af;
                if (params.renal === 1) score += coef.renal;
                if (params.treatedHyp === 1) score += coef.treatedHyp;
                if (params.migraines === 1) score += coef.migraines;
                if (params.ra === 1) score += coef.ra;
                if (params.sle === 1) score += coef.sle;
                if (params.psychosis === 1) score += coef.psychosis;
                if (params.erectileDys === 1) score += coef.erectileDys;
                if (params.atypicalAntipsy === 1) score += coef.atypicalAntipsy;
                if (params.steroids === 1) score += coef.steroids;
                
                // Add town and BP variability
                score += coef.town * (params.town - constants.town);
                score += coef.bpVariability * (params.bpVariability - constants.sbpStd);
                
                // Add ethnicity
                score += params.ethnicCoef;
                
                // Convert to risk percentage
                const survival = this.baselineSurvival.male;
                const risk = 100 * (1 - Math.pow(survival, Math.exp(score)));
                
                if (this.debugMode) {
                    console.log('Male Risk Calculation:', {
                        score,
                        survival,
                        risk,
                        params
                    });
                }
                
                return risk;
            }
            
            /**
             * Calculate age terms for QRISK3
             * @param {number} age - Age in years
             * @param {number} meanAge - Mean age from constants
             * @returns {Object} Age terms
             * @private
             */
            calculateAgeTerms(age, meanAge) {
                const centeredAge = age - meanAge;
                return {
                    term1: centeredAge,
                    term2: centeredAge * centeredAge
                };
            }
            
            /**
             * Calculate BMI terms for QRISK3
             * @param {number} bmi - BMI
             * @param {number} meanBmi - Mean BMI from constants
             * @returns {Object} BMI terms
             * @private
             */
            calculateBmiTerms(bmi, meanBmi) {
                // Cap BMI to valid range
                const cappedBmi = Math.min(Math.max(bmi, 15), 47);
                const centeredBmi = Math.log(cappedBmi) - Math.log(meanBmi);
                
                return {
                    term1: centeredBmi,
                    term2: centeredBmi * centeredBmi
                };
            }
            
            /**
             * Apply Lipoprotein(a) modifier to risk score
             * @param {number} risk - Risk percentage
             * @param {Object} params - Risk parameters
             * @returns {number} Modified risk percentage
             * @private
             */
            applyLipoproteinAModifier(risk, params) {
                let modifier = 1.0; // Default: no change
                
                // Apply modifier based on Lp(a) level
                switch (params.lpaModifier) {
                    case 'low':
                        modifier = 1.0; // No change
                        break;
                    case 'moderate':
                        modifier = 1.2; // 20% increase
                        break;
                    case 'high':
                        modifier = 1.5; // 50% increase
                        break;
                    case 'very-high':
                        modifier = 2.0; // Double risk
                        break;
                    case 'custom':
                        // Use custom modifier if provided
                        if (params.lpaCustomModifier && !isNaN(params.lpaCustomModifier)) {
                            modifier = parseFloat(params.lpaCustomModifier);
                        }
                        break;
                }
                
                // Apply modifier and return new risk
                return risk * modifier;
            }
            
            /**
             * Determine risk category based on Canadian Cardiovascular Society guidelines
             * @param {number} risk - Risk percentage
             * @returns {Object} Risk category
             * @private
             */
            determineRiskCategory(risk) {
                // Canadian Cardiovascular Society 2021 Guidelines
                if (risk < 10) {
                    return {
                        category: 'low',
                        description: 'Low Risk (<10%)',
                        recommendation: 'Consider lifestyle modifications if risk factors present.'
                    };
                } else if (risk < 20) {
                    return {
                        category: 'intermediate',
                        description: 'Intermediate Risk (10-19%)',
                        recommendation: 'Consider statin therapy if LDL-C ≥ 3.5 mmol/L. Target ≥ 30% reduction in LDL-C.'
                    };
                } else {
                    return {
                        category: 'high',
                        description: 'High Risk (≥20%)',
                        recommendation: 'Statin therapy recommended. Target LDL-C reduction of ≥ 50% and < 2.0 mmol/L.'
                    };
                }
            }
            
            /**
             * Enable or disable debug mode
             * @param {boolean} enable - Whether to enable debug mode
             */
            setDebugMode(enable) {
                this.debugMode = enable;
            }
        }
        
        // Create global calculator instance
        window.qrisk3Calculator = new QRISK3Calculator();
    </script>
    
    <!-- Framingham Risk Score Implementation -->
    <script>
        /**
         * Framingham Risk Score Calculator
         * Based on the 2008 Framingham Heart Study General CVD Risk Score
         */
        class FraminghamCalculator {
            constructor() {
                // Initialize coefficients and constants
                this.initializeCoefficients();
                
                // Validation rules
                this.validationRules = {
                    age: { min: 30, max: 79 },
                    sbp: { min: 90, max: 200 },
                    tc: { min: 2.0, max: 15.0 },
                    hdl: { min: 0.4, max: 5.0 }
                };
                
                // Debug mode flag
                this.debugMode = false;
            }
            
            /**
             * Initialize Framingham coefficients
             * @private
             */
            initializeCoefficients() {
                // Coefficients for women - 2008 FHS General CVD Risk
                this.femaleCoef = {
                    ln_age: 2.32888,
                    ln_tc: 1.20904,
                    ln_hdl: -0.70833,
                    ln_sbp_untreated: 2.76157,
                    ln_sbp_treated: 2.82263,
                    smoker: 0.52873,
                    diabetes: 0.69154,
                    baselineSurvival: 0.95012,
                    meanTerms: 26.1931
                };
                
                // Coefficients for men - 2008 FHS General CVD Risk
                this.maleCoef = {
                    ln_age: 3.06117,
                    ln_tc: 1.12370,
                    ln_hdl: -0.93263,
                    ln_sbp_untreated: 1.93303,
                    ln_sbp_treated: 1.99881,
                    smoker: 0.65451,
                    diabetes: 0.57367,
                    baselineSurvival: 0.88936,
                    meanTerms: 23.9802
                };
            }
            
            /**
             * Calculate Framingham Risk Score
             * @param {Object} params - Risk factors
             * @returns {Object} Risk calculation results
             */
            calculateRisk(params) {
                try {
                    // Validate parameters
                    const validationResult = this.validateParameters(params);
                    if (!validationResult.isValid) {
                        return {
                            success: false,
                            error: validationResult.error,
                            details: validationResult.details
                        };
                    }
                    
                    // Process parameters
                    const processedParams = this.processParameters(params);
                    
                    // Calculate the risk
                    let risk;
                    if (processedParams.sex === 'female') {
                        risk = this.calculateFemaleRisk(processedParams);
                    } else {
                        risk = this.calculateMaleRisk(processedParams);
                    }
                    
                    // Apply Lp(a) modifier if present
                    if (params.lpaModifier && params.lpaModifier !== 'none') {
                        risk = this.applyLipoproteinAModifier(risk, params);
                    }
                    
                    // Determine risk category based on Canadian guidelines
                    const riskCategory = this.determineRiskCategory(risk);
                    
                    // Create result object
                    return {
                        success: true,
                        risk: Math.round(risk * 10) / 10, // Round to 1 decimal place
                        riskPercentage: Math.round(risk * 10) / 10,
                        riskCategory: riskCategory.category,
                        categoryDescription: riskCategory.description,
                        inputs: processedParams,
                        algorithm: 'Framingham-General-CVD-2008',
                        lpaModifier: params.lpaModifier || 'none'
                    };
                } catch (error) {
                    console.error('Error calculating Framingham Risk Score:', error);
                    return {
                        success: false,
                        error: 'Error calculating Framingham Risk Score',
                        details: error.message
                    };
                }
            }
            
            /**
             * Validate input parameters
             * @param {Object} params - Risk factors
             * @returns {Object} Validation result
             * @private
             */
            validateParameters(params) {
                const requiredParams = ['age', 'sex', 'sbp', 'cholesterol', 'hdl', 'smoking', 'diabetes'];
                const missing = requiredParams.filter(param => !(param in params));
                
                if (missing.length > 0) {
                    return {
                        isValid: false,
                        error: `Missing required parameters: ${missing.join(', ')}`,
                        details: { missing }
                    };
                }
                
                // Check param types and ranges
                const errors = [];
                
                // Age validation (30-79)
                if (params.age < this.validationRules.age.min || params.age > this.validationRules.age.max) {
                    errors.push(`Age must be between ${this.validationRules.age.min} and ${this.validationRules.age.max}`);
                }
                
                // Blood pressure validation
                if (params.sbp < this.validationRules.sbp.min || params.sbp > this.validationRules.sbp.max) {
                    errors.push(`Systolic blood pressure must be between ${this.validationRules.sbp.min} and ${this.validationRules.sbp.max}`);
                }
                
                // Cholesterol validation
                if (params.cholesterol < this.validationRules.tc.min || params.cholesterol > this.validationRules.tc.max) {
                    errors.push(`Total cholesterol must be between ${this.validationRules.tc.min} and ${this.validationRules.tc.max}`);
                }
                
                // HDL validation
                if (params.hdl < this.validationRules.hdl.min || params.hdl > this.validationRules.hdl.max) {
                    errors.push(`HDL cholesterol must be between ${this.validationRules.hdl.min} and ${this.validationRules.hdl.max}`);
                }
                
                // Sex validation
                if (!['male', 'female'].includes(params.sex.toLowerCase())) {
                    errors.push("Sex must be 'male' or 'female'");
                }
                
                // Smoking validation
                if (typeof params.smoking !== 'boolean' && !['yes', 'no', 'true', 'false', 0, 1].includes(params.smoking)) {
                    errors.push("Smoking must be a boolean value (true/false, yes/no, or 0/1)");
                }
                
                // Diabetes validation
                if (typeof params.diabetes !== 'boolean' && !['yes', 'no', 'true', 'false', 0, 1].includes(params.diabetes)) {
                    errors.push("Diabetes must be a boolean value (true/false, yes/no, or 0/1)");
                }
                
                if (errors.length > 0) {
                    return {
                        isValid: false,
                        error: 'Parameter validation errors',
                        details: { errors }
                    };
                }
                
                return { isValid: true };
            }
            
            /**
             * Process input parameters for calculation
             * @param {Object} params - Risk factors
             * @returns {Object} Processed parameters
             * @private
             */
            processParameters(params) {
                const processed = { ...params };
                
                // Convert sex to lowercase
                processed.sex = params.sex.toLowerCase();
                
                // Normalize boolean values
                processed.smoking = this.normalizeBooleanValue(params.smoking);
                processed.diabetes = this.normalizeBooleanValue(params.diabetes);
                processed.bpTreated = this.normalizeBooleanValue(params.bpTreated);
                
                // Process height and weight if provided
                if ('height' in params && 'weight' in params) {
                    const heightM = params.height / 100; // Convert cm to m
                    processed.bmi = params.weight / (heightM * heightM);
                }
                
                return processed;
            }
            
            /**
             * Normalize boolean value from various formats
             * @param {any} value - Boolean value in various formats
             * @returns {boolean} Normalized boolean
             * @private
             */
            normalizeBooleanValue(value) {
                if (typeof value === 'boolean') {
                    return value;
                }
                
                if (typeof value === 'number') {
                    return value !== 0;
                }
                
                if (typeof value === 'string') {
                    const lowerValue = value.toLowerCase();
                    return lowerValue === 'yes' || lowerValue === 'true' || lowerValue === '1';
                }
                
                return false;
            }
            
            /**
             * Calculate female Framingham risk
             * @param {Object} params - Processed risk factors
             * @returns {number} 10-year risk percentage
             * @private
             */
            calculateFemaleRisk(params) {
                const coef = this.femaleCoef;
                
                // Calculate sum of terms
                let sum = 0;
                
                // Add age term
                sum += coef.ln_age * Math.log(params.age);
                
                // Add total cholesterol term
                sum += coef.ln_tc * Math.log(params.cholesterol);
                
                // Add HDL term
                sum += coef.ln_hdl * Math.log(params.hdl);
                
                // Add SBP term based on treatment status
                if (params.bpTreated) {
                    sum += coef.ln_sbp_treated * Math.log(params.sbp);
                } else {
                    sum += coef.ln_sbp_untreated * Math.log(params.sbp);
                }
                
                // Add smoking term
                if (params.smoking) {
                    sum += coef.smoker;
                }
                
                // Add diabetes term
                if (params.diabetes) {
                    sum += coef.diabetes;
                }
                
                // Calculate risk
                const risk = 100 * (1 - Math.pow(coef.baselineSurvival, Math.exp(sum - coef.meanTerms)));
                
                if (this.debugMode) {
                    console.log('Female Framingham Risk Calculation:', {
                        sum,
                        baselineSurvival: coef.baselineSurvival,
                        meanTerms: coef.meanTerms,
                        risk,
                        params
                    });
                }
                
                return risk;
            }
            
            /**
             * Calculate male Framingham risk
             * @param {Object} params - Processed risk factors
             * @returns {number} 10-year risk percentage
             * @private
             */
            calculateMaleRisk(params) {
                const coef = this.maleCoef;
                
                // Calculate sum of terms
                let sum = 0;
                
                // Add age term
                sum += coef.ln_age * Math.log(params.age);
                
                // Add total cholesterol term
                sum += coef.ln_tc * Math.log(params.cholesterol);
                
                // Add HDL term
                sum += coef.ln_hdl * Math.log(params.hdl);
                
                // Add SBP term based on treatment status
                if (params.bpTreated) {
                    sum += coef.ln_sbp_treated * Math.log(params.sbp);
                } else {
                    sum += coef.ln_sbp_untreated * Math.log(params.sbp);
                }
                
                // Add smoking term
                if (params.smoking) {
                    sum += coef.smoker;
                }
                
                // Add diabetes term
                if (params.diabetes) {
                    sum += coef.diabetes;
                }
                
                // Calculate risk
                const risk = 100 * (1 - Math.pow(coef.baselineSurvival, Math.exp(sum - coef.meanTerms)));
                
                if (this.debugMode) {
                    console.log('Male Framingham Risk Calculation:', {
                        sum,
                        baselineSurvival: coef.baselineSurvival,
                        meanTerms: coef.meanTerms,
                        risk,
                        params
                    });
                }
                
                return risk;
            }
            
            /**
             * Apply Lipoprotein(a) modifier to risk score
             * @param {number} risk - Risk percentage
             * @param {Object} params - Risk parameters
             * @returns {number} Modified risk percentage
             * @private
             */
            applyLipoproteinAModifier(risk, params) {
                let modifier = 1.0; // Default: no change
                
                // Apply modifier based on Lp(a) level
                switch (params.lpaModifier) {
                    case 'low':
                        modifier = 1.0; // No change
                        break;
                    case 'moderate':
                        modifier = 1.2; // 20% increase
                        break;
                    case 'high':
                        modifier = 1.5; // 50% increase
                        break;
                    case 'very-high':
                        modifier = 2.0; // Double risk
                        break;
                    case 'custom':
                        // Use custom modifier if provided
                        if (params.lpaCustomModifier && !isNaN(params.lpaCustomModifier)) {
                            modifier = parseFloat(params.lpaCustomModifier);
                        }
                        break;
                }
                
                // Apply modifier and return new risk
                return risk * modifier;
            }
            
            /**
             * Determine risk category based on Canadian Cardiovascular Society guidelines
             * @param {number} risk - Risk percentage
             * @returns {Object} Risk category
             * @private
             */
            determineRiskCategory(risk) {
                // Canadian Cardiovascular Society 2021 Guidelines
                if (risk < 10) {
                    return {
                        category: 'low',
                        description: 'Low Risk (<10%)',
                        recommendation: 'Consider lifestyle modifications if risk factors present.'
                    };
                } else if (risk < 20) {
                    return {
                        category: 'intermediate',
                        description: 'Intermediate Risk (10-19%)',
                        recommendation: 'Consider statin therapy if LDL-C ≥ 3.5 mmol/L. Target ≥ 30% reduction in LDL-C.'
                    };
                } else {
                    return {
                        category: 'high',
                        description: 'High Risk (≥20%)',
                        recommendation: 'Statin therapy recommended. Target LDL-C reduction of ≥ 50% and < 2.0 mmol/L.'
                    };
                }
            }
            
            /**
             * Enable or disable debug mode
             * @param {boolean} enable - Whether to enable debug mode
             */
            setDebugMode(enable) {
                this.debugMode = enable;
            }
        }
        
        // Create global calculator instance
        window.framinghamCalculator = new FraminghamCalculator();
    </script>
    
    <!-- Input Sanitization Implementation -->
    <script>
        /**
         * Input Sanitization Module
         * Provides comprehensive input sanitization for security
         */
        class InputSanitizer {
            constructor() {
                // Regular expressions for validation
                this.patterns = {
                    // Basic patterns
                    alphanumeric: /^[a-zA-Z0-9]+$/,
                    alphabetic: /^[a-zA-Z]+$/,
                    numeric: /^[0-9]+$/,
                    email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
                    url: /^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([/\w .-]*)*\/?$/,
                    
                    // Medical data patterns
                    age: /^([1-9][0-9]?|1[0-1][0-9]|120)$/, // 1-120
                    systolicBP: /^([6-9][0-9]|[1-2][0-9]{2}|300)$/, // 60-300
                    diastolicBP: /^([3-9][0-9]|[1-1][0-9]{2}|200)$/, // 30-200
                    cholesterol: /^([0-9]|[1-9][0-9])(\.[0-9]{1,2})?$/, // 0-99.99
                    height: /^([0-9]{2,3})(\.[0-9]{1,2})?$/, // 10-999.99
                    weight: /^([0-9]{1,3})(\.[0-9]{1,2})?$/, // 0-999.99
                    
                    // HTML pattern for detecting potentially dangerous tags
                    dangerousHtml: /<script|<iframe|<object|<embed|<form|javascript:|on\w+=/i
                };
                
                // Dangerous attributes that should be removed
                this.dangerousAttributes = [
                    'onload', 'onerror', 'onclick', 'onmouseover', 'onfocus', 'onblur',
                    'onkeydown', 'onkeyup', 'onkeypress', 'onchange', 'onsubmit',
                    'formaction', 'href', 'xlink:href', 'action'
                ];
                
                // Initialize automatic form sanitization
                this._initializeFormSanitization();
            }
            
            /**
             * Set up automatic sanitization for all forms
             * @private
             */
            _initializeFormSanitization() {
                document.addEventListener('DOMContentLoaded', () => {
                    // Add submit event listeners to all forms
                    const forms = document.querySelectorAll('form');
                    forms.forEach(form => {
                        form.addEventListener('submit', (event) => {
                            this.sanitizeForm(form);
                        });
                    });
                    
                    // Add input event listeners to form elements with validation attributes
                    const inputs = document.querySelectorAll('input[data-validation-type], select[data-validation-type], textarea[data-validation-type]');
                    inputs.forEach(input => {
                        input.addEventListener('input', () => {
                            this.validateAndSanitizeInput(input);
                        });
                        
                        // Initial validation
                        this.validateAndSanitizeInput(input);
                    });
                });
            }
            
            /**
             * Sanitize text input
             * @param {string} input - Text to sanitize
             * @param {boolean} [allowHtml=false] - Whether to allow safe HTML tags
             * @returns {string} Sanitized text
             */
            sanitizeText(input, allowHtml = false) {
                if (input === null || input === undefined) {
                    return '';
                }
                
                // Convert to string
                const text = String(input);
                
                if (allowHtml) {
                    // Allow safe HTML but remove dangerous elements and attributes
                    return this.sanitizeHtml(text);
                } else {
                    // Escape all HTML
                    return this.escapeHtml(text);
                }
            }
            
            /**
             * Escape HTML special characters
             * @param {string} html - HTML string to escape
             * @returns {string} Escaped HTML
             */
            escapeHtml(html) {
                const div = document.createElement('div');
                div.textContent = html;
                return div.innerHTML;
            }
            
            /**
             * Sanitize HTML allowing safe tags but removing dangerous ones
             * @param {string} html - HTML to sanitize
             * @returns {string} Sanitized HTML
             */
            sanitizeHtml(html) {
                // Check if DOMPurify is available (preferred)
                if (typeof DOMPurify !== 'undefined') {
                    return DOMPurify.sanitize(html);
                }
                
                // Fallback sanitization
                try {
                    // Create a DOM parser
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Remove dangerous elements
                    const dangerousElements = doc.querySelectorAll('script, iframe, object, embed, form');
                    dangerousElements.forEach(element => {
                        element.parentNode.removeChild(element);
                    });
                    
                    // Remove dangerous attributes from all elements
                    const allElements = doc.querySelectorAll('*');
                    allElements.forEach(element => {
                        this.dangerousAttributes.forEach(attr => {
                            if (element.hasAttribute(attr)) {
                                element.removeAttribute(attr);
                            }
                        });
                        
                        // Remove style attributes with javascript
                        if (element.hasAttribute('style')) {
                            const style = element.getAttribute('style');
                            if (style.includes('javascript:') || style.includes('expression(')) {
                                element.removeAttribute('style');
                            }
                        }
                    });
                    
                    // Return sanitized HTML
                    return doc.body.innerHTML;
                } catch (error) {
                    console.error('HTML sanitization error:', error);
                    // Fallback to complete escaping
                    return this.escapeHtml(html);
                }
            }
            
            /**
             * Sanitize a URL to prevent XSS
             * @param {string} url - URL to sanitize
             * @returns {string} Sanitized URL
             */
            sanitizeUrl(url) {
                if (!url) {
                    return '';
                }
                
                // Remove whitespace
                const trimmedUrl = url.trim();
                
                // Remove dangerous protocols
                const sanitizedUrl = trimmedUrl.replace(/^javascript:|data:|vbscript:|file:/i, '');
                
                // Validate against URL pattern
                if (this.patterns.url.test(sanitizedUrl)) {
                    return sanitizedUrl;
                } else {
                    // If not a valid URL, return empty string or a safe default
                    return '';
                }
            }
            
            /**
             * Sanitize numeric input
             * @param {string|number} input - Numeric input
             * @param {Object} options - Validation options
             * @returns {number|null} Sanitized number or null if invalid
             */
            sanitizeNumber(input, options = {}) {
                // Default options
                const opts = {
                    min: Number.MIN_SAFE_INTEGER,
                    max: Number.MAX_SAFE_INTEGER,
                    decimal: true,
                    defaultValue: null
                };
                
                // Merge with provided options
                Object.assign(opts, options);
                
                // Handle empty input
                if (input === null || input === undefined || input === '') {
                    return opts.defaultValue;
                }
                
                // Parse number
                const num = opts.decimal ? parseFloat(input) : parseInt(input, 10);
                
                // Validate
                if (isNaN(num)) {
                    return opts.defaultValue;
                }
                
                // Apply range limits
                if (num < opts.min) {
                    return opts.min;
                }
                
                if (num > opts.max) {
                    return opts.max;
                }
                
                return num;
            }
            
            /**
             * Validate and sanitize a single form input
             * @param {HTMLElement} input - Input element
             * @returns {boolean} Validation result
             */
            validateAndSanitizeInput(input) {
                if (!input || !input.hasAttribute('data-validation-type')) {
                    return true;
                }
                
                const validationType = input.getAttribute('data-validation-type');
                const value = input.value;
                let isValid = true;
                let sanitizedValue = value;
                
                // Get validation message element
                const validationMessageId = input.id + '-validation';
                const validationMessage = document.getElementById(validationMessageId);
                
                // Clear previous validation
                input.classList.remove('error');
                if (validationMessage) {
                    validationMessage.textContent = '';
                    validationMessage.style.display = 'none';
                }
                
                // Skip validation for empty optional fields
                if (value === '' && !input.hasAttribute('required')) {
                    return true;
                }
                
                // Validate based on type
                switch (validationType) {
                    case 'text':
                        // Basic text validation - just sanitize
                        sanitizedValue = this.sanitizeText(value);
                        break;
                        
                    case 'numeric':
                        // Numeric validation
                        isValid = this.patterns.numeric.test(value);
                        if (isValid) {
                            const options = {
                                min: input.hasAttribute('min') ? parseFloat(input.getAttribute('min')) : undefined,
                                max: input.hasAttribute('max') ? parseFloat(input.getAttribute('max')) : undefined,
                                decimal: input.hasAttribute('step') && parseFloat(input.getAttribute('step')) < 1
                            };
                            sanitizedValue = this.sanitizeNumber(value, options);
                            isValid = sanitizedValue !== null;
                        }
                        break;
                        
                    case 'age':
                        // Age validation
                        isValid = this.patterns.age.test(value);
                        if (isValid) {
                            sanitizedValue = this.sanitizeNumber(value, {
                                min: 1, max: 120, decimal: false
                            });
                        }
                        break;
                        
                    case 'systolicBP':
                        // Blood pressure validation
                        isValid = this.patterns.systolicBP.test(value);
                        if (isValid) {
                            sanitizedValue = this.sanitizeNumber(value, {
                                min: 60, max: 300, decimal: false
                            });
                        }
                        break;
                        
                    case 'cholesterol':
                        // Cholesterol validation
                        isValid = this.patterns.cholesterol.test(value);
                        if (isValid) {
                            sanitizedValue = this.sanitizeNumber(value, {
                                min: 0, max: 99.99, decimal: true
                            });
                        }
                        break;
                        
                    case 'email':
                        // Email validation
                        isValid = this.patterns.email.test(value);
                        if (isValid) {
                            sanitizedValue = this.sanitizeText(value);
                        }
                        break;
                        
                    case 'url':
                        // URL validation
                        isValid = this.patterns.url.test(value);
                        if (isValid) {
                            sanitizedValue = this.sanitizeUrl(value);
                        }
                        break;
                        
                    // Add more validation types as needed
                }
                
                // Update input with sanitized value if different and valid
                if (isValid && sanitizedValue !== value) {
                    input.value = sanitizedValue;
                }
                
                // Show validation message if invalid
                if (!isValid) {
                    input.classList.add('error');
                    if (validationMessage) {
                        validationMessage.textContent = 'Please enter a valid ' + validationType;
                        validationMessage.style.display = 'block';
                    }
                }
                
                return isValid;
            }
            
            /**
             * Sanitize an entire form
             * @param {HTMLFormElement} form - Form to sanitize
             * @returns {boolean} Whether all inputs are valid
             */
            sanitizeForm(form) {
                if (!form || !(form instanceof HTMLFormElement)) {
                    return false;
                }
                
                let allValid = true;
                
                // Get all form elements with validation
                const inputs = form.querySelectorAll('input[data-validation-type], select[data-validation-type], textarea[data-validation-type]');
                
                // Validate each input
                inputs.forEach(input => {
                    const isValid = this.validateAndSanitizeInput(input);
                    if (!isValid) {
                        allValid = false;
                    }
                });
                
                return allValid;
            }
        }
        
        // Create global input sanitizer instance
        window.inputSanitizer = new InputSanitizer();
    </script>
    
    <!-- Encryption Service Implementation -->
    <script>
        /**
         * Encryption Service
         * Provides secure data encryption and decryption
         * Requires CryptoJS library from cdnjs
         */
        class EncryptionService {
            constructor() {
                // Check if CryptoJS is available
                if (typeof CryptoJS === 'undefined') {
                    console.error('CryptoJS library is required for encryption');
                }
                
                // Default encryption key (should be stored securely in a real app)
                this.defaultKey = 'CVDRiskToolkit_SecureKey2025';
                
                // Initialize secure storage
                this._initializeSecureStorage();
            }
            
            /**
             * Initialize secure storage mechanism
             * @private
             */
            _initializeSecureStorage() {
                // Check if localStorage is available
                if (typeof localStorage === 'undefined') {
                    console.warn('LocalStorage not available for secure storage');
                    return;
                }
                
                // Create secure storage namespace
                if (!localStorage.getItem('cvd_secure_storage')) {
                    localStorage.setItem('cvd_secure_storage', '{}');
                }
            }
            
            /**
             * Encrypt data
             * @param {any} data - Data to encrypt
             * @param {string} [key] - Optional encryption key
             * @returns {string} Encrypted data as string
             */
            encrypt(data, key = this.defaultKey) {
                try {
                    // Convert data to string if needed
                    const dataString = typeof data === 'object' ? JSON.stringify(data) : String(data);
                    
                    // Encrypt data
                    const encrypted = CryptoJS.AES.encrypt(dataString, key).toString();
                    
                    return encrypted;
                } catch (error) {
                    console.error('Encryption error:', error);
                    return null;
                }
            }
            
            /**
             * Decrypt data
             * @param {string} encryptedData - Encrypted data string
             * @param {string} [key] - Optional decryption key
             * @returns {any} Decrypted data
             */
            decrypt(encryptedData, key = this.defaultKey) {
                try {
                    // Decrypt data
                    const decrypted = CryptoJS.AES.decrypt(encryptedData, key).toString(CryptoJS.enc.Utf8);
                    
                    // Try to parse as JSON if possible
                    try {
                        return JSON.parse(decrypted);
                    } catch {
                        // Return as string if not valid JSON
                        return decrypted;
                    }
                } catch (error) {
                    console.error('Decryption error:', error);
                    return null;
                }
            }
            
            /**
             * Store encrypted data in secure storage
             * @param {string} key - Storage key
             * @param {any} data - Data to store
             * @param {string} [encryptionKey] - Optional encryption key
             * @returns {boolean} Success status
             */
            secureStore(key, data, encryptionKey = this.defaultKey) {
                try {
                    // Get current secure storage
                    const storageString = localStorage.getItem('cvd_secure_storage') || '{}';
                    const storage = JSON.parse(storageString);
                    
                    // Encrypt data
                    const encrypted = this.encrypt(data, encryptionKey);
                    
                    // Store encrypted data
                    storage[key] = encrypted;
                    
                    // Update storage
                    localStorage.setItem('cvd_secure_storage', JSON.stringify(storage));
                    
                    return true;
                } catch (error) {
                    console.error('Secure store error:', error);
                    return false;
                }
            }
            
            /**
             * Retrieve and decrypt data from secure storage
             * @param {string} key - Storage key
             * @param {string} [encryptionKey] - Optional encryption key
             * @returns {any} Decrypted data or null
             */
            secureRetrieve(key, encryptionKey = this.defaultKey) {
                try {
                    // Get current secure storage
                    const storageString = localStorage.getItem('cvd_secure_storage') || '{}';
                    const storage = JSON.parse(storageString);
                    
                    // Check if key exists
                    if (!storage[key]) {
                        return null;
                    }
                    
                    // Decrypt data
                    return this.decrypt(storage[key], encryptionKey);
                } catch (error) {
                    console.error('Secure retrieve error:', error);
                    return null;
                }
            }
            
            /**
             * Generate a secure hash of data
             * @param {any} data - Data to hash
             * @returns {string} SHA-256 hash
             */
            generateHash(data) {
                try {
                    // Convert data to string if needed
                    const dataString = typeof data === 'object' ? JSON.stringify(data) : String(data);
                    
                    // Generate hash
                    return CryptoJS.SHA256(dataString).toString();
                } catch (error) {
                    console.error('Hash generation error:', error);
                    return null;
                }
            }
            
            /**
             * Verify data integrity using hash
             * @param {any} data - Data to verify
             * @param {string} hash - Expected hash
             * @returns {boolean} Whether hash matches
             */
            verifyIntegrity(data, hash) {
                try {
                    // Generate hash of data
                    const generatedHash = this.generateHash(data);
                    
                    // Compare hashes
                    return generatedHash === hash;
                } catch (error) {
                    console.error('Integrity verification error:', error);
                    return false;
                }
            }
        }
        
        // Create global encryption service instance
        window.encryptionService = new EncryptionService();
    </script>
    
    <!-- Tab Navigation and Form Handling -->
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tab navigation
            initializeTabs();
            
            // Initialize form handlers
            initializeFormHandlers();
            
            // Initialize unit converters
            initializeUnitConverters();
            
            // Initialize EMR integration buttons
            initializeIntegrationButtons();
            
            // Initialize form validation
            initializeFormValidation();
            
            // Initialize cross-tab synchronization
            initializeCrossTabSync();
        });
        
        /**
         * Initialize tab navigation
         */
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Set the first tab as active by default
            if (tabs.length > 0 && !document.querySelector('.tab.active')) {
                tabs[0].classList.add('active');
                const firstTabId = tabs[0].getAttribute('data-tab');
                const firstTabContent = document.getElementById(firstTabId + '-tab-content');
                if (firstTabContent) {
                    firstTabContent.classList.add('active');
                }
            }
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function(event) {
                    // Prevent default behavior
                    event.preventDefault();
                    
                    // Skip if tab is disabled
                    if (this.hasAttribute('disabled')) {
                        return;
                    }
                    
                    // Get tab content ID from data-tab attribute
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById(tabId + '-tab-content');
                    
                    if (!tabContent) {
                        console.error('Tab content not found for:', tabId);
                        return;
                    }
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to selected tab and content
                    this.classList.add('active');
                    tabContent.classList.add('active');
                    
                    // Store active tab in sessionStorage for persistence
                    try {
                        sessionStorage.setItem('activeTab', tabId);
                    } catch (error) {
                        console.warn('Session storage not available:', error);
                    }
                    
                    console.log('Tab switched to:', tabId);
                });
            });
            
            // Restore active tab from sessionStorage if available
            try {
                const activeTab = sessionStorage.getItem('activeTab');
                if (activeTab) {
                    const tabToActivate = document.querySelector(`.tab[data-tab="${activeTab}"]`);
                    if (tabToActivate && !tabToActivate.classList.contains('active') && !tabToActivate.hasAttribute('disabled')) {
                        tabToActivate.click();
                    }
                }
            } catch (error) {
                console.warn('Session storage not available:', error);
            }
        }
        
        /**
         * Initialize form handlers
         */
        function initializeFormHandlers() {
            // FRS Form
            const frsForm = document.getElementById('frs-form');
            if (frsForm) {
                frsForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    calculateFrsRisk();
                });
            }
            
            // QRISK3 Form
            const qriskForm = document.getElementById('qrisk-form');
            if (qriskForm) {
                qriskForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    calculateQriskRisk();
                });
            }
            
            // Medication Form
            const medicationForm = document.getElementById('medication-form');
            if (medicationForm) {
                medicationForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    evaluateMedications();
                });
            }
            
            // Research Contact Form
            const researchContactForm = document.getElementById('research-contact-form');
            if (researchContactForm) {
                researchContactForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    submitResearchContact();
                });
            }
            
            // Reset buttons
            const resetButtons = document.querySelectorAll('button[type="reset"]');
            resetButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Clear results container for the form
                    const form = this.closest('form');
                    const formId = form.id;
                    const resultsContainerId = formId.split('-')[0] + '-results-container';
                    const resultsContainer = document.getElementById(resultsContainerId);
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '';
                    }
                    
                    // Clear validation messages
                    const errorMessages = form.querySelectorAll('.error-message');
                    errorMessages.forEach(message => {
                        message.textContent = '';
                        message.style.display = 'none';
                    });
                    
                    // Remove error classes
                    const errorInputs = form.querySelectorAll('.error');
                    errorInputs.forEach(input => {
                        input.classList.remove('error');
                    });
                });
            });
            
            // BP Statistical Calculation
            const calculateBpStats = document.getElementById('calculate-bp-stats');
            if (calculateBpStats) {
                calculateBpStats.addEventListener('click', function() {
                    calculateBpStatistics();
                });
            }
            
            // Multiple BP Readings Checkbox
            const multipleReadingsCheckboxes = document.querySelectorAll('input[name$="multiple-sbp"]');
            multipleReadingsCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const prefix = this.id.split('-')[0];
                    const readingsContainer = document.getElementById(`${prefix}-sbp-readings`);
                    const extraReadingsContainer = document.getElementById(`${prefix}-sbp-readings-extra`);
                    const sdContainer = document.getElementById(`${prefix}-sbp-sd-container`);
                    
                    if (this.checked) {
                        if (readingsContainer) readingsContainer.style.display = 'block';
                        if (extraReadingsContainer) extraReadingsContainer.style.display = 'block';
                        if (sdContainer) sdContainer.style.display = 'block';
                    } else {
                        if (readingsContainer) readingsContainer.style.display = 'none';
                        if (extraReadingsContainer) extraReadingsContainer.style.display = 'none';
                        if (sdContainer) sdContainer.style.display = 'none';
                    }
                });
            });
            
            // Comparison Button
            const runComparisonButton = document.getElementById('run-comparison');
            if (runComparisonButton) {
                runComparisonButton.addEventListener('click', function() {
                    runRiskComparison();
                });
            }
            
            // Advanced Visualization Buttons
            const calculateImpactButton = document.getElementById('calculate-impact');
            if (calculateImpactButton) {
                calculateImpactButton.addEventListener('click', function() {
                    calculateRiskFactorImpact();
                });
            }
            
            const calculateTreatmentButton = document.getElementById('calculate-treatment');
            if (calculateTreatmentButton) {
                calculateTreatmentButton.addEventListener('click', function() {
                    calculateTreatmentEffect();
                });
            }
            
            const calculateProgressionButton = document.getElementById('calculate-progression');
            if (calculateProgressionButton) {
                calculateProgressionButton.addEventListener('click', function() {
                    calculateRiskProgression();
                });
            }
            
            // Toggle erectile dysfunction field visibility based on sex
            const sexSelectors = document.querySelectorAll('select[name$="-sex"]');
            sexSelectors.forEach(selector => {
                selector.addEventListener('change', function() {
                    // Handle QRISK erectile dysfunction container
                    if (this.id === 'qrisk-sex') {
                        const edContainer = document.getElementById('qrisk-erectile-dysfunction-container');
                        if (edContainer) {
                            edContainer.style.display = this.value === 'male' ? 'block' : 'none';
                        }
                    }
                });
            });
            
            // Export Fields Container Toggle
            const exportDataSelection = document.getElementById('export-data-selection');
            if (exportDataSelection) {
                exportDataSelection.addEventListener('change', function() {
                    const fieldsContainer = document.getElementById('export-fields-container');
                    if (fieldsContainer) {
                        fieldsContainer.style.display = this.value === 'selected' ? 'block' : 'none';
                    }
                });
            }
            
            // Export Encryption Toggle
            const encryptExportCheckbox = document.getElementById('encrypt-exported-data');
            if (encryptExportCheckbox) {
                encryptExportCheckbox.addEventListener('change', function() {
                    const encryptionOptions = document.getElementById('export-encryption-options');
                    if (encryptionOptions) {
                        encryptionOptions.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // Import/Export Buttons
            const importDataButton = document.getElementById('import-data-button');
            if (importDataButton) {
                importDataButton.addEventListener('click', function() {
                    importPatientData();
                });
            }
            
            // Export buttons
            const exportButtons = document.querySelectorAll('button[id^="export-"]');
            exportButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const format = this.id.split('-')[1];
                    exportData(format);
                });
            });
            
            // Disclaimer links
            const disclaimerLinks = document.querySelectorAll('.disclaimer-link, .footer-links a');
            disclaimerLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    showDisclaimerModal(this.id);
                });
            });
            
            // Close disclaimer alert
            const alertCloseButton = document.querySelector('.alert-close');
            if (alertCloseButton) {
                alertCloseButton.addEventListener('click', function() {
                    const disclaimerAlert = document.getElementById('disclaimer-alert');
                    if (disclaimerAlert) {
                        disclaimerAlert.style.display = 'none';
                    }
                });
            }
        }
        
        /**
         * Initialize unit converters
         */
        function initializeUnitConverters() {
            // Height-Weight-BMI conversions
            const heightInputs = document.querySelectorAll('input[id$="-height"]');
            const weightInputs = document.querySelectorAll('input[id$="-weight"]');
            const heightUnitSelectors = document.querySelectorAll('select[id$="-height-unit"]');
            const weightUnitSelectors = document.querySelectorAll('select[id$="-weight-unit"]');
            const bmiOutputs = document.querySelectorAll('input[id$="-bmi"]');
            
            // Height unit converters
            heightUnitSelectors.forEach(selector => {
                selector.addEventListener('change', function() {
                    const prefix = this.id.split('-')[0];
                    const heightInput = document.getElementById(`${prefix}-height`);
                    if (!heightInput || !heightInput.value) return;
                    
                    const currentUnit = this.value;
                    const previousUnit = this.dataset.previousUnit || 'cm';
                    this.dataset.previousUnit = currentUnit;
                    
                    let height = parseFloat(heightInput.value);
                    
                    // Convert from previous unit to cm
                    if (previousUnit === 'in') {
                        height = height * 2.54; // inches to cm
                    }
                    
                    // Convert from cm to new unit
                    if (currentUnit === 'in') {
                        height = height / 2.54; // cm to inches
                    }
                    
                    heightInput.value = Math.round(height * 10) / 10;
                    updateBmi(prefix);
                });
            });
            
            // Weight unit converters
            weightUnitSelectors.forEach(selector => {
                selector.addEventListener('change', function() {
                    const prefix = this.id.split('-')[0];
                    const weightInput = document.getElementById(`${prefix}-weight`);
                    if (!weightInput || !weightInput.value) return;
                    
                    const currentUnit = this.value;
                    const previousUnit = this.dataset.previousUnit || 'kg';
                    this.dataset.previousUnit = currentUnit;
                    
                    let weight = parseFloat(weightInput.value);
                    
                    // Convert from previous unit to kg
                    if (previousUnit === 'lb') {
                        weight = weight * 0.453592; // pounds to kg
                    }
                    
                    // Convert from kg to new unit
                    if (currentUnit === 'lb') {
                        weight = weight / 0.453592; // kg to pounds
                    }
                    
                    weightInput.value = Math.round(weight * 10) / 10;
                    updateBmi(prefix);
                });
            });
            
            // Update BMI when height or weight changes
            heightInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const prefix = this.id.split('-')[0];
                    updateBmi(prefix);
                });
            });
            
            weightInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const prefix = this.id.split('-')[0];
                    updateBmi(prefix);
                });
            });
            
            // Cholesterol unit converters (mmol/L <-> mg/dL)
            const cholesterolInputs = document.querySelectorAll('input[data-param-type="totalCholesterol"], input[data-param-type="ldl"], input[data-param-type="hdl"], input[data-param-type="nonHdl"], input[data-param-type="triglycerides"]');
            const cholesterolUnitSelectors = document.querySelectorAll('select[id$="-chol-unit"], select[id$="-hdl-unit"], select[id$="-ldl-unit"], select[id$="-nonhdl-unit"], select[id$="-trig-unit"]');
            
            cholesterolUnitSelectors.forEach(selector => {
                selector.addEventListener('change', function() {
                    const inputId = this.id.replace('-unit', '');
                    const input = document.getElementById(inputId);
                    if (!input || !input.value) return;
                    
                    const currentUnit = this.value;
                    const previousUnit = this.dataset.previousUnit || 'mmol/L';
                    this.dataset.previousUnit = currentUnit;
                    
                    let value = parseFloat(input.value);
                    
                    // Convert cholesterol values
                    if (input.dataset.paramType === 'triglycerides') {
                        // Triglycerides conversion factor
                        if (previousUnit === 'mmol/L' && currentUnit === 'mg/dL') {
                            value = value * 88.57; // mmol/L to mg/dL
                        } else if (previousUnit === 'mg/dL' && currentUnit === 'mmol/L') {
                            value = value / 88.57; // mg/dL to mmol/L
                        }
                    } else {
                        // Cholesterol conversion factor (TC, LDL, HDL, non-HDL)
                        if (previousUnit === 'mmol/L' && currentUnit === 'mg/dL') {
                            value = value * 38.67; // mmol/L to mg/dL
                        } else if (previousUnit === 'mg/dL' && currentUnit === 'mmol/L') {
                            value = value / 38.67; // mg/dL to mmol/L
                        }
                    }
                    
                    input.value = Math.round(value * 10) / 10;
                    
                    // Update cholesterol ratio if applicable
                    if (input.dataset.paramType === 'totalCholesterol' || input.dataset.paramType === 'hdl') {
                        const prefix = input.id.split('-')[0];
                        updateCholesterolRatio(prefix);
                    }
                });
            });
            
            // Lp(a) unit converters (mg/dL <-> nmol/L)
            const lpaInputs = document.querySelectorAll('input[data-param-type="lpa"]');
            const lpaUnitSelectors = document.querySelectorAll('select[id$="-lpa-unit"]');
            
            lpaUnitSelectors.forEach(selector => {
                selector.addEventListener('change', function() {
                    const inputId = this.id.replace('-unit', '');
                    const input = document.getElementById(inputId);
                    if (!input || !input.value) return;
                    
                    const currentUnit = this.value;
                    const previousUnit = this.dataset.previousUnit || 'mg/dL';
                    this.dataset.previousUnit = currentUnit;
                    
                    let value = parseFloat(input.value);
                    
                    // Convert Lp(a) values (approximate conversion factor)
                    if (previousUnit === 'mg/dL' && currentUnit === 'nmol/L') {
                        value = value * 2.5; // mg/dL to nmol/L (approximate)
                    } else if (previousUnit === 'nmol/L' && currentUnit === 'mg/dL') {
                        value = value / 2.5; // nmol/L to mg/dL (approximate)
                    }
                    
                    input.value = Math.round(value * 10) / 10;
                });
            });
            
            // HbA1c unit converters (% <-> mmol/mol)
            const hba1cInputs = document.querySelectorAll('input[data-param-type="hba1c"]');
            const hba1cUnitSelectors = document.querySelectorAll('select[id$="-hba1c-unit"]');
            
            hba1cUnitSelectors.forEach(selector => {
                selector.addEventListener('change', function() {
                    const inputId = this.id.replace('-unit', '');
                    const input = document.getElementById(inputId);
                    if (!input || !input.value) return;
                    
                    const currentUnit = this.value;
                    const previousUnit = this.dataset.previousUnit || '%';
                    this.dataset.previousUnit = currentUnit;
                    
                    let value = parseFloat(input.value);
                    
                    // Convert HbA1c values
                    if (previousUnit === '%' && currentUnit === 'mmol/mol') {
                        value = (value - 2.15) * 10.929; // % to mmol/mol
                    } else if (previousUnit === 'mmol/mol' && currentUnit === '%') {
                        value = (value / 10.929) + 2.15; // mmol/mol to %
                    }
                    
                    input.value = Math.round(value * 10) / 10;
                });
            });
            
            // ApoB unit converters (g/L <-> mg/dL)
            const apobInputs = document.querySelectorAll('input[data-param-type="apoB"]');
            const apobUnitSelectors = document.querySelectorAll('select[id$="-apob-unit"]');
            
            apobUnitSelectors.forEach(selector => {
                selector.addEventListener('change', function() {
                    const inputId = this.id.replace('-unit', '');
                    const input = document.getElementById(inputId);
                    if (!input || !input.value) return;
                    
                    const currentUnit = this.value;
                    const previousUnit = this.dataset.previousUnit || 'g/L';
                    this.dataset.previousUnit = currentUnit;
                    
                    let value = parseFloat(input.value);
                    
                    // Convert ApoB values
                    if (previousUnit === 'g/L' && currentUnit === 'mg/dL') {
                        value = value * 100; // g/L to mg/dL
                    } else if (previousUnit === 'mg/dL' && currentUnit === 'g/L') {
                        value = value / 100; // mg/dL to g/L
                    }
                    
                    input.value = value.toFixed(2);
                });
            });
            
            // Initialize unit data
            heightUnitSelectors.forEach(selector => {
                selector.dataset.previousUnit = selector.value;
            });
            
            weightUnitSelectors.forEach(selector => {
                selector.dataset.previousUnit = selector.value;
            });
            
            cholesterolUnitSelectors.forEach(selector => {
                selector.dataset.previousUnit = selector.value;
            });
            
            lpaUnitSelectors.forEach(selector => {
                selector.dataset.previousUnit = selector.value;
            });
            
            hba1cUnitSelectors.forEach(selector => {
                selector.dataset.previousUnit = selector.value;
            });
            
            apobUnitSelectors.forEach(selector => {
                selector.dataset.previousUnit = selector.value;
            });
            
            // Auto-calculate all BMIs
            document.querySelectorAll('input[id$="-bmi"]').forEach(bmiInput => {
                const prefix = bmiInput.id.split('-')[0];
                updateBmi(prefix);
            });
            
            // Auto-calculate all cholesterol ratios
            document.querySelectorAll('input[id$="-cholesterol-ratio"]').forEach(ratioInput => {
                const prefix = ratioInput.id.split('-')[0];
                updateCholesterolRatio(prefix);
            });
        }
        
        /**
         * Update BMI calculation
         * @param {string} prefix - Form prefix (frs, qrisk, med)
         */
        function updateBmi(prefix) {
            const heightInput = document.getElementById(`${prefix}-height`);
            const weightInput = document.getElementById(`${prefix}-weight`);
            const bmiOutput = document.getElementById(`${prefix}-bmi`);
            const heightUnitSelector = document.getElementById(`${prefix}-height-unit`);
            const weightUnitSelector = document.getElementById(`${prefix}-weight-unit`);
            
            if (!heightInput || !weightInput || !bmiOutput) return                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-condition-6">Condition 6</label>
                                <input type="text" id="med-condition-6" name="med-condition-6" class="form-control" data-validation-type="text">
                                <div id="med-condition-6-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="med-condition-6-duration">Duration (months)</label>
                                <input type="number" id="med-condition-6-duration" name="med-condition-6-duration" class="form-control" min="0" max="1200" data-validation-type="numeric">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Assessment Link Section -->
                <div class="section">
                    <h3>Risk Assessment</h3>
                    <p>To help guide medication recommendations, provide a risk assessment:</p>
                    <div class="form-group">
                        <label class="form-label">Use existing risk assessment:</label>
                        <div class="form-check">
                            <input type="radio" id="med-use-frs" name="med-use-risk" class="form-check-input" value="frs">
                            <label for="med-use-frs" class="form-check-label">Use Framingham Risk Score</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" id="med-use-qrisk" name="med-use-risk" class="form-check-input" value="qrisk">
                            <label for="med-use-qrisk" class="form-check-label">Use QRISK3</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" id="med-use-none" name="med-use-risk" class="form-check-input" value="none" checked>
                            <label for="med-use-none" class="form-check-label">No risk assessment</label>
                        </div>
                    </div>
                </div>
                
                <!-- Form Controls -->
                <div class="form-actions">
                    <button type="submit" class="button button-primary" id="medication-evaluate">Evaluate Medications</button>
                    <button type="reset" class="button button-secondary" id="medication-reset">Reset</button>
                </div>
            </form>
            
            <!-- Loading Indicator -->
            <div class="loading" id="medication-loading">
                <div class="loading-spinner"></div>
                <p>Evaluating...</p>
            </div>
            
            <!-- Results Container -->
            <div id="medication-results-container"></div>
        </div>
        
        <!-- Risk Comparison Tab -->
        <div class="tab-content" id="comparison-tab-content">
            <h2>Risk Calculator Comparison</h2>
            <div class="comparison-status">
                <div class="row">
                    <div class="col">
                        <h3>Framingham Risk Score</h3>
                        <div id="frs-status" class="status-indicator incomplete">Not calculated</div>
                    </div>
                    <div class="col">
                        <h3>QRISK3</h3>
                        <div id="qrisk-status" class="status-indicator incomplete">Not calculated</div>
                    </div>
                </div>
                <div class="comparison-actions">
                    <button id="run-comparison" class="button button-primary" disabled>Compare Risk Calculators</button>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div class="loading" id="comparison-loading">
                <div class="loading-spinner"></div>
                <p>Comparing...</p>
            </div>
            
            <!-- Results Container -->
            <div id="comparison-results-container"></div>
        </div>
        
        <!-- Future Projects Tab -->
        <div class="tab-content" id="future-projects-tab">
            <h2>Future Research & Development</h2>
            
            <div class="section">
                <h3>Machine Learning for Lipoprotein(a) Risk Assessment</h3>
                <p>Our team is currently developing advanced machine learning models to better quantify the impact of Lipoprotein(a) levels on cardiovascular risk. Traditional risk calculators often underestimate the contribution of elevated Lp(a) to overall cardiovascular risk.</p>
                
                <div class="row">
                    <div class="col">
                        <h4>Research Goals</h4>
                        <ul>
                            <li>Utilize deep learning techniques to identify non-linear relationships between Lp(a) levels and CVD outcomes</li>
                            <li>Develop personalized risk modifiers based on individual patient characteristics</li>
                            <li>Create a more precise risk stratification system for patients with elevated Lp(a)</li>
                            <li>Integrate genetic risk factors to enhance prediction accuracy</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h4>Preliminary Findings</h4>
                        <p>Our preliminary analysis suggests that Lp(a) risk is not linear and may have threshold effects that vary by ethnicity, sex, and other risk factors. We are developing a multi-dimensional model that accounts for these complex interactions.</p>
                        <div class="visualization-container" id="lpa-preliminary-viz">
                            <!-- Placeholder for future visualization -->
                            <p class="text-center">Visualization in development</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3>Multi-Ethnic Risk Calibration</h3>
                <p>Current risk calculators were primarily developed in populations of European descent. We are working on calibration factors for diverse ethnic populations to improve risk prediction accuracy across all patient groups.</p>
                
                <div class="row">
                    <div class="col">
                        <h4>Ethnicity-Specific Risk Models</h4>
                        <ul>
                            <li>Creating ethnicity-specific risk modifiers for major risk calculators</li>
                            <li>Incorporating social determinants of health into risk assessment</li>
                            <li>Developing region-specific calibration tools</li>
                            <li>Validating models in diverse populations</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h4>Current Progress</h4>
                        <p>We have collected data from multiple cohorts representing diverse populations and are in the process of developing and validating ethnicity-specific calibration factors.</p>
                        <div class="visualization-container" id="ethnic-calibration-viz">
                            <!-- Placeholder for future visualization -->
                            <p class="text-center">Visualization in development</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3>Lifetime Risk Trajectory</h3>
                <p>Most current risk calculators focus on 10-year risk, which may underestimate lifetime risk, especially in younger patients. We are developing models to visualize and quantify lifetime risk trajectories.</p>
                
                <div class="row">
                    <div class="col">
                        <h4>Key Features</h4>
                        <ul>
                            <li>Lifetime risk estimation based on current risk factors</li>
                            <li>Modeling of risk factor progression over time</li>
                            <li>Impact of early intervention on lifetime risk</li>
                            <li>Patient-specific risk trajectories with multiple intervention scenarios</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h4>Implementation Timeline</h4>
                        <p>We anticipate rolling out the first version of lifetime risk trajectories in Q3 2025, with ongoing refinements based on user feedback and new research findings.</p>
                        <div class="visualization-container" id="lifetime-risk-viz">
                            <!-- Placeholder for future visualization -->
                            <p class="text-center">Visualization in development</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3>Research Collaboration Opportunities</h3>
                <p>We welcome collaboration with researchers and clinicians interested in cardiovascular risk assessment and prevention. If you are interested in collaborating or have data that could contribute to our research, please contact us.</p>
                
                <div class="contact-form">
                    <h4>Contact the Research Team</h4>
                    <form id="research-contact-form">
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label class="form-label" for="contact-name">Name</label>
                                    <input type="text" id="contact-name" name="contact-name" class="form-control" required data-validation-type="text">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label class="form-label" for="contact-email">Email</label>
                                    <input type="email" id="contact-email" name="contact-email" class="form-control" required data-validation-type="email">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="contact-institution">Institution</label>
                            <input type="text" id="contact-institution" name="contact-institution" class="form-control" data-validation-type="text">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="contact-message">Message</label>
                            <textarea id="contact-message" name="contact-message" class="form-control" rows="4" required data-validation-type="text"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="button button-primary" id="contact-submit">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Data Import/Export Tab -->
        <div class="tab-content" id="data-tab">
            <h2>Patient Data Management</h2>
            
            <!-- Import Section -->
            <div class="section">
                <h3>Import Patient Data</h3>
                <div class="import-container">
                    <input type="file" id="patient-data-import" accept=".csv,.json,.xlsx" />
                    <button id="import-data-button" class="button button-primary">Import</button>
                    <div id="import-status" class="status-message"></div>
                </div>
                <div class="form-group">
                    <label for="import-format">Format:</label>
                    <select id="import-format" class="form-control">
                        <option value="auto">Auto-detect</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xlsx">Excel</option>
                    </select>
                </div>
                <div class="data-validation-options">
                    <h4>Data Validation Options</h4>
                    <div class="form-check">
                        <input type="checkbox" id="validate-data-types" class="form-check-input" checked>
                        <label for="validate-data-types" class="form-check-label">Validate Data Types</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="auto-correct-values" class="form-check-input" checked>
                        <label for="auto-correct-values" class="form-check-label">Auto-correct Values (when possible)</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="skip-invalid-rows" class="form-check-input">
                        <label for="skip-invalid-rows" class="form-check-label">Skip Invalid Rows</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="encrypt-imported-data" class="form-check-input" checked>
                        <label for="encrypt-imported-data" class="form-check-label">Encrypt Stored Data</label>
                    </div>
                </div>
            </div>
            
            <!-- Export Section -->
            <div class="section">
                <h3>Export Assessment</h3>
                <div class="export-options">
                    <button id="export-pdf" class="button button-secondary">Export to PDF</button>
                    <button id="export-json" class="button button-secondary">Export to JSON</button>
                    <button id="export-csv" class="button button-secondary">Export to CSV</button>
                    <button id="export-emr" class="button button-secondary">Export to EMR</button>
                </div>
                <div class="form-group">
                    <label for="export-data-selection">Export Data:</label>
                    <select id="export-data-selection" class="form-control">
                        <option value="current">Current Assessment Only</option>
                        <option value="all">All Assessments</option>
                        <option value="selected">Selected Fields</option>
                    </select>
                </div>
                <div id="export-fields-container" style="display: none;">
                    <h4>Select Fields to Export</h4>
                    <div class="export-fields-list">
                        <!-- Dynamically populated with available fields -->
                        <div class="form-check">
                            <input type="checkbox" id="export-field-patient-info" class="form-check-input export-field" checked>
                            <label for="export-field-patient-info" class="form-check-label">Patient Information</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="export-field-lipids" class="form-check-input export-field" checked>
                            <label for="export-field-lipids" class="form-check-label">Lipid Parameters</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="export-field-bp" class="form-check-input export-field" checked>
                            <label for="export-field-bp" class="form-check-label">Blood Pressure</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="export-field-conditions" class="form-check-input export-field" checked>
                            <label for="export-field-conditions" class="form-check-label">Medical Conditions</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="export-field-results" class="form-check-input export-field" checked>
                            <label for="export-field-results" class="form-check-label">Risk Assessment Results</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="export-field-medications" class="form-check-input export-field" checked>
                            <label for="export-field-medications" class="form-check-label">Medications</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="export-field-recommendations" class="form-check-input export-field" checked>
                            <label for="export-field-recommendations" class="form-check-label">Treatment Recommendations</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="encrypt-exported-data" class="form-check-input">
                        <label for="encrypt-exported-data" class="form-check-label">Encrypt Exported Data</label>
                    </div>
                    <div id="export-encryption-options" style="display: none;">
                        <label for="export-encryption-password" class="form-label">Password:</label>
                        <input type="password" id="export-encryption-password" class="form-control" data-validation-type="password">
                        <small class="form-text text-muted">Required to decrypt the exported data.</small>
                    </div>
                </div>
            </div>
            
            <!-- Data Preview Section -->
            <div class="section">
                <h3>Data Preview</h3>
                <div id="data-preview-container" class="data-preview">
                    <div class="loading" id="data-preview-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Loading data preview...</p>
                    </div>
                    <div id="data-preview-content"></div>
                </div>
            </div>
            
            <!-- Batch Processing Section -->
            <div class="section">
                <h3>Batch Processing</h3>
                <p>Calculate risk for multiple patients and generate a summary report.</p>
                
                <div class="form-group">
                    <label for="batch-template" class="form-label">Download Template:</label>
                    <button id="download-csv-template" class="button button-secondary">CSV Template</button>
                    <button id="download-excel-template" class="button button-secondary">Excel Template</button>
                </div>
                
                <div class="form-group">
                    <label for="batch-file" class="form-label">Upload Patient Data File:</label>
                    <input type="file" id="batch-file" accept=".csv,.xlsx" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="batch-calculator" class="form-label">Risk Calculator:</label>
                    <select id="batch-calculator" class="form-control">
                        <option value="frs">Framingham Risk Score</option>
                        <option value="qrisk">QRISK3</option>
                        <option value="both">Both Calculators</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button id="run-batch" class="button button-primary">Process Batch</button>
                </div>
                
                <div class="loading" id="batch-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Processing batch data...</p>
                </div>
                
                <div id="batch-results-container"></div>
            </div>
        </div>
        
        <!-- Advanced Visualization Tab -->
        <div class="tab-content" id="advanced-viz-tab">
            <h2>Advanced Risk Visualization</h2>
            
            <div class="section">
                <h3>Risk Factor Impact</h3>
                <div id="risk-factor-impact-visualization" class="visualization-container"></div>
                <div class="control-panel">
                    <div class="form-group">
                        <label for="impact-factor">Risk Factor:</label>
                        <select id="impact-factor" class="form-control">
                            <option value="sbp">Systolic Blood Pressure</option>
                            <option value="cholesterol">Total Cholesterol</option>
                            <option value="hdl">HDL Cholesterol</option>
                            <option value="smoking">Smoking Status</option>
                            <option value="diabetes">Diabetes</option>
                            <option value="age">Age</option>
                            <option value="lpa">Lipoprotein(a)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="impact-range">Value Range:</label>
                        <div class="range-selector">
                            <input type="range" id="impact-range" min="0" max="100" value="50">
                            <div class="range-value-container">
                                <span id="impact-range-min">Min</span>
                                <span id="impact-range-current">Current</span>
                                <span id="impact-range-max">Max</span>
                            </div>
                        </div>
                    </div>
                    <button id="calculate-impact" class="button button-primary">Calculate Impact</button>
                </div>
            </div>
            
            <div class="section">
                <h3>Treatment Comparison</h3>
                <div id="treatment-comparison-visualization" class="visualization-container"></div>
                <div class="control-panel">
                    <div class="form-group">
                        <label for="treatment-type">Treatment Type:</label>
                        <select id="treatment-type" class="form-control">
                            <option value="statins">Statin Therapy</option>
                            <option value="ezetimibe">Ezetimibe</option>
                            <option value="pcsk9">PCSK9 Inhibitors</option>
                            <option value="combined">Combined Therapy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="treatment-intensity">Treatment Intensity:</label>
                        <select id="treatment-intensity" class="form-control">
                            <option value="low">Low Intensity</option>
                            <option value="moderate">Moderate Intensity</option>
                            <option value="high">High Intensity</option>
                        </select>
                    </div>
                    <button id="calculate-treatment" class="button button-primary">Calculate Treatment Effect</button>
                </div>
            </div>
            
            <div class="section">
                <h3>Risk Progression Over Time</h3>
                <div id="risk-progression-visualization" class="visualization-container"></div>
                <div class="control-panel">
                    <div class="form-group">
                        <label for="progression-years">Time Span (years):</label>
                        <select id="progression-years" class="form-control">
                            <option value="5">5 Years</option>
                            <option value="10" selected>10 Years</option>
                            <option value="15">15 Years</option>
                            <option value="20">20 Years</option>
                            <option value="30">30 Years</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intervention-age">Intervention Start Age:</label>
                        <input type="number" id="intervention-age" class="form-control" min="20" max="90">
                    </div>
                    <button id="calculate-progression" class="button button-primary">Calculate Progression</button>
                </div>
            </div>
            
            <div class="section">
                <h3>Risk Calculator Sensitivity Analysis</h3>
                <div id="sensitivity-analysis-visualization" class="visualization-container"></div>
                <div class="control-panel">
                    <div class="form-group">
                        <label for="sensitivity-calculator">Risk Calculator:</label>
                        <select id="sensitivity-calculator" class="form-control">
                            <option value="frs">Framingham Risk Score</option>
                            <option value="qrisk">QRISK3</option>
                            <option value="both">Both Calculators</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sensitivity-factor">Parameter to Vary:</label>
                        <select id="sensitivity-factor" class="form-control">
                            <option value="age">Age</option>
                            <option value="sbp">Systolic Blood Pressure</option>
                            <option value="cholesterol">Total Cholesterol</option>
                            <option value="hdl">HDL Cholesterol</option>
                            <option value="smoking">Smoking Status</option>
                        </select>
                    </div>
                    <button id="calculate-sensitivity" class="button button-primary">Calculate Sensitivity</button>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 CVD Risk Assessment Team. All rights reserved.</p>
            <div class="footer-links">
                <a href="#" id="show-terms">Terms of Use</a>
                <a href="#" id="show-clinical-disclaimer">Clinical Disclaimer</a>
                <a href="#" id="show-privacy">Privacy Notice</a>
                <a href="#" id="show-canadian">Canadian Guidelines</a>
                <a href="#" id="show-pcsk9">PCSK9 Inhibitor Information</a>
            </div>
            <p class="footer-note">This tool is based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult.</p>
            <p class="footer-note">Calculator references: D'Agostino RB Sr, et al. General cardiovascular risk profile for use in primary care: the Framingham Heart Study. Circulation. 2008;117(6):743-53. Hippisley-Cox J, et al. Development and validation of QRISK3 risk prediction algorithms to estimate future risk of cardiovascular disease: prospective cohort study. BMJ. 2017;357:j2099.</p>
        </div>
    </footer>
    
    <!-- Results Template (Hidden) -->
    <template id="results-template">
        <div class="results-container">
            <div class="results-header">
                <h3 class="results-title">Risk Assessment Results</h3>
                <div class="results-date"></div>
                <div class="results-actions">
                    <button class="button button-secondary results-print">Print</button>
                    <button class="button button-secondary results-export">Export PDF</button>
                </div>
            </div>
            <div class="results-body">
                <div class="results-column">
                    <div class="result-item">
                        <div class="result-label">10-Year CVD Risk:</div>
                        <div class="result-value base-risk"></div>
                    </div>
                    <div class="result-item lpa-modifier-container" style="display: none;">
                        <div class="result-label">Lp(a) Modifier:</div>
                        <div class="result-value lpa-modifier"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Modified Risk:</div>
                        <div class="result-value modified-risk"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Risk Category:</div>
                        <div class="result-value risk-category"></div>
                    </div>
                    <div class="result-item healthy-risk-container" style="display: none;">
                        <div class="result-label">Risk in Healthy Person:</div>
                        <div class="result-value healthy-risk"></div>
                    </div>
                    <div class="result-item relative-risk-container" style="display: none;">
                        <div class="result-label">Relative Risk:</div>
                        <div class="result-value relative-risk"></div>
                    </div>
                </div>
                <div class="results-column">
                    <div class="result-visualization"></div>
                    <div class="risk-meter-container">
                        <div class="risk-meter">
                            <div class="risk-meter-marker"></div>
                            <div class="risk-meter-labels">
                                <span class="risk-meter-label">Low</span>
                                <span class="risk-meter-label">Moderate</span>
                                <span class="risk-meter-label">High</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="results-footer">
                <div class="recommended-treatment">
                    <h4>Recommended Treatment</h4>
                    <div class="treatment-primary"></div>
                    <ul class="treatment-secondary"></ul>
                </div>
                <div class="treatment-rationale"></div>
                <div class="results-disclaimer">
                    <p><small>These recommendations are based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult. They are intended as a general guide only and should be interpreted in the context of individual patient factors.</small></p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Medication Results Template (Hidden) -->
    <template id="medication-results-template">
        <div class="results-container">
            <div class="results-header">
                <h3 class="results-title">Medication Evaluation Results</h3>
                <div class="results-date"></div>
                <div class="results-actions">
                    <button class="button button-secondary results-print">Print</button>
                    <button class="button button-secondary results-export">Export PDF</button>
                </div>
            </div>
            <div class="results-body">
                <div class="results-column">
                    <div class="result-item">
                        <div class="result-label">Risk Category:</div>
                        <div class="result-value risk-category"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Current Therapy:</div>
                        <div class="result-value current-therapy"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Current LDL-C:</div>
                        <div class="result-value current-ldl"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Target LDL-C:</div>
                        <div class="result-value target-ldl"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Target Status:</div>
                        <div class="result-value target-status"></div>
                    </div>
                </div>
                <div class="results-column">
                    <div class="medication-visualization"></div>
                </div>
            </div>
            <div class="results-footer">
                <div class="recommended-changes">
                    <h4>Recommended Changes</h4>
                    <div class="changes-primary"></div>
                    <ul class="changes-secondary"></ul>
                </div>
                <div class="pcsk9-eligibility">
                    <h4>PCSK9 Inhibitor Eligibility</h4>
                    <div class="eligibility-status"></div>
                    <div class="eligibility-details"></div>
                </div>
                <div class="changes-rationale"></div>
                <div class="results-disclaimer">
                    <p><small>These recommendations are based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease in the Adult. They are intended as a general guide only and should be interpreted in the context of individual patient factors. BC PharmaCare coverage criteria for PCSK9 inhibitors may change over time; verify current criteria before submitting coverage applications.</small></p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Comparison Results Template (Hidden) -->
    <template id="comparison-results-template">
        <div class="results-container">
            <div class="results-header">
                <h3 class="results-title">Risk Calculator Comparison</h3>
                <div class="results-date"></div>
                <div class="results-actions">
                    <button class="button button-secondary results-print">Print</button>
                    <button class="button button-secondary results-export">Export PDF</button>
                </div>
            </div>
            <div class="results-body">
                <div class="results-column">
                    <div class="result-item">
                        <div class="result-label">Framingham Risk:</div>
                        <div class="result-value frs-risk"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">QRISK3:</div>
                        <div class="result-value qrisk-risk"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Absolute Difference:</div>
                        <div class="result-value risk-difference"></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Relative Difference:</div>
                        <div class="result-value relative-difference"></div>
                    </div>
                </div>
                <div class="results-column">
                    <div class="comparison-visualization"></div>
                </div>
            </div>
            <div class="results-footer">
                <div class="comparison-explanation">
                    <h4>Explanation of Differences</h4>
                    <div class="explanation-content"></div>
                </div>
                <div class="comparison-recommendation">
                    <h4>Recommended Approach</h4>
                    <div class="recommendation-content"></div>
                </div>
                <div class="results-disclaimer">
                    <p><small>Differences between risk calculators are expected due to their development in different populations and inclusion of different risk factors. For Canadian patients, recommendations should generally follow the 2021 Canadian Cardiovascular Society Guidelines, which primarily reference the Framingham Risk Score while acknowledging that QRISK3 includes additional risk factors that may be clinically relevant.</small></p>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Modal Template (Hidden) -->
    <template id="modal-template">
        <div class="modal">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title"></h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button class="button button-secondary modal-cancel">Cancel</button>
                    <button class="button button-primary modal-accept">Accept</button>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Integration Setup Modal Template (Hidden) -->
    <template id="integration-setup-template">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Integration Setup</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="integration-endpoint">API Endpoint:</label>
                    <input type="text" id="integration-endpoint" class="form-control" />
                </div>
                <div class="form-group">
                    <label for="integration-auth">Authentication:</label>
                    <select id="integration-auth" class="form-control">
                        <option value="none">None</option>
                        <option value="basic">Basic Auth</option>
                        <option value="oauth">OAuth 2.0</option>
                        <option value="token">API Token</option>
                    </select>
                </div>
                <div id="auth-details" class="form-group-container"></div>
            </div>
            <div class="modal-footer">
                <button id="test-connection" class="button button-secondary">Test Connection</button>
                <button id="save-connection" class="button button-primary">Save Connection</button>
            </div>
        </div>
    </template>
    
    <!-- Error Correction Template (Hidden) -->
    <template id="error-correction-template">
        <div class="error-correction-modal">
            <div class="modal-header">
                <h3>Error Detected</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="error-details">
                    <div class="error-type"></div>
                    <div class="error-message"></div>
                    <div class="error-location"></div>
                </div>
                <div class="error-correction">
                    <h4>Suggested Correction</h4>
                    <div class="correction-message"></div>
                    <div class="code-comparison">
                        <div class="original-code">
                            <h5>Original</h5>
                            <pre></pre>
                        </div>
                        <div class="corrected-code">
                            <h5>Corrected</h5>
                            <pre></pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button button-secondary error-ignore">Ignore</button>
                <button class="button button-primary error-apply">Apply Correction</button>
            </div>
        </div>
    </template>

    <!-- QRISK3 Algorithm Implementation with Gold Standard Coefficients -->
    <script>
        /**
         * QRISK3 Algorithm Implementation
         * Based on the official QRISK3-2017 algorithm
         * @see https://qrisk.org/three/
         */
        class QRISK3Calculator {
            constructor() {
                // Initialize coefficients and constants
                this.initializeCoefficients();
                
                // Validation rules
                this.validationRules = {
                    age: { min: 25, max: 84 },
                    bmi: { min: 15, max: 47 },
                    sbp: { min: 70, max: 210 },
                    sbpStd: { min: 0, max: 40 },
                    cholHDLRatio: { min: 1, max: 12 },
                    town: { min: -7, max: 11 }
                };
                
                // Debug mode flag
                this.debugMode = false;
            }
            
            /**
             * Initialize QRISK3 coefficients
             * @private
             */
            initializeCoefficients() {
                // Female coefficient values - Official from QRISK3-2017
                this.femaleCoef = {
                    age1: 0.0497808621802437,
                    age2: -0.0004733903894341,
                    bmi1: 0.1501555265360523,
                    bmi2: -0.0018468186320675,
                    sbp: 0.0132800030110735,
                    sbpTreated: 0.0128164464996637,
                    cholHDLRatio: 0.1553979172457958,
                    smokeCat2: 0.1688824247438475,
                    smokeCat3: 0.3536937575994129,
                    smokeCat4: 0.5483147201975757,
                    diab1: 0.6359799601839306,
                    diab2: 0.8820923679525587,
                    family: 0.4559145375031096,
                    af: 1.5923340997217813,
                    renal: 0.6642681954861353,
                    treatedHyp: 0.5286450016924947,
                    migraines: 0.3012627353589264,
                    ra: 0.2432896188950373,
                    sle: 0.7089135296042471,
                    psychosis: 0.1301119512578294,
                    erectileDys: 0,
                    atypicalAntipsy: 0.1386127368979525,
                    steroids: 0.4598671508963475,
                    town: 0.0332682082606618,
                    bpVariability: 0.0899262720748919
                };
                
                // Male coefficient values - Official from QRISK3-2017
                this.maleCoef = {
                    age1: 0.0413926851266775,
                    age2: 0.0004278740245496,
                    bmi1: 0.2661973746175299,
                    bmi2: -0.0033897830659899,
                    sbp: 0.0124392029708795,
                    sbpTreated: 0.0118187609045657,
                    cholHDLRatio: 0.1533683913205353,
                    smokeCat2: 0.1532801684267217,
                    smokeCat3: 0.4055354177172647,
                    smokeCat4: 0.6409616247305854,
                    diab1: 0.6350044091342981,
                    diab2: 0.8951170626366127,
                    family: 0.4720653941291436,
                    af: 0.8820732882156602,
                    renal: 0.6464267908651787,
                    treatedHyp: 0.5274354811680869,
                    migraines: 0.2334326224723391,
                    ra: 0.2336282525934746,
                    sle: 0.4401685167058754,
                    psychosis: 0.1375439550781575,
                    erectileDys: 0.2066823358589239,
                    atypicalAntipsy: 0.1370837838348022,
                    steroids: 0.4764315766329461,
                    town: 0.0305046085438465,
                    bpVariability: 0.0879175400526802
                };
                
                // Ethnicity hazard ratios - Female
                this.femaleEthnicity = {
                    WHITE_OR_NOT_STATED: 0.0,
                    WHITE_IRISH: -0.0558658599454022,
                    WHITE_GYPSY: 0.1262567454633941,
                    OTHER_WHITE: -0.1341296386555474,
                    WHITE_AND_BLACK_CARIBBEAN: 0.0509279828826456,
                    WHITE_AND_BLACK_AFRICAN: -0.0889113408498136,
                    WHITE_AND_ASIAN: -0.0399007429451072,
                    OTHER_MIXED: -0.0093261809202349,
                    INDIAN: 0.003801671365008,
                    PAKISTANI: 0.1207146770279964,
                    BANGLADESHI: 0.1054300761030818,
                    OTHER_ASIAN: -0.1160573809672091,
                    CARIBBEAN: -0.1559649701819821,
                    BLACK_AFRICAN: -0.4003357620961412,
                    OTHER_BLACK: -0.1589068700802761,
                    CHINESE: -0.355629485442937,
                    OTHER: -0.141541655922905
                };
                
                // Ethnicity hazard ratios - Male
                this.maleEthnicity = {
                    WHITE_OR_NOT_STATED: 0.0,
                    WHITE_IRISH: -0.0562526128923578,
                    WHITE_GYPSY: 0.0732094997327006,
                    OTHER_WHITE: -0.2391364075910735,
                    WHITE_AND_BLACK_CARIBBEAN: 0.0500540214267804,
                    WHITE_AND_BLACK_AFRICAN: -0.1877512102332203,
                    WHITE_AND_ASIAN: -0.0900391304554949,
                    OTHER_MIXED: -0.1155622720205735,
                    INDIAN: 0.1028478994879736,
                    PAKISTANI: 0.2088674852950272,
                    BANGLADESHI: 0.1730303030996641,
                    OTHER_ASIAN: -0.0927814555334513,
                    CARIBBEAN: -0.3763045090525771,
                    BLACK_AFRICAN: -0.4104961156436749,
                    OTHER_BLACK: -0.2803447586893469,
                    CHINESE: -0.3792411511009705,
                    OTHER: -0.2134722280242171
                };
                
                // Baseline survivals (10-year risk)
                this.baselineSurvival = {
                    female: 0.9775208658865292,
                    male: 0.9651106464776332
                };
                
                // Constants
                this.constants = {
                    female: {
                        age: 59.3676233259583,
                        bmi: 25.9666597686605,
                        sbp: 123.125314381847,
                        sbpStd: 9.2502256599018,
                        town: -0.139403834669107,
                        cholHDLRatio: 3.51888980740468
                    },
                    male: {
                        age: 58.2543714017006,
                        bmi: 26.7832051247266,
                        sbp: 128.77268295288,
                        sbpStd: 9.15877725164258,
                        town: -0.273270023920049,
                        cholHDLRatio: 4.11733081998737
                    }
                };
            }
            
            /**
             * Calculate QRISK3 10-year cardiovascular risk
             * @param {Object} params - Risk factors
             * @returns {Object} Risk calculation results
             */
            calculateRisk(params) {
                try {
                    // Validate parameters
                    const validationResult = this.validateParameters(params);
                    if (!validationResult.isValid) {
                        return {
                            success: false,
                            error: validationResult.error,
                            details: validationResult.details
                        };
                    }
                    
                    // Process parameters
                    const processedParams = this.processParameters(params);
                    
                    // Calculate the risk
                    let risk;
                    if (processedParams.sex === 'female') {
                        risk = this.calculateFemaleRisk(processedParams);
                    } else {
                        risk = this.calculateMaleRisk(processedParams);
                    }
                    
                    // Apply Lp(a) modifier if present
                    if (params.lpaModifier && params.lpaModifier !== 'none') {
                        risk = this.applyLipoproteinAModifier(risk, params);
                    }
                    
                    // Determine risk category based on Canadian guidelines
                    const riskCategory = this.determineRiskCategory(risk);
                    
                    // Create result object
                    return {
                        success: true,
                        risk: Math.round(risk * 10) / 10, // Round to 1 decimal place
                        riskPercentage: Math.round(risk * 10) / 10,
                        riskCategory: riskCategory.category,
                        categoryDescription: riskCategory.description,
                        inputs: processedParams,
                        algorithm: 'QRISK3-2017',
                        lpaModifier: params.lpaModifier || 'none',
                        baselines: {
                            survival: this.baselineSurvival[processedParams.sex],
                            constants: this.constants[processedParams.sex]
                        }
                    };
                } catch (error) {
                    console.error('Error calculating QRISK3:', error);
                    return {
                        success: false,
                        error: 'Error calculating QRISK3',
                        details: error.message
                    };
                }
            }
            
            /**
             * Validate input parameters
             * @param {Object} params - Risk factors
             * @returns {Object} Validation result
             * @private
             */
            validateParameters(params) {
                const requiredParams = ['age', 'sex', 'sbp', 'cholHDLRatio', 'smoking'];
                const missing = requiredParams.filter(param => !(param in params));
                
                if (missing.length > 0) {
                    return {
                        isValid: false,
                        error: `Missing required parameters: ${missing.join(', ')}`,
                        details: { missing }
                    };
                }
                
                // Check param types and ranges
                const errors = [];
                
                // Age validation (25-84)
                if (params.age < this.validationRules.age.min || params.age > this.validationRules.age.max) {
                    errors.push(`Age must be between ${this.validationRules.age.min} and ${this.validationRules.age.max}`);
                }
                
                // BMI validation
                if ('bmi' in params) {
                    if (params.bmi < this.validationRules.bmi.min || params.bmi > this.validationRules.bmi.max) {
                        errors.push(`BMI must be between ${this.validationRules.bmi.min} and ${this.validationRules.bmi.max}`);
                    }
                } else if (!('height' in params && 'weight' in params)) {
                    errors.push('Either BMI or both height and weight must be provided');
                }
                
                // Blood pressure validation
                if (params.sbp < this.validationRules.sbp.min || params.sbp > this.validationRules.sbp.max) {
                    errors.push(`Systolic blood pressure must be between ${this.validationRules.sbp.min} and ${this.validationRules.sbp.max}`);
                }
                
                // Cholesterol ratio validation
                if (params.cholHDLRatio < this.validationRules.cholHDLRatio.min || params.cholHDLRatio > this.validationRules.cholHDLRatio.max) {
                    errors.push(`Total cholesterol:HDL ratio must be between ${this.validationRules.cholHDLRatio.min} and ${this.validationRules.cholHDLRatio.max}`);
                }
                
                // Sex validation
                if (!['male', 'female'].includes(params.sex.toLowerCase())) {
                    errors.push("Sex must be 'male' or 'female'");
                }
                
                // Smoking validation
                if (!['non', 'ex', 'light', 'moderate', 'heavy'].includes(params.smoking)) {
                    errors.push("Smoking must be one of: 'non', 'ex', 'light', 'moderate', 'heavy'");
                }
                
                if (errors.length > 0) {
                    return {
                        isValid: false,
                        error: 'Parameter validation errors',
                        details: { errors }
                    };
                }
                
                return { isValid: true };
            }
            
            /**
             * Process input parameters for calculation
             * @param {Object} params - Risk factors
             * @returns {Object} Processed parameters
             * @private
             */
            processParameters(params) {
                const processed = { ...params };
                
                // Convert sex to lowercase
                processed.sex = params.sex.toLowerCase();
                
                // Calculate BMI if not provided
                if (!('bmi' in params) && 'height' in params && 'weight' in params) {
                    const heightM = params.height / 100; // Convert cm to m
                    processed.bmi = params.weight / (heightM * heightM);
                }
                
                // Process smoking category
                processed.smokeCat = this.getSmokingCategory(params.smoking);
                
                // Process diabetes category
                processed.diabCat = this.getDiabetesCategory(params);
                
                // Process ethnicity
                processed.ethnicCoef = this.getEthnicityCoefficient(params);
                
                // Calculate Townsend score if not provided
                if (!('town' in params)) {
                    processed.town = 0; // Default to average
                }
                
                // Process BP variability
                if ('sbpStd' in params) {
                    // Use provided value
                    processed.bpVariability = params.sbpStd;
                } else if ('sbpReadings' in params && Array.isArray(params.sbpReadings) && params.sbpReadings.length >= 2) {
                    // Calculate from readings
                    processed.bpVariability = this.calculateStandardDeviation(params.sbpReadings);
                } else {
                    // Default to population average
                    processed.bpVariability = processed.sex === 'female' ? 
                        this.constants.female.sbpStd : 
                        this.constants.male.sbpStd;
                }
                
                // Convert boolean parameters to 0/1
                const booleanParams = [
                    'af', 'renal', 'treatedHyp', 'migraines', 'ra', 
                    'sle', 'psychosis', 'erectileDys', 'atypicalAntipsy', 
                    'steroids', 'family'
                ];
                
                booleanParams.forEach(param => {
                    if (param in params) {
                        processed[param] = params[param] ? 1 : 0;
                    } else {
                        processed[param] = 0; // Default to no
                    }
                });
                
                return processed;
            }
            
            /**
             * Get smoking category value
             * @param {string} smokingStatus - Smoking status
             * @returns {number} Smoking category (0-4)
             * @private
             */
            getSmokingCategory(smokingStatus) {
                switch (smokingStatus) {
                    case 'non':
                        return 0;
                    case 'ex':
                        return 1;
                    case 'light':
                        return 2;
                    case 'moderate':
                        return 3;
                    case 'heavy':
                        return 4;
                    default:
                        return 0;
                }
            }
            
            /**
             * Get diabetes category value
             * @param {Object} params - Risk factors
             * @returns {number} Diabetes category (0-2)
             * @private
             */
            getDiabetesCategory(params) {
                if (!params.diabetes) {
                    return 0; // No diabetes
                }
                
                if (params.diabetes === 'type1') {
                    return 1; // Type 1 diabetes
                }
                
                if (params.diabetes === 'type2') {
                    return 2; // Type 2 diabetes
                }
                
                return 0; // Default to no diabetes
            }
            
            /**
             * Get ethnicity coefficient
             * @param {Object} params - Risk factors
             * @returns {number} Ethnicity coefficient
             * @private
             */
            getEthnicityCoefficient(params) {
                if (!params.ethnicity) {
                    return 0; // Default to WHITE_OR_NOT_STATED
                }
                
                const ethnicity = params.ethnicity.toUpperCase();
                const ethnicityMap = params.sex.toLowerCase() === 'female' ? 
                    this.femaleEthnicity : 
                    this.maleEthnicity;
                
                // Map ethnicity to coefficient
                if (ethnicity in ethnicityMap) {
                    return ethnicityMap[ethnicity];
                }
                
                // If exact match not found, try to match based on first word
                for (const key in ethnicityMap) {
                    if (key.startsWith(ethnicity)) {
                        return ethnicityMap[key];
                    }
                }
                
                // If still no match, return default (WHITE_OR_NOT_STATED)
                return 0;
            }
            
            /**
             * Calculate standard deviation of an array of values
             * @param {Array<number>} values - Array of values
             * @returns {number} Standard deviation
             * @private
             */
            calculateStandardDeviation(values) {
                // Filter out any non-numeric values
                const validValues = values.filter(v => !isNaN(parseFloat(v)));
                
                if (validValues.length < 2) {
                    return 0; // Cannot calculate SD with fewer than 2 values
                }
                
                // Calculate mean
                const mean = validValues.reduce((sum, val) => sum + val, 0) / validValues.length;
                
                // Calculate sum of squared differences
                const squaredDiffs = validValues.map(val => Math.pow(val - mean, 2));
                const sumSquaredDiffs = squaredDiffs.reduce((sum, val) => sum + val, 0);
                
                // Calculate standard deviation
                return Math.sqrt(sumSquaredDiffs / validValues.length);
            }
            
            /**
             * Calculate female QRISK3 score
             * @param {Object} params - Processed risk factors
             * @returns {number} 10-year risk percentage
             * @private
             */
            calculateFemaleRisk(params) {
                const coef = this.femaleCoef;
                const constants = this.constants.female;
                
                // Prepare derived variables
                const ageTerms = this.calculateAgeTerms(params.age, constants.age);
                const bmiTerms = this.calculateBmiTerms(params.bmi, constants.bmi);
                
                // Calculate risk score
                let score = 0;
                
                // Add age and BMI terms
                score += coef.age1 * ageTerms.term1;
                score += coef.age2 * ageTerms.term2;
                score += coef.bmi1 * bmiTerms.term1;
                score += coef.bmi2 * bmiTerms.term2;
                
                // Add blood pressure terms
                if (params.treatedHyp === 1) {
                    score += coef.sbpTreated * (params.sbp - constants.sbp);
                } else {
                    score += coef.sbp * (params.sbp - constants.sbp);
                }
                
                // Add other risk factors
                score += coef.cholHDLRatio * (params.cholHDLRatio - constants.cholHDLRatio);
                
                // Add smoking categories
                if (params.smokeCat === 2) score += coef.smokeCat2;
                if (params.smokeCat === 3) score += coef.smokeCat3;
                if (params.smokeCat === 4) score += coef.smokeCat4;
                
                // Add diabetes categories
                if (params.diabCat === 1) score += coef.diab1;
                if (params.diabCat === 2) score += coef.diab2;
                
                // Add all other binary factors
                if (params.family === 1) score += coef.family;
                if (params.af === 1) score += coef.af;
                if (params.renal === 1) score += coef.renal;
                if (params.treatedHyp === 1) score += coef.treatedHyp;
                if (params.migraines === 1) score += coef.migraines;
                if (params.ra === 1) score += coef.ra;
                if (params.sle === 1) score += coef.sle;
                if (params.psychosis === 1) score += coef.psychosis;
                if (params.atypicalAntipsy === 1) score += coef.atypicalAntipsy;
                if (params.steroids === 1) score += coef.steroids;
                
                // Add town and BP variability
                score += coef.town * (params.town - constants.town);
                score += coef.bpVariability * (params.bpVariability - constants.sbpStd);
                
                // Add ethnicity
                score += params.ethnicCoef;
                
                // Convert to risk percentage
                const survival = this.baselineSurvival.female;
                const risk = 100 * (1 - Math.pow(survival, Math.exp(score)));
                
                if (this.debugMode) {
                    console.log('Female Risk Calculation:', {
                        score,
                        survival,
                        risk,
                        params
                    });
                }
                
                return risk;
            }
            
            /**
             * Calculate male QRISK3 score
             * @param {Object} params - Processed risk factors
             * @returns {number} 10-year risk percentage
             * @private
             */
            calculateMaleRisk(params) {
                const coef = this.maleCoef;
                const constants = this.constants.male;
                
                // Prepare derived variables
                const ageTerms = this.calculateAgeTerms(params.age, constants.age);
                const bmiTerms = this.calculateBmiTerms(params.bmi, constants.bmi);
                
                // Calculate risk score
                let score = 0;
                
                // Add age and BMI terms
                score += coef.age1 * ageTerms.term1;
                score += coef.age2 * ageTerms.term2;
                score += coef.bmi1 * bmiTerms.term1;
                score += coef.bmi2 * bmiTerms.term2;
                
                // Add blood pressure terms
                if (params.treatedHyp === 1) {
                    score += coef.sbpTreated * (params.sbp - constants.sbp);
                } else {
                    score += coef.sbp * (params.sbp - constants.sbp);
                }
                
                // Add other risk factors
                score += coef<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Enhanced Cardiovascular Disease Risk Assessment Toolkit for healthcare professionals">
    <meta name="author" content="CVD Risk Assessment Team">
    <title>Enhanced CVD Risk Toolkit</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self'; img-src 'self' data:; font-src 'self' https://cdnjs.cloudflare.com; object-src 'none';">
    
    <!-- Runtime Error Protection for early script errors -->
    <script>
        // Early error detection before main error handling system loads
        window.__earlyErrors = [];
        window.__originalConsoleError = console.error;
        console.error = function() {
            window.__originalConsoleError.apply(console, arguments);
            window.__earlyErrors.push({
                timestamp: new Date(),
                message: Array.from(arguments).join(' '),
                type: 'console.error'
            });
        };
        
        // Global error handler for early errors
        window.__originalOnError = window.onerror;
        window.onerror = function(message, source, lineno, colno, error) {
            window.__earlyErrors.push({
                timestamp: new Date(),
                message: message,
                source: source,
                lineno: lineno,
                colno: colno,
                error: error ? error.stack : null,
                type: 'global.error'
            });
            
            // Call original handler if it exists
            if (typeof window.__originalOnError === 'function') {
                return window.__originalOnError(message, source, lineno, colno, error);
            }
            
            return true; // Prevents default error handling
        };
        
        // Global promise rejection handler for early errors
        window.__originalUnhandledRejection = window.onunhandledrejection;
        window.onunhandledrejection = function(event) {
            window.__earlyErrors.push({
                timestamp: new Date(),
                message: event.reason ? (event.reason.message || event.reason) : 'Unhandled Promise Rejection',
                stack: event.reason && event.reason.stack ? event.reason.stack : null,
                type: 'promise.rejection'
            });
            
            // Call original handler if it exists
            if (typeof window.__originalUnhandledRejection === 'function') {
                return window.__originalUnhandledRejection(event);
            }
        };
    </script>
    
    <!-- Add Service Worker for Offline Support -->
    <script>
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.error('ServiceWorker registration failed: ', error);
                        // Gracefully handle service worker registration failure
                        console.log('Continuing without offline capabilities');
                    });
            });
        }
    </script>
    
    <!-- Cross-Browser Polyfills for Compatibility -->
    <script>
        // Polyfill for browsers without Fetch API
        if (!window.fetch) {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js" integrity="sha512-1Gn7//DzAGZmcrGdBCPvRfcY2AkRIXHJM0VOgOVj6XAnGYFwdAEpb0GrWjVzCUKTRMgJIlRgyIJYKL/5liwdgQ==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>');
        }
        
        // Polyfill for browsers without Promise
        if (!window.Promise) {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js" integrity="sha512-3KkQBdZ2AYuHQ1Xsx7dBl+0vF2QOGbZZSKVl/p78cp0CG4Q7TBQbR8tCOVSAXJFI9oLtxzEK843+D3bKpQrXmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>');
        }
        
        // Polyfill for browsers without Symbol
        if (!window.Symbol) {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.12.1/polyfill.min.js" integrity="sha512-uzOpZ74myvXTYZ+mXUsPhDF+/iL/n32GDxdryI2SJronkEyKC8FBFRLiBQ7l7U/PTYebDbgTtbqTa6/vGtU23A==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>');
        }
        
        // Feature detection and enhanced compatibility fixes
        (function() {
            // Check for and fix CSS Variables support (IE11)
            if (!window.CSS || !window.CSS.supports || !window.CSS.supports('--a', '0')) {
                document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/css-vars-ponyfill/2.4.5/css-vars-ponyfill.min.js" integrity="sha512-VbS9YGk0oKVJ1S2AQj8wk98HG42aGr4iuQfG9ZpnqWktRep/P36Vp8k4wfVLN5DEkAVIPYuuWe4T0mCrjlYK/A==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>');
                document.addEventListener('DOMContentLoaded', function() {
                    if (typeof cssVars === 'function') {
                        cssVars({
                            watch: true,
                            onlyLegacy: true,
                            preserveStatic: true
                        });
                    }
                });
            }
            
            // Fix for older Safari versions missing some ES6 features
            if (typeof Object.fromEntries !== 'function') {
                Object.fromEntries = function(entries) {
                    const obj = {};
                    for (const [key, value] of entries) {
                        obj[key] = value;
                    }
                    return obj;
                };
            }
            
            // Detect and add touch support enhancement for mobile
            var hasTouchSupport = ('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch;
            if (hasTouchSupport) {
                document.documentElement.classList.add('touch-enabled');
            }
            
            // Detect viewport size for responsive behavior
            function updateViewportClass() {
                var width = window.innerWidth;
                document.documentElement.classList.remove('viewport-xs', 'viewport-sm', 'viewport-md', 'viewport-lg', 'viewport-xl');
                if (width < 576) {
                    document.documentElement.classList.add('viewport-xs');
                } else if (width < 768) {
                    document.documentElement.classList.add('viewport-sm');
                } else if (width < 992) {
                    document.documentElement.classList.add('viewport-md');
                } else if (width < 1200) {
                    document.documentElement.classList.add('viewport-lg');
                } else {
                    document.documentElement.classList.add('viewport-xl');
                }
            }
            
            // Update viewport class on resize and initial load
            window.addEventListener('resize', updateViewportClass);
            window.addEventListener('load', updateViewportClass);
            updateViewportClass();
        })();
    </script>
    
    <!-- Critical CSS for immediate rendering -->
    <style>
        /* Critical CSS for initial render */
        :root {
            --primary-color: #2c7afc;
            --primary-dark: #1f5fc7;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #ffffff;
            --text-color: #212529;
            --border-radius: 0.25rem;
            --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --transition-speed: 0.3s;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 1rem;
            --spacing-4: 1.5rem;
            --spacing-5: 3rem;
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            flex: 1;
        }
        
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 1rem;
            text-align: center;
            margin-top: auto;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--secondary-color);
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            background-color: var(--light-color);
            border: 1px solid transparent;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            margin-right: 0.25rem;
            margin-bottom: -1px;
            transition: all var(--transition-speed);
        }
        
        .tab.active {
            background-color: var(--background-color);
            border-color: var(--secondary-color);
            border-bottom-color: var(--background-color);
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .tab:hover:not(.active) {
            background-color: rgba(44, 122, 252, 0.1);
        }
        
        .tab:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .tab-content {
            display: none;
            padding: 1rem;
            border: 1px solid var(--secondary-color);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-control {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(44, 122, 252, 0.25);
        }
        
        .form-control.error {
            border-color: var(--danger-color);
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .form-text {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        .form-check {
            position: relative;
            display: block;
            padding-left: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .form-check-input {
            position: absolute;
            margin-left: -1.25rem;
        }
        
        .form-check-label {
            margin-bottom: 0;
        }
        
        .button {
            display: inline-block;
            font-weight: 400;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: all var(--transition-speed);
            cursor: pointer;
        }
        
        .button-primary {
            color: white;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .button-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .button-secondary {
            color: white;
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .button-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -0.5rem;
            margin-left: -0.5rem;
        }
        
        .col {
            flex: 1 0 0%;
            padding-right: 0.5rem;
            padding-left: 0.5rem;
        }
        
        /* Loading indicator */
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 0.25rem solid var(--light-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Results styling */
        .results-container {
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1rem;
            background-color: var(--light-color);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .results-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0;
        }
        
        .results-date {
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        .results-body {
            display: flex;
            flex-wrap: wrap;
        }
        
        .results-column {
            flex: 1;
            min-width: 250px;
            padding: 0.5rem;
        }
        
        .result-item {
            margin-bottom: 1rem;
        }
        
        .result-label {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .result-value {
            font-size: 1.5rem;
        }
        
        .risk-category {
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-weight: bold;
            display: inline-block;
        }
        
        .low-risk {
            background-color: rgba(40, 167, 69, 0.2);
            color: #155724;
        }
        
        .moderate-risk {
            background-color: rgba(255, 193, 7, 0.2);
            color: #856404;
        }
        
        .high-risk {
            background-color: rgba(220, 53, 69, 0.2);
            color: #721c24;
        }
        
        .very-high-risk {
            background-color: rgba(153, 0, 0, 0.2);
            color: #721c24;
        }
        
        /* Disclaimer alert */
        .disclaimer-alert {
            background-color: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.5);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-speed);
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--secondary-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-color);
        }
        
        /* Data Import/Export Tab Styles */
        .import-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .import-container input[type="file"] {
            flex: 1;
            margin-right: 1rem;
        }
        
        .data-validation-options {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .data-preview {
            margin-top: 1rem;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            min-height: 200px;
            max-height: 400px;
            overflow: auto;
        }
        
        .data-preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-preview-table th, 
        .data-preview-table td {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        
        .data-preview-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .data-preview-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .export-fields-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 0.5rem;
        }
        
        /* Advanced Visualization Tab Styles */
        .visualization-container {
            min-height: 300px;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 1rem;
        }
        
        .control-panel {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .range-selector {
            display: flex;
            flex-direction: column;
        }
        
        .range-selector input[type="range"] {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .range-value-container {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        /* Integration Controls Styles */
        .integration-controls {
            margin: 1rem 0;
            display: flex;
            gap: 0.5rem;
        }
        
        /* Error Correction Modal Styles */
        .error-correction-modal {
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .error-details {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .error-type {
            font-weight: bold;
            color: var(--danger-color);
            margin-bottom: 0.5rem;
        }
        
        .code-comparison {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .code-comparison > div {
            flex: 1;
        }
        
        .code-comparison pre {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            overflow: auto;
            max-height: 200px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .original-code pre {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .corrected-code pre {
            background-color: rgba(40, 167, 69, 0.1);
        }
        
        /* Error Correction Notification */
        .error-correction-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 300px;
            background-color: white;
            border-left: 4px solid var(--success-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 10px;
            z-index: 10000;
            font-family: var(--font-family);
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .error-correction-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .notification-title {
            font-weight: bold;
        }
        
        .notification-close {
            cursor: pointer;
            font-size: 18px;
        }
        
        .notification-body {
            color: #666;
        }
        
        /* Animation Keyframes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Interactive Element States */
        /* Buttons */
        .button:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 122, 252, 0.25);
        }
        
        .button:active {
            transform: translateY(1px);
            filter: brightness(0.95);
            box-shadow: none;
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Form elements */
        .form-control:hover {
            border-color: #adb5bd;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 122, 252, 0.25);
            outline: none;
        }
        
        .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(44, 122, 252, 0.25);
            outline: none;
        }
        
        /* Tab navigation */
        .tab:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 122, 252, 0.25);
        }
        
        /* Accessibility enhancements */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }
        
        @media (prefers-contrast: more) {
            :root {
                --primary-color: #0058cc;
                --primary-dark: #00438a;
                --secondary-color: #4a4a4a;
                --success-color: #00701a;
                --warning-color: #ac7a00;
                --danger-color: #a31010;
            }
            
            .button {
                border-width: 2px;
            }
            
            .form-control {
                border-width: 2px;
            }
            
            .error-message {
                color: #a31010;
                font-weight: bold;
            }
        }
        
        /* Focus visible utility for keyboard navigation */
        .js-focus-visible :focus:not(.focus-visible) {
            outline: none;
        }
        
        .js-focus-visible .focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Skip to main content link for keyboard users */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }
        
        .skip-to-content:focus {
            top: 0;
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .font-weight-bold { font-weight: bold; }
        .font-weight-normal { font-weight: normal; }
        
        .text-primary { color: var(--primary-color); }
        .text-success { color: var(--success-color); }
        .text-warning { color: var(--warning-color); }
        .text-danger { color: var(--danger-color); }
        
        .bg-light { background-color: var(--light-color); }
        .bg-primary { background-color: var(--primary-color); color: white; }
        .bg-success { background-color: var(--success-color); color: white; }
        .bg-warning { background-color: var(--warning-color); color: white; }
        .bg-danger { background-color: var(--danger-color); color: white; }
        
        .mt-1 { margin-top: var(--spacing-1); }
        .mt-2 { margin-top: var(--spacing-2); }
        .mt-3 { margin-top: var(--spacing-3); }
        .mt-4 { margin-top: var(--spacing-4); }
        .mt-5 { margin-top: var(--spacing-5); }
        
        .mb-1 { margin-bottom: var(--spacing-1); }
        .mb-2 { margin-bottom: var(--spacing-2); }
        .mb-3 { margin-bottom: var(--spacing-3); }
        .mb-4 { margin-bottom: var(--spacing-4); }
        .mb-5 { margin-bottom: var(--spacing-5); }
        
        .ml-1 { margin-left: var(--spacing-1); }
        .ml-2 { margin-left: var(--spacing-2); }
        .ml-3 { margin-left: var(--spacing-3); }
        .ml-4 { margin-left: var(--spacing-4); }
        .ml-5 { margin-left: var(--spacing-5); }
        
        .mr-1 { margin-right: var(--spacing-1); }
        .mr-2 { margin-right: var(--spacing-2); }
        .mr-3 { margin-right: var(--spacing-3); }
        .mr-4 { margin-right: var(--spacing-4); }
        .mr-5 { margin-right: var(--spacing-5); }
        
        .p-1 { padding: var(--spacing-1); }
        .p-2 { padding: var(--spacing-2); }
        .p-3 { padding: var(--spacing-3); }
        .p-4 { padding: var(--spacing-4); }
        .p-5 { padding: var(--spacing-5); }
        
        .d-none { display: none; }
        .d-block { display: block; }
        .d-flex { display: flex; }
        
        .flex-column { flex-direction: column; }
        .flex-row { flex-direction: row; }
        .justify-content-between { justify-content: space-between; }
        .justify-content-center { justify-content: center; }
        .align-items-center { align-items: center; }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        
        .rounded { border-radius: var(--border-radius); }
        .shadow { box-shadow: var(--box-shadow); }
        
        /* Responsive adjustments for mobile - Enhanced with better breakpoints */
        /* Small screens (phones) */
        @media (max-width: 576px) {
            .container {
                padding: 0.5rem;
            }
            
            .header {
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-right: 0;
                margin-bottom: 0.25rem;
                border-radius: var(--border-radius);
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .tab.active {
                border-bottom-color: var(--secondary-color);
            }
            
            .tab-content {
                padding: 0.75rem;
                border-top: 1px solid var(--secondary-color);
                border-radius: var(--border-radius);
            }
            
            .results-body {
                flex-direction: column;
            }
            
            .col {
                flex: 0 0 100%;
                padding: 0.25rem;
            }
            
            .form-group {
                margin-bottom: 0.75rem;
            }
            
            .code-comparison {
                flex-direction: column;
            }
            
            .code-comparison > div {
                margin-bottom: 1rem;
            }
            
            .integration-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .button {
                width: 100%;
            }
        }
        
        /* Medium screens (tablets) */
        @media (min-width: 577px) and (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                margin-bottom: 0.25rem;
                flex: 0 0 48%;
            }
            
            .results-body {
                flex-direction: column;
            }
            
            .col {
                flex: 0 0 100%;
            }
        }
        
        /* Large screens (desktops) */
        @media (min-width: 769px) and (max-width: 992px) {
            .tab {
                padding: 0.75rem 1rem;
            }
            
            .col {
                padding: 0 0.5rem;
            }
        }

        /* Print Styles */
        @media print {
            .header, .footer, .tabs, .form-actions,
            .button-secondary, .button-primary {
                display: none !important;
            }
            
            .tab-content {
                display: block !important;
                border: none;
            }
            
            .container {
                width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .results-container {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            @page {
                margin: 1cm;
            }
        }
    </style>
    
    <!-- Non-critical CSS loaded asynchronously with fallback -->
    <link rel="preload" href="css/styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/styles.css"></noscript>
    <script>
        // Fallback for preload CSS
        (function() {
            var cssMain = document.createElement('link');
            cssMain.rel = 'stylesheet';
            cssMain.href = 'css/styles.css';
            cssMain.type = 'text/css';
            var timer = setTimeout(function() {
                var firstLink = document.getElementsByTagName('link')[0];
                firstLink.parentNode.insertBefore(cssMain, firstLink);
                clearTimeout(timer);
            }, 3000); // Fallback after 3 seconds if preload fails
        })();
    </script>
    
    <!-- Add encryption support library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Preload essential JavaScript modules -->
    <link rel="modulepreload" href="js/utils/event-bus.js">
    <link rel="modulepreload" href="js/utils/security-validation.js">
    <link rel="modulepreload" href="js/utils/input-sanitizer.js">
    <link rel="modulepreload" href="js/utils/cross-tab-sync.js">
    <link rel="modulepreload" href="js/utils/legal-disclaimers.js">
    <link rel="modulepreload" href="js/utils/risk-visualization.js">
    <link rel="modulepreload" href="js/utils/data-import-export.js">
    <link rel="modulepreload" href="js/utils/advanced-visualizations.js">
    <link rel="modulepreload" href="js/calculations/framingham-algorithm.js">
    <link rel="modulepreload" href="js/calculations/qrisk3-algorithm.js">
    <link rel="modulepreload" href="js/calculations/medication-evaluation.js">
    <link rel="modulepreload" href="js/utils/error-detection-system.js">
    <link rel="modulepreload" href="js/utils/runtime-protection.js">
    <link rel="modulepreload" href="js/utils/encryption-service.js">
    
    <!-- Favicon -->
    <link rel="icon" href="icons/icon-192x192.svg" type="image/svg+xml">
    
    <!-- Mobile web app capable -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="icons/icon-192x192.svg">
    
    <!-- Web app manifest -->
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    
    <header class="header">
        <h1>Enhanced CVD Risk Toolkit</h1>
        <p>Evidence-based cardiovascular risk assessment and management tool for healthcare professionals</p>
        
        <!-- EMR Integration Controls -->
        <div class="integration-controls">
            <button id="fhir-integration-button" class="button button-secondary" aria-label="Configure FHIR Integration">FHIR Integration</button>
            <button id="emr-integration-button" class="button button-secondary" aria-label="Configure EMR Integration">EMR Integration</button>
        </div>
    </header>
    
    <main class="container" id="main-content">
        <!-- Tool Description -->
        <div class="tool-description">
            <h2>About This Tool</h2>
            <p>This cardiovascular disease (CVD) risk assessment and management tool integrates evidence-based calculators including the Framingham Risk Score and QRISK3, with tailored treatment recommendations based on the Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia.</p>
            
            <!-- Disclaimer Alert -->
            <div class="disclaimer-alert" id="disclaimer-alert">
                <p><strong>Medical Disclaimer:</strong> This tool is intended for use by healthcare professionals only as a supplementary aid in cardiovascular risk assessment and management. The results provided are based on epidemiological data and should not replace clinical judgment. Individual patient factors may not be fully captured by these risk algorithms.</p>
                <p>Treatment recommendations are based on the 2021 Canadian Cardiovascular Society Guidelines for the Management of Dyslipidemia for the Prevention of Cardiovascular Disease. These guidelines may change over time, and users should refer to the most current recommendations.</p>
                <p>By using this application, you acknowledge that you have read and agreed to the <a href="#" id="show-clinical-disclaimer" class="disclaimer-link">Clinical Use Disclaimer</a> and <a href="#" id="show-terms" class="disclaimer-link">Terms of Use</a>.</p>
                <button class="alert-close" aria-label="Close disclaimer">×</button>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab" data-tab="frs" id="frs-tab-button">
                <span class="tab-icon">📊</span>Framingham Risk Score
            </button>
            <button class="tab" data-tab="qrisk" id="qrisk-tab-button">
                <span class="tab-icon">📉</span>QRISK3
            </button>
            <button class="tab" data-tab="medication" id="medication-tab-button">
                <span class="tab-icon">💊</span>Medications & Labs
            </button>
            <button class="tab" data-tab="combined" id="combined-tab-button">
                <span class="tab-icon">🔄</span>FRS and QRISK3
            </button>
            <button class="tab" data-tab="output" id="output-tab-button">
                <span class="tab-icon">📁</span>Data Export
            </button>
            <button class="tab" data-tab="future-projects" id="future-projects-tab-button">
                <span class="tab-icon">🔬</span>Future Projects
            </button>
        </div>
        
        <!-- Framingham Risk Score Tab -->
        <div class="tab-content active" id="frs-tab">
            <h2>Framingham Risk Score Calculator</h2>
            <form id="frs-form">
                <!-- Patient Information Section -->
                <div class="section">
                    <h3>Patient Information</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-age">Age (30-79 years)</label>
                                <input type="number" id="frs-age" name="frs-age" class="form-control" min="30" max="79" required data-validation-type="age" data-param-type="age">
                                <div id="frs-age-validation" class="error-message"></div>
                            </div>
                
                <!-- Medical Conditions Section -->
                <div class="section">
                    <h3>Medical Conditions</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-condition-1">Condition 1</label>
                                <input type="text" id="med-condition-1" name="med-condition-1" class="form-control" data-validation-type="text">
                                <div id="med-condition-1-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="med-condition-1-duration">Duration (months)</label>
                                <input type="number" id="med-condition-1-duration" name="med-condition-1-duration" class="form-control" min="0" max="1200" data-validation-type="numeric">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-condition-2">Condition 2</label>
                                <input type="text" id="med-condition-2" name="med-condition-2" class="form-control" data-validation-type="text">
                                <div id="med-condition-2-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="med-condition-2-duration">Duration (months)</label>
                                <input type="number" id="med-condition-2-duration" name="med-condition-2-duration" class="form-control" min="0" max="1200" data-validation-type="numeric">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-condition-3">Condition 3</label>
                                <input type="text" id="med-condition-3" name="med-condition-3" class="form-control" data-validation-type="text">
                                <div id="med-condition-3-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="med-condition-3-duration">Duration (months)</label>
                                <input type="number" id="med-condition-3-duration" name="med-condition-3-duration" class="form-control" min="0" max="1200" data-validation-type="numeric">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-condition-4">Condition 4</label>
                                <input type="text" id="med-condition-4" name="med-condition-4" class="form-control" data-validation-type="text">
                                <div id="med-condition-4-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="med-condition-4-duration">Duration (months)</label>
                                <input type="number" id="med-condition-4-duration" name="med-condition-4-duration" class="form-control" min="0" max="1200" data-validation-type="numeric">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-condition-5">Condition 5</label>
                                <input type="text" id="med-condition-5" name="med-condition-5" class="form-control" data-validation-type="text">
                                <div id="med-condition-5-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="med-condition-5-duration">Duration (months)</label>
                                <input type="number" id="med-condition-5-duration" name="med-condition-5-duration" class="form-control" min="0" max="1200" data-validation-type="numeric">
                            </div>
                        
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-sex">Sex</label>
                                <select id="frs-sex" name="frs-sex" class="form-control" required data-validation-type="sex">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                                <div id="frs-sex-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-height">Height</label>
                                <div class="input-group">
                                    <input type="number" id="frs-height" name="frs-height" class="form-control" min="100" max="250" step="0.1" data-validation-type="height" data-param-type="height_cm" data-physiological="true">
                                    <select id="frs-height-unit" name="frs-height-unit" class="form-control">
                                        <option value="cm">cm</option>
                                        <option value="in">in</option>
                                    </select>
                                </div>
                                <div id="frs-height-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-weight">Weight</label>
                                <div class="input-group">
                                    <input type="number" id="frs-weight" name="frs-weight" class="form-control" min="20" max="300" step="0.1" data-validation-type="weight" data-param-type="weight_kg" data-physiological="true">
                                    <select id="frs-weight-unit" name="frs-weight-unit" class="form-control">
                                        <option value="kg">kg</option>
                                        <option value="lb">lb</option>
                                    </select>
                                </div>
                                <div id="frs-weight-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-bmi">BMI (kg/m²)</label>
                                <input type="number" id="frs-bmi" name="frs-bmi" class="form-control" readonly data-param-type="bmi">
                                <div id="frs-bmi-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lipid Parameters Section -->
                <div class="section">
                    <h3>Current Lipid Parameters</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-ldl">LDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="med-ldl" name="med-ldl" class="form-control" min="0.5" max="15" step="0.1" data-validation-type="ldl" data-param-type="ldl" data-physiological="true">
                                    <select id="med-ldl-unit" name="med-ldl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="med-ldl-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-total-chol">Total Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="med-total-chol" name="med-total-chol" class="form-control" min="1" max="15" step="0.1" data-validation-type="cholesterol" data-param-type="totalCholesterol" data-physiological="true">
                                    <select id="med-total-chol-unit" name="med-total-chol-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="med-total-chol-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-hdl">HDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="med-hdl" name="med-hdl" class="form-control" min="0.4" max="5" step="0.1" data-validation-type="hdl" data-param-type="hdl" data-physiological="true">
                                    <select id="med-hdl-unit" name="med-hdl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="med-hdl-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-trig">Triglycerides</label>
                                <div class="input-group">
                                    <input type="number" id="med-trig" name="med-trig" class="form-control" min="0.2" max="20" step="0.1" data-validation-type="triglycerides" data-param-type="triglycerides" data-physiological="true">
                                    <select id="med-trig-unit" name="med-trig-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="med-trig-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-nonhdl">Non-HDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="med-nonhdl" name="med-nonhdl" class="form-control" min="0.5" max="18" step="0.1" data-validation-type="cholesterol" data-param-type="nonHdl" data-physiological="true">
                                    <select id="med-nonhdl-unit" name="med-nonhdl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="med-nonhdl-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-apob">Apolipoprotein B</label>
                                <div class="input-group">
                                    <input type="number" id="med-apob" name="med-apob" class="form-control" min="0.1" max="3" step="0.01" data-validation-type="apob" data-param-type="apoB" data-physiological="true">
                                    <select id="med-apob-unit" name="med-apob-unit" class="form-control">
                                        <option value="g/L">g/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="med-apob-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-lpa">Lipoprotein(a)</label>
                                <div class="input-group">
                                    <input type="number" id="med-lpa" name="med-lpa" class="form-control" min="0" max="500" step="0.1" data-validation-type="lpa" data-param-type="lpa" data-physiological="true">
                                    <select id="med-lpa-unit" name="med-lpa-unit" class="form-control">
                                        <option value="mg/dL">mg/dL</option>
                                        <option value="nmol/L">nmol/L</option>
                                    </select>
                                </div>
                                <div id="med-lpa-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-hba1c">HbA1c</label>
                                <div class="input-group">
                                    <input type="number" id="med-hba1c" name="med-hba1c" class="form-control" min="3" max="20" step="0.1" data-validation-type="hba1c" data-param-type="hba1c" data-physiological="true">
                                    <select id="med-hba1c-unit" name="med-hba1c-unit" class="form-control">
                                        <option value="%">%</option>
                                        <option value="mmol/mol">mmol/mol</option>
                                    </select>
                                </div>
                                <div id="med-hba1c-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <!-- Additional space for future parameters -->
                        </div>
                    </div>
                </div>
                
                <!-- Blood Pressure Readings Section -->
                <div class="section">
                    <h3>Blood Pressure Readings</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp">Current Systolic BP (mmHg)</label>
                                <input type="number" id="med-sbp" name="med-sbp" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                <div id="med-sbp-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-dbp">Current Diastolic BP (mmHg)</label>
                                <input type="number" id="med-dbp" name="med-dbp" class="form-control" min="40" max="150" data-validation-type="diastolicBP" data-param-type="dbp" data-physiological="true">
                                <div id="med-dbp-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h4>Multiple BP Readings for Standard Deviation Calculation</h4>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-1">Reading 1 (SBP)</label>
                                <input type="number" id="med-sbp-1" name="med-sbp-1" class="form-control sbp-reading" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                <div id="med-sbp-1-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-2">Reading 2 (SBP)</label>
                                <input type="number" id="med-sbp-2" name="med-sbp-2" class="form-control sbp-reading" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                <div id="med-sbp-2-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-3">Reading 3 (SBP)</label>
                                <input type="number" id="med-sbp-3" name="med-sbp-3" class="form-control sbp-reading" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                <div id="med-sbp-3-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-4">Reading 4 (SBP)</label>
                                <input type="number" id="med-sbp-4" name="med-sbp-4" class="form-control sbp-reading" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                <div id="med-sbp-4-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-5">Reading 5 (SBP)</label>
                                <input type="number" id="med-sbp-5" name="med-sbp-5" class="form-control sbp-reading" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                <div id="med-sbp-5-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-6">Reading 6 (SBP)</label>
                                <input type="number" id="med-sbp-6" name="med-sbp-6" class="form-control sbp-reading" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                <div id="med-sbp-6-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-mean">Mean SBP</label>
                                <input type="number" id="med-sbp-mean" name="med-sbp-mean" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sbp-sd">SBP Standard Deviation</label>
                                <input type="number" id="med-sbp-sd" name="med-sbp-sd" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <button type="button" id="calculate-bp-stats" class="button button-secondary" style="margin-top: 2rem;">Calculate BP Statistics</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Clinical Parameters Section -->
                <div class="section">
                    <h3>Clinical Parameters</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-sbp">Systolic Blood Pressure (mmHg)</label>
                                <div class="input-group">
                                    <input type="number" id="frs-sbp" name="frs-sbp" class="form-control" min="90" max="200" required data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                    <div class="form-check">
                                        <input type="checkbox" id="frs-multiple-sbp" name="frs-multiple-sbp" class="form-check-input">
                                        <label for="frs-multiple-sbp" class="form-check-label">Multiple readings</label>
                                    </div>
                                </div>
                                <div id="frs-sbp-validation" class="error-message"></div>
                            </div>
                            <div id="frs-sbp-readings" class="form-group" style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="frs-sbp-1">Reading 1</label>
                                        <input type="number" id="frs-sbp-1" name="frs-sbp-1" class="form-control" min="90" max="200" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="frs-sbp-1-validation" class="error-message"></div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="frs-sbp-2">Reading 2</label>
                                        <input type="number" id="frs-sbp-2" name="frs-sbp-2" class="form-control" min="90" max="200" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="frs-sbp-2-validation" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="frs-sbp-readings-extra" class="form-group" style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="frs-sbp-3">Reading 3</label>
                                        <input type="number" id="frs-sbp-3" name="frs-sbp-3" class="form-control" min="90" max="200" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="frs-sbp-3-validation" class="error-message"></div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="frs-sbp-4">Reading 4</label>
                                        <input type="number" id="frs-sbp-4" name="frs-sbp-4" class="form-control" min="90" max="200" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="frs-sbp-4-validation" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="frs-sbp-sd-container" class="form-group" style="display: none;">
                                <label class="form-label" for="frs-sbp-sd">SBP Standard Deviation</label>
                                <input type="number" id="frs-sbp-sd" name="frs-sbp-sd" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-bp-treatment">On Blood Pressure Treatment?</label>
                                <select id="frs-bp-treatment" name="frs-bp-treatment" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <div id="frs-bp-treatment-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="frs-smoker">Current Smoker?</label>
                                <select id="frs-smoker" name="frs-smoker" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <div id="frs-smoker-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="frs-diabetes">Diabetes?</label>
                                <select id="frs-diabetes" name="frs-diabetes" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                                <div id="frs-diabetes-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lipid Parameters Section -->
                <div class="section">
                    <h3>Lipid Parameters</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-total-chol">Total Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="frs-total-chol" name="frs-total-chol" class="form-control" min="1" max="15" step="0.1" required data-validation-type="cholesterol" data-param-type="totalCholesterol" data-physiological="true">
                                    <select id="frs-total-chol-unit" name="frs-total-chol-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="frs-total-chol-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-hdl">HDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="frs-hdl" name="frs-hdl" class="form-control" min="0.4" max="5" step="0.1" required data-validation-type="hdl" data-param-type="hdl" data-physiological="true">
                                    <select id="frs-hdl-unit" name="frs-hdl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="frs-hdl-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-ldl">LDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="frs-ldl" name="frs-ldl" class="form-control" min="0.5" max="15" step="0.1" data-validation-type="ldl" data-param-type="ldl" data-physiological="true">
                                    <select id="frs-ldl-unit" name="frs-ldl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="frs-ldl-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-trig">Triglycerides</label>
                                <div class="input-group">
                                    <input type="number" id="frs-trig" name="frs-trig" class="form-control" min="0.2" max="20" step="0.1" data-validation-type="triglycerides" data-param-type="triglycerides" data-physiological="true">
                                    <select id="frs-trig-unit" name="frs-trig-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="frs-trig-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-nonhdl">Non-HDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="frs-nonhdl" name="frs-nonhdl" class="form-control" min="0.5" max="18" step="0.1" data-validation-type="cholesterol" data-param-type="nonHdl" data-physiological="true">
                                    <select id="frs-nonhdl-unit" name="frs-nonhdl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="frs-nonhdl-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-apob">Apolipoprotein B</label>
                                <div class="input-group">
                                    <input type="number" id="frs-apob" name="frs-apob" class="form-control" min="0.1" max="3" step="0.01" data-validation-type="apob" data-param-type="apoB" data-physiological="true">
                                    <select id="frs-apob-unit" name="frs-apob-unit" class="form-control">
                                        <option value="g/L">g/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="frs-apob-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-lpa">Lipoprotein(a)</label>
                                <div class="input-group">
                                    <input type="number" id="frs-lpa" name="frs-lpa" class="form-control" min="0" max="500" step="0.1" data-validation-type="lpa" data-param-type="lpa" data-physiological="true">
                                    <select id="frs-lpa-unit" name="frs-lpa-unit" class="form-control">
                                        <option value="mg/dL">mg/dL</option>
                                        <option value="nmol/L">nmol/L</option>
                                    </select>
                                </div>
                                <div id="frs-lpa-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="frs-medical-conditions">Medical Conditions</label>
                                <select id="frs-medical-conditions" name="frs-medical-conditions" class="form-control" multiple data-validation-type="text">
                                    <option value="prev_mi">Previous MI</option>
                                    <option value="stroke">Stroke</option>
                                    <option value="tia">TIA</option>
                                    <option value="pvd">Peripheral Vascular Disease</option>
                                    <option value="afib">Atrial Fibrillation</option>
                                    <option value="hf">Heart Failure</option>
                                    <option value="ckd">Chronic Kidney Disease</option>
                                    <option value="ra">Rheumatoid Arthritis</option>
                                    <option value="familial_hypercholesterolemia">Familial Hypercholesterolemia</option>
                                </select>
                                <div id="frs-medical-conditions-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Controls -->
                <div class="form-actions">
                    <button type="submit" class="button button-primary" id="frs-calculate">Calculate Risk</button>
                    <button type="reset" class="button button-secondary" id="frs-reset">Reset</button>
                </div>
            </form>
            
            <!-- Loading Indicator -->
            <div class="loading" id="frs-loading">
                <div class="loading-spinner"></div>
                <p>Calculating...</p>
            </div>
            
            <!-- Results Container -->
            <div id="frs-results-container"></div>
        </div>
        
        <!-- QRISK3 Tab -->
        <div class="tab-content" id="qrisk-tab">
            <h2>QRISK3 Calculator</h2>
            <form id="qrisk-form">
                <!-- Patient Information Section -->
                <div class="section">
                    <h3>Patient Information</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-age">Age (25-84 years)</label>
                                <input type="number" id="qrisk-age" name="qrisk-age" class="form-control" min="25" max="84" required data-validation-type="age" data-param-type="age">
                                <div id="qrisk-age-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-sex">Sex</label>
                                <select id="qrisk-sex" name="qrisk-sex" class="form-control" required data-validation-type="sex">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                                <div id="qrisk-sex-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-ethnicity">Ethnicity</label>
                                <select id="qrisk-ethnicity" name="qrisk-ethnicity" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="WHITE_OR_NOT_STATED">White or not stated</option>
                                    <option value="WHITE_IRISH">White Irish</option>
                                    <option value="WHITE_GYPSY">White Gypsy</option>
                                    <option value="OTHER_WHITE">Other White</option>
                                    <option value="WHITE_BLACK_CARIBBEAN">White + Black Caribbean</option>
                                    <option value="WHITE_BLACK_AFRICAN">White + Black African</option>
                                    <option value="WHITE_ASIAN">White + Asian</option>
                                    <option value="OTHER_MIXED">Other mixed</option>
                                    <option value="INDIAN">Indian</option>
                                    <option value="PAKISTANI">Pakistani</option>
                                    <option value="BANGLADESHI">Bangladeshi</option>
                                    <option value="OTHER_ASIAN">Other Asian</option>
                                    <option value="BLACK_CARIBBEAN">Black Caribbean</option>
                                    <option value="BLACK_AFRICAN">Black African</option>
                                    <option value="OTHER_BLACK">Other Black</option>
                                    <option value="CHINESE">Chinese</option>
                                    <option value="OTHER">Other</option>
                                </select>
                                <div id="qrisk-ethnicity-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-height">Height</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-height" name="qrisk-height" class="form-control" min="100" max="250" step="0.1" data-validation-type="height" data-param-type="height_cm" data-physiological="true">
                                    <select id="qrisk-height-unit" name="qrisk-height-unit" class="form-control">
                                        <option value="cm">cm</option>
                                        <option value="in">in</option>
                                    </select>
                                </div>
                                <div id="qrisk-height-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-weight">Weight</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-weight" name="qrisk-weight" class="form-control" min="20" max="300" step="0.1" data-validation-type="weight" data-param-type="weight_kg" data-physiological="true">
                                    <select id="qrisk-weight-unit" name="qrisk-weight-unit" class="form-control">
                                        <option value="kg">kg</option>
                                        <option value="lb">lb</option>
                                    </select>
                                </div>
                                <div id="qrisk-weight-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-bmi">BMI (kg/m²)</label>
                                <input type="number" id="qrisk-bmi" name="qrisk-bmi" class="form-control" readonly data-param-type="bmi">
                                <div id="qrisk-bmi-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Clinical Parameters Section -->
                <div class="section">
                    <h3>Clinical Parameters</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-sbp">Systolic Blood Pressure (mmHg)</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-sbp" name="qrisk-sbp" class="form-control" min="70" max="250" required data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                    <div class="form-check">
                                        <input type="checkbox" id="qrisk-multiple-sbp" name="qrisk-multiple-sbp" class="form-check-input">
                                        <label for="qrisk-multiple-sbp" class="form-check-label">Multiple readings</label>
                                    </div>
                                </div>
                                <div id="qrisk-sbp-validation" class="error-message"></div>
                            </div>
                            <div id="qrisk-sbp-readings" class="form-group" style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-1">Reading 1</label>
                                        <input type="number" id="qrisk-sbp-1" name="qrisk-sbp-1" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-1-validation" class="error-message"></div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-2">Reading 2</label>
                                        <input type="number" id="qrisk-sbp-2" name="qrisk-sbp-2" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-2-validation" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="qrisk-sbp-readings-extra" class="form-group" style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-3">Reading 3</label>
                                        <input type="number" id="qrisk-sbp-3" name="qrisk-sbp-3" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-3-validation" class="error-message"></div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="qrisk-sbp-4">Reading 4</label>
                                        <input type="number" id="qrisk-sbp-4" name="qrisk-sbp-4" class="form-control" min="70" max="250" data-validation-type="systolicBP" data-param-type="sbp" data-physiological="true">
                                        <div id="qrisk-sbp-4-validation" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="qrisk-sbp-sd-container" class="form-group" style="display: none;">
                                <label class="form-label" for="qrisk-sbp-sd">SBP Standard Deviation</label>
                                <input type="number" id="qrisk-sbp-sd" name="qrisk-sbp-sd" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-bp-treatment">On Blood Pressure Treatment?</label>
                                <select id="qrisk-bp-treatment" name="qrisk-bp-treatment" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                                <div id="qrisk-bp-treatment-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="qrisk-smoker">Smoking Status</label>
                                <select id="qrisk-smoker" name="qrisk-smoker" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="non">Non-smoker</option>
                                    <option value="ex">Ex-smoker</option>
                                    <option value="light">Light smoker (< 10/day)</option>
                                    <option value="moderate">Moderate smoker (10-19/day)</option>
                                    <option value="heavy">Heavy smoker (≥ 20/day)</option>
                                </select>
                                <div id="qrisk-smoker-validation" class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="qrisk-diabetes">Diabetes Status</label>
                                <select id="qrisk-diabetes" name="qrisk-diabetes" class="form-control" required data-validation-type="text">
                                    <option value="">Select</option>
                                    <option value="none">No diabetes</option>
                                    <option value="type1">Type 1 diabetes</option>
                                    <option value="type2">Type 2 diabetes</option>
                                </select>
                                <div id="qrisk-diabetes-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lipid Parameters Section -->
                <div class="section">
                    <h3>Lipid Parameters</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-total-chol">Total Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-total-chol" name="qrisk-total-chol" class="form-control" min="1" max="15" step="0.1" required data-validation-type="cholesterol" data-param-type="totalCholesterol" data-physiological="true">
                                    <select id="qrisk-total-chol-unit" name="qrisk-total-chol-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="qrisk-total-chol-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-hdl">HDL Cholesterol</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-hdl" name="qrisk-hdl" class="form-control" min="0.4" max="5" step="0.1" required data-validation-type="hdl" data-param-type="hdl" data-physiological="true">
                                    <select id="qrisk-hdl-unit" name="qrisk-hdl-unit" class="form-control">
                                        <option value="mmol/L">mmol/L</option>
                                        <option value="mg/dL">mg/dL</option>
                                    </select>
                                </div>
                                <div id="qrisk-hdl-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="qrisk-cholesterol-ratio">Total Chol:HDL Ratio</label>
                                <input type="number" id="qrisk-cholesterol-ratio" name="qrisk-cholesterol-ratio" class="form-control" readonly min="1" max="15" step="0.1">
                                <div id="qrisk-cholesterol-ratio-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Risk Factors Section -->
                <div class="section">
                    <h3>Additional Risk Factors</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label">Family History of CVD?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-family-history" name="qrisk-family-history" class="form-check-input">
                                    <label for="qrisk-family-history" class="form-check-label">Yes (angina or heart attack in a 1st degree relative < 60 years)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Chronic Kidney Disease (Stage 3, 4, or 5)?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-chronic-kidney-disease" name="qrisk-chronic-kidney-disease" class="form-check-input">
                                    <label for="qrisk-chronic-kidney-disease" class="form-check-label">Yes</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Atrial Fibrillation?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-atrial-fibrillation" name="qrisk-atrial-fibrillation" class="form-check-input">
                                    <label for="qrisk-atrial-fibrillation" class="form-check-label">Yes</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Migraines?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-migraine" name="qrisk-migraine" class="form-check-input">
                                    <label for="qrisk-migraine" class="form-check-label">Yes</label>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label">Rheumatoid Arthritis?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-rheumatoid-arthritis" name="qrisk-rheumatoid-arthritis" class="form-check-input">
                                    <label for="qrisk-rheumatoid-arthritis" class="form-check-label">Yes</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Systemic Lupus Erythematosus (SLE)?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-sle" name="qrisk-sle" class="form-check-input">
                                    <label for="qrisk-sle" class="form-check-label">Yes</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Severe Mental Illness?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-severe-mental-illness" name="qrisk-severe-mental-illness" class="form-check-input">
                                    <label for="qrisk-severe-mental-illness" class="form-check-label">Yes (Schizophrenia, bipolar disorder, or moderate/severe depression)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">On Atypical Antipsychotics?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-atypical-antipsychotics" name="qrisk-atypical-antipsychotics" class="form-check-input">
                                    <label for="qrisk-atypical-antipsychotics" class="form-check-label">Yes</label>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label">On Regular Steroid Tablets?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-regular-steroids" name="qrisk-regular-steroids" class="form-check-input">
                                    <label for="qrisk-regular-steroids" class="form-check-label">Yes</label>
                                </div>
                            </div>
                            <div class="form-group" id="qrisk-erectile-dysfunction-container" style="display: none;">
                                <label class="form-label">Erectile Dysfunction?</label>
                                <div class="form-check">
                                    <input type="checkbox" id="qrisk-erectile-dysfunction" name="qrisk-erectile-dysfunction" class="form-check-input">
                                    <label for="qrisk-erectile-dysfunction" class="form-check-label">Yes</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="qrisk-townsend">Townsend Deprivation Score</label>
                                <input type="number" id="qrisk-townsend" name="qrisk-townsend" class="form-control" min="-10" max="15" step="0.1" data-validation-type="numeric">
                                <div id="qrisk-townsend-validation" class="error-message"></div>
                                <small class="form-text text-muted">Optional: -7 (least deprived) to +12 (most deprived)</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="qrisk-lpa">Lipoprotein(a)</label>
                                <div class="input-group">
                                    <input type="number" id="qrisk-lpa" name="qrisk-lpa" class="form-control" min="0" max="500" step="0.1" data-validation-type="lpa" data-param-type="lpa" data-physiological="true">
                                    <select id="qrisk-lpa-unit" name="qrisk-lpa-unit" class="form-control">
                                        <option value="mg/dL">mg/dL</option>
                                        <option value="nmol/L">nmol/L</option>
                                    </select>
                                </div>
                                <div id="qrisk-lpa-validation" class="error-message"></div>
                                <small class="form-text text-muted">Optional: for Lp(a) modification (not in original QRISK3)</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Controls -->
                <div class="form-actions">
                    <button type="submit" class="button button-primary" id="qrisk-calculate">Calculate Risk</button>
                    <button type="reset" class="button button-secondary" id="qrisk-reset">Reset</button>
                </div>
            </form>
            
            <!-- Loading Indicator -->
            <div class="loading" id="qrisk-loading">
                <div class="loading-spinner"></div>
                <p>Calculating...</p>
            </div>
            
            <!-- Results Container -->
            <div id="qrisk-results-container"></div>
        </div>
        
        <!-- Medication Evaluation Tab -->
        <div class="tab-content" id="medication-tab">
            <h2>Medication Evaluation</h2>
            <form id="medication-form">
                <!-- Patient Information Section -->
                <div class="section">
                    <h3>Patient Information</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-age">Age</label>
                                <input type="number" id="med-age" name="med-age" class="form-control" min="18" max="120" data-validation-type="age" data-param-type="age">
                                <div id="med-age-validation" class="error-message"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label" for="med-sex">Sex</label>
                                <select id="med-sex" name="med-sex" class="form-control" data-validation-type="sex">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                                <div id="med-sex-validation" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>