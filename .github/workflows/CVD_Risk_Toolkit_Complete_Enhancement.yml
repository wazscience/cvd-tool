name: CVD Risk Toolkit Complete Enhancement

on:
  # Triggers when text files are pushed to the repository
  push:
    branches: [ main ]
    paths:
      - '**.txt'
  
  # Allows manual triggering from the Actions tab
  workflow_dispatch:
    inputs:
      deployChanges:
        description: 'Deploy the changes to production'
        required: false
        default: false
        type: boolean

jobs:
  enhance-toolkit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
    
    - name: Create directories for processed files
      run: |
        mkdir -p converted_files
        mkdir -p backup_files
    
    # Backup existing files before making changes
    - name: Backup existing files
      run: |
        # Backup HTML file
        if [ -f "index.html" ]; then
          cp index.html backup_files/index.html.bak
          echo "Backed up index.html"
        fi
        
        # Backup existing JavaScript files
        for file in qrisk3-implementation.js juno-integration.js enhanced-display.js; do
          if [ -f "$file" ]; then
            cp "$file" "backup_files/$(basename "$file").bak"
            echo "Backed up $file"
          fi
        done
        
        echo "Backup completed"
    
    # Convert the text files to JavaScript files
    - name: Convert text files to JavaScript
      run: |
        # Check if QRISK3 Implementation file exists
        if [ -f "QRISK3 Implementation Module.txt" ]; then
          cp "QRISK3 Implementation Module.txt" converted_files/qrisk3-implementation.js
          echo "Converted QRISK3 Implementation Module.txt to qrisk3-implementation.js"
        else 
          echo "Warning: QRISK3 Implementation Module.txt not found"
        fi
        
        # Check if Juno EMR Integration file exists
        if [ -f "Juno EMR Integration Module.txt" ]; then
          cp "Juno EMR Integration Module.txt" converted_files/juno-integration.js
          echo "Converted Juno EMR Integration Module.txt to juno-integration.js"
        else
          echo "Warning: Juno EMR Integration Module.txt not found"
        fi
        
        # Check if Enhanced Results Display file exists (with either spelling)
        if [ -f "Enhanced Results Display Module.txt" ]; then
          cp "Enhanced Results Display Module.txt" converted_files/enhanced-display.js
          echo "Converted Enhanced Results Display Module.txt to enhanced-display.js"
        elif [ -f "Enhanced Results Display Moduel.txt" ]; then
          # Handle alternative spelling
          cp "Enhanced Results Display Moduel.txt" converted_files/enhanced-display.js
          echo "Converted Enhanced Results Display Moduel.txt to enhanced-display.js"
        else
          echo "Warning: Enhanced Results Display file not found with either spelling"
        fi
        
        # List converted files
        echo "Converted files:"
        ls -la converted_files/
    
    # Validate JavaScript syntax for the converted files
    - name: Validate JavaScript syntax
      run: |
        echo "Checking JavaScript syntax..."
        for file in converted_files/*.js; do
          if [ -f "$file" ]; then
            echo "Validating $file..."
            node --check "$file" || echo "Warning: Syntax issues in $file, but continuing..."
          fi
        done
    
    # Replace existing files with converted ones
    - name: Replace existing JavaScript files
      run: |
        # Move converted JS files to main directory
        for file in converted_files/*.js; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            mv "$file" "./$filename"
            echo "Added/replaced $filename"
          fi
        done
    
    # Update HTML file
    - name: Update HTML file
      run: |
        # Find the main HTML file
        HTML_FILE="index.html"
        if [ ! -f "$HTML_FILE" ]; then
          # Try to find any HTML file if index.html doesn't exist
          HTML_FILE=$(find . -maxdepth 1 -name "*.html" | head -n 1)
          if [ -z "$HTML_FILE" ]; then
            echo "No HTML file found to update"
            exit 0
          fi
        fi
        
        echo "Updating $HTML_FILE..."
        
        # 1. Add script references if they don't exist
        if ! grep -q "qrisk3-implementation.js" "$HTML_FILE"; then
          # Find closing body tag to insert scripts before it
          if grep -q "</body>" "$HTML_FILE"; then
            # Insert scripts before closing body tag
            sed -i 's|</body>|<script src="qrisk3-implementation.js"></script>\n<script src="juno-integration.js"></script>\n<script src="enhanced-display.js"></script>\n</body>|' "$HTML_FILE"
            echo "Added script references before closing body tag"
          else
            # If no body tag, add to the end of the file
            echo -e "\n<script src=\"qrisk3-implementation.js\"></script>\n<script src=\"juno-integration.js\"></script>\n<script src=\"enhanced-display.js\"></script>" >> "$HTML_FILE"
            echo "Added script references at the end of the file"
          fi
        else
          echo "Script references already exist in the HTML file"
        fi
        
        # 2. Update QRISK3 form with new fields
        # Find the Medical Conditions section
        if grep -q "Medical Conditions" "$HTML_FILE"; then
          # Create a temporary file for the new fields
          cat > temp_fields.txt << 'EOL'
<div class="checkbox-item">
    <input type="checkbox" id="qrisk-migraine">
    <label for="qrisk-migraine">Migraine</label>
</div>

<div class="checkbox-item">
    <input type="checkbox" id="qrisk-sle">
    <label for="qrisk-sle">Systemic Lupus Erythematosus (SLE)</label>
</div>

<div class="checkbox-item">
    <input type="checkbox" id="qrisk-semi">
    <label for="qrisk-semi">Severe Mental Illness</label>
</div>

<div class="checkbox-item" id="qrisk-ed-container" style="display: none;">
    <input type="checkbox" id="qrisk-ed">
    <label for="qrisk-ed">Erectile Dysfunction/Impotence</label>
</div>
EOL

          # Check if these fields already exist
          if ! grep -q "qrisk-migraine" "$HTML_FILE"; then
            # Find the closing div for checkbox-group in the Medical Conditions section
            MEDICAL_LINE=$(grep -n "Medical Conditions" "$HTML_FILE" | head -n 1 | cut -d ':' -f 1)
            CHECKBOX_GROUP_END=$(tail -n +$MEDICAL_LINE "$HTML_FILE" | grep -n "</div>" | head -n 3 | tail -n 1 | cut -d ':' -f 1)
            CHECKBOX_GROUP_END=$((MEDICAL_LINE + CHECKBOX_GROUP_END - 1))
            
            # Insert new fields before the closing div
            sed -i "${CHECKBOX_GROUP_END}r temp_fields.txt" "$HTML_FILE"
            echo "Added new medical condition fields"
          else
            echo "Medical condition fields already exist"
          fi
          
          # Create the Medications section if it doesn't exist
          if ! grep -q "qrisk-atypical-antipsychotics" "$HTML_FILE"; then
            # Create a temporary file for the medications section
            cat > temp_medications.txt << 'EOL'
<div class="card">
    <div class="card-header active">
        <h3>Medications</h3>
        <span class="toggle-icon">â–¼</span>
    </div>
    <div class="card-body active">
        <div class="checkbox-group">
            <div class="checkbox-item">
                <input type="checkbox" id="qrisk-atypical-antipsychotics">
                <label for="qrisk-atypical-antipsychotics">On Atypical Antipsychotics</label>
            </div>
            
            <div class="checkbox-item">
                <input type="checkbox" id="qrisk-corticosteroids">
                <label for="qrisk-corticosteroids">On Regular Corticosteroids</label>
            </div>
        </div>
    </div>
</div>
EOL
            
            # Find the closing div after the Medical Conditions card
            MEDICAL_LINE=$(grep -n "Medical Conditions" "$HTML_FILE" | head -n 1 | cut -d ':' -f 1)
            CARD_END=$(tail -n +$MEDICAL_LINE "$HTML_FILE" | grep -n "</div>" | head -n 6 | tail -n 1 | cut -d ':' -f 1)
            CARD_END=$((MEDICAL_LINE + CARD_END))
            
            # Insert medications section after the Medical Conditions card
            sed -i "${CARD_END}r temp_medications.txt" "$HTML_FILE"
            echo "Added medications section"
          else
            echo "Medications section already exists"
          fi
          
          # Add hidden fields for BMI and cholesterol ratio
          if ! grep -q "qrisk-bmi\|qrisk-chol-ratio" "$HTML_FILE"; then
            # Find the Lipid Profile section
            LIPID_LINE=$(grep -n "Lipid Profile" "$HTML_FILE" | head -n 1 | cut -d ':' -f 1)
            if [ -n "$LIPID_LINE" ]; then
              # Add hidden fields after the closing div of the Lipid Profile card
              LIPID_END=$(tail -n +$LIPID_LINE "$HTML_FILE" | grep -n "</div>" | head -n 6 | tail -n 1 | cut -d ':' -f 1)
              LIPID_END=$((LIPID_LINE + LIPID_END))
              
              # Create temp file for hidden fields
              cat > temp_hidden.txt << 'EOL'
<!-- Hidden fields for calculations -->
<input type="hidden" id="qrisk-bmi">
<input type="hidden" id="qrisk-chol-ratio">
EOL
              
              sed -i "${LIPID_END}r temp_hidden.txt" "$HTML_FILE"
              echo "Added hidden fields for calculations"
            else
              echo "Could not find Lipid Profile section to add hidden fields"
            fi
          else
            echo "Hidden calculation fields already exist"
          fi
        else
          echo "Could not find Medical Conditions section in the HTML file"
        fi
        
        # 3. Add event handlers and function updates
        # First check if there's a script section at the end
        if grep -q "</script>" "$HTML_FILE"; then
          # Create temp file for event handlers
          cat > temp_handlers.txt << 'EOL'
// QRISK3 Enhancement Event Handlers
document.addEventListener('DOMContentLoaded', function() {
    // Toggle erectile dysfunction field based on sex
    const sexSelect = document.getElementById('qrisk-sex');
    if (sexSelect) {
        sexSelect.addEventListener('change', function() {
            const edContainer = document.getElementById('qrisk-ed-container');
            if (edContainer) {
                if (this.value === 'male') {
                    edContainer.style.display = 'block';
                } else {
                    edContainer.style.display = 'none';
                    document.getElementById('qrisk-ed').checked = false;
                }
            }
        });
    }

    // Auto-calculate BMI when height or weight changes
    const heightInput = document.getElementById('qrisk-height');
    const weightInput = document.getElementById('qrisk-weight');
    if (heightInput) heightInput.addEventListener('change', calculateBMIForQRISK);
    if (weightInput) weightInput.addEventListener('change', calculateBMIForQRISK);
    
    // Auto-calculate cholesterol ratio
    const totalCholInput = document.getElementById('qrisk-total-chol');
    const hdlInput = document.getElementById('qrisk-hdl');
    if (totalCholInput) totalCholInput.addEventListener('change', calculateCholesterolRatio);
    if (hdlInput) hdlInput.addEventListener('change', calculateCholesterolRatio);
    
    // Initialize Juno EMR integration if available
    if (window.JunoIntegration && typeof window.JunoIntegration.init === 'function') {
        window.JunoIntegration.init();
    }
});

// Override the calculateQRISK function to use the new implementation
function calculateQRISK() {
    const result = validateQRISKForm();
    
    if (!result.isValid) {
        displayErrors(result.errors);
        return;
    }
    
    const data = result.data;
    
    // Add additional fields to data object
    data.migraine = document.getElementById('qrisk-migraine')?.checked || false;
    data.sle = document.getElementById('qrisk-sle')?.checked || false;
    data.severeMetalIllness = document.getElementById('qrisk-semi')?.checked || false;
    data.erectileDysfunction = document.getElementById('qrisk-ed')?.checked || false;
    data.atypicalAntipsychotics = document.getElementById('qrisk-atypical-antipsychotics')?.checked || false;
    data.corticosteroids = document.getElementById('qrisk-corticosteroids')?.checked || false;
    
    // Get BMI and cholesterol ratio from hidden fields if available
    const bmiInput = document.getElementById('qrisk-bmi');
    if (bmiInput && bmiInput.value) {
        data.bmi = parseFloat(bmiInput.value);
    }
    
    const cholRatioInput = document.getElementById('qrisk-chol-ratio');
    if (cholRatioInput && cholRatioInput.value) {
        data.cholRatio = parseFloat(cholRatioInput.value);
    }
    
    const results = calculateQRISK3Score(data);
    
    // Get LDL value for treatment recommendations if available
    let ldlValue = null;
    if (data.ldl !== null) {
        ldlValue = data.ldl;
        if (data.ldlUnit === 'mg/dL') {
            ldlValue = convertCholesterol(ldlValue, 'mg/dL', 'mmol/L');
        }
    }
    
    // Get treatment recommendations
    const recommendations = getCCSRecommendation(
        results.modifiedRisk, 
        ldlValue, 
        data.diabetes !== 'none', 
        data.age
    );
    
    // Use the enhanced display function if available, otherwise fall back to original
    if (typeof displayQRISKResults === 'function') {
        displayQRISKResults(data, results, recommendations);
    } else {
        // Legacy display function
        console.warn("Enhanced display function not available, using legacy display");
        displayResults(data, results, recommendations);
    }
    
    // Dispatch event with risk data for cross-tab sharing
    document.dispatchEvent(new CustomEvent('risk-calculated', {
        detail: {
            riskScore: results.modifiedRisk,
            calculator: 'QRISK3'
        }
    }));
    
    // Update the comparison tab status if function exists
    if (typeof updateComparisonTabStatus === 'function') {
        updateComparisonTabStatus('qrisk', true);
    }
}
EOL
          
          # Find the last script tag in the file
          LAST_SCRIPT=$(grep -n "</script>" "$HTML_FILE" | tail -n 1 | cut -d ':' -f 1)
          
          # Insert handlers before the closing script tag
          sed -i "${LAST_SCRIPT}i $(cat temp_handlers.txt)" "$HTML_FILE"
          echo "Added event handlers and function overrides"
        else
          # Create a new script section at the end of the file
          cat > temp_script.txt << 'EOL'
<script>
// QRISK3 Enhancement Event Handlers
document.addEventListener('DOMContentLoaded', function() {
    // Toggle erectile dysfunction field based on sex
    const sexSelect = document.getElementById('qrisk-sex');
    if (sexSelect) {
        sexSelect.addEventListener('change', function() {
            const edContainer = document.getElementById('qrisk-ed-container');
            if (edContainer) {
                if (this.value === 'male') {
                    edContainer.style.display = 'block';
                } else {
                    edContainer.style.display = 'none';
                    document.getElementById('qrisk-ed').checked = false;
                }
            }
        });
    }

    // Auto-calculate BMI when height or weight changes
    const heightInput = document.getElementById('qrisk-height');
    const weightInput = document.getElementById('qrisk-weight');
    if (heightInput) heightInput.addEventListener('change', calculateBMIForQRISK);
    if (weightInput) weightInput.addEventListener('change', calculateBMIForQRISK);
    
    // Auto-calculate cholesterol ratio
    const totalCholInput = document.getElementById('qrisk-total-chol');
    const hdlInput = document.getElementById('qrisk-hdl');
    if (totalCholInput) totalCholInput.addEventListener('change', calculateCholesterolRatio);
    if (hdlInput) hdlInput.addEventListener('change', calculateCholesterolRatio);
    
    // Initialize Juno EMR integration if available
    if (window.JunoIntegration && typeof window.JunoIntegration.init === 'function') {
        window.JunoIntegration.init();
    }
});

// Override the calculateQRISK function to use the new implementation
function calculateQRISK() {
    const result = validateQRISKForm();
    
    if (!result.isValid) {
        displayErrors(result.errors);
        return;
    }
    
    const data = result.data;
    
    // Add additional fields to data object
    data.migraine = document.getElementById('qrisk-migraine')?.checked || false;
    data.sle = document.getElementById('qrisk-sle')?.checked || false;
    data.severeMetalIllness = document.getElementById('qrisk-semi')?.checked || false;
    data.erectileDysfunction = document.getElementById('qrisk-ed')?.checked || false;
    data.atypicalAntipsychotics = document.getElementById('qrisk-atypical-antipsychotics')?.checked || false;
    data.corticosteroids = document.getElementById('qrisk-corticosteroids')?.checked || false;
    
    // Get BMI and cholesterol ratio from hidden fields if available
    const bmiInput = document.getElementById('qrisk-bmi');
    if (bmiInput && bmiInput.value) {
        data.bmi = parseFloat(bmiInput.value);
    }
    
    const cholRatioInput = document.getElementById('qrisk-chol-ratio');
    if (cholRatioInput && cholRatioInput.value) {
        data.cholRatio = parseFloat(cholRatioInput.value);
    }
    
    const results = calculateQRISK3Score(data);
    
    // Get LDL value for treatment recommendations if available
    let ldlValue = null;
    if (data.ldl !== null) {
        ldlValue = data.ldl;
        if (data.ldlUnit === 'mg/dL') {
            ldlValue = convertCholesterol(ldlValue, 'mg/dL', 'mmol/L');
        }
    }
    
    // Get treatment recommendations
    const recommendations = getCCSRecommendation(
        results.modifiedRisk, 
        ldlValue, 
        data.diabetes !== 'none', 
        data.age
    );
    
    // Use the enhanced display function if available, otherwise fall back to original
    if (typeof displayQRISKResults === 'function') {
        displayQRISKResults(data, results, recommendations);
    } else {
        // Legacy display function
        console.warn("Enhanced display function not available, using legacy display");
        displayResults(data, results, recommendations);
    }
    
    // Dispatch event with risk data for cross-tab sharing
    document.dispatchEvent(new CustomEvent('risk-calculated', {
        detail: {
            riskScore: results.modifiedRisk,
            calculator: 'QRISK3'
        }
    }));
    
    // Update the comparison tab status if function exists
    if (typeof updateComparisonTabStatus === 'function') {
        updateComparisonTabStatus('qrisk', true);
    }
}
</script>
EOL
          
          # Add script section to the end of the file
          echo -e "\n$(cat temp_script.txt)" >> "$HTML_FILE"
          echo "Added new script section with event handlers and function overrides"
        fi
        
        # Clean up temporary files
        rm -f temp_*.txt
        
        echo "HTML file update completed"
    
    # Commit all changes
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add and commit all changes
        git add *.js *.html
        git commit -m "Implement CVD Risk Toolkit enhancements" || echo "No changes to commit"
    
    # Push the changes
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    # Optional deployment step
    - name: Deploy to production
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deployChanges == 'true' }}
      run: |
        echo "Deploying to production..."
        # Add your deployment commands here
        # For example, deploy to GitHub Pages:
        # git subtree push --prefix dist origin gh-pages
